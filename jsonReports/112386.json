{"id":112386,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTIzODY=","url":"https://hackerone.com/reports/112386","title":"smartlist_add, smartlist_insert (may) cause heap corruption as a result of inadequate checks in smartlist_ensure_capacity","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-23T03:33:29.620Z","submitted_at":"2016-01-23T03:33:29.620Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"guido","url":"/guido","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1800,"url":"https://hackerone.com/torproject","handle":"torproject","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Tor","twitter_handle":"torproject","website":"https://www.torproject.org/","about":"Anonymity Online"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-10-19T10:16:15.572Z","bug_reporter_agreed_on_going_public_at":"2017-10-19T10:16:15.522Z","team_member_agreed_on_going_public_at":"2017-10-19T09:34:51.427Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"#Walkthrough of the vulnerability\n\n```smartlist_add``` and ```smartlist_insert``` both invoke ```smartlist_ensure_capacity``` prior adding an element to the list in order to ensure that sufficient memory is available, to ```exit()``` if not enough memory is available and to detect requests for an invalid size:\n\n```c\nstatic INLINE void\nsmartlist_ensure_capacity(smartlist_t *sl, int size)\n{\n#if SIZEOF_SIZE_T \u003e SIZEOF_INT\n#define MAX_CAPACITY (INT_MAX)\n#else\n#define MAX_CAPACITY (int)((SIZE_MAX / (sizeof(void*))))\n#define ASSERT_CAPACITY\n#endif\n  if (size \u003e sl-\u003ecapacity) {\n    int higher = sl-\u003ecapacity;\n    if (PREDICT_UNLIKELY(size \u003e MAX_CAPACITY/2)) {\n#ifdef ASSERT_CAPACITY\n      /* We don't include this assertion when MAX_CAPACITY == INT_MAX,\n       * since int size; (size \u003c= INT_MAX) makes analysis tools think we're\n       * doing something stupid. */\n      tor_assert(size \u003c= MAX_CAPACITY);\n#endif\n      higher = MAX_CAPACITY;\n    } else {\n      while (size \u003e higher)\n        higher *= 2;\n    }\n    sl-\u003ecapacity = higher;\n    sl-\u003elist = tor_reallocarray(sl-\u003elist, sizeof(void*),\n                                ((size_t)sl-\u003ecapacity));\n  }\n#undef ASSERT_CAPACITY\n#undef MAX_CAPACITY\n}\n```\n\nOn a typical 64-bit system, ```SIZEOF_INT``` is 4 and ```SIZEOF_SIZE_T``` is 8. Consequently, ```MAX_CAPACITY``` is ```INT_MAX```, which is 0x7FFFFFFF as can be seen in torint.h:\n\n```c\n#ifndef INT_MAX\n#if (SIZEOF_INT == 4)\n#define INT_MAX 0x7fffffffL\n#elif (SIZEOF_INT == 8)\n#define INT_MAX 0x7fffffffffffffffL\n#else\n#error \"Can't define INT_MAX\"\n#endif\n#endif\n```\n\nSo ```MAX_CAPACITY``` is 0x7FFFFFFF. Now assume that that many (0x7FFFFFFF) items have already been added to a smartlist via smartlist_add(sl, value).\n\nsmartlist_add() is:\n\n```c\nvoid\nsmartlist_add(smartlist_t *sl, void *element)\n{\n  smartlist_ensure_capacity(sl, sl-\u003enum_used+1);\n  sl-\u003elist[sl-\u003enum_used++] = element;\n}\n```\n\nIf ```sl-\u003enum_used``` is 0x7FFFFFFF prior to invoking ```smartlist_add```, then the next ```smartlist_add``` is effectively:\n\n```c\nvoid\nsmartlist_add(smartlist_t *sl, void *element)\n{\n  smartlist_ensure_capacity(sl, -2147483648);\n  sl-\u003elist[2147483647] = element;\n  sl-\u003enum_used = -2147483648\n}\n```\n\nThis is the case since we are dealing with a signed 32 bit integer, and 2147483647 + 1 equals -2147483647.\n\nAll of the code in ```smartlist_ensure_capacity``` is wrapped inside the following ```if``` block:\n\n```c\n  if (size \u003e sl-\u003ecapacity) {\n  }\n```\n\nThe expression -2147483648 \u003e 2147483647 equals false, thus the code inside the block is not executed.\n\nWhat actually causes the segmentation fault is that a negative 32 bit integer is used to compute a the location of array index on a 64 bit memory layout, ie., the next call to smartlist_add is effectively:\n\n```c\nvoid\nsmartlist_add(smartlist_t *sl, void *element)\n{\n  smartlist_ensure_capacity(sl, -2147483647); // Note that this is effective do-nothing code, as explained above\n  sl-\u003elist[-2147483648] = element;\n  sl-\u003enum_used = -2147483647\n}\n```\n\n#Proof of concept\n\nI've prepared a proof of concept which consists of smartlist_new, smartlist_add, smartlist_ensure_capacity taken from the Tor source code version 0.2.7.6 and their dependencies (tor_*alloc functions etc).\n\nI have made one change to it and that is the size of one element can be configured. In the Tor source code this is void*, which is 8 bytes on a 64 bit system.\n\nI've defined:\n\n```c\n#define ELEMENT unsigned char\n```\n\nbecause 2147483647 * 8 bytes = 17179869176 bytes = 16 gigabyte, which I couldn't allocate on my system. ```unsigned int``` works since it only requires 8 gigabytes of memory.\n\n#Discussion\n\nThe requirement for 16 gigabytes of memory is considerable.\n\nTriggering the vulnerability obviously also requires some code path which will invoke ```smartlist_add``` or ```smartlist_insert``` upon the same smartlist at the attacker's behest. Moreover, such a code path may have the side effect that it requires a separate allocation for each object that is added to the list; ```smartlist_add``` takes a pointer argument after all -- usually, but not always, this pointer refers to freshly allocated memory. Exceptions to this rule are static strings and pointers to a place in a large string or buffer that was already extant.\nOnce a vulnerable code path has been discovered, then it ultimately boils down to how much memory a user's machine is able to allocate in order to corrupt the heap.\n\nDespite these constraints, smartlists form a considerable portion of the infrastructure of your code (I count some 380+ occurrences of ```smartlist_add```/```smartlist_insert``` in the .c files using grep, that is excluding the test/ directory) and as such it's probably wise to revise the checks in ```smartlist_ensure_capacity```.\n\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":70504,"file_name":"poc.tar","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/070/504/d6bb53c68866bc6ece3f0e80b748134d0d3cd821/poc.tar?response-content-disposition=attachment%3B%20filename%3D%22poc.tar%22%3B%20filename%2A%3DUTF-8%27%27poc.tar\u0026response-content-type=application%2Fx-tar\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQUWIS6VCD%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T132613Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQD5qsiIq7Ck1i9U3MTr1Jo1%2F3EDxH2PPmsZwQtKB8ZKHgIhAJ3GPiydxb4RL1gx8xsJzOsLrxI5jwwj0tTnFObt0P14KoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgzIOEXrWQ9u1AQUX0Uq1wOcZjaNugHMVKWeqymcjzBFh6Y1k6CMr8RU%2By%2FCZ4rv9GZiC2wT8OmGhsgt00HKgFWK1MpUtynFdgo25n2Z3Hw%2BIbYI8vc1JJdIjhuurHucoJNgsKCs02JzKj8GyJUC61pv0yaDJyGUVPN694UkMEyn%2FPWTQr%2BUTeBhbmczKhCGUj%2FpPN2iIbYsRZixR6LxxOf2cvjX2jSZkAk%2FSVsApfA8g%2BhlsBjDUA9%2B8YRWNjxfWtxQ%2Foo1xWaWyO6R0C2NxkUOjfjpECLEYEQ7vJ%2Bmu27ctvQxX8DIgxS97NsRC7LzasVsLHVmntXBAZ7PuEI4sWc5xs%2Fk66Q906%2BB%2BzvloL3Axk31g5hiymuem0csQnadqDxLt8p2LjIDw8YcQPN5NH0kGSb6mQrkldEFgJqP84RMAJRIxUJWDd%2B%2BPuzQFsioIExGAI0yAK1L2jOitJOooOZlWfFIzjDUn7dj9xSziPydE91tqmI514stzkBU2GFbRIrklzPo3g7n0zD%2FNL7OLEHlmYWBTM9ot%2B6bu4Bck8DrV4VVi9QHnC5ukEnqLU7NSIQGPaibC1SdOVjM2Iv6X9PdR0rR6F07TM%2FRs9G%2B%2BYIK1kHXDHgTN6Tqa9Kn%2B8BfoEt%2BZqnCJGYwv%2ByQiwY6pAFugzNge1CtFW4ATDcRX3hNOdndjPYZIsRGJutSgqHjCwxt8awsI7yZQ6vRxlp6LSSmoSK%2BkQ3evRcXC09cJ%2F1e4JrEeYASE3WVsCxAQVnPVIMtkim2T%2BFMB87kfQL6qAH6iiBO2KVli0mZ4%2BX%2ByxoxRVipnwQh%2B2l8LEnW1ug4kWwPqBp1%2F3G0D3IViaM%2F6KEe0O675l3jsd9YY%2BgtdY9L6zl0yg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=52a8ab177c36502ac237b650eb74ac49f25f2954a4d49e49d4b2157abd3056f8","file_size":40960,"type":"application/x-tar"}],"allow_singular_disclosure_at":"2017-11-18T09:34:51.473Z","allow_singular_disclosure_after":-122961082.30051391,"singular_disclosure_allowed":true,"vote_count":6,"voters":["geeknik","eveeez","mr_r3boot","spetr0x","b4155f7c29acd42c27d007a","mycel"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":770621,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello there,\n\nmany thanks for the bug report.\n\nWe are currently investigating this and trying to gauge its exploitation severity and how it fits with our reward tiers.\n\nWe will get back to you soon!","automated_response":false,"created_at":"2016-01-25T10:21:08.486Z","updated_at":"2016-01-25T10:21:08.486Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":772430,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hello again!\n\nWe have decided to reward $500 for this vulnerability!\n\nIt does not seem something like something triggerable  in practice, mainly because of the huge memory requirement.\nHowever, smartlist are indeed heavily used in Tor and we should try to bulletproof them in any case.\n\nWe will start working on this fix soon!\n\nThanks for the second bug report!\n\nKeep them coming!","automated_response":false,"created_at":"2016-01-26T14:26:44.944Z","updated_at":"2016-01-26T14:26:44.944Z","actor":{"url":"/torproject","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Tor"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"torproject","collaborator":{"username":"guido","url":"/guido"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":773167,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!","automated_response":false,"created_at":"2016-01-26T22:01:13.099Z","updated_at":"2016-01-26T22:01:13.099Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":773947,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This was filed in our bug tracker as:\nhttps://trac.torproject.org/projects/tor/ticket/18162\n\nWill close this issue when a patch is merged.","automated_response":false,"created_at":"2016-01-27T15:18:36.420Z","updated_at":"2016-01-27T15:18:36.420Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":775345,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello Guido,\n\nwe have prepared a patch for this issue here:\nhttps://trac.torproject.org/projects/tor/ticket/18162#comment:5\n\nIf you could take a look and see if it's reasonable, it would be great.\n\nThanks!","automated_response":false,"created_at":"2016-01-28T11:48:02.478Z","updated_at":"2016-01-28T11:48:02.478Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":775460,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2016-01-28T13:51:25.173Z","updated_at":"2016-01-28T13:51:25.173Z","actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":798272,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"OK this was fixed here:\nhttps://gitweb.torproject.org/tor.git/commit/?id=ad95d64fece2c6d2eddffc8fa5178c3ffccc0cd7\nhttps://gitweb.torproject.org/tor.git/commit/?id=c2fd64846978290b0e7c7165d7658a5e704eee8f\n\nPlease let us know if the fix was not proper.\n\nThanks :)","automated_response":false,"created_at":"2016-02-15T13:05:45.140Z","updated_at":"2016-02-15T13:05:45.140Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"guido","url":"/guido"},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083665,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T09:34:51.450Z","updated_at":"2017-10-19T09:34:51.450Z","first_to_agree":true,"actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083745,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T10:16:15.543Z","updated_at":"2017-10-19T10:16:15.543Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2083746,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-10-19T10:16:15.588Z","updated_at":"2017-10-19T10:16:15.588Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}