{"id":1194606,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTk0NjA2","url":"https://hackerone.com/reports/1194606","title":"Virtual Data Room / Hide download on collabora is easy to bypass","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2021-05-12T18:27:06.034Z","submitted_at":"2021-05-12T18:27:06.135Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"rtod","url":"/rtod","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2021-32748"],"singular_disclosure_disabled":false,"disclosed_at":"2021-08-07T14:28:34.326Z","bug_reporter_agreed_on_going_public_at":"2021-07-08T14:28:23.814Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"So, let me start with saying I'm not sure if this is a security issue or if it is by design. The reason I'm reporting it here is since Nextcloud promotes this Virtual Data Room a lot.\n\nhttps://nextcloud.com/blog/nextcloud-announces-virtual-data-room-solution-for-ultimate-protection-of-data-during-sensitive-dealmaking/\nhttps://nextcloud.com/virtual-data-room/\n\nAnd let me just quote: \"configure Secure View ensure the users can still read and (when shared with editing rights) modify documents, while the documents are watermarked when on screen.\"\n\n\"With secure view, our online office solutions can be configured to open PDF files, images and text files, making these files available in a watermark-protected way, while downloads and other apps are disabled using File Access Control. This setup is useful when data has to be protected from leaking but still has to be made available for review, as in a virtual data room scenario.\"\n\nBoth of these claims are false. \n\nMinimal proof of concept.\n\n1. Setup Nextcloud with Collabora\n2. Setup sercure view \u0026 file access control to disallow the download of the files\n3. Share a document, lets say `vdr.odt` by public link and mark as hide download\n4. Copy the link\n\nNow the point here is that anybody you send the link will only see the watermarked file. Not being able to download or copy data. And of course making a picture of these things is useless as it shows the watermark.\n\n5. attacker opens their network tab in the developer tools\n6. attacker opens the link\n7. attacker filters on WOPISRC\n8. Attacker finds a link like\n\n```\nwss://collabora.server/https%3A%2F%2Fserver%2Findex.php%2Fapps%2Frichdocuments%2Fwopi%2Ffiles%2F1234_abcd%3Faccess_token%3efgh%26access_token_ttl%3D0/ws?WOPISrc=https%3A%2F%2Fserver%2Findex.php%2Fapps%2Frichdocuments%2Fwopi%2Ffiles%2F1234_abcd\u0026compat=/ws\n```\n\nAs far as I understand the WOPI spec this is us sending the collabora server the WOPI endpoint they have to call. Which in this case is\n\n`https://server/index.php/apps/richdocument/wopi/files/1234_abcd`\nThe `1234_abcd` seems to be the `fileid` and the `instance id`\n\nAnd the access token is also there in the url. In this case `efgh`.\n\nNow if an attacker just does the following curl command\n\n```\ncurl https://server/index.php/apps/richdocument/wopi/files/1234_abcd?access_token=efgh -o stolen.odt\n```\n\nYou will see that they have the unwatermarked version of the data. This is even easier than copying everything over or making photographs.\n\n## Impact\n\nYour Virtual Data Room is inherently broken. And the claims you make on your website are at best misleading.\nHowever as said I'm not sure if this may be intentional as the feature is called hide download in the UI.\n\nIn any case. Maybe a good idea would be to have a secret configured on both collabora and the Nextcloud host. Which gets send. So that in case of hide download a client that doesn't know the secret token can't download the file.\n\nI do not have access to a setup with Only Office. But I believe that to be vulnerable to a similar attack.","bounty_amount":"150.0","formatted_bounty":"$150","weakness":{"id":26,"name":"Improper Access Control - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2021-08-07T14:28:23.904Z","allow_singular_disclosure_after":-5612581.649328492,"singular_disclosure_allowed":true,"vote_count":11,"voters":["bl4de","h4x0r_dz","akashhamal0x01","cryptographer","prashantjadon","iamcoolcat","amgadesam77","thehostel","ion95in","userinput","and 1 more..."],"severity":{"rating":"high","score":7.7,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":68219,"asset_type":"SOURCE_CODE","asset_identifier":"nextcloud/richdocuments","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":11723697,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","automated_response":true,"created_at":"2021-05-12T18:27:07.398Z","updated_at":"2021-05-12T18:27:07.398Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11769200,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for your report.\nWe filled an internal ticket and will get back to you after our findings.","automated_response":false,"created_at":"2021-05-17T06:30:41.699Z","updated_at":"2021-05-17T06:30:41.699Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11775166,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2021-05-17T14:19:58.514Z","updated_at":"2021-05-17T14:19:58.514Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12223880,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Did you manage to verify my suggestion with Collabora?","automated_response":false,"created_at":"2021-06-23T18:24:49.354Z","updated_at":"2021-06-23T18:24:49.354Z","actor":{"username":"rtod","cleared":false,"url":"/rtod","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12272199,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We unfortunately don't have much updates to share here. I'll ask the product team for the next steps here.","automated_response":false,"created_at":"2021-06-28T13:44:14.046Z","updated_at":"2021-06-28T13:44:14.046Z","actor":{"username":"lukasreschkenc","cleared":false,"url":"/lukasreschkenc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12286428,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The product team is in talks with Collabora about adding some potential secret here. In the meantime, they are considering adding an IP check. (https://github.com/nextcloud/richdocuments/pull/1640)","automated_response":false,"created_at":"2021-06-29T13:20:24.501Z","updated_at":"2021-06-29T13:20:24.501Z","actor":{"username":"lukasreschkenc","cleared":false,"url":"/lukasreschkenc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12289136,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"FYI:\n\n\u003e For further enhancement Collabora suggested that we could make use of the proof key that would already be available instead of a static shared secret, so we could indeed use that to verify that only the configured Collabora instance can perform WOPI requests. https://wopi.readthedocs.io/en/latest/scenarios/proofkeys.html","automated_response":false,"created_at":"2021-06-29T15:41:18.964Z","updated_at":"2021-06-29T15:41:18.964Z","actor":{"username":"lukasreschkenc","cleared":false,"url":"/lukasreschkenc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12381693,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Draft advisory is at https://github.com/nextcloud/security-advisories/security/advisories/GHSA-24x8-h6m2-9jf2. This should be fixed with 3.8.3 and 4.2.0 by adding an additional IP allowlist feature.","automated_response":false,"created_at":"2021-07-07T09:12:15.524Z","updated_at":"2021-07-07T09:12:15.524Z","actor":{"username":"lukasreschkenc","cleared":false,"url":"/lukasreschkenc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"rtod","url":"/rtod"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12381729,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2021-07-07T09:13:07.594Z","updated_at":"2021-07-07T09:13:07.594Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"bounty_amount":"150.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"nextcloud","collaborator":{"username":"rtod","url":"/rtod"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12401836,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-07-08T14:28:23.849Z","updated_at":"2021-07-08T14:28:23.849Z","first_to_agree":true,"actor":{"username":"rtod","cleared":false,"url":"/rtod","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12453848,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","automated_response":false,"created_at":"2021-07-12T15:41:13.163Z","updated_at":"2021-07-12T15:41:13.163Z","cve_ids":["CVE-2021-32748"],"actor":{"username":"lukasreschkenc","cleared":false,"url":"/lukasreschkenc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12871899,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-08-07T14:28:34.383Z","updated_at":"2021-08-07T14:28:34.383Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}