{"id":158330,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNTgzMzA=","url":"https://hackerone.com/reports/158330","title":"Ability to access all user authentication tokens, leads to RCE","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2016-08-11T01:21:05.379Z","submitted_at":"2016-08-11T01:21:05.379Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-11-03T22:28:43.639Z","bug_reporter_agreed_on_going_public_at":"2016-11-03T22:28:43.590Z","team_member_agreed_on_going_public_at":"2016-11-03T00:40:07.793Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Vulnerability details\nThe project export feature serializes the user objects of team members and stores it in the `project.json` file. This object contains the `authentication_token` for every user, meaning that an attacker can simply go ahead and create a project on GitLab.com, add one of the admins of GitLab.com, create an export, and obtain the authentication token for that user.\n\n# Proof of concept\nFollow these steps to reproduce the issue:\n\n - create a test account on a GitLab instance and create a temporary repository\n - invite an admin of the GitLab instance as a team member to the repository\n - go to the repository settings and create an export\n - wait a few minutes until you received the export email\n - now go to http://gitlab-instance/account/repo/download_export\n - unzip the downloaded file and examine `projects.json` - the `project_members` will contain the user object that contains the `authentication_token`\n\nHere's the first few bytes of `rspeicher` (sorry Robert) his authentication token on GitLab.com: `ZyhqJr4XJZ...`. Someone could get access to GitLab's admin panel by extracting the token of an admin and go to https://gitlab.com/admin/users?authentication_token=\u003ctoken\u003e. From what I've seen on my own GitLab instance, this leads to RCE and gives me access to all code in private repositories. Let me know if you need more information!","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-12-03T00:40:07.831Z","allow_singular_disclosure_after":-153234412.5003451,"singular_disclosure_allowed":true,"vote_count":56,"voters":["lukasreschke","sameoldstory","jensec","derision","shubs","michiel","suv","troubleshooter","yaworsk","zombiehelp54","and 46 more..."],"severity":{"rating":"critical","score":9.9,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1118427,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The link in the report should be `https://gitlab.com/gitlab-org/gitlab-ce/issues?private_token=\u003ctoken\u003e`. Also, because the entire user object is serialized, the hashed password, OTP secrets, hashed backup codes, hashed confirmation tokens are all leaked into the response as well. I demonstrated the exploitability of the attack with the authentication token, because that one is stored without any form of hashing or encryption in the database.","automated_response":false,"created_at":"2016-08-11T01:31:05.012Z","updated_at":"2016-08-11T01:32:52.828Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1118531,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks @jobert, we're looking into it.","automated_response":false,"created_at":"2016-08-11T03:33:16.024Z","updated_at":"2016-08-11T03:33:16.024Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1118533,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"There seem to be a lot more issues with this feature. When importing, the repository gets restored based on the value of the `project.json` file. Besides the `project_members` array, which is deleted before the import is processed, its pretty trivial to link to other objects that belong to other repositories. Simply assign an array of IDs to, for example, `hooks` and run the import. This will \"claim\" the object IDs and give you access to them after the import is completed.\n\nAnother issue here is that the upload restore script actually copies files on disk. This means that if someone untars the export, adds an uploads directory, symlinks /etc/passwd in that directory, tars and uploads it, the attacker gets access to the contents of /etc/passwd (it can be accessed by making an export again after that). \n\nI thought about a fix for this problem, and albeit signing the contents of the file could be a solution, that's probably not what you want here. These export files are likely being used across multiple GitLab instances, making signing not an option (someone could just sign the file again, since the key pairs would be publicly available). To be fair, it seems that the direction that was taken with this export / import strategy warrants a revert of the feature, given the amount of (potential) issues that this introduces, but hey - who am I :)\n\nThanks, @rspeicher! Let me know if you need anything.","automated_response":false,"created_at":"2016-08-11T03:34:48.020Z","updated_at":"2016-08-11T03:34:48.020Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1118567,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We've disabled importing projects from GitLab exports on GitLab.com to mitigate part of this issue. We're looking into disabling the export routes temporarily until we can apply a proper fix.","automated_response":false,"created_at":"2016-08-11T04:02:01.574Z","updated_at":"2016-08-11T04:02:01.574Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1128027,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@jobert We've got a fix ready for the original information disclosure you reported and will have patches out in the next day or two.\n\nWe're continuing internal discussions about the security of the feature as a whole. James, who developed the feature, wasn't able to get a proof of concept working for the `/etc/passwd` example:\n\n\u003e I don't think this would work -  we are using `copy_entry` with `dereference_root` default's false  - http://apidock.com/ruby/FileUtils/copy_entry\n\u003e\n\u003e Also see my test - but definitely correct me if I'm wrong!\n\n```bash\n\u003e echo 'secret' \u003e /tmp/passwd\n\u003e chmod 777 /tmp/passwd #extra vulnerability that is needed.\n\u003e stat /tmp/passwd\n16777220 28528016 -rwxrwxrwx 1 James wheel 0 7 \"Aug 12 09:39:16 2016\" \"Aug 12 09:39:12 2016\" \"Aug 12 09:39:12 2016\" \"Aug 12 09:31:50 2016\" 4096 8 0 /tmp/passwd\n# Now, download an export file\n\u003e ls -t ~/Downloads/ | head -1\n2016-08-12_09-34-826_gitlab-org_gitlab-test_export.tar.gz\n\u003e tar -xzf ~/Downloads/2016-08-12_09-34-826_gitlab-org_gitlab-test_export.tar.gz -C /tmp/export\n\u003e cd /tmp/export/uploads\n# Create the symlink to /tmp/passwd\n\u003e ln -s /tmp/passwd ./passwd\n\u003e cd ../..\n\u003e tar -czf export.tar.gz -C ./export .\n\u003e tar -ztvf export.tar.gz\ndrwxr-xr-x James/wheel       0 2016-08-12 09:34 ./\n-rw-r--r-- James/wheel  318472 2016-08-12 09:34 ./project.bundle\n-rw-r--r-- James/wheel  144235 2016-08-12 09:34 ./project.json\n-rw-r--r-- James/wheel     346 2016-08-12 09:34 ./project.wiki.bundle\ndrwxr-xr-x James/wheel       0 2016-08-12 09:38 ./uploads/\ndrwxr-xr-x James/wheel       0 2016-08-12 09:34 ./uploads/8d5d0e7b3981edb77dc751d41e527302/\n-rw-r--r-- James/wheel     346 2016-08-12 09:34 ./uploads/8d5d0e7b3981edb77dc751d41e527302/project.wiki.bundle\ndrwxr-xr-x James/wheel       0 2016-08-12 09:34 ./uploads/8f32485f7e896b15c62886951b13744f/\n-rw-r--r-- James/wheel  340523 2016-08-12 09:34 ./uploads/8f32485f7e896b15c62886951b13744f/test_project_export.tar.gz\nlrwxr-xr-x James/wheel       0 2016-08-12 09:38 ./uploads/passwd -\u003e /tmp/passwd\n-rw-r--r-- James/wheel       5 2016-08-12 09:34 ./VERSION\n# Now, upload that export.tar.gz and export the new imported project\n\u003e ls -t ~/Downloads/ | head -1\n2016-08-12_09-45-747_root_test-uploads_export.tar.gz\n\u003e tar -tzvf ~/Downloads/2016-08-12_09-45-747_root_test-uploads_export.tar.gz\ndrwxr-xr-x James/staff       0 2016-08-12 09:45 ./\n-rw-r--r-- James/staff  317859 2016-08-12 09:45 ./project.bundle\n-rw-r--r-- James/staff  148058 2016-08-12 09:45 ./project.json\n-rw-r--r-- James/staff     346 2016-08-12 09:45 ./project.wiki.bundle\ndrwxr-xr-x James/staff       0 2016-08-12 09:45 ./uploads/\ndrwxr-xr-x James/staff       0 2016-08-12 09:45 ./uploads/8d5d0e7b3981edb77dc751d41e527302/\n-rw-r--r-- James/staff     346 2016-08-12 09:45 ./uploads/8d5d0e7b3981edb77dc751d41e527302/project.wiki.bundle\ndrwxr-xr-x James/staff       0 2016-08-12 09:45 ./uploads/8f32485f7e896b15c62886951b13744f/\n-rw-r--r-- James/staff  340523 2016-08-12 09:45 ./uploads/8f32485f7e896b15c62886951b13744f/test_project_export.tar.gz\nlrwxr-xr-x James/staff       0 2016-08-12 09:45 ./uploads/passwd -\u003e /tmp/passwd\n-rw-r--r-- James/staff       5 2016-08-12 09:45 ./VERSION\n```\n\n\u003e So it's a symlink and filesize is indeed 0: `0 2016-08-12 09:45 ./uploads/passwd -\u003e /tmp/passwd`\n","automated_response":false,"created_at":"2016-08-15T21:15:16.656Z","updated_at":"2016-08-15T21:15:16.656Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1171095,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @rspeicher, I haven't had time yet to dive into it (I have to set up a GitLab instance of an older version). What's the current state of the feature? Is there anything specific you want me to look at? Happy to provide some comments in a discussion that you might be having.","automated_response":false,"created_at":"2016-09-03T07:04:39.715Z","updated_at":"2016-09-03T07:04:39.715Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1268094,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @rspeicher, I looked at the import tonight and filed another report for the vulnerbility: #178152. The vulnerability turned out not to be in the `uploads` directory, but the `VERSION` and `project.json` files. The initially reported vulnerability seems to be fixed and can be closed. I'll request disclosure once #178152 is fixed. Thanks and let me know if you need anything.","automated_response":false,"created_at":"2016-10-26T05:52:54.242Z","updated_at":"2016-10-26T05:52:54.242Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1268095,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2016-10-26T05:53:30.491Z","updated_at":"2016-10-26T05:53:30.491Z","additional_data":{"old_severity":null,"new_severity":"Critical (9.9)","old_severity_id":null,"new_severity_id":4265},"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1268512,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"@jobert Excellent. Well, not really, but... yeah. Thanks! ♥️","automated_response":false,"created_at":"2016-10-26T12:16:16.809Z","updated_at":"2016-10-26T12:16:16.809Z","actor":{"username":"rspeicher","cleared":false,"url":"/rspeicher","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/070/800/771703800f32dcb0c5413919f04f19305041dd58_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1281496,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Our patch and security announcement have gone live!\n\nhttps://about.gitlab.com/2016/11/02/cve-2016-9086-patches/\n\nThanks so much, Jobert.","automated_response":false,"created_at":"2016-11-03T00:40:07.806Z","updated_at":"2016-11-03T00:40:07.806Z","first_to_agree":true,"actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1283526,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-11-03T22:28:43.608Z","updated_at":"2016-11-03T22:28:43.608Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1283527,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-11-03T22:28:43.654Z","updated_at":"2016-11-03T22:28:43.654Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}