{"id":179920,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNzk5MjA=","url":"https://hackerone.com/reports/179920","title":"WordPress DB Class, bad implementation of prepare method guides to sqli and information disclosure","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2016-11-03T13:32:17.535Z","submitted_at":"2016-11-03T13:32:17.535Z","is_member_of_team?":false,"reporter":{"disabled":true,"username":"b258ea62bf297b02afa9854","url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":55,"url":"https://hackerone.com/wordpress","handle":"wordpress","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"WordPress","twitter_handle":"wordpress","website":"https://wordpress.org/","about":"Beautiful sites of any kind."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-13T14:56:48.898Z","bug_reporter_agreed_on_going_public_at":"2017-10-14T14:56:45.530Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Issue 1: Method checks if first argument is an array and if it is, it avoids the rest of the arguments and uses the first argument array values as input.\n\nIssue 2: When input query has %s in it, then it quote and this guides to sql injection in case query that need to be prepared have quoted user controlled input in it.  \n\nThis leaves all wordpress plugins/ themes potentially vulnerable on this two types of attack. As PoC sqli in bbpress wp plugin and core wp function is shown.\n\nPoC: \n1. There is SQLi in bbpress in case anonymous posting is allowed. ( check  bbpress-sqli.png)\n2.  Demo for the Issue 1 and Issue 2 for the prepare method\n3. Wordpress core function delete_metadata is vulnerable to sqli in case delete all e.g. last argument is true and meta value has value e.g. is user supplied / controlled.","weakness":{"id":67,"name":"SQL Injection"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":132087,"file_name":"bbpress-sqli.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/132/087/2b5692ba30e2a51c3fa2d31a09f95ccd2785b935/bbpress-sqli.png?response-content-disposition=attachment%3B%20filename%3D%22bbpress-sqli.png%22%3B%20filename%2A%3DUTF-8%27%27bbpress-sqli.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=a7f8537c8bcec107e5f0781fdb9ef56a34c7a6497dd770dabb7888678c2fc6d8","file_size":17066,"type":"image/png"},{"id":132088,"file_name":"dh1.php","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/132/088/4c8580aebf8712978c479cb5618de2bbba6c9b21/dh1.php?response-content-disposition=attachment%3B%20filename%3D%22dh1.php%22%3B%20filename%2A%3DUTF-8%27%27dh1.php\u0026response-content-type=text%2Fx-php\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=84bf255764792047ea366f867952a584dc6a948c41ba2a762c9207d8e107faad","file_size":2224,"type":"text/x-php"}],"allow_singular_disclosure_at":"2017-11-13T14:56:45.627Z","allow_singular_disclosure_after":-123375445.61384602,"singular_disclosure_allowed":true,"vote_count":17,"voters":["jin","jokebookservice1","marcs0h","jensec","kuromatae","hunter","skansing","eveeez","firs0v","hassham","and 7 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1282292,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2016-11-03T13:35:26.632Z","updated_at":"2016-11-03T13:35:26.632Z","actor":{"username":"nikolayb","cleared":false,"url":"/nikolayb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/006/838/e07dd5308575ffd0d3b0f0650974a8482379734e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1284674,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"As another example there is working sqli into popular wordpress plugin nextgen gallery (https://wordpress.org/plugins/nextgen-gallery/). It has huge number of active installations and is vulnerable to sqli caused by this WP issue.  Detailed description as attachment.","automated_response":false,"created_at":"2016-11-04T16:37:02.122Z","updated_at":"2016-11-04T16:37:02.122Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":132913,"filename":"ngg-description-sqli.txt","type":"text/plain","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/132/913/cf5a74ffd1b4438762e60ef5c93208a7a0f6272f/ngg-description-sqli.txt?response-content-disposition=attachment%3B%20filename%3D%22ngg-description-sqli.txt%22%3B%20filename%2A%3DUTF-8%27%27ngg-description-sqli.txt\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=33a4f89306c965dcac4e7948b919acd7e819f26257b1babcc6085fac1ad37dd3"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1286735,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Another wordpress core method vulnerable to sqli is get_pages() function located in wp-includes/post.php . In case of attacker controls post_status variable then we have working sqli if it is passed as array and not sanitized as valid text for the input.","automated_response":false,"created_at":"2016-11-06T14:53:59.854Z","updated_at":"2016-11-06T14:53:59.854Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1291696,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey, @slavco, thanks for the added examples. I am attaching our preliminary patch here, it should fix the reported issue, but let us know if you find a case we’ve missed.\n\nWe’re still exploring the backwards compatibility implications, since few plugins actually use this functionality.","automated_response":false,"created_at":"2016-11-09T17:20:05.200Z","updated_at":"2016-11-09T17:20:05.200Z","actor":{"username":"nikolayb","cleared":false,"url":"/nikolayb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/006/838/e07dd5308575ffd0d3b0f0650974a8482379734e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":133676,"filename":"h1-179920.diff","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/133/676/42572733e98672ee7db5f7f808cac431794921ed/h1-179920.diff?response-content-disposition=attachment%3B%20filename%3D%22h1-179920.diff%22%3B%20filename%2A%3DUTF-8%27%27h1-179920.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=635eec743ee1e83b19d956bb7a7a4e7e86745a68c61e365fbedb9ca11084aa27"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1292459,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm afraid that given fix doesn't solve the issue. \n\nTry this:\n$str = $wpdb-\u003eprepare(\"select * from test where id = %s\", \"%2$%2$%s%ss\");\necho $wpdb-\u003eprepare($str, \" or 1=1#\", \"t\");\n\nwill result in:\n\nselect * from test where id = '%2$%2$' or 1=1#''t's' \n\nand this is valid sqli.\n","automated_response":false,"created_at":"2016-11-09T23:49:00.027Z","updated_at":"2016-11-09T23:49:00.027Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1293973,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e I'm afraid that given fix doesn't solve the issue.\n\nWhile technically correct, the poc against the patch isn't really valid - you're injecting a valid conversion specification (`%s`) **AND** providing the correct number of arguments when you call `$wpdb-\u003eprepare()` for the second time.\n\nIf this were real code, the second call to `$wpdb::prepare()` would trigger a PHP notice, via `_doing_it_wrong()`, for all valid values because there wouldn't normally be any conversions to take place.\n\n````\nwp\u003e $sql = $wpdb-\u003eprepare( 'SELECT * FROM test WHERE id = %s', 'foo' ); // no injection\n=\u003e string(38) \"SELECT * FROM test WHERE id = 'foo'\"\nwp\u003e $sql = $wpdb-\u003eprepare( $sql, 'bar' ); // _doing_it_wrong()\nPHP Notice:  wpdb::prepare was called \u003cstrong\u003eincorrectly\u003c/strong\u003e. The query argument of wpdb::prepare() must have a placeholder. Please see \u003ca href=\"https://codex.wordpress.org/Debugging_in_WordPress\"\u003eDebugging in WordPress\u003c/a\u003e for more information. (This message was added in version 3.9.0.) in ...\n=\u003e string(35) \"SELECT * FROM test WHERE id = 'foo'\"\n````\n\nIn a more realistic use-case, there would be additional placeholders added to the sql during the second call to `$wpdb-\u003eprepare()` - such as:\n\n````\nwp\u003e $sql = $wpdb-\u003eprepare( 'SELECT * FROM test WHERE id = %s', 'foo' ); // no injection\n=\u003e string(35) \"SELECT * FROM test WHERE id = 'foo'\"\nwp\u003e $sql = $wpdb-\u003eprepare( $sql . ' AND username = %s', 'bar' ); // everything works as expected\n=\u003e string(56) \"SELECT * FROM test WHERE id = 'foo' AND username = 'bar'\"\n````\n\nIf you were to try and inject an additional conversion specification, everything should fail due to the mismatched number of placeholders and values.\n\n````\nwp\u003e $sql = $wpdb-\u003eprepare( 'SELECT * FROM test WHERE id = %s', '%s' ); // placeholder injection\n=\u003e string(34) \"SELECT * FROM test WHERE id = '%s'\"\nwp\u003e $sql = $wpdb-\u003eprepare( $sql . ' AND username = %s', 'bar' ); // failed due to argument mismatch\n=\u003e bool(false)\n````","automated_response":false,"created_at":"2016-11-10T18:50:43.140Z","updated_at":"2016-11-10T18:50:43.140Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1294272,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It is valid because on the second call you need to have one more param not exactly the same. \nRegarding the calling -\u003eprepare for two times you know that there are real world examples that show the following:\n\n$sql = \"somestring where x='{$condition}' and x='strong' \";\n$wpdb-\u003eprepare($prequery.$sql,$arg1,$arg2,...) \n\nIs it valid now?","automated_response":false,"created_at":"2016-11-10T21:33:34.172Z","updated_at":"2016-11-10T21:33:34.172Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1294667,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Forgot to mention that another argument from my side why test case I propose is valid sqli and vulnerability that exists in the proposed patch is the moment where we state that this method could accept array as input, so there are a lot of cases where sqli will rise again.","automated_response":false,"created_at":"2016-11-11T07:31:51.940Z","updated_at":"2016-11-11T07:31:51.940Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1295087,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"To be much more precise via your examples:\n\n$var1 = user controlled variable\n\n$sql = $wpdb-\u003eprepare( 'SELECT * FROM test WHERE id = %s', $var1 ); //ofc no injection\n\nand here we go:\n\n$var2 = esc_sql($_POST[\"id\"]);\n\nhere in this case $_POST['id'] could be an array so we have the following: \n\n$sql = $wpdb-\u003eprepare( $sql . ' AND username = %s', $var2 ); // sqli by definition\n","automated_response":false,"created_at":"2016-11-11T13:34:59.873Z","updated_at":"2016-11-11T13:36:18.020Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1296768,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"From proposed fix I can get the direction from you guys how you want to solve the issue. There is always but and I think that the biggest threat in this bug isn't sprintf functionality with swapping arguments where was your focus, but instead is this line of code in the prepare method:\n\n$query = preg_replace( '|(?\u003c!%)%s|', \"'%s'\", $query ); // quote the strings, avoiding escaped strings like %%s\n\nThis functionality fails on %%%s e.g. won't add quotes and it is quite simple e.g. if you find %s add quotes and it doesn't checks if it causes sql injection e.g. breaks valid sql code. \nThat is why my latest example is valid and is real e.g. proposed fix doesn't protect for sql injection in every cases and there is no way to keep compatibility and to be sure that first parameter should be scalar or array ( this will solve my latest test case too ). This means we must focus on this line e.g. to provide smart method for adding quotes on %%%s or omitting %%%%s in this method.\n\nSee attachment fix.php, more precisely method checkquotes .\n\nTest samples:\n\necho $wpdb-\u003eprepare(\"test ' \\\\\\\\\\' %s ' %%%%%s opa %s third '%s' cool \", \"a1\",\"a2\",\"a3\",\"a4\").\"\\n\";\necho $wpdb-\u003eprepare(\"test ' \\'%s ' %%%%%%s opa %s third '%s' cool \", \"a1\",\"a2\",\"a3\").\"\\n\";\n\nOutput with fix you proposed:\n\ntest ' \\\\\\' 'a1' ' %%a2 opa 'a3' third 'a4' cool \ntest ' \\''a1' ' %%%s opa 'a2' third 'a3' cool \n\nOutput with new method for handling %s and its variants depending of the place in the query:\n\ntest ' \\\\\\' a1 ' %%'a2' opa 'a3' third 'a4' cool \ntest ' \\'a1 ' %%%s opa 'a2' third 'a3' cool  \n\nNow I think wp should be safe from tricking this method and causing sql injection.","automated_response":false,"created_at":"2016-11-13T02:54:59.388Z","updated_at":"2016-11-13T02:54:59.388Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":134410,"filename":"fix.php","type":"text/x-php","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/410/99c31a9cbc33fa6db2ad33dcbcf138e1dde87a33/fix.php?response-content-disposition=attachment%3B%20filename%3D%22fix.php%22%3B%20filename%2A%3DUTF-8%27%27fix.php\u0026response-content-type=text%2Fx-php\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=476ff8512c927dcff1416a116f37a9f4a5f010e1da6fc4e597411a3fb363b4ae"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1298941,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The changes made in `fix.php` introduce the following SQLi\n\n````\n$sql = $wpdb-\u003eprepare( \"SELECT * FROM test WHERE id = %s\", \"'%s\" );\n$sql = $wpdb-\u003eprepare( $sql . \" AND name = %s\", [ \"' OR 1=1 -- -\", \"ignored\" ] );\n\n// fix.php: SELECT * FROM test WHERE id = '\\\\' OR 1=1 -- - AND name = ignored\n//    core: SELECT * FROM test WHERE id = '\\'\\' OR 1=1 -- -' AND name = 'ignored'\n````","automated_response":false,"created_at":"2016-11-14T19:21:10.070Z","updated_at":"2016-11-14T19:21:10.070Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1299246,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"True, that lousy substr_count... Knew I should write my own function :) Will upload fix right now :)","automated_response":false,"created_at":"2016-11-14T21:14:15.488Z","updated_at":"2016-11-14T21:14:15.488Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299253,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Edit:\n###########\nAvoid this answer uploaded wrong file :)\n###########\nAs attachment fix e.g. substr_count is replaced with my own function. Didn't expect native php function to fail in substring counting but it is what it is. Fix as attachment and works even for this test case :)","automated_response":false,"created_at":"2016-11-14T21:18:23.997Z","updated_at":"2016-11-14T21:28:28.308Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":134734,"filename":"fix.php","type":"text/x-php","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/734/7379bc7cb59f290bf1091fe8ea21de061fe52caa/fix.php?response-content-disposition=attachment%3B%20filename%3D%22fix.php%22%3B%20filename%2A%3DUTF-8%27%27fix.php\u0026response-content-type=text%2Fx-php\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=e28829608e28689b5d75fb976e66aef5f67235f837bf8a9f59305c666c6254f9"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299292,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It isn't substr_count it is:\n\n$query = str_replace( \"'%s'\", '%s', $query ); // in case someone mistakenly already singlequoted it \n\nNow this line it is not needed anymore because function is aware for adding quotes now and we won't be in situation to add quotes twice.Checked twice and made mistake and I've blamed substr_count...\n\nNvm check attachment ","automated_response":false,"created_at":"2016-11-14T21:35:02.684Z","updated_at":"2016-11-14T21:35:02.684Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":134740,"filename":"fix.php","type":"text/x-php","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/740/6035fa8eec542559f8fd0994ba96180b96b705ca/fix.php?response-content-disposition=attachment%3B%20filename%3D%22fix.php%22%3B%20filename%2A%3DUTF-8%27%27fix.php\u0026response-content-type=text%2Fx-php\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=11669eae5e4e4ee01f3c83021dd70d6605a7db4c7dc123aa43fa4bbecd1b9496"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299368,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This version of `checkquotes` seems broken (wrt trailing single quotes breaking things).\n````\n$sql = $wpdb-\u003eprepare( 'SELECT * FROM test WHERE id = %s', 'foobar' );\necho $sql . PHP_EOL; // SELECT * FROM test WHERE id = 'foobar''\n\n$sql = $wpdb-\u003eprepare( $sql . ' AND name = %s', 'pewpewpew' );\necho $sql . PHP_EOL; // SELECT * FROM test WHERE id = 'foobar'' AND name = pewpewpew\n````","automated_response":false,"created_at":"2016-11-14T22:01:49.138Z","updated_at":"2016-11-14T22:01:49.138Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1299382,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yes made change in a \nif ( $lq === true \u0026\u0026 $i\u003c=$chunks_len-2){ \n\ninto (when I was checking the reason for the test cases you provide to me)\n\nif ( $lq === true \u0026\u0026 $i\u003c=$chunks_len-1){\n\nNow it is changed, check attachment :)\n","automated_response":false,"created_at":"2016-11-14T22:08:21.448Z","updated_at":"2016-11-14T22:08:21.448Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":134752,"filename":"fix.php","type":"text/x-php","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/752/6b5e0a14655bc5242e05e285802592ac7d422cca/fix.php?response-content-disposition=attachment%3B%20filename%3D%22fix.php%22%3B%20filename%2A%3DUTF-8%27%27fix.php\u0026response-content-type=text%2Fx-php\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ7H6NCLCA%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135411Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJHMEUCIBCjdoUai95GqoqRdZPvewVTGWTu7hW9M1xsEa2tnJ2wAiEApQcvVvkI%2BBsK0ecHviHNOIueIogzHcih4FNXbWCzeVkqgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF%2BSeVXC33iyV8QWeSrXA1ssE%2FEGIWSZ%2FuRCd4oXxa0L1Lxp%2FgZ3zVMnFb3xAeki0kryhhssKmftZAynWR2Q1zaBR53gjdraq6wRyIKeaN10nGH%2BCzjURsH34KRC1TOwts5MYcloS6LERgqr1SpV%2B%2FyQzDTgT2kS7g6IE%2FPeoepcFFJMxl5IvtRGcabRXuEPLRYcxt7w6jKNei1awCDyq1irj02Z42QRBSTvkYgIOHYNLMFYX3E%2F0tFI1gV2NfcCmFszpeFyasntII3Gyw3H1an6BrUGChcOYIfu%2F1WTbUdNI%2Fpjmr10lpa6XlUtxFI9c0eKAVGXcoQ3EJHRTPyWcd6Gnq4TSlpHL0D54jaEQGHBDeDUxeA6DotTHBbroOpxOoq6S1nhZ0OMb3p%2BjXCBVueAHtDFqN%2Bnjx3qwjEEfRqnOUZVwu2AW7uQZCfC2vw4kynhx1t%2FbtkiC5KthO6jIzK1h%2FjH9uqYT0bwnLaiuJs7%2Fa0R8E%2FhplfGIzFmI%2BPPnknXwAmmWU9Xa%2Bm189leh9xBp6nNN7ufioFPFK77gl8s%2FXWhnHHRwfkQk2D0unemyL2YGJyVofMRhz7FlOLdoDcPt%2FVEvFBOEQOr5BaJlpQMGIbhI0gXAmjbeZwS3uck7lnUXN7N%2BDCB7ZCLBjqlASAOgKdryIO2D5AU3ejK49G6vrtKAglCcTf7cFkw0ROVtRedKGY3KUk5E3StqVBKZSdhowAIQjfqwiAkemJwzUJGbeun1p67EPamOv2EPpEqY6R88tB4ybHuSsWOJiykQnbihgfjANmR19lVcpFUZpvB6v00p8I6H%2F%2FUOjnFdoCXZkBX1hdc0Cr9U5xZqBbFVM8Hds5wc%2BboAR7bu67Z%2Fvqp9K%2BbZg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=0a935918341c135cd7a38743844ac4459f5321f1cc9f593ddda5bee2278a13a9"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299566,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I would like to add opinion regarding proposed solution from your side and code/method I sent as extra for it. This solution where %1$s are escaped ( for sprintf ) could lead into bugs in some of the plugins out there. There are plugins that use this functionality when preparing queries... \nAnyway I think that after query is prepared there should not be place for %s, %1#s, ... in it e.g. any form of valid sprintf type specifier. \nAll of this data should be replaced/removed/cleaned from the query.","automated_response":false,"created_at":"2016-11-15T00:00:22.452Z","updated_at":"2016-11-15T00:00:22.452Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1338550,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Bump, what is the status of the current issue? When will be fixed and why it takes too long. It is obvious that removing content from final query isn't good for security (based on current design in wordpress core), but your patch combined with smart quotes provided by me is almost ideal solution.","automated_response":false,"created_at":"2016-12-03T14:13:25.874Z","updated_at":"2016-12-03T14:13:25.874Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1338569,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey, slavco,\n\nWe’re still looking at the best approach, and we’d like some more time to test with some of the bigger plugins – from experience we’ve seen a lot of weird uses of queries and `prepare` there and we don’t want to break millions of websites. But yes, currently the initial patch with your quotes fixes seems the prevailing approach.\n\nNikolay.","automated_response":false,"created_at":"2016-12-03T14:47:33.307Z","updated_at":"2016-12-03T14:47:33.307Z","actor":{"username":"nikolayb","cleared":false,"url":"/nikolayb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/006/838/e07dd5308575ffd0d3b0f0650974a8482379734e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1338574,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm glad there is progress with this one.  :)","automated_response":false,"created_at":"2016-12-03T14:54:19.122Z","updated_at":"2016-12-03T14:54:19.122Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1449647,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\nI apologize for our unresponsiveness. We've had a long and somewhat rough transition to HackerOne. That should not be a valid excuse for not keeping up communication though. I'm adding your report to a list that I will be bringing up with the rest of the team over the next week. I'm also reaching out to our plugin team to see if we can tell if there are any existing uses of `wpdb::prepare()` that might be unexpected broken by this. As @nikolayb said, \"from experience we've seen a lot of weird uses of queries and `prepare`\".\n\nSorry again and thank you for your continued patience,\nAaron","automated_response":false,"created_at":"2017-01-28T17:21:45.856Z","updated_at":"2017-01-28T17:21:45.856Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1648507,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003c?php\n// Silence is golden.","automated_response":false,"created_at":"2017-05-02T10:48:42.464Z","updated_at":"2017-05-02T10:48:42.464Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1649119,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\n\nI know this has been a very slow moving issue and I apologize for that. Breaking changes to such widely used functions have historically been extremely troublesome, so we try to be especially careful and thoughtful about our approaches. We've run some of the potential solutions past a set of plugin authors and have been discussing it internally as well. We'll try to get back to you soon with more information based on the feedback we've received.","automated_response":false,"created_at":"2017-05-02T15:30:41.052Z","updated_at":"2017-05-02T15:30:41.052Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1707154,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"If possible to tell me the release time/period because I want to craft one security related tool :)","automated_response":false,"created_at":"2017-05-29T10:55:59.020Z","updated_at":"2017-05-29T10:55:59.020Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1794330,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ding dong :)))","automated_response":false,"created_at":"2017-06-30T14:59:14.378Z","updated_at":"2017-06-30T14:59:14.378Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1933292,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nIssue was reported 10 months ago more than enough time to patch anything / anywhere so I'll consider this report more than responsible. I'll be releasing a white paper regarding this issue on 22nd - 24th August 2017, so you have more than enough time to push the patch.","automated_response":false,"created_at":"2017-08-16T12:45:20.336Z","updated_at":"2017-08-16T12:45:20.336Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1936445,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\nThe person handling this ( @vortfu ) has been out on leave for the last couple months and isn't due back in until early next month. I apologize that communication slipped through the cracks. I'd like to get this into a release in the near future, but:\n\n1) We won't have a release before August 22\n2) I'd prefer to let the person that's been working with this all along continue to shepherd it into the release, so I'd like to wait until he gets back.\n\nI know it's already been a long time, but would it be possible to delay the white paper for a month?\n\nThanks,\nAaron","automated_response":false,"created_at":"2017-08-17T15:26:40.519Z","updated_at":"2017-08-17T15:26:40.519Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2009996,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @slavco,\n\nAs you'll have noticed, 4.8.2 was released yesterday with a fix for this issue. We'll arrange for a bounty payment shortly and close this report as fixed. Thanks again for your valuable report.\n\nIn the meantime, we noticed that you commented on your blog post stating that the fix in 4.8.2 is incomplete. Are you able to share some more information with us please? If you'd like to open another report on H1 please feel free. We're happy to award points and bounties to you for your responsible disclosure and co-operation.","automated_response":false,"created_at":"2017-09-20T21:11:04.058Z","updated_at":"2017-09-20T21:11:04.058Z","actor":{"username":"johnbillion","cleared":false,"url":"/johnbillion","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/083/8a397390a09844d8b0657ea57e4203abd852bb2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2010013,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-09-20T21:18:20.302Z","updated_at":"2017-09-20T21:18:20.302Z","actor":{"username":"johnbillion","cleared":false,"url":"/johnbillion","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/083/8a397390a09844d8b0657ea57e4203abd852bb2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"b258ea62bf297b02afa9854","url":"/b258ea62bf297b02afa9854"},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2058990,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\n\nI was going through and getting bounties assigned for all tickets that were missing it, and I see that I neglected to comment here before. I wanted to make sure that I made it clear why no bounty was being paid for this one. We know that fixing this issue took a long time, but public disclosure before it is granted here (which is only after the issue has been fixed and shipped) makes a report ineligible for bounty.\n\nThanks,\nAaron","automated_response":false,"created_at":"2017-10-11T14:58:49.381Z","updated_at":"2017-10-11T14:58:49.381Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2059911,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yo @aaroncampbell \n\nFrom the day one I wasn't expecting nothing except fix for this issue (isn't delivered) and that is why I have reported to security@wordpress.org, it was your wish this issue to be moved here. Please check with @johnbillion too ^^ he says something else, but who the fuck is he to tell something here.  \n\u003eAs you'll have noticed, 4.8.2 was released yesterday with a fix for this issue. We'll arrange for a bounty payment shortly and close this report as fixed. Thanks again for your valuable report.\n\nAccording me that is more than normal behavior for the Wordpress  security or what ever team. \n\nThis security issue/report brings the biggest bounty for me. Beside acknowledgment from infosec community I have learned why Wordpress is the worst open source project from security aspect and making this report public (yes will be public 100%) the audience will learn it too. It will learn to never trust the [fake news] (https://wordpress.org/news/category/security/) section on wordpress.org that is under your control. Will learn that any minor \"bigfix\" update could holds scary security fix. Will learn that some of the plugin authors are not equal with the another ones. Will learn that you care only if persons with huge number of followers rant against you and isn't important normal approach from regular users who believe in responsible disclosure (please learn what it means). This knowledge will be crucial for the developers out there to stay safe while they migrate towards another open source solution that will fit towards their needs and will care for the security of its users.  \n\np.s. It was pleasure to see how `types` plugin was removed from the repository and `bbpress` was there not patched to the same end...\n\np.s. Security researchers will learn that reporting vulnerabilities towards Wordpress security team on hackerone is nothing but wasting time and hackerone maybe will notice abusing their service from your side.\n\nFuck off,\nSlavco","automated_response":false,"created_at":"2017-10-11T20:45:59.166Z","updated_at":"2017-10-11T20:56:12.993Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2060514,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Slavco,\n\nThe bbPress issue you brought up here was fixed in June via a separate bbPress-specific HackerOne report.\nPlease accept my personal apologies for not including that info for you here.\n\nWarmest regards,\n-JJJ","automated_response":false,"created_at":"2017-10-12T01:19:02.619Z","updated_at":"2017-10-12T01:19:02.619Z","actor":{"username":"jjj","cleared":false,"url":"/jjj","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/063/b21324cc7d9861888c1ddd4fa345cda6612361ff_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2060842,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi jjj,\n\nStrange, I was watching the [development changelog] (https://wordpress.org/plugins/bbpress/#developers) in the past, but I didn't notice update neither saw removal from Wordpress plugin directory listing. Maybe update was silent, m? o_O \n\nHottest regards,\n-Slavco ","automated_response":false,"created_at":"2017-10-12T06:52:44.823Z","updated_at":"2017-10-12T07:00:53.108Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2066040,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-14T14:56:45.567Z","updated_at":"2017-10-14T14:56:45.567Z","first_to_agree":true,"actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2069259,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"Just cleaning this up, please see [previous comment for explanation](https://hackerone.com/reports/179920#activity-2058990)","automated_response":false,"created_at":"2017-10-16T15:14:15.969Z","updated_at":"2017-10-16T15:14:15.969Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"WordPress"}},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2120446,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Congrats for the new security release for the patch for this patch, you just introduced new feature towards wp.\nRecommended memory usage for the Wordpress gets new formula: \n`memory_limit` \u003e= `post_max_size * 66 * 3`\n\nCongrats again,\nSlavco ","automated_response":false,"created_at":"2017-11-01T10:17:24.627Z","updated_at":"2017-11-01T10:17:24.627Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2131119,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Report will be disclosed in 10 days according counter. You understand the implications of latest 4.8.3 patch right? \n\nBeside not fixed `$wpdb-\u003eprepare(\"%1$%s\",\"grr\")` and easy out of memory for any wp instance, now there is something else:\n \n`code where variable is esc_sql-ed`\n...\n`code where wp-load.php is included/required again`\n...\n`salute extra data in the variable that won't be removed by -\u003equery`\n\nFew existing attacks made easy... :(  8.4.3 patch is probably worst in the wp history.\n\nStay safe,\nSlavco","automated_response":false,"created_at":"2017-11-03T11:02:18.229Z","updated_at":"2017-11-03T11:02:18.229Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133104,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\n\nThanks for your continued concern and for the additional information.\n\n## Query Issue\n\nIn the case of `$wpdb-\u003eprepare( \"%1$%s\", \"grr\" )`, `%1$%s` isn't a valid placeholder. This means that during regular (expected) usage, the query would be broken and a developer would fix it. If a developer is putting something directly into the query part of a `wpdb::prepare` call, they could also just do `$wpdb-\u003eprepare( \"grr' ...\", ... )`. What we were attempting to protect against in 4.8.3 with regard to this, was developers that were using common practices that they *expected* (likely reasonably so) to be secure but they weren't. This included user-controlled data going into the query part of a `wpdb::prepare()` call only **after** having gone through `esc_sql()` or another `wpdb::prepare()` which the developer thought was protecting them.\n\nI also scanned the WordPress.org plugin directory and am not seeing any matches for `%[1-9][0-9]*\\$%s`. Can you point to the plugins you are saying are vulnerable? (Ref: https://twitter.com/mslavco/status/925686658779009025)\n\n## Memory\n\nI had a couple people on our team compare memory usage of 4.8.2 and 4.8.3. We're seeing results like this:\n\n| 4.8.2    | 4.8.3    | Diff     |\n|----------|----------|----------|\n| 14495632 | 14511272 | 15640    |\n| 20143104 | 20156416 | 13312    |\n\nThere is an increase, but it's fairly negligible. Only about 10-20k on an average page load, which doesn't seem like it justifies an adjustment to the memory limit. Hosts don't seem to be noticing any issues related to this either, at least not the ones that I've spoken to so far. Can you tell me what kind of setup you're testing on and what numbers you're seeing?\n\n## Something Else\n\nI'm not sure I'm tracking with the new things you mentioned:\n\n\u003e `code where variable is esc_sql-ed`\n...\n`code where wp-load.php is included/required again`\n...\n`salute extra data in the variable that won't be removed by -\u003equery`\n\nCould you expand on these or supply a PoC to help us understand what you mean?\n\nThanks,\nAaron","automated_response":false,"created_at":"2017-11-03T20:33:05.297Z","updated_at":"2017-11-03T20:33:05.297Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2133368,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"No need to search for the `%1$%s` you need to search for example you should search for code like this:\n`$not_in = \"'\" . implode( \"', '\", esc_sql( $_POST['exclude'] ) ) . \"'\";` - yes direct request in wp is sqli save. But also you can search for code like this:\n`if (!self::getDB()-\u003equeryWrite(sprintf(\"insert ignore into \" . self::table() . \" (name, val, autoload) values (%%s, X'%s', 'no')\", $dataChunk), $chunkedValueKey . $chunks))` - part of wordfence code and only because of `hex2bin` there isn't sqli towards wp `4.8.3`. Now if places like this exists :) then the payload would be more than simple e.g. you can play with the directives in order to get something like the following format string:\n`$wpdb-\u003e(\"%1$%s%2$%s%2$%s %s %s\", $input['one'], $input['two'])` - input one if it is user controlled then just set it on `'' - empty value` and choose your sqli payload in `$input['two']` - I think I was clear regarding this case.\n\nCase for memory usage (short: you replace `%` into 66 characters and you hold it in memory for some time):\n```\n((wp_posts.post_title LIKE '{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}slavco{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}') OR (wp_posts.post_excerpt LIKE '{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}slavco{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}') OR (wp_posts.post_content LIKE '{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}slavco{5944533a7bbf0e39b0751657f6618c4003a77dc4d2a15581d17deef104a124a8}'))\n```\nthis is output of the prepare when you search something in wp - this case I search for `slavco`. This means that the attacker could stop execution of the PHP script at the place he want if he controls the user input and if PHP setting for memory usage e.g. memory_limit is lower than `66 * max_post_size` - 66 is output of hash_hmac + `{}` and I say `max_post_size` because if 10MB it is, then PHP memory must be bigger than 66*post_max_size in order to stop payload holding a lot of `%` in it. Good for the test of the memory usage for wp you conducted, but you  can try it with more `%` when you post comments for instance - yes you just turned wp in web goat for beginners to practice DOS attacks on it.\n\nRegarding the third concern it is the biggest of all, but this time I'll leave towards all of you to trust me e.g. I won't show any attack vector atm.\n\n","automated_response":false,"created_at":"2017-11-03T21:58:42.775Z","updated_at":"2017-11-03T21:58:42.775Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133416,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"`$not_in = \"'\" . implode( \"', '\", esc_sql( $_POST['exclude'] ) ) . \"'\";` - need to be without `esc_sql` in it. by default wp is sqli proof and there are many plugins that add `$_POST['var']` in the query \n`$wpdb-\u003equery(\"bla '\".$_POST['var'].\"'\");` - no sqli in wp","automated_response":false,"created_at":"2017-11-03T22:13:51.244Z","updated_at":"2017-11-03T22:13:51.244Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133423,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"^^ `hex2bin` need to be `bin2hex` too ","automated_response":false,"created_at":"2017-11-03T22:15:07.779Z","updated_at":"2017-11-03T22:15:07.779Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133465,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"These are in WordFence? Have you reported it to them? https://www.wordfence.com/security/","automated_response":false,"created_at":"2017-11-03T22:26:17.575Z","updated_at":"2017-11-03T22:26:17.575Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2133470,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Nothing scary, it is hex encoded data, as extra they use $wpdb only in case mysqli isn't avaliable on the server... NVM, this is just sample there are many many places where user input is put in the $query and then $query is used in `-\u003eprepare`. I can't believe after a year I'm talking this again, but it is my fault I don't have many followers to be able to rant like a man :D","automated_response":false,"created_at":"2017-11-03T22:29:11.903Z","updated_at":"2017-11-03T22:29:11.903Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133569,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"In one of my code bases just found a plugin that is (90% just followed the function calls) vulnerable to sqli caused by this patch ( wasn't with previous patch ). Core problem here isn't just numbered placeholders, but also input into format string and functionality of PHP sprintf. Yes with the latest patch something was done, but `%[NUMBER]$%s` is allowed in it and combined with quoting there is trouble e.g. sqli, basically for some cases you rolled back wordpress to not patched version `4.8.1`. Regarding memory usage and new \"features\" introduced with replacement of `%` that is another story that opens wide doors for different types of attack and it is a quite unbelievable for me. \nThere are two ways for complete backward compatible fix for wp regarding this issue with price not to introduce new issues like now. First half of the solution is delivered by me as idea for the patch and the rest of it is simple vsprintf functionality written in php that will be sprintf by the \"book\" without hidden gems of it (`c`, `O`, `l`, ... could be completely dismissed then ). Another one is much more simple and require no coding at all - just big note in the documentation and warning against community to not place in the query-format string any user input except constants in the form of allowed format directives. That is it, there is no another way. ","automated_response":false,"created_at":"2017-11-03T23:21:44.881Z","updated_at":"2017-11-03T23:21:44.881Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133778,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @slavco,\n\nIt is true that non-escaped data going directly into either `wpdb::query()` or the query (first) parameter in `wpdb::prepare()` is generally unsafe and could be vulnerable to SQLi. Documentation around this, as you pointed out, is a must. I'll try to make sure what we document this where we can.\n\nIf you have a list of specific plugins that are are doing this, we could bring these cases directly to the developers and help them fix and secure their plugins. It would be extremely helpful.\n\nThanks,\nAaron","automated_response":false,"created_at":"2017-11-04T04:58:23.152Z","updated_at":"2017-11-04T04:58:23.152Z","actor":{"username":"aaroncampbell","cleared":false,"url":"/aaroncampbell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/020/821/f7e6872e5cd77bbdfb5edb77e7b9b2c91bb6c0c7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2133940,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"- Fixing current  issues won't prevent future failures in plugins, themes, cron scripts in the future... You should keep in mind that wp code base is PHP code and also you know that there are cases where people are using `mysqli_real_escape_string` into `array_map`, implement their own `esc_sql` functions like, use/parse output from mysql dumps in order to restructure/restore data, ... yes there are many use cases that are vulnerable towards SQLi re-introduced in `4.8.3` - but not in `4.8.2` for instance.\n- memory usage beside dos-ing the server php module could stop php execution at certain point (if accepts user input towards operation that includes `prepare`) that could lead towards broken authentications/authorizations or bypassing some flows...\n-told you there is 3rd case but I'm not going to disclose anything regarding it atm :)\n\n","automated_response":false,"created_at":"2017-11-04T08:17:08.735Z","updated_at":"2017-11-04T08:17:30.236Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2136980,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"And there are live traces of the 3rd case e.g. the new feature https://wordpress.org/support/topic/bug-with-character-in-woocommerce-product-name/ this is not functional bug, but it is security bug because it leads towards `unserialize` of the attacker/user payload. There are case scenarios that work in both directions - defeat `maybe_serialize` and defeat `maybe_unserialize`. Yup, core is now opened towards `unserialize` of user payload - few scenarios and as extra escalates limited security vulnerability as LFI towards possible RCE on wp. ","automated_response":false,"created_at":"2017-11-06T14:07:01.145Z","updated_at":"2017-11-06T14:07:01.145Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2136997,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"```\n$value = wc_clean($_POST[\"name\"]);\n...\n$value = esc_sql($value);\n//used here in some insert / update query and on success used as meta\n...\nupdate_metadata('post', $_id, $key, $value );\n```\nIs this code safe, why isn't and why are there production codes with same approach? :)","automated_response":false,"created_at":"2017-11-06T14:16:46.040Z","updated_at":"2017-11-06T14:16:46.040Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2138082,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Somebody reads here, you have opened wp for `unserialize` of user input. Many plugins perform `esc_sql` on some value -\u003e then `serialize` -\u003e then `-\u003equery`. We all know that `-\u003equery` removes the `{64charfeature}`, but string is already `serialized` =\u003e we can craft our payload so when `{64charfeature}` occurrences removed, some another serialized string property will become part of serialized object/array - boom RCE :)","automated_response":false,"created_at":"2017-11-06T20:07:36.629Z","updated_at":"2017-11-06T20:07:36.629Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2139773,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"In my last comment regarding solution (11 months ago) ^^ I have warned, but here we are. \nAgain, sorry that I do not have huge number of followers on social media, so my guides could be considered as valid. :( \n\n```\n... It is obvious that removing content from final query isn't good for security (based on current design in wordpress core)...\n```\n","automated_response":false,"created_at":"2017-11-07T10:19:51.230Z","updated_at":"2017-11-07T10:19:51.230Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2154083,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-11-13T14:56:49.388Z","updated_at":"2017-11-13T14:56:49.388Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"WordPress"}},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}