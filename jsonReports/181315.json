{"id":181315,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODEzMTU=","url":"https://hackerone.com/reports/181315","title":"Not using Binary::safe* functions for substr/strlen function","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-11-10T12:50:45.937Z","submitted_at":"2016-11-10T12:50:45.937Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"e3amn2l","url":"/e3amn2l","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8539,"url":"https://hackerone.com/paragonie","handle":"paragonie","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/008/539/72f76fed45e5220b47ba2f679371ebf9ccb19c70_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/539/72f76fed45e5220b47ba2f679371ebf9ccb19c70_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Paragon Initiative Enterprises","twitter_handle":"ParagonIE","website":"https://github.com/paragonie","about":"Cryptography and Application Security Consultants - We Produce Various Open Source Libraries"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-11-13T00:43:30.432Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2016-11-13T00:35:51.452Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Several places in the code don't use Binary::safe* or CryptoUtil::safe* functions, but use raw functions instead (strlen/substr) which can act as mb_funcname instead (not count bytes for strlen/etc...)\n\n1\\. https://github.com/paragonie/airship/blob/4be7ac0f16b1744255a876a38dbe13fb1c09731a/src/Engine/Security/CSRF.php#L87\n```\n            $lockTo = substr($lockTo, 0, strlen($lockTo) - 1);\n```\n\n2\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/Engine/Security/Util.php#L98\ncan be changed to use self::subString which use  Binary::safeSubstr\n```\n                        \\substr($mimeType, $p),\n```\n\n3\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/audit_helper.php#L30\n```\n    if (\\substr($print, 0, 3) === 'tmp' || \\substr($print, 0, 5) === 'files') {\n```\n\n4\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/tools/hangar/src/SessionCommand.php#L23-L24\n```\n            $x = \\strlen($this-\u003esession['dir']);\n            return \\substr($current, $x + 1);\n```\n\n5\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/tools/hangar/src/SessionCommand.php#L46-L47\n```\n            $x = \\strlen($this-\u003esession['dir']);\n            return \\substr($file, $x + 1);\n```\n\n6\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/random_audit.php#L28\n```\necho \\substr($fileList[$choice], $l), \"\\n\";\n```\n\n7\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/CommandLine/installer.php#L39\n8\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/CommandLine/manual_update.php#L40\n9\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/symlinks.php#L48\n10\\. https://github.com/paragonie/airship/blob/4aa579c564383355ad3de111a746f14a07164dba/src/config/logger.php#L28\n11\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Add.php#L62\n12\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Add.php#L62\n13\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/hangar.php#L68\n14\\. https://github.com/paragonie/airship/blob/7bb8d24487e127b2210ac7f1153df8153208c3b9/tools/hangar/src/Command.php#L168\n\n\nstrlen usage:\n\n1\\. https://github.com/paragonie/airship/blob/ef2d4f725e5af2eae27fd919533d01b625d020b1/src/Cabin/Hull/Blueprint/Blog.php#L1080\n2\\. https://github.com/paragonie/airship/blob/ef2d4f725e5af2eae27fd919533d01b625d020b1/src/Cabin/Hull/Blueprint/Blog.php#L1098\n3\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/Cabin/Hull/Landing/IndexPage.php#L43\n4\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Help.php#L100\n5\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Add.php#L60\n6\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/Cabin/Hull/Landing/BlogPosts.php#L85\n7\\. https://github.com/paragonie/airship/blob/58f96aa0e5002b60e74456502d9bfc9483d77b3d/src/Cabin/Hull/Landing/BlogPosts.php#L147\n8\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Autorun.php#L61\n9\\. https://github.com/paragonie/airship/blob/0e9289553cdc538556d362faaee63be6cc534a0c/tools/hangar/src/Commands/Autorun.php#L81\n10\\. https://github.com/paragonie/airship/blob/4aa579c564383355ad3de111a746f14a07164dba/src/config/logger.php#L26\n11\\. https://github.com/paragonie/halite/blob/8980974467cd54c6d2bb4dd98b2f0e9838570549/autoload.php#L13\n\n\nfix:\n1. change strlen usage to CryptoUtil::safeStrlen or Util::safeStrlen or Binary::safeStrlen or Util::stringLength across the codebase.\n2. change substr usage to Util::safeSubstr or CryptoUtil::safeSubstr or Binary::safeSubstr across the codebase.","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-12-13T00:35:51.481Z","allow_singular_disclosure_after":-152371130.18732512,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1293275,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for looking through the code. For stuff like this, where there is no security risk (except maybe in extreme corner cases that require extreme creativity to imagine), would you feel comfortable creating a Github issue instead of opening a HackerOne report?","automated_response":false,"created_at":"2016-11-10T14:03:10.249Z","updated_at":"2016-11-10T14:03:10.249Z","actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1293305,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I do open issues that not related to security vulns/risk in any way in Github (from emanuelb)\nin this case I didn't looked in detail for every use-case usage (thus there might be a security risk for some cases, still it's better to fix across the code base (even the non vulnerable code))\nSecurity related issues I prefer to report privately (HackerOne report / email).\nUnfortunately Github don't support private reports (security reports) and all issues reported through it will be public.","automated_response":false,"created_at":"2016-11-10T14:18:26.856Z","updated_at":"2016-11-10T14:20:46.938Z","actor":{"username":"e3amn2l","cleared":false,"url":"/e3amn2l","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1293316,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Oh, I see.\n\nIn this case, I'm sure there's no danger of `strlen()` or `substr()`. The `Util` functions are meant to provide correctness even with `mbstring.func_overload` enabled. The \"safe\" here isn't about security, rather than a \"you can safely use these functions even in a dangerous configuration setting and get the results you expect\".\n\nSince we're not polyfilling `hash_equals()`, there really aren't many places where an incorrect result could be security critical. See https://github.com/facebook/php-graph-sdk/pull/552#issuecomment-182123879 for one specific scenario.","automated_response":false,"created_at":"2016-11-10T14:23:21.703Z","updated_at":"2016-11-10T14:23:59.457Z","actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1293342,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yeah, I am aware of the mbstring.func_overload mechanism (thanks to reading your comment several months ago :) ), I found other places (not hash_equals related) in other PHP FLOSS projects where incorrect result is security critical, for example which result in following change:\nhttps://github.com/phpmyadmin/phpmyadmin/pull/12616\nthat will refuse to work if mbstring.func_overload enabled, you can do the same for airship (or other projects, but not for libraries (code that other users will reuse))\ncan't share yet the vulnerable place as it's still not patched (above pull request is only in master, next release wasn't released yet)\nregarding paragoinie projects I barely familiar with the code yet (started read it recently) and didn't checked usages, thus can't say for sure (checking = time that will better served for looking into other issues)","automated_response":false,"created_at":"2016-11-10T14:44:11.121Z","updated_at":"2016-11-10T14:44:11.121Z","actor":{"username":"e3amn2l","cleared":false,"url":"/e3amn2l","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1296691,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e didn't checked usages, thus can't say for sure (checking = time that will better served for looking into other issues)\n\nIndeed. :)\n\nThank you for taking the time to look at all of our code.","automated_response":false,"created_at":"2016-11-12T23:43:11.461Z","updated_at":"2016-11-12T23:43:11.461Z","actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1296705,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"The fix for this will be rolled out in 1.4.1.\n\n* https://github.com/paragonie/airship/commit/0344b08f02aab09d49d4db1ed3f6814cc3d9eccc\n* https://github.com/paragonie/airship/commit/eb4293aee5be59e329015520de7e0e44c3593ee6","automated_response":false,"created_at":"2016-11-13T00:28:13.278Z","updated_at":"2016-11-13T00:28:13.278Z","actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"e3amn2l","url":"/e3amn2l"},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1296715,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-11-13T00:35:51.467Z","updated_at":"2016-11-13T00:35:51.467Z","first_to_agree":true,"actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1296724,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","automated_response":false,"created_at":"2016-11-13T00:43:30.403Z","updated_at":"2016-11-13T00:43:30.403Z","actor":{"username":"paragonie-scott","cleared":false,"url":"/paragonie-scott","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/441/089de22b2f1b80a1e57a2792318dede5cbad81db_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1322058,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"for anyone who read my previous comments (as this report is public), regarding the security issue in PHPMyAdmin that exists when mbstring.func_overload is enabled, it's fixed in 4.6.5 by commit:\nhttps://github.com/phpmyadmin/phpmyadmin/pull/12616\nand in Debian package partially (when apache is used) by commit:\nhttps://anonscm.debian.org/git/collab-maint/phpmyadmin.git/commit/?id=e87a428ec42883340708a502407179b4bff0583d\nit enable bypassing the function PMA_safeUnserialize, which introduced as fix for:\nhttps://www.phpmyadmin.net/security/PMASA-2016-43/\nThe latest release contain another bypass of PMA_safeUnserialize which fixed in:\nhttps://www.phpmyadmin.net/security/PMASA-2016-70/\n\nThe bypass when mbstring.func_overload is enabled isn't mentioned in changelog/security advisories, the function PMA_safeUnserialize is still vulnerable as is, but PMA decline to work if mbstring.func_overload is enabled.\nPOC:\nrun:\n```\nphp -d mbstring.func_overload=2 ./poc.php\n```\npoc.php content: (using symbol https://en.wiktionary.org/wiki/%F0%A0%9C%8E)\n```\n\u003c?php\n$safeUnserializeBypass='a:3:{i:0;s:16:\"𠜎𠜎𠜎𠜎\";i:1;O:8:\"stdClass\":0:{}s:4:\"abcd\";s:44:\"abcdefga23hi𠜎qwer𠜎ty𠜎ab𠜎a𠜎;:A\";}';\nvar_dump(PMA_safeUnserialize($safeUnserializeBypass));\n?\u003e","automated_response":false,"created_at":"2016-11-27T23:42:22.704Z","updated_at":"2016-11-27T23:42:22.704Z","actor":{"username":"e3amn2l","cleared":false,"url":"/e3amn2l","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1653847,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"Not security-affecting in the context of Airship, but better code consistency makes life easier for all parties.","automated_response":false,"created_at":"2017-05-04T14:19:41.575Z","updated_at":"2017-05-04T14:19:41.575Z","actor":{"url":"/paragonie","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/539/72f76fed45e5220b47ba2f679371ebf9ccb19c70_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Paragon Initiative Enterprises"}},"genius_execution_id":null,"team_handle":"paragonie","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}