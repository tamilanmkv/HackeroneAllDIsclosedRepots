{"id":181319,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODEzMTk=","url":"https://hackerone.com/reports/181319","title":"Memory disclosure in mruby String#lines method","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2016-11-10T13:17:47.675Z","submitted_at":"2016-11-10T13:17:47.675Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"isra17","url":"/isra17","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-16T20:53:52.497Z","bug_reporter_agreed_on_going_public_at":"2016-12-16T20:53:52.464Z","team_member_agreed_on_going_public_at":"2016-12-16T20:52:29.027Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"This bug was found with `jmlb337`.\n\nHey again,\nwhile reviewing mruby for vulnerabilities, I stumble onto a case that allow an attacker to leak heap content including pointer that can be used along another vulnerability to craft a complete exploit.\n\n## Reproduction Step\n1. Allocate a string with a few lines.\n2. Call String#lines and free or reallocate the string.\n3. Allocate a few objects.\n4. The next lines will now contains the value of the newly allocated data, including pointer used by `mrb_value`s.\n\n## PoC\n```ruby\n@a = []\n$a = (\"a\"*0xf + \"\\n\") * 1000\n$a.lines do |l|\n  $a.clear\n  foo = \"UUUUUUUU\" * 1000\n  @a \u003c\u003c l\nend\n```\nLook at `@a` to get the \"UUUU...\" `mrb_value` object and strings.\n\n## Explaination\nThe bug is triggered due to the caching of `p` at [string.c:310](https://github.com/mruby/mruby/blob/872517dff372ee6fde92c71861abf6ab9fbab958/mrbgems/mruby-string-ext/src/string.c#L310): \n```c\n  char *p = RSTRING_PTR(self), *t;\n  char *e = p + RSTRING_LEN(self);\n```\n\nHowever, while iterating on each line, the function allow the caller to provide a block to be called for each line [string.c:324](https://github.com/mruby/mruby/blob/872517dff372ee6fde92c71861abf6ab9fbab958/mrbgems/mruby-string-ext/src/string.c#L324): \n```c\n      mrb_yield_argv(mrb, blk, 1, \u0026arg);\n```\nThis block let the attacker to update the `self` string, in which case `p` will now be a dangling pointer pointing to free memory. Allocating new objects will end up in this free location and let the next iteration read this data before giving it back to the block.\n\n## Exploitability\n\nThe vulnerability is exploitable as long as the attacker can run arbitrary ruby code in the mruby interpreter. It should cover mruby-engine case as used by Shopify.\n\n## Impact\n\nThis vulnerability comes handy to locate object address in the heap, by allowing reliable, cheap and simple memory disclosure. We would use this bug to build a complete RCE along with another reported bug in the following 1 or 2 week  (Will add a comment with the other report ID). I spoke with Fran√ßois Chagnon and we preferred to report the bugs as soon as possible while working on provable RCE afterward so it can get patched earlier.\n\n## Proposed Fix\nSee patch in attachment.","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":133844,"file_name":"0001-Fix-use-after-free-access-in-String-lines.patch","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/133/844/1ea2922a8273f6995bf4cdf833e269e4cc289718/0001-Fix-use-after-free-access-in-String-lines.patch?response-content-disposition=attachment%3B%20filename%3D%220001-Fix-use-after-free-access-in-String-lines.patch%22%3B%20filename%2A%3DUTF-8%27%270001-Fix-use-after-free-access-in-String-lines.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRJF6VFL6%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T135442Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJGMEQCID1So1KYRjOmBFJqLsqO1j9SSUCF9kJ%2FHqahOyDLmrnJAiAr2q5Z8bAgCyaCmyDSz7xwtmUTDOoz04myJOluBHRCeyqDBAju%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMvFUMWX6P00RsVarQKtcDflFFNScU3coA1YbnKy4lPXtwGDNsJcqhfcCTaePuAuK6nWvl5xRbjzjOBPvBHaTAnb2Iw%2B6Jdj2uyjmRMn%2F5%2F5AzD5di2wWOcC0am9iLaFmORG4VIVXTc8aAiiwqjNAu7dH2hTUNL9bwPzYUBq3%2FjwvNZUM%2FmpdXfugOwAP%2FP3w9e9PqozA16XzrwGIunimlg58HKZfOM0xp%2FESLFXRHAssX6DaYqQQyV5%2F0triAQeOx328GOBUjfGTiAl1aoS1J0%2FqN%2BmywXW%2FqqkEfAQ2n2f18dX2dkbwMnyQ4F47zR6jJw3CdBkeCPRDbbhcu8YGu2%2F%2BzzM9B4uguhR76M3KYB3dr919eRp%2F%2BcOfUxc8TC3gXMmp1jh0ywwC27sBrzUgZdh%2B2g4artPxRaRZPHbQvC%2F1OZ0MxZYsQmEItbUc65WqfO6PSdLbymEFDMyN5ona14j%2BaQHfp1MWNaO02I2WPYO5mZIsPuHjCO5MYUldcsrZMP7pydKVo87gkO2fPB2orxw1RGazxVwGy5R2PDIV7HsKH4KSOqhGLTTYcSjZvxzmTWIy013yrXhU3CEdFUoB7QifSN1bUli2cMIaUe7sr75onhlaNnQxqLv%2By7jqQ9RiOHvcMM4XIMInwkIsGOqYBzgDHFUI%2FtkToYUBHsGsXyI9vGkS81IUV4PSjgSfvCFIGR%2BPjro3EYi30Oc%2FQZijhik3H1oI82Vno5zo%2BVnueR7%2BkGCloKvMkJAe%2F77e%2BPPRDClquvRG9ERm7ELsd6WvljYOJTmuP4pWPW%2B2d%2BQu26lThNein0I5abJKiu%2FYvnXDmBeYAgLMwbyg9Lq3qT5qMKsr3i1aOgHcGHtYldnzNcLqwaNJYhw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=73cd6cdc5d731a74c4b9cf26b5f5de9d130339d2cd024d418fa5495074f386c4","file_size":2017,"type":"text/x-diff"}],"allow_singular_disclosure_at":"2017-01-15T20:52:29.056Z","allow_singular_disclosure_after":-149446933.33219236,"singular_disclosure_allowed":true,"vote_count":10,"voters":["isra17","michiel","mpz","eveeez","khizer47","japz","spetr0x","scept1c","no-longer-with-company","jmlb1337"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1293515,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@isra17 since we may end up using the patch you submitted (or parts of it) I just want to confirm in writing that you agree to release it under the original project license (MIT License). We'll attribute the patches to you by linking to this issue and your github account if you wish.","automated_response":false,"created_at":"2016-11-10T15:52:58.166Z","updated_at":"2016-11-10T15:52:58.166Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1293536,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I agree to release it under the original project license.","automated_response":false,"created_at":"2016-11-10T16:01:09.817Z","updated_at":"2016-11-10T16:01:09.817Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1293548,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The other reported bug I talked about: https://hackerone.com/reports/181321 .\nBoth of those should be usable to get an RCE to escape the ruby sandbox.","automated_response":false,"created_at":"2016-11-10T16:05:53.543Z","updated_at":"2016-11-10T16:05:53.543Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1298876,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the issue, and our engineering team is working on a fix.","automated_response":false,"created_at":"2016-11-14T18:56:20.797Z","updated_at":"2016-11-14T18:56:20.797Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1301026,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you again for this great report. We've resolved this issue in our production environment and the fix has been submitted upstream: https://github.com/mruby/mruby/commit/242b21947102d98aba2fa3db2725b129ca547f20\n\nI'm marking this issue as resolved now but we still need to assess the impact \u0026  determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.","automated_response":false,"created_at":"2016-11-15T20:15:59.107Z","updated_at":"2016-11-15T20:15:59.107Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"isra17","url":"/isra17"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370227,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify Scripts and the mruby project!","automated_response":false,"created_at":"2016-12-16T20:52:24.122Z","updated_at":"2016-12-16T20:52:24.122Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"2000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"isra17","url":"/isra17"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370229,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-12-16T20:52:29.042Z","updated_at":"2016-12-16T20:52:29.042Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370240,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-12-16T20:53:52.479Z","updated_at":"2016-12-16T20:53:52.479Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370241,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-12-16T20:53:52.509Z","updated_at":"2016-12-16T20:53:52.509Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}