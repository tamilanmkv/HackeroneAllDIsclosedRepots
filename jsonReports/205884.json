{"id":205884,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDU4ODQ=","url":"https://hackerone.com/reports/205884","title":"Interger overflow in str_substr leading to read/write out of bound memory","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-02-13T05:26:12.272Z","submitted_at":"2017-02-13T05:26:12.272Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"luniching","url":"/luniching","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-03-15T01:29:48.346Z","bug_reporter_agreed_on_going_public_at":"2017-03-15T01:29:48.307Z","team_member_agreed_on_going_public_at":"2017-03-14T21:07:11.577Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Failed check len \u0026 beg in str_substr when call mrb_str_aref_m by String. This can lead to read/write into invalid memory which may be memory corruption or  RCE.\nthis snippet causes a crash in mruby(i can't check mruby-engine by error undefined symbol \u003erb_utf8_str_new ):\n```\n$b=\"B\"*2048\n$expand=$b[0x40,0x7fffffff]\nputs $expand.size()\nputs $expand\n```\nAnd, here is error: beg=0x40, len=0x7fffffff, clen=0x800=\u003e beg+len \u003c clen(Integer Overflow)\n```\nstatic mrb_value\nstr_substr(mrb_state *mrb, mrb_value str, mrb_int beg, mrb_int len)\n{\n/**\n*..some code here\n**/\nif (beg + len \u003e clen) =\u003e Integer overflow here\n    len = clen - beg;\n  if (len \u003c= 0) {\n    len = 0;\n  }\n  return str_subseq(mrb, str, beg, len);\n}\n```","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-04-13T21:07:11.612Z","allow_singular_disclosure_after":-141843335.8734617,"singular_disclosure_allowed":true,"vote_count":4,"voters":["mpz","eveeez","spetr0x","markopetrynuok"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1481351,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","automated_response":true,"created_at":"2017-02-13T05:26:12.452Z","updated_at":"2017-02-13T05:26:12.452Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1493030,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"To fix this issue, we just change ``` if (beg + len \u003e clen) ``` to ``` if (len \u003e clen - beg) ```\nI have not built the exploit code for this issue yet. Hopefully i am the first guy for this issue\nbtw, attached is a patch to mruby to fix this issue. ","automated_response":false,"created_at":"2017-02-18T15:06:33.432Z","updated_at":"2017-02-18T15:06:33.432Z","actor":{"username":"luniching","cleared":false,"url":"/luniching","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":161866,"filename":"patch.diff","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/161/866/b8faf2410ac6c54036e7f6d40a7a72f13f543bc9/patch.diff?response-content-disposition=attachment%3B%20filename%3D%22patch.diff%22%3B%20filename%2A%3DUTF-8%27%27patch.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ33OZT5PP%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T140247Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQDh91HQqgz8mt29LtWDknUFVa4Bu86qeWnq8qOBQ4%2B8YAIhAJicmQmdRKuH%2BFKshKD5HTFqxieLS9bLt%2Bm8ixoUQIW3KoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxjBiCZo4VtYu6s0mkq1wMS3NiFshNMAkLirys6UqWqG8DtyLSnjp2Jjq3FOYZ3z5QPGI3pyApw22mHN9%2FCuJJ7nvZBlTnqVZioeymrRwRkh3Ep2Grp7bfy17tsucRab4%2Fwcov%2FuB%2BH%2FlOKLA0dPOLvtzKyIZukVE4weTfh0vOmJyKq0MNT872S%2BEJQLaNHxuaApYj89CoiKQ8iIYPil%2Fer515Tq61zraK163aXC6Wy%2Bh9wZG9n9nO%2BF1HjHbOKQzNHLtEPDs0LaRFl2yyG012UrzxbWRh3SKf%2BZrF4YZHuHGoHHIILeGK7ULsTEUwPzgUchRw1iPy0mN9FOZAmWbrDJGsit0hVq3pp5X2hPUG4sFE8%2F6L9i0WnB%2B10Vp3U%2Frt684dQjLB%2BN9XMGfru4gI4tqqTswEvdVKIEl24vu1y1GF4NHtB52g2uU0a32AMPT4CyiEmO89SmREN7kkSkG506ZPZM6WpVb3X01QplYYRrO8hlLoLzsG90yPauXyc9z1g3ctobA3rwzP0%2BqnbTFOPOLdg%2Fez87Kn7dOH%2FJ5gT4VcfvDJKUt7spf4PMSNNs%2B45MGrcVDhtPaqpVkGpjTY2Qumd8jnWYmah%2BcSUkcSfYxIQ8VjPNpkeGcsLaLhPLK%2BhKhc6iXUw9vqQiwY6pAEkpudJjvKBj1n%2B2NK2uzTbiu0zjrqvjRC7B2s5rDWkChSlyjdb5Gs7Y4xGynRFg2owPJvc66mub6OLgiEzz%2BMOYFcjvSwIHpDD0Esy3kPtVCPpCMvheYuZFtLkLN%2FOortUj7F7jaVVdakEud32Wsg33glLfI0B%2F55RSf0DkRble%2FhL0EB4lzVO1F1OLS0MQQYssZKljr4UYXvI8G5j0rwW6dHIGQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=af8cda5741f1767baaeed2e61dac6fc341fa134d4338d01a3081a7abdc15963b"}],"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1509192,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the crash and opened an issue upstream: https://github.com/mruby/mruby/issues/3473\n\nThis issue does not appear to affect our production environment because we build MRuby with `MRB_INT64` where the maximum allowed `mrb_int` is `0x3fffffffffffffff`.","automated_response":false,"created_at":"2017-02-27T19:54:47.292Z","updated_at":"2017-02-27T19:54:47.292Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509928,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"When i recompile mruby with MRB_INT64 (set in ./include/mrbconf.h) then change len to 0x7fffffffffffffff \n```\n$expand=$b[0x40,0x7fffffffffffffff]\n```\nI still reproduced a crash. beg=0x40, len=0x7fffffffffffffff, clen=0x400 then  beg+len \u003c clen( Still Integer Overflow).\ndebug in  gef:\n```\n 468\t   if (beg \u003c 0) {\n 469\t     beg += clen;\n 470\t     if (beg \u003c 0) return mrb_nil_value();\n 471\t   }\n 472\t   if (beg + len \u003e clen) \t\t \u003c- $pc\t\n 473\t     len = clen - beg;\n 474\t   if (len \u003c= 0) {\n 475\t     len = 0;\n 476\t   }\n-------------------------------------------------------------------------------------------------------------------------------------------------------------------[trace]--\n#0  str_substr (mrb=0x61400000fe40, str=..., beg=64, len=9223372036854775807) at /home/lucnguyen/Desktop/WorkSpace/mruby/mruby-latest/src/string.c:472\n#1  0x0000000000517c45 in mrb_str_aref_m (mrb=0x61400000fe40, str=...) at /home/lucnguyen/Desktop/WorkSpace/mruby/mruby-latest/src/string.c:1172\n#2  0x0000000000507a38 in mrb_vm_exec (mrb=0x61400000fe40, proc=0x62f000002ec0, pc=0x60600000d544) at /home/lucnguyen/Desktop/WorkSpace/mruby/mruby-latest/src/vm.c:1229\n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------\ngef\u003e p /x beg + len\n$1 = 0x800000000000003f\ngef\u003e p /x clen\n$2 = 0x400\ngef\u003e p /x len\n$3 = 0x7fffffffffffffff\n```\nAnd SIGSEV:\n```\nProgram received signal SIGSEGV, Segmentation fault.\nAddressIsPoisoned () at /home/development/llvm/3.9.0/final/llvm.src/projects/compiler-rt/lib/asan/asan_mapping.h:326\n326\t/home/development/llvm/3.9.0/final/llvm.src/projects/compiler-rt/lib/asan/asan_mapping.h: No such file or directory.\n---------------------------------------------------------------------------------------------------------------------------------------------------------------[registers]--\n$rax     0x10000c3200000477 $rbx     0x00000000009eb7e0 $rcx     0x000062f000002560 $rdx     0x000062f000002578 $rsp     0x00007fffffffb680 \n$rbp     0x00007fffffffbf00 $rsi     0x000062f000002578 $rdi     0x80006190000023be $rip     0x000000000042a50e $r8      0x0000000000000010 \n$r9      0x00007fffffffbfb0 $r10     0x0000000000000001 $r11     0x00007ffff69c2390 $r12     0x0000000000000001 $r13     0x00007fffffffdac0 \n$r14     0x0000000000c3c6a0 $r15     0x80006190000023be $cs      0x0000000000000033 $ss      0x000000000000002b $ds      0x0000000000000000 \n$es      0x0000000000000000 $fs      0x0000000000000000 $gs      0x0000000000000000 $eflags  [ CF PF IF OF RF ] \nFlags: [ CARRY  PARITY  adjust  zero  sign  trap  INTERRUPT  direction  OVERFLOW  RESUME  virtualx86  identification ]\n-------------------------------------------------------------------------------------------------------------------------------------------------------------------[stack]--\n0x00007fffffffb680|+0x0000: 0x80028a00000120\t\t\u003c-$rsp   \n0x00007fffffffb688|+0x0008: 0x0000628000000120 -\u003e 0x000061400000fe40 -\u003e 0x00007fffffffd388 -\u003e 0x0\n0x00007fffffffb690|+0x0010: 0x00007fffffffb730 -\u003e 0x00007fffffffb7c0 -\u003e 0x00007fffffffc170 -\u003e 0x00007fffffffc1f8 -\u003e 0x000000000051bc96 -\u003e \u003cmrb_default_allocf+70\u003e: mov QWORD PTR [rbp-0x8],rax\n0x00007fffffffb698|+0x0018: 0x0000000000548a58 -\u003e \u003cgenop_peep+3032\u003e: mov DWORD PTR [rbp-0x4],eax\n0x00007fffffffb6a0|+0x0020: 0x0\n0x00007fffffffb6a8|+0x0028: 0x000000010000002a -\u003e 0x0\n0x00007fffffffb6b0|+0x0030: 0x29e\n0x00007fffffffb6b8|+0x0038: 0x0000628000000120 -\u003e 0x000061400000fe40 -\u003e 0x00007fffffffd388 -\u003e 0x0\n--------------------------------------------------------------------------------------------------------------------------------------------------------[code:i386:x86-64]--\n0x42a501\t \u003c__interceptor_memcmp()+737\u003e     cmp   r12,0x20\n0x42a505\t \u003c__interceptor_memcmp()+741\u003e     ja   0x42a56b \u003c__interceptor_memcmp()+843\u003e\n0x42a507\t \u003c__interceptor_memcmp()+743\u003e     mov   rax,r15\n0x42a50a\t \u003c__interceptor_memcmp()+746\u003e     shr   rax,0x3\n0x42a50e\t \u003c__interceptor_memcmp()+750\u003e     movsx   eax,BYTE PTR [rax+0x7fff8000] \t\t \u003c- $pc\n0x42a515\t \u003c__interceptor_memcmp()+757\u003e     test   eax,eax\n0x42a517\t \u003c__interceptor_memcmp()+759\u003e     je   0x42a523 \u003c__interceptor_memcmp()+771\u003e\n0x42a519\t \u003c__interceptor_memcmp()+761\u003e     mov   ecx,r15d\n0x42a51c\t \u003c__interceptor_memcmp()+764\u003e     and   ecx,0x7\n```\nBtw, i reproduced on this commit  ```a9f7b41219810fdbe0cffa872051cd091fc070ac```.\nSorry if i missed something.\nRgs","automated_response":false,"created_at":"2017-02-28T01:52:04.100Z","updated_at":"2017-02-28T01:52:04.100Z","actor":{"username":"luniching","cleared":false,"url":"/luniching","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1511038,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sorry, I forgot to mention that we are also building with `MRB_WORD_BOXING`, which reduces the maximum `Fixnum` size by one bit.","automated_response":false,"created_at":"2017-02-28T14:12:52.523Z","updated_at":"2017-02-28T14:12:52.523Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1511048,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This issue has been addressed upstream in https://github.com/mruby/mruby/commit/7db0786abdd243ba031e24683f6140f410b65588\n\nOur next round of bounty decisions will take place in approximately two weeks, so we'll be in touch with you again soon.","automated_response":false,"created_at":"2017-02-28T14:21:05.851Z","updated_at":"2017-02-28T14:21:05.851Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"luniching","url":"/luniching"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541560,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of the MRuby project!","automated_response":false,"created_at":"2017-03-14T21:07:05.691Z","updated_at":"2017-03-14T21:07:05.691Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"luniching","url":"/luniching"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541561,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-03-14T21:07:11.595Z","updated_at":"2017-03-14T21:07:11.595Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541972,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the reward","automated_response":false,"created_at":"2017-03-15T01:28:58.262Z","updated_at":"2017-03-15T01:28:58.262Z","actor":{"username":"luniching","cleared":false,"url":"/luniching","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1541975,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-03-15T01:29:48.324Z","updated_at":"2017-03-15T01:29:48.324Z","actor":{"username":"luniching","cleared":false,"url":"/luniching","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1541976,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-03-15T01:29:48.361Z","updated_at":"2017-03-15T01:29:48.361Z","actor":{"username":"luniching","cleared":false,"url":"/luniching","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/300/745246af6714fc8495b07b50fe12451a97ea58c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}