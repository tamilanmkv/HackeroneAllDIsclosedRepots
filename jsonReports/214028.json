{"id":214028,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTQwMjg=","url":"https://hackerone.com/reports/214028","title":"Race condition in GitLab import, giving access to other people their imports due to filename collision","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-03-16T22:30:03.968Z","submitted_at":"2017-03-16T22:30:03.968Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-10-03T19:11:28.808Z","bug_reporter_agreed_on_going_public_at":"2017-10-03T17:46:25.354Z","team_member_agreed_on_going_public_at":"2017-10-03T19:11:28.740Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Vulnerability details\nThere's a race condition in the `Import::GitlabProjectsController#create` endpoint that allows an attacker to gain access to someone else's import file. The race condition happens when there's a collision in two or more file names uploaded at the same time, before the import gets processed by Sidekiq. The person uploading the file for the first time will see the last person's file contents instead.\n\n# Impact\nDepending on the contents of the GitLab import file, this could leak confidential information from other users on the GitLab instance.\n\n# Proof of concept\nThis is hard to reproduce without a good setup, but conceptually it's pretty easy to explain by going through the code. When someone uploads a new file, the following code gets executed:\n\n**app/controllers/import/gitlab_projects_controller.rb** (15-18)\n```ruby\nimport_upload_path = Gitlab::ImportExport.import_upload_path(filename: project_params[:file].original_filename)\n\nFileUtils.mkdir_p(File.dirname(import_upload_path))\nFileUtils.copy_entry(project_params[:file].path, import_upload_path)\n```\n\nThe `Gitlab::ImportExport.import_upload_path` method looks like this:\n\n```ruby\ndef import_upload_path(filename:)\n  File.join(storage_path, 'uploads', filename)\nend\n```\n\nThis means, when a file called `import.tar.gz` would get uploaded, it would copy the temporary file to `/var/opt/gitlab/gitlab-rails/shared/tmp/project_exports/uploads/import.tar.gz`. Next, it'll schedule an async job in Sidekiq that'll take care of unpacking the import file and restore it's contents. However, since there's a delay between when the file gets copied and when the job gets processed (depending on how busy the workers are, etc.), someone else could upload a file with the same filename. If this happens before the import job gets processed, the victim will unknowingly overwrite the attacker's import file. When the attacker's Sidekiq job gets executed, it'll unpack the victim's import file and restore the files in the attacker's repository.\n\nThe entropy of a GitLab export file is decent enough to make this extremely hard to pull off. However, when someone would rename the file to something more common, for example a repository name, project name, or something generic like `import.tar.gz`, the changes of this happening increase.\n\nTo reproduce this vulnerability locally, it is easiest to shutdown the Sidekiq workers and upload two files with the same name under two different accounts. After that, restart the Sidekiq workers. You'll notice that both repositories hold the contents of the last imported file.\n\n# Remediation advice\nGenerate a random filename instead of using the original filename or add the namespace and project URL to avoid file name collisions.","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-11-02T17:46:25.398Z","allow_singular_disclosure_after":-124316304.29290707,"singular_disclosure_allowed":true,"vote_count":17,"voters":["jensec","sp1d3rs","bughunterninja","bl4de","fa1rlight","tungpun","gamliel","eveeez","code_monkey","khizer47","and 7 more..."],"severity":{"rating":"low","score":3.7,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"low","user_interaction":"required","scope":"unchanged","confidentiality":"low","integrity":"low","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1547991,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @jobert,\n\nI think the chances of a collision here are relatively high given that so many users are importing their own versions of the same projects and Sidekiq can get overloaded at times. I've opened confidential issue: https://gitlab.com/gitlab-org/gitlab-ce/issues/29652 to discuss a fix. Thanks again for another report!","automated_response":false,"created_at":"2017-03-17T16:14:58.184Z","updated_at":"2017-03-17T16:14:58.184Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1765524,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jobert,\n\nI just wanted to let you know this is still waiting for a fix. Hopefully we'll be able to get one out soon. Sorry for the delay!","automated_response":false,"created_at":"2017-06-19T15:29:22.186Z","updated_at":"2017-06-19T15:29:22.186Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1766730,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@briann Sounds good. If you need help, let me know. Calling `project_params[:file].tempfile.path` instead of `project_params[:file].original_filename` should add enough entropy to the filename to avoid collisions. You could also specify the project namespace and name to separate the files per project, but I'd still add additional entropy to the filename to avoid collisions. Writing a regression spec is slightly harder, but I'd probably manually copy a file to the `uploads` directory in the spec and then write a controller spec with that exact filename to make sure it isn't overwritten.\n\n```diff\ndiff --git i/app/controllers/import/gitlab_projects_controller.rb w/app/controllers/import/gitlab_projects_controller.rb\nindex 36d246d185..29c6f7431a 100644\n--- i/app/controllers/import/gitlab_projects_controller.rb\n+++ w/app/controllers/import/gitlab_projects_controller.rb\n@@ -12,7 +12,7 @@ class Import::GitlabProjectsController \u003c Import::BaseController\n       return redirect_back_or_default(options: { alert: \"You need to upload a GitLab project export archive.\" })\n     end\n\n-    import_upload_path = Gitlab::ImportExport.import_upload_path(filename: project_params[:file].original_filename)\n+    import_upload_path = Gitlab::ImportExport.import_upload_path(filename: project_params[:file].tempfile.path)\n\n     FileUtils.mkdir_p(File.dirname(import_upload_path))\n     FileUtils.copy_entry(project_params[:file].path, import_upload_path)\n```","automated_response":false,"created_at":"2017-06-19T21:19:58.695Z","updated_at":"2017-06-19T21:19:58.695Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1768349,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I appreciate the help. You know how it goes, it's not so much a lack of technical knowledge that keeps these from being patched quickly but rather a lack of time. ","automated_response":false,"created_at":"2017-06-20T14:08:21.238Z","updated_at":"2017-06-20T14:08:21.238Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1878501,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jobert,\n\nWe have a fix ready for this. I hope to have it included in our next security release. I'll let you know for sure when it's released.","automated_response":false,"created_at":"2017-07-30T22:12:49.895Z","updated_at":"2017-07-30T22:12:49.895Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1967024,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jobert,\n\nA fix for this will be included in our next security release. Hopefully to be released in a the next day or two. I'll let you know!","automated_response":false,"created_at":"2017-08-30T18:10:16.629Z","updated_at":"2017-08-30T18:10:16.629Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1984009,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @jobert,\n\nA patch for this vulnerability was included with our security release today: https://about.gitlab.com/2017/09/07/gitlab-9-dot-5-dot-4-security-release/\n\nThanks again for another report!","automated_response":false,"created_at":"2017-09-07T23:02:56.561Z","updated_at":"2017-09-07T23:02:56.561Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2041504,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-03T17:46:25.380Z","updated_at":"2017-10-03T17:46:25.380Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2041795,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-03T19:11:28.768Z","updated_at":"2017-10-03T19:11:28.768Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2041796,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-10-03T19:11:28.856Z","updated_at":"2017-10-03T19:11:28.856Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}