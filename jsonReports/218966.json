{"id":218966,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTg5NjY=","url":"https://hackerone.com/reports/218966","title":"avrecode: global-buffer-overflow in get_neighbor()","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-04-06T06:10:15.406Z","submitted_at":"2017-04-06T06:10:15.406Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"geeknik","url":"/geeknik","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/7xfGZCKCxUuGLYGfuUZM3XyY/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":461,"url":"https://hackerone.com/dropbox","handle":"dropbox","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/461/76f193964f418c594dd74ae1326cf4d9223f481b_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/461/76f193964f418c594dd74ae1326cf4d9223f481b_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Dropbox","twitter_handle":"","website":"https://www.dropbox.com","about":"Your stuff, anywhere"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-11-03T16:15:23.381Z","bug_reporter_agreed_on_going_public_at":"2019-10-04T16:15:19.542Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Source: https://github.com/dropbox/avrecode\nVersion:  2de743d\n\nBuilt using the Github instructions with afl-gcc and ASAN. Feeding this malformed .mp4 to recode triggers a global buffer overflow. \n\n`./recode roundtrip test003.mp4`\n\n```\n[mov,mp4,m4a,3gp,3g2,mj2 @ 0x61b00001f180] Protocol name not provided, cannot determine if input is local or a network protocol, buffers and access patterns cannot be configured optimally without knowing the protocol\n[h264 @ 0x61a00001f280] error while decoding MB 2 2, bytestream -11\n[h264 @ 0x61a00001f280] concealing 27 DC, 27 AC, 27 MV errors in I frame\nInput #0, mov,mp4,m4a,3gp,3g2,mj2, from 'id:000003,sig:06,src:000000,op:havoc,rep:4':\n  Metadata:\n    major_brand     : mp42\n    minor_version   : 19529854\n    compatible_brands: mp42isom\n    creation_time   : 2014-11-14 07:34:24\n  Duration: 00:00:01.00, start: 0.083333, bitrate: N/A\n    Stream #0:0(eng): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, smpte170m), 48x144 [SAR 1:1 DAR 1:3], 3 kb/s, 12 fps, 12 tbr, 12 tbn, 24 tbc (default)\n    Metadata:\n      rotate          : 0\n      creation_time   : 2014-11-14 07:34:24\n      handler_name    : Video Media Handler\n      encoder         : AVC Coding\n    Side data:\n      displaymatrix: rotation of -0.00 degrees\nFINISHED QUEUING DECODE: 1\nFINISHED QUEUING DECODE: 2\nFINISHED QUEUING DECODE: 2\nFINISHED QUEUING DECODE: 3\nFINISHED QUEUING DECODE: 3\nFINISHED QUEUING DECODE: 6\nFINISHED QUEUING DECODE: 7\nFINISHED QUEUING DECODE: 7\nFINISHED QUEUING DECODE: 6\nFINISHED QUEUING DECODE: 2\n=================================================================\n==5924==ERROR: AddressSanitizer: global-buffer-overflow on address 0x000003bceea4 at pc 0x656bd8 bp 0x7ffc81e15650 sp 0x7ffc81e15648\nREAD of size 1 at 0x000003bceea4 thread T0\n    #0 0x656bd7 in get_neighbor(bool, int, CoefficientCoord, CoefficientCoord*) /root/avrecode/recode.cpp:496\n    #1 0x6648f2 in h264_model::get_model_key(void const*) const /root/avrecode/recode.cpp:717\n    #2 0x670fb3 in h264_model::probability_for_state(unsigned long, void const*) /root/avrecode/recode.cpp:822\n    #3 0x670fb3 in void h264_symbol::execute\u003carithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e \u003e(arithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e\u0026, h264_model*, Recoded_Block*, std::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e\u0026)::{lambda(unsigned long)#1}::operator()(unsigned long) const /root/avrecode/recode.cpp:1075\n    #4 0x670fb3 in std::_Function_handler\u003cunsigned long (unsigned long), void h264_symbol::execute\u003carithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e \u003e(arithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e\u0026, h264_model*, Recoded_Block*, std::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e\u0026)::{lambda(unsigned long)#1}\u003e::_M_invoke(std::_Any_data const\u0026, unsigned long) /usr/include/c++/4.9/functional:2025\n    #5 0x683241 in std::function\u003cunsigned long (unsigned long)\u003e::operator()(unsigned long) const /usr/include/c++/4.9/functional:2439\n    #6 0x683241 in arithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e::put(int, std::function\u003cunsigned long (unsigned long)\u003e) /root/avrecode/arithmetic_code.h:107\n    #7 0x683241 in void h264_symbol::execute\u003carithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e \u003e(arithmetic_code\u003cunsigned long, unsigned char, 0\u003e::encoder\u003cstd::back_insert_iterator\u003cstd::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e \u003e, unsigned char\u003e\u0026, h264_model*, Recoded_Block*, std::vector\u003cunsigned char, std::allocator\u003cunsigned char\u003e \u003e\u0026) /root/avrecode/recode.cpp:1075\n    #8 0x6916b7 in compressor::cabac_decoder::pop_queueing_symbols(CodingType) /root/avrecode/recode.cpp:1252\n    #9 0x6916b7 in compressor::cabac_decoder::end_coding_type(CodingType) /root/avrecode/recode.cpp:1226\n    #10 0x6916b7 in av_decoder\u003ccompressor\u003e::model_hooks::end_coding_type(void*, CodingType) /root/avrecode/recode.cpp:207\n    #11 0x36bc9b3 in decode_cabac_residual_internal libavcodec/h264_cabac.c:1721\n    #12 0x36bc9b3 in decode_cabac_residual_dc_internal libavcodec/h264_cabac.c:1789\n    #13 0x36de622 in decode_cabac_residual_dc libavcodec/h264_cabac.c:1837\n    #14 0x36de622 in decode_cabac_luma_residual libavcodec/h264_cabac.c:1887\n    #15 0x36de622 in ff_h264_decode_mb_cabac libavcodec/h264_cabac.c:2418\n    #16 0x18b80ac in decode_slice libavcodec/h264_slice.c:2384\n    #17 0x18de556 in ff_h264_execute_decode_slices libavcodec/h264_slice.c:2560\n    #18 0x176348b in decode_nal_units libavcodec/h264.c:1646\n    #19 0x176348b in h264_decode_frame libavcodec/h264.c:1831\n    #20 0x6f522f in avcodec_decode_video2 libavcodec/utils.c:2115\n    #21 0x66b870 in av_decoder\u003ccompressor\u003e::decode_video() /root/avrecode/recode.cpp:130\n    #22 0x67de37 in compressor::run() /root/avrecode/recode.cpp:1119\n    #23 0x6585f5 in roundtrip(std::string const\u0026, std::ostream*) /root/avrecode/recode.cpp:1598\n    #24 0x638509 in main /root/avrecode/recode.cpp:1650\n    #25 0x7f73e7c3ab44 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b44)\n    #26 0x65451c (/root/avrecode/recode+0x65451c)\n\n0x000003bceea4 is located 60 bytes to the left of global variable 'zigzag4' from 'recode.cpp' (0x3bceee0) of size 4\n0x000003bceea4 is located 0 bytes to the right of global variable 'unzigzag4' from 'recode.cpp' (0x3bceea0) of size 4\nSUMMARY: AddressSanitizer: global-buffer-overflow /root/avrecode/recode.cpp:496 get_neighbor(bool, int, CoefficientCoord, CoefficientCoord*)\n```","weakness":{"id":3,"name":"Classic Buffer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":173685,"file_name":"test003.mp4.gz","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/173/685/478b39b6f20a85b65808eb09e5746ee5f1260f42/test003.mp4.gz?response-content-disposition=attachment%3B%20filename%3D%22test003.mp4.gz%22%3B%20filename%2A%3DUTF-8%27%27test003.mp4.gz\u0026response-content-type=application%2Fgzip\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ3XETQKVM%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T140616Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIQCGITGEBL0GDazIgFIa28tiYmEhXENYyhaNz5SA%2FlGoWgIgUpM2O%2BqLplk1PxLgHvwucUcfaWBDs4lcpMfbeWt8lf0qgwQI7v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDKzBywxhiDPCGniAXCrXA0hN3FmE2a%2FvX745J3E%2FVZOyco%2FXdDJhTa6QLBz8ruxItJd7RBy%2BDgWvdA9F9VhH6hQi1%2BoGROPLiNtVXscv2SAyqwnGAvovNwUJ1XHdXq9csPneVktpMYUl5e6BGW1xCryz1JW0SV%2BUfaSbieJMT38q3eYU9Qxk5dVB%2FFSLDg1wEknhr%2FrXVV%2FyMqUg1dTUYtXEjLNILLRPWX%2F4wv3E6jg3evrZ7gOO5fAJ9yd3K5iXRj4PV28TPJwb4Bp0K3AV23Xw17YRvstL2wS%2FKJ5kkbPQixYXwVbw8yOEBuTf5C9xK0ZT%2BUy2XrR%2BHohMKCcUEmtk4PUYdUQFeneehIWQAkbd4qIQq1wWh3%2BtFZuz9DX0pjS8WWix5bToWfIKFuKulPfC5YwvJmaPyfSRVTaZ6I14bWPkalqD2SgW4Vy%2B09y41yRaXPxOlIrJMFvQS2IEJ1HEHz4ZUR1yXSp0gHeUDD8o18FKUmWJbFX0f4qg6QMujUtz72wUwuuVALx3RPw6LWvm7guP0GVvaCkepTd9y%2FQPIJ5BMWpXjOzk8woMpmPNPVmiY%2B0aJf85ceJPSOr4SQhScx2VlsmYJMnP01anhvN0NHIzV5cw9ydQaVt5O0LNrdQYH%2FIyrzC885CLBjqlAaE%2FfvTfYEPLtbspKR1t8pqzvolC92qkeVrvH%2BpD5KXCuP33P%2Bp2tmR3wVnz2EohJYzmGrrnBvRXs0coN12U37MszdI%2Bvzj6PkJc0Y4l0wDgwvf1eWilxQANi8xmwPgCDVfgGtOQp6uxiNpwW3IAibhcqSDm28IB01CUcpdI9PzabCC%2B8IpU1mKKntGaQJtzs4L%2BAHeAe57KgaMrEoYitz0ixKUbTw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=f1e4754fb4155fb08ffb9625ae64be35f23706314dca1cf50846c8705fe0e2c1","file_size":751,"type":"application/gzip"}],"allow_singular_disclosure_at":"2019-11-03T16:15:19.693Z","allow_singular_disclosure_after":-61163457.00787792,"singular_disclosure_allowed":true,"vote_count":10,"voters":["libcontainer","geeknik","r3y","exception","tarwadahorse","cryptographer","krt_","youngowl","ytatack","cipy"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1588066,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @geeknik, thanks for the report! Our policy does not have avrecode in scope for bounty, but I'll discuss the possibly of rewarding with the team. In the meantime we are investigating the issue.","automated_response":false,"created_at":"2017-04-06T21:28:21.332Z","updated_at":"2017-04-06T21:28:21.332Z","actor":{"username":"gabepike","cleared":false,"url":"/gabepike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1589905,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"We do not use avrecode in our infrastructure, so this bug is not eligible for bounty.","automated_response":false,"created_at":"2017-04-07T18:38:57.083Z","updated_at":"2017-04-07T18:38:57.083Z","actor":{"url":"/dropbox","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/461/76f193964f418c594dd74ae1326cf4d9223f481b_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Dropbox"}},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1590017,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"No worries my friends, it was a shot in the dark (I fuzz everything, 16 CVEs and counting).","automated_response":false,"created_at":"2017-04-07T19:29:12.863Z","updated_at":"2017-04-07T19:29:12.863Z","actor":{"username":"geeknik","cleared":false,"url":"/geeknik","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/7xfGZCKCxUuGLYGfuUZM3XyY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1809610,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"btw, we have fixed in https://github.com/dropbox/avrecode/commit/0749548cc337c59933da84063c1edc97ac11d259 but also  added a warning in the repo about using this only on test, trusted data. thanks for your help!","automated_response":false,"created_at":"2017-07-06T03:42:35.300Z","updated_at":"2017-07-06T03:42:35.300Z","actor":{"username":"devd","cleared":false,"url":"/devd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/376/241e11c4ddebe1e81cd547edaae1532bbed268aa_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"geeknik","url":"/geeknik"},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5960613,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-10-04T16:15:19.614Z","updated_at":"2019-10-04T16:15:19.614Z","first_to_agree":true,"actor":{"username":"geeknik","cleared":false,"url":"/geeknik","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/7xfGZCKCxUuGLYGfuUZM3XyY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6205296,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-11-03T16:15:23.917Z","updated_at":"2019-11-03T16:15:23.917Z","actor":{"url":"/dropbox","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/461/76f193964f418c594dd74ae1326cf4d9223f481b_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Dropbox"}},"genius_execution_id":null,"team_handle":"dropbox","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}