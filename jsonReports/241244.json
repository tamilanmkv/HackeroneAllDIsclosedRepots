{"id":241244,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDEyNDQ=","url":"https://hackerone.com/reports/241244","title":"Spring security configuration allows agent sessions to be hijacked","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-06-19T00:48:58.888Z","submitted_at":"2017-06-19T00:48:58.888Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"4cad","url":"/4cad","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13559,"url":"https://hackerone.com/gocd","handle":"gocd","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/559/870f3bcab332d087cde7b75fe2922e93615e3f78_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/559/870f3bcab332d087cde7b75fe2922e93615e3f78_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GoCD","twitter_handle":"goforcd","website":"https://github.com/gocd/gocd","about":"Open-source continuous delivery server specializing in advanced workflow modeling and visualization"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-07-31T19:35:11.411Z","bug_reporter_agreed_on_going_public_at":"2018-07-01T19:35:10.729Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Summary\n=======\nIf agents have successfully logged in, then unauthenticated requests to /go/agent-websocket or /go/remoting/* will randomly succeed sometimes.\n\nDescription\n========\n\nThe deprecated X509ProcessingFilter apparently does not work without a HttpSessionContextIntegrationFilter earlier on the chain. After a successful authentication it sets a thread-local security context that never gets cleared - meaning that future requests on /go/remoting or /go/agent-websocket will successfully authenticate if they randomly happen to be processed by one of the threads which has a valid security context.\n\nSteps to Reproduce\n=======\n1) Start up a server.\n2) Run the following command a bunch of times. It should always return a 403 Forbidden\n\n \"curl http://localhost:8153/go/remoting/api/admin/config.xml | grep -B 2 Error\"\n\n3) Start up an agent, and wait about two minutes\n4) Repeat the command from step 2. It should occasionally return a 500 Server Error. This happens when the request was successfully authenticated, and then fails in the GoCD code that is handling the request.\n\nIf the server has any artifacts, the URL from step (2) can be changed to a path to that URL. In this case it will sometimes return 403 Forbidden, and sometimes return the artifact itself. \n\nRisk\n========\n\nThis allows an attacker without any credentials to read all artifacts or even upload artifacts (combined with #240198 they could use this to execute a stored XSS). While preparing this ticket, I was able to successfully upload a stored XSS file without any credentials by submitting a bunch of POST requests to http://localhost:8153/go/remoting/files/up42/1/up42_stage/1/up42_job/attack_unauthenticated.html\n\nThis is also really easy to discover - I stumbled across it when I noticed some requests were randomly being denied as unauthorized. It turns out all of my requests should have been unauthorized!\n\nRecommended Fix\n========\nAdd httpSessionContextIntegrationFilter immediately before x509ProcessingFilter in the acegi-security.xml file, for the /remoting/ and /agent-websocket/ entries.\n\nThis fixes it because the httpSessionContextIntegrationFilter clears the thread-local security context after each request, thus fixing the problem. \n","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-07-31T19:35:10.818Z","allow_singular_disclosure_after":-100895812.1496275,"singular_disclosure_allowed":true,"vote_count":4,"voters":["yashrs","ali","apapedulimu","cryptographer"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1764304,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2017-06-19T00:49:09.835Z","updated_at":"2017-06-19T00:49:09.835Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":52109},"actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1764305,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I will give you a break after this one :)","automated_response":false,"created_at":"2017-06-19T00:49:21.768Z","updated_at":"2017-06-19T00:49:21.768Z","actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1765232,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Adding the HttpSessionContextIntegrationFilter to the filter chain makes sense. We will be fixing this and share an experimental build.  ","automated_response":false,"created_at":"2017-06-19T13:32:12.809Z","updated_at":"2017-06-19T13:32:12.809Z","actor":{"username":"maheshp","cleared":false,"url":"/maheshp","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1766879,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sounds good - feel free to give me the pull request if it is easier, I can build it myself","automated_response":false,"created_at":"2017-06-19T21:59:49.821Z","updated_at":"2017-06-19T21:59:49.821Z","actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1768188,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"As per your suggestion added HttpSessionContextIntegrationFilter to the filter chain. Can you please verify the changes [1].\n\n[1] https://github.com/gocd/gocd/pull/3597","automated_response":false,"created_at":"2017-06-20T12:59:17.503Z","updated_at":"2017-06-20T12:59:17.503Z","actor":{"username":"maheshp","cleared":false,"url":"/maheshp","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1769914,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I just verified the bug by testing before and after the fix - looks like the fix works!","automated_response":false,"created_at":"2017-06-20T22:45:15.983Z","updated_at":"2017-06-20T22:45:15.983Z","actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1784437,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This has been fixed as part of GoCD 17.6.0 [1]\n\n[1] https://www.gocd.org/releases/#latest\n\nThanks!","automated_response":false,"created_at":"2017-06-27T14:01:12.193Z","updated_at":"2017-06-27T14:01:12.193Z","actor":{"username":"maheshp","cleared":false,"url":"/maheshp","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"4cad","url":"/4cad"},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2969024,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"It has been a year - is it a good time for disclosure? I would like to write a blog post about it.","automated_response":false,"created_at":"2018-07-01T19:35:10.761Z","updated_at":"2018-07-01T19:35:10.761Z","first_to_agree":true,"actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2969566,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Absolutely! If you have a chance, could you give us a link to the post when you publish it - we might be able to help share it too. ","automated_response":false,"created_at":"2018-07-02T04:54:10.307Z","updated_at":"2018-07-02T04:54:10.307Z","actor":{"username":"nyuday","cleared":false,"url":"/nyuday","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/BwbF1wXRoeQnF15zSsya7zVS/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2969574,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@4cad — do you want me to set the status of this ticket to \"Disclose publicly\" right away, or after you're done with the blog post?","automated_response":false,"created_at":"2018-07-02T05:01:09.697Z","updated_at":"2018-07-02T05:01:09.697Z","actor":{"username":"ketan","cleared":false,"url":"/ketan","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/084/881/66b020e6f200716ec4b6e66dc72dd2bda845da2a_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2988913,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks! @ketan\n\nThat is a good idea - I will let you know when the blog is ready. This is my first blog post, so I appreciate the help.","automated_response":false,"created_at":"2018-07-04T20:05:23.978Z","updated_at":"2018-07-04T20:06:27.023Z","actor":{"username":"4cad","cleared":true,"url":"/4cad","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/214/9c771a1b02e8d394ddd437b845191e13beb0ccc7_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3123509,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-07-31T19:35:11.436Z","updated_at":"2018-07-31T19:35:11.436Z","actor":{"url":"/gocd","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/559/870f3bcab332d087cde7b75fe2922e93615e3f78_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"GoCD"}},"genius_execution_id":null,"team_handle":"gocd","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}