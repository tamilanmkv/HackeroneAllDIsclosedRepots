{"id":396493,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTY0OTM=","url":"https://hackerone.com/reports/396493","title":"Reflected DOM XSS on www.starbucks.co.uk","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2018-08-17T11:25:53.034Z","submitted_at":"2018-08-17T11:25:53.034Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"bayotop","url":"/bayotop","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1989,"url":"https://hackerone.com/starbucks","handle":"starbucks","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Starbucks","twitter_handle":"Starbucks","website":"http://www.starbucks.com","about":"Inspiring and nurturing the human spirit -- one person, one cup, one neighborhood at a time."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-06-16T21:21:07.555Z","bug_reporter_agreed_on_going_public_at":"2020-05-22T13:39:52.031Z","team_member_agreed_on_going_public_at":"2020-06-16T21:21:07.452Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\n\n`www.starbucks.co.uk` is vulnerable to reflected DOM XSS due to 2 seemingly unexploitable issues. The first issue is unfixed for over a year now, #252908, the second issue originates in a 3rd party module called prettyPhoto. \n\n**Description:**\n\nVisiting the following link results in a JavaScript alert (use Firefox or Edge, Chrome's XSS Auditor blocks this particular payload):\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n\nThis is possible because:\n\n1. there is a seemingly harmless HTML attribute injection into a `\u003clink rel=\"canonical\"\u003e` element (unfixed for over a year, see #252908) and\n2. the prettyPhoto JavaScript module allows to trigger the `click` event on any existing HTML element.\n\nThe following is done by prettyPhoto in https://www.starbucks.com/static/resource/shop_js/676938998_en-US:\n\n```js\nfunction d() {\n  url = location.href;\n  hashtag = (url.indexOf(\"#!\") != -1) ? decodeURI(url.substring(url.indexOf(\"#!\") + 2, url.length)) : false;\n  return hashtag\n}\n\nhashIndex = d();\nhashRel = hashIndex;\nhashIndex = hashIndex.substring(hashIndex.indexOf(\"/\") + 1, hashIndex.length - 1);\nhashRel = hashRel.substring(0, hashRel.indexOf(\"/\"));\nhashIndex = parseInt(hashIndex);\nhashRel = hashRel.replace(/([ #;\u0026,.+*~\\':\"!^$[\\]()=\u003e|\\/])/g, \"\\\\$1\");\nsetTimeout(function() {\n  b(\"a[rel^='\" + hashRel + \"']:eq(\" + hashIndex + \")\").trigger(\"click\")\n}, 50)\n```\n\nNotice how the user-controlled `hashRel` variable is [sanitized to prevent DOM XSS](https://www.saotn.org/prettyphoto-dom-based-xss/#how-to-fix-prettyphoto-dom-based-xss) in a quite obscure manner. It only works because it prefixes `=` with a `\\` ruining all standard DOM XSS payloads known to me. Also notice that `\\` is **not** escaped which means that it's possible to inject arbitrary valid jQuery selectors.\n\nCombining these two issues makes it possible to execute arbitrary JavaScript, by injecting an `onclick` HTML attribute into the `\u003clink rel=\"canonical\"\u003e` element and triggering it via the prettyPhoto JavaScript module by setting `hashRel` to `\\'\\,\\*\\,`. Due to the used jQuery version and it's lax parsing the following triggers the `click` event on all existing elements:\n\n```js\n$(\"a[rel^='\\\\\\\\'\\\\\\\\,\\\\\\\\*\\\\\\\\,']:eq(NaN)\").trigger(\"click\")\n```\n\n**Steps To Reproduce:**\n\nTested on latest Firefox and Edge:\n\n1. `https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n\n**Recommendation:**\n\nRegarding the HTML attribute injection I suggested a fix in #252908. Regarding prettyPhoto, I don't believe it's actively maintained anymore so a customization will be necessary in my opinion. White-listing allowed characters in `hashRel` is the way to go with something like `\\w+`.\n\n## Impact\n\nAttackers can execute arbitrary JavaScript in the victims' browsing context by tricking them into visiting an URL under the attackers' control. I believe you are aware of the dangers of XSS, but I am more then happy to show an actual exploit if needed.","bounty_amount":"250.0","formatted_bounty":"$250","weakness":{"id":61,"name":"Cross-site Scripting (XSS) - Reflected"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-06-21T13:39:52.101Z","allow_singular_disclosure_after":-41217347.25242699,"singular_disclosure_allowed":true,"vote_count":11,"voters":["wh0ru","e4366eolywrgpidfbio","brahim_boufakri01","ali","leonishan","d4rkm4tter","potatosalad420","user923413253","mideno","komic_sans","and 1 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":13017,"asset_type":"URL","asset_identifier":"www.starbucks.co.uk","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3213734,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @bayotop,\n\nThank you for your submission. We have received your report.\n\nBest regards,\n@thefrog\n\nSecurity Analyst\n**HackerOne**","automated_response":false,"created_at":"2018-08-18T11:54:24.131Z","updated_at":"2018-08-18T11:54:24.131Z","actor":{"username":"thefrog","cleared":false,"url":"/thefrog","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/246/015/2eead02646771af4df7aa20c21edb7d5dc99d3da_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3222819,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @bayotop, Thank you for your report. We are working with our internal team to prioritize the fix for  #252908 and will be working with the team for this XSS new issue on prettyPhoto javascript module. We will get back once we receive an update on either of the above issues. Thanks much for your patience and for your report.\n\n@ristretto","automated_response":false,"created_at":"2018-08-20T22:21:33.889Z","updated_at":"2018-08-20T22:21:33.889Z","actor":{"username":"ristretto","cleared":false,"url":"/ristretto","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3222822,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2018-08-20T22:22:27.458Z","updated_at":"2018-08-20T22:22:27.458Z","actor":{"url":"/starbucks","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Starbucks"}},"bounty_amount":"250.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"starbucks","collaborator":{"username":"bayotop","url":"/bayotop"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4238399,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @bayotop,\n\nAre you still able to repro this issue? To me, it looks like the WAF is picking up and blocking the encoded quotes, but I'm having a hard time confirming whether the root cause has been fixed (I expect not).\n\nThanks,\n@shadegrown ","automated_response":false,"created_at":"2019-03-01T20:20:53.432Z","updated_at":"2019-03-01T20:20:53.432Z","actor":{"username":"shadegrown","cleared":false,"url":"/shadegrown","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/241/256/c58560470742940abd59de20f14746b5f8b2dcd2_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4300422,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown,\n\nNone of the root causes is fixed. You can verify that the injection in the link element is still possible via: `https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522`. The vulnerable `prettyPhoto` module is still there too. \n\nThe PoC is no longer working because the WAF is now triggering on `onclick=` in the path. This seems like a typical Starbucks fix :)\n\nFeel free to close this as resolved if you want (this was done in the past and I would submit a bypass as a new issue). If the team (hey Starbucks!) feels like fixing the root cause instead, please let me know. Thanks! ","automated_response":false,"created_at":"2019-03-11T14:23:37.873Z","updated_at":"2019-03-11T14:23:37.873Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4643627,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown, \n\nI was playing around with the current state and found a bypass eventually (Firefox):\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522on%2563lick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n \nThought I'd share it right away as a new issue doesn't really make sense in my opinion. Happy to add more information if you need any. ","automated_response":false,"created_at":"2019-04-25T18:14:43.146Z","updated_at":"2019-04-25T18:14:43.146Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4812617,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@bayotop I'm still not able to reproduce the issue. Can you please check if you can still repro the issue ?","automated_response":false,"created_at":"2019-05-10T22:10:22.388Z","updated_at":"2019-05-10T22:10:22.388Z","actor":{"username":"nitrobr3w","cleared":false,"url":"/nitrobr3w","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4812705,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @nitrobr3w,\n\nSeems that one of the root causes is fixed: `%2522` is no longer included back in the response as `\"` (the reflected URL is being trimmed). This implies that #252908 isn't reproducible either. For the sake of completeness, I'll have to mention that the vulnerable prettyPhoto library is still being used.","automated_response":false,"created_at":"2019-05-10T22:41:24.821Z","updated_at":"2019-05-10T22:42:58.697Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5019375,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @bayotop,\n\nThanks for hanging in there with us on this one! We really appreciate your patience. We have validated the fix and can no longer reproduce the issue, so I'm going to close this as resolved.\n\nThank you again for the report!\n@shadegrown ","automated_response":false,"created_at":"2019-06-06T20:31:33.068Z","updated_at":"2019-06-06T20:31:33.068Z","actor":{"username":"shadegrown","cleared":false,"url":"/shadegrown","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/241/256/c58560470742940abd59de20f14746b5f8b2dcd2_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"bayotop","url":"/bayotop"},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5020036,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown,\n\nI double-checked the fix and I'm still not able to reproduce. However, my last comment turns out to be incomplete. \n\nThe root cause seems to be addressed only on this one particular page that includes the prettyPhoto module (since the injection in `\u003clink rel=\"injection\"` happens site wide). I assume this is the reason why @252908 is still open. Just thought I'd mention that for the sake of completeness. Here's a link to demonstrate what I mean:\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything/a%2522`\n\nRegardless, I believe closing this as resolved is correct. Thank you and see you on the next one!","automated_response":false,"created_at":"2019-06-06T21:39:31.661Z","updated_at":"2019-06-06T21:40:05.654Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8079924,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-05-22T13:39:52.069Z","updated_at":"2020-05-22T13:39:52.069Z","first_to_agree":true,"actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8312571,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-06-16T21:21:07.477Z","updated_at":"2020-06-16T21:21:07.477Z","actor":{"username":"agedsumatra","cleared":false,"url":"/agedsumatra","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8312572,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-06-16T21:21:07.581Z","updated_at":"2020-06-16T21:21:07.581Z","actor":{"username":"agedsumatra","cleared":false,"url":"/agedsumatra","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":23025,"category":"team","content":"bayotop discovered a reflected DOM XSS on www.starbucks.co.uk.\n@bayotop â€” thank you for reporting this vulnerability and for confirming the resolution.","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":706273,"username":"agedsumatra","name":"agedSumatra","bio":"","cleared":false,"website":null,"location":"","created_at":"2019-08-12T17:50:49.926Z","url":"https://hackerone.com/agedsumatra","anc_triager":false,"hackerone_triager":false,"hackerone_employee":null,"user_type":"company","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c","xtralarge":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/c11036e2d3f8b05af4b5da5984ccdec6f786b763c8abceb4e68042e10dcdae85"}}},{"category":"researcher","can_view?":true,"can_create?":false}]}