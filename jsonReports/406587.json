{"id":406587,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MDY1ODc=","url":"https://hackerone.com/reports/406587","title":"Self DOM-Based XSS in www.hackerone.com","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2018-09-06T19:11:11.340Z","submitted_at":"2018-09-06T19:11:11.340Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"adac95","url":"/adac95","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-11-08T10:46:50.735Z","bug_reporter_agreed_on_going_public_at":"2018-11-08T10:46:50.641Z","team_member_agreed_on_going_public_at":"2018-11-07T18:51:29.870Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nThere is a 'self' DOM-based cross-site scripting vulnerability in the contact form available on the www.hackerone.com website. This could allow an attacker to perform cross-site scripting, or other client-side attacks, against users of the application. However, the risk presented by this issue is significantly reduced because exploitation would require an element of social engineering to succeed, and the website's Content Security Policy (CSP) blocked the execution of inline scripts.\n\n**Description:**\nThe HackerOne contact form is automatically displayed when the string  'contact/' is detected in the URI fragment on any page under the www.hackerone.com domain (for example, https://www.hackerone.com/#contact/). When the 'submit' button is clicked, the following JavaScript functions are executed:\n\n```javascript\n//Marketo Form Code\nfunction strip(html) {\n    var tmp = document.createElement(\"DIV\");\n    tmp.innerHTML = html;\n    return tmp.textContent || tmp.innerText || \"\";\n}\n\n$('form').submit(function() {\n    $('textarea').val(function() {\n        return strip($(this).val());\n    });\n});\n```\nThe 'submit' event handler passes the current value of any 'textarea' elements to the 'strip' function. This function creates a new 'div' element, sets the 'innerHTML'  property to the provided value, and then returns the 'textContent' property of the resulting div. This type of code is typically used to remove HTML tags from a string, as the textContent property contains the String which was rendered by the browser when the HTML was parsed. (A reference to this exact function was also found on Stack Overflow: https://stackoverflow.com/questions/12941663/removing-html-tags-from-a-string-and-keeping-colon) \n\nHowever , this particular method is inherently insecure because it uses 'innerHTML'. When user input is provided to the 'innerHTML' property, it is parsed by the web browser and can therefore lead to the execution of malicious JavaScript. A screenshot has been attached to this report showing the result in the web browser when the following payload was typed into the 'Message' textarea of the HackerOne contact form, and the 'send message' button was clicked:\n\n```html\n\u003cimg src=x onerror=alert(1) /\u003e\n```\nThe developer console (in Google Chrome) displayed two errors - one which stated that https://www.hackerone.com/x was requested and returned a 404 (due to the src attribute of the img tag), and another which reported a violation of the website's CSP. This second error occurred because the browser attempted to execute the JavaScript code in the 'onerror' attribute, but the website's CSP did not allow it. Performing the same actions in a browser with CSP disabled allowed the JavaScript in the 'onerror' attribute to execute.\n\nAn attacker could exploit this vulnerability by convincing a user (ideally with a browser which does not support CSP) to paste a malicious payload into the 'message' field of the contact form and then click the 'send message' button.\n\nIt should also be noted that, if the 'strip' function was implemented to prevent an attacker from sending malicious HTML to Marketo or the server, it can be trivially bypassed using an intercepting proxy tool such as Burp Suite. By intercepting the HTTP request sent once the form submission is complete, any HTML 'stripped' by the JavaScript can simply be replaced. In light of this, developers should consider whether the 'strip' function is required - any validation or sanitization should  be performed by the server, where it cannot be influenced by an attacker.\n\nIf the 'strip' function is required, it is recommended that it is replaced with a solution which does not require the use of 'innerHTML'. A suitable alternative may be the use of a regex to remove common HTML characters.\n\n### Steps To Reproduce\n\n1. Open the https://www.hackerone.com/#contact/ page and open the browser's developer tools\n2.  Type \"\u003cimg src=x onerror=alert(1) /\u003e\" into the 'message' textarea\n3.  Click the 'send message' button\n4. Check the developer console to view the two errors\n\n(alternatively, disable CSP in your web browser and repeat the steps above. The JavaScript code 'alert(1)' should execute)\n\n## Impact\n\nThe attacker could achieve XSS in the www.hackerone.com website.","weakness":{"id":63,"name":"Cross-site Scripting (XSS) - DOM"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":343117,"file_name":"self-XSS.PNG","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/343/117/4a6c2b7af987bf851a33e53be22dda1e7565ce5a/self-XSS.PNG?response-content-disposition=attachment%3B%20filename%3D%22self-XSS.PNG%22%3B%20filename%2A%3DUTF-8%27%27self-XSS.PNG\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ67VGDS6J%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T145650Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIBUTJ%2BNbh3iGCDafndtBQHkqG1OchqwWgdsmguvhgcLdAiAZVuUXVW1VaXDOlTKJW4MkHKw5%2BpgOTsVzeaztjAVXniqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMAWL4B0QSi4hczgSpKtcD3VOAKPL2y75%2FC3vWJu4CxM2H0MhpokFUEt9l4V7Gq%2BkP2JZRIvSX1xKqm2Gk%2BJRjjqXa9QVImay%2FdjekrRmCYTSSDt9dxM0L0oVJr7N6F8ODRv2P7lMfnzU0QMlpmHbiPpiQb5vSlaxU6jX1ESO3u1VQpKIm%2B7BGH6YiJgHcf9pDdPJ24QxGmfk3jwQevnf60P1KEwb1KLJ2JtKpPhawQ8CP%2Fp%2B8Udd6EL0VEe2hP01M49Skdizp3cnpjBBz%2FKaJPQOVb%2FxLwhTaiAm4Gs7LWex0SieNQGn7QnS8LjaHWQ69N6yv2yl5daZ0uO8CMISq44OuSORn5NNfE6Wx49Y1QtLur%2BY0bpfImT2%2Bc3AvhGI16NMEhk5qpUfU2p6NU4IF0P6m2durenSRqQWtxyQafE31VSJU%2FhpOLcgkiLcYO84tTOPewOIMl9iBrNtCggjBX8%2FrEvRnKduv0F4uzhgiTrLXMqiHsoMRJfAlsnKSaskF2MN%2FW8oUK%2Fx2WHxpYJSGLi98vCnAnrjkI1O0VdepFdfxg4xzpi25EpMuF10ISO7%2BOVlPuH4gcxSmKXq2nnWHAyNBbYGCcXKMdnH%2BrKVSQO3JfLw8lTFoTNA9axFJVvLPV3N6%2FondMJKHkYsGOqYBXTEQgnOCUR6Njz81XybrbzJvU1Pc2hk4bMTrt1%2BCSeA%2FbFO392%2FoWlFJGmK4bl3JexiICV3H2r69Blx%2FAIbSxJ4%2Bl1Ric4x9veCmMmxtb3M7uvCDvG9rrJjEd5V99ttvzT1tURyLC0o%2FETycAhpeR4E%2BNiVWXOm1S8L2NA83yPbiobo0yaywdayHxWpEhNSXoJ8gkKAiNtIC0AZekCrrrdnKzbLEBw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=baff9569c7a27af0c1c90b704185e2b0d77cc7c00f841054f4f3a0cca056fbfa","file_size":84297,"type":"image/png"}],"allow_singular_disclosure_at":"2018-12-07T18:51:30.010Z","allow_singular_disclosure_after":-89755520.61807288,"singular_disclosure_allowed":true,"vote_count":22,"voters":["sameerphad72","romesful","ali","0nlymohammed","eveeez","an0nym0us","khizer47","t4ym","bb00x","japz","and 12 more..."],"severity":{"rating":"low","author_type":"User"},"structured_scope":{"databaseId":6,"asset_type":"URL","asset_identifier":"https://www.hackerone.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3303152,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"This fix originated from #220009. Given the CSP is in place and this is a self XSS I'm leaning towards us accepting this risk. It seems like there should be an easy fix to this though. Do you have an idea on a more accepted html striping approach that works in these cases?","automated_response":false,"created_at":"2018-09-06T20:32:30.475Z","updated_at":"2018-09-06T20:32:30.475Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3303218,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"That's interesting, I hadn't seen this report before.\n\nIs this the only change Marketo made to address this bug? Or were there changes made to the backend? I would assume that, if no other changes were made, an attacker could still exploit the SSRF (or HTML injection) on the backend by adding the HTML back in to their request, or by overriding the strip function in their browser to do nothing. The strip function is a client-side control after all, and an attacker can therefore still modify the request after the strip function has made its changes.\n\nThe only way to prevent the HTML injection described in 220009 would be to check the message contents on the server-side and encode the HTML there, before using it anywhere else. I've just used Burp to add an img tag to a message sent in the contact form and I am monitoring for requests to see if the HTML injection is still exploitable. I'll let you know if I get anything back.\n\nMy suggestion would be to remove the strip function entirely (eliminating the self XSS) and clarify whether Marketo added a protection for the previous vulnerability on the server-side.","automated_response":false,"created_at":"2018-09-06T20:53:10.296Z","updated_at":"2018-09-06T20:53:10.296Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3308354,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @adac95 - \n\nWe have confirmed with Marketo that the original SSRF vulnerability was mitigated by enabling HTML encode token in the settings. \n\nThis is their response:\n\u003e Marketo has a setting to HTML encode tokens used in Marketo emails. Customers can control this setting themselves in Admin \u003e Field Management \u003e Field Actions \u003e HTML Encode Settings. We also have a feature slated for Q4 to make the default of this option ON for all customers (still with ability to override at the field level for customers who want to use HTML in a token).\n\u003e \n\u003e If token contents within emails are set to be HTML-encoded, there’s not much more we can do other than “clean” content when it comes into Marketo. That’s a long-term goal but I wouldn’t say it is in any way critical. Using the features described above, should resolve these concerns.\n\nGiven this, we think it makes sense to remove our home-brewed `strip()` function. Do you see any problem with the removal? \n","automated_response":false,"created_at":"2018-09-07T17:49:52.196Z","updated_at":"2018-09-07T17:53:59.748Z","actor":{"username":"pei","cleared":false,"url":"/pei","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/939/2d83322336a492279dc84d8f92f280c2d54fcb5b_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3309015,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @pei,\n\nThanks for clarifying. Given it is trivial to bypass the strip function, and any HTML tags sent in the contact form by an attacker will be encoded by the Marketo server, I am confident that it can be safely removed.\n\nIf it helps, I retested the original SSRF vulnerability by bypassing the strip function and did not receive any requests to my server. This suggests to me that the HTML encoding performed by Marketo is working as intended.","automated_response":false,"created_at":"2018-09-07T20:47:02.877Z","updated_at":"2018-09-07T20:47:02.877Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3338739,"is_internal":false,"editable":false,"type":"Activities::SwagAwarded","message":"Hi @adac95 -\n\nThanks for verifying! There isn't a real attack scenario here, though we really appreciate your creative finding and have decided to award you swag. \n\nHappy Friday!\n-Pei","automated_response":false,"created_at":"2018-09-14T16:47:40.743Z","updated_at":"2018-09-14T16:47:40.743Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"reporter":{"username":"adac95","url":"/adac95"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3338741,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","automated_response":false,"created_at":"2018-09-14T16:47:53.661Z","updated_at":"2018-09-14T16:47:53.661Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3347288,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you @pei! ","automated_response":false,"created_at":"2018-09-17T09:35:18.927Z","updated_at":"2018-09-17T09:35:18.927Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3552878,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @adac95 - thanks again for bringing this to our attention! This should be resolved by now. Can you confirm this? Thanks!","automated_response":false,"created_at":"2018-10-29T23:37:14.119Z","updated_at":"2018-10-29T23:37:14.119Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"adac95","url":"/adac95"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3586147,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jobert, sorry for the delay! I have just taken another look at the main contact form and it seems that this is fixed. The old strip() function has been removed and I can no longer cause HTML to be injected into the page.\n\nIt looks like there are still some client-side sanitisation functions though. For example, this function is used on the HackerOne Go contact form (https://www.hackerone.com/hackerone-go):\n\n```javascript\nMktoForms2.loadForm(\"//app-sj17.marketo.com\", \"168-NAU-732\", 1079);         \nMktoForms2.whenReady(function (form){\n  vals = form.vals();\n  $('#preview-modal').click(function() {        \n    $('strong.company').each(function () {\n      $(this).text($('input#Company').val()?$('input#Company').val():\"Your Company\"); \n    })\n    var tmpDiv = jQuery(document.createElement('div'));\n    var sanitizedDomains = [];\n\n    var unsanitizedDomains = $('textarea#Customer_Defined_Scope__c').val().split('\\n');\n    for (var i = 0 ; i \u003c unsanitizedDomains.length ; i++) {\n      sanitizedDomains.push(tmpDiv.text(unsanitizedDomains[i]).html());\n    }\n    $('ul.scope li').remove();\n    $.each(sanitizedDomains, function(){\n      $('ul.scope').append('\u003cli\u003e'+this+'\u003c/li\u003e');\n    });\n    $('#preview').dialog({\n      title: \"Preview\",\n        buttons: {\n            Ok: function () {\n                $(this).dialog('close');\n            }\n        },\n        modal: true,\n        width: \"80%\"\n    });\n    return false; \n  })\n```\nHowever, the use of JQuery's text() on the user's input means that this can't be used to inject HTML into the page.  I don't see the value in encoding a user's input before a request but this appears to be a safe way to do it.","automated_response":false,"created_at":"2018-11-05T09:18:13.684Z","updated_at":"2018-11-05T09:18:13.684Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3602503,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi @adac95 - thanks for confirming the fix. We believe that this is ready to be disclosed!","automated_response":false,"created_at":"2018-11-07T18:51:29.918Z","updated_at":"2018-11-07T18:52:34.920Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3608491,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-11-08T10:46:50.680Z","updated_at":"2018-11-08T10:46:50.680Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3608492,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-11-08T10:46:50.760Z","updated_at":"2018-11-08T10:46:50.760Z","actor":{"username":"adac95","cleared":false,"url":"/adac95","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}