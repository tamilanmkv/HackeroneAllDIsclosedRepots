{"id":4114,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MTE0","url":"https://hackerone.com/reports/4114","title":"Persistent XSS: Editor link","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-03-16T11:30:47.494Z","submitted_at":"2014-03-16T11:30:47.494Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"tomvg","url":"/tomvg","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2014-04-16T20:02:21.407Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-03-17T20:04:33.019Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The editor link used for external applications allows scheme other than `http:` or `https:`.  Although the `phutil_tag` function checks whether the scheme is `javascript:` to prevent XSS attacks ([see GitHub](https://github.com/facebook/libphutil/blob/6b1066f7c0b34f5a485ad5d8af57792b3acae4d9/src/markup/render.php#L19)), it is straightforward to bypass this check by adding a whitespace character in between `javascript` and `:`.  For instance, clicking a link with the following value for the `href` attribute will execute arbitary JavaScript code: \r\n\r\n```\r\njavascript\r\n:alert('xss')\r\n``` \r\n(note the newline character between `javascript` and `:`).\r\n\r\n# Replication steps:\r\n\r\n* Go to `settings/panel/display/`\r\n* Press \"Save\" with network panel of console active\r\n* Copy the POST request as cURL\r\n* Use `curl` to set the `editor` parameter to `javascript%0A%3Aalert%281%29` (this is not possible to do in the browser as it strips these characters from input fields)\r\n* Go to a repository, and click \"Edit\", you should now see an alert box pop up\r\n\r\n# Attack scenarios\r\n\r\nAlthough the JavaScript code will only be executed on the user's own account, several attack scenarios are possible:\r\n\r\n1. A temporary account take-over would allow the attacker to set the editor link to include JavaScript code. Even when the victim manages to recover his account, clicking on the \"Edit\" link will  give the attacker again control over the account.\r\n2. Several login-csrf were found in Phabricator, so an attacker could have abused this (or abuse it if a similar issue arises) to login the victim into his account. The attacker could use the XSS to trick the victim into entering his own credentials\r\n\r\n# Proposed fix\r\n\r\nIn the `phutil_tag` function, first filter all non-alphanumerical characters of `$href` and then check whether it starts with `javascript:`.","bounty_amount":"300.0","formatted_bounty":"$300","weakness":{"id":60,"name":"Cross-site Scripting (XSS) - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2014-04-16T19:02:13.954Z","allow_singular_disclosure_after":-236289314.5402023,"singular_disclosure_allowed":true,"vote_count":5,"voters":["realtess","fantam1","cryptographer","khleymu_da","omaratik123"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":17158,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hmm. It looks like Safari and Firefox don't interpret \"javascript\\n:alert(1)\" as Javascript (am I setting things up wrong?), but Chrome does. IE11 also does.","automated_response":false,"created_at":"2014-03-16T13:44:56.003Z","updated_at":"2014-03-16T13:44:56.003Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17160,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That seems correct, Opera also does.\nSee [shazzer fuzz db](http://shazzer.co.uk/database/All/Characters-after-javascript-uri)\n\nNote that a character that is not matched by `\\s` in PCRE may be prepended as well; again see [fuzz db](http://shazzer.co.uk/database/All/Characters-before-javascript-uri).","automated_response":false,"created_at":"2014-03-16T14:04:18.425Z","updated_at":"2014-03-16T14:04:18.425Z","actor":{"username":"tomvg","cleared":false,"url":"/tomvg","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":17164,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, that's helpful. I think this should fix it:\n\nhttps://secure.phabricator.com/D8548\n\nMaybe we should also whitelist editor protocols and give administrators configuration to control that. I'm hesitant to lock it down too much since I don't want to prevent users from using it with weird/obscure/future editors, but as long as administrators could configure it we could probably create a reasonable whitelist. I could imagine the editor feature opening up other attacks in the future that we don't really need to be exposed to (we do already whitelist protocols allowed in links).","automated_response":false,"created_at":"2014-03-16T14:30:56.578Z","updated_at":"2014-03-16T14:30:56.578Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17334,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That patch seems to fix the reported problem.\n\nA whitelist seems like a good idea: it should also prevent some phishing attacks after temporary account compromise (e.g. URLs with `data:` scheme or external phishing websites could trick a user into re-entering his credentials). ","automated_response":false,"created_at":"2014-03-17T13:02:13.246Z","updated_at":"2014-03-17T13:02:13.246Z","actor":{"username":"tomvg","cleared":false,"url":"/tomvg","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":17438,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The `javascript:` fix is in HEAD; this should whitelist editor protocols:\n\nhttps://secure.phabricator.com/D8551\n\nI'll close this out once that lands.","automated_response":false,"created_at":"2014-03-17T19:00:25.153Z","updated_at":"2014-03-17T19:00:25.153Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17452,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This should now be fixed in HEAD.","automated_response":false,"created_at":"2014-03-17T20:02:14.045Z","updated_at":"2014-03-17T20:02:14.045Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"tomvg","url":"/tomvg"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17454,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"I'm assessing this as relatively low-severity because it's self-XSS only and the user must click a fairly obscure link after being XSS'd.","automated_response":false,"created_at":"2014-03-17T20:04:12.669Z","updated_at":"2014-03-17T20:04:12.669Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"tomvg","url":"/tomvg"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17455,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This can be disclosed publicly at any time. Thanks for the report!","automated_response":false,"created_at":"2014-03-17T20:04:33.031Z","updated_at":"2014-03-17T20:04:33.031Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":31511,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2014-04-16T20:02:21.583Z","updated_at":"2014-04-16T20:02:21.583Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}