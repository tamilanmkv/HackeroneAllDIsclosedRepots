{"id":454,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NTQ=","url":"https://hackerone.com/reports/454","title":"PNG compression DoS","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2013-11-23T21:21:28.099Z","submitted_at":"2013-11-23T21:21:28.099Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"beurtschipper","url":"/beurtschipper","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/625/dd7df1c933e04d0149bf0b5760a04212cf881c70_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-05-28T04:45:07.299Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2015-04-28T04:44:55.488Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"[ztxt]: http://www.libpng.org/pub/png/spec/1.1/PNG-Chunks.html#C.zTXt \"zTXT Documentation\"\r\n[tech]: http://www.zlib.net/zlib_tech.html \"zlib technical details\"\r\n[zlibvuln1]: http://www.kb.cert.org/vuls/id/680620\r\n[zlibvuln2]: http://www.kb.cert.org/vuls/id/238678\r\n\r\n\r\nPNG compression DoS\r\n---------------------\r\n Because I did JPEG and GIF I just had to check out the PNG format.\r\n\r\nFound\r\n---------------------\r\nA PNG file is composed of multiple chunks.\r\nOne of the optional ancillary chunks is called zTXT ([ztxt]).\r\nThis chunk allows storage of compressed text data using the zlib library.\r\nFrom the zlib [tech] details:\r\n\"The test case was a 50MB file filled with zeros; it compressed to roughly 49 KB\"\r\nI used this to store a huge amount of data in a small PNG (smaller than 1 MB). When sent to HackerOne the service timed out. I think it's because Paperclip tried to `identify` and `convert` my image again.\r\n\r\nAs a attachment I sent the Python code I made to create the PNG, and the PNG itself. \r\nUsage: python createpng.py filename\r\n\r\nFixes\r\n---------------------\r\nFor an easy fix every PNG file with the string \"zTXt\" in it should be rejected. Other data chunks may be exploitable, but I haven't looked into them yet. When this bug is fixed I will continue my research.\r\n\r\nTheory\r\n---------------------\r\nMake sure your zlib library is updated . Because of old exploits in zlib's inflate() ([zlibvuln1], [zlibvuln2]), attackers might make a PNG that can exploit old machines. ","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":146,"file_name":"createpng.zip","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/000/146/4f72baa7a817e1559a6a8d003653bcfc5dc3ccc2/createpng.zip?response-content-disposition=attachment%3B%20filename%3D%22createpng.zip%22%3B%20filename%2A%3DUTF-8%27%27createpng.zip\u0026response-content-type=application%2Fzip\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T150153Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=5c4c05dcdb2793e5e8dcd62e8b61c8be5936d89902d0aecb005a78396fca0a67","file_size":2327,"type":"application/zip"},{"id":147,"file_name":"txt.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/000/147/ffd01cd906c010211aa7d22a83251cdbde2c108b/txt.png?response-content-disposition=attachment%3B%20filename%3D%22txt.png%22%3B%20filename%2A%3DUTF-8%27%27txt.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T150153Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=bca33bb1a289b35caaf56a95497f2e050477bb02aa0e31ed068d3462cc9295de","file_size":782881,"type":"image/png"}],"allow_singular_disclosure_at":"2015-05-28T04:44:56.144Z","allow_singular_disclosure_after":-201176217.18969944,"singular_disclosure_allowed":true,"vote_count":12,"voters":["sw33tlie","ali","kieran","khizer47","trieulieuf9","japz","sa1tama0","cryptographer","shaaan","nigba","and 2 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2500,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks â€“ nice one. I tried to reproduce the bug by uploading the crafted image. It does have impact on the server's resources, but the impact is not as significant as the previous two bugs (memory exhaustion and intensive CPU usage). The server is able to finish the job without running out of resources. The timeout is probably caused by the server not being able to respond with an answer before the default timeout expires.\n\nWe'll experiment with the Python script you provided to see if it's possible to create a PNG that will actually significantly impact server performance. We'll keep you posted!\n\nThanks again!","automated_response":false,"created_at":"2013-11-25T02:56:55.727Z","updated_at":"2013-11-25T02:56:55.727Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2513,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"No problem! You could try the compressobj  function to create bigger zip blocks:\r\n\r\n\u003ekeyword = ['\\x41', '\\x00']\r\n\u003e\r\n\u003eimport zlib\r\n\u003e\r\n\u003ecompobj = zlib.compressobj(9)\r\n\u003e\r\n\u003edat = 'a' * 0xfffff\r\n\u003e\r\n\u003ed = b''\r\n\u003efor i in range(1000):\r\n\u003e[tab] d += compobj.compress(dat)\r\n\u003ed += compobj.flush(4)\r\n\u003e\r\n\u003ecompdata = []\r\n\u003ecompdata += [i for i in d]\r\n\u003e\r\n\u003ecreatepng.write_chunk(typearr['zTXt'], keyword +['\\x00'] +compdata,f)\r\n\r\nBut you're right about it not being as significant as the previous bugs. When I try to `identify` the image on my computer, ImageMagick notices the memory exhaustion and quits before the program actually fills up memory.","automated_response":false,"created_at":"2013-11-25T18:03:51.243Z","updated_at":"2013-11-25T18:10:09.883Z","actor":{"username":"beurtschipper","cleared":false,"url":"/beurtschipper","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/625/dd7df1c933e04d0149bf0b5760a04212cf881c70_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3035,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Sipke - quick update from our side. We decided to offload image processing to a different machine (so it can't impact our application servers anymore). That way we have a lot more control over the amount of resources each job uses.\n\nIt's not at the top of our list right now, so it'll probably take some time before we make that move. We'll keep you posted!","automated_response":false,"created_at":"2013-12-08T02:10:37.614Z","updated_at":"2013-12-08T02:10:37.614Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3197,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Sipke, here's a quick update. We plan on doing a few server upgrades in the first few weeks of 2014. These upgrades allow us to constrain resources for ImageMagick. This mitigates the attack you described. Will keep you posted!","automated_response":false,"created_at":"2013-12-23T18:22:16.866Z","updated_at":"2013-12-23T18:22:16.866Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":22218,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @dutchgraa - sorry for the extreme delay in bringing you another update. We actually had to reprioritize this and pushed the operating system upgrade a few weeks forward. We've documented a pretty solid upgrade path for our complete environment and we aim to have that completed this month :). Let me know if you have any further questions.","automated_response":false,"created_at":"2014-04-01T14:10:33.287Z","updated_at":"2014-04-01T14:10:33.287Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":60886,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @dutchgraa, we're currently testing a fix for this in our testing environment. This bug proved harder to fix/mitigate than expected.\n\nWe currently mitigate it by limiting the resources that ImageMagick can use. There are a lot of images that represent a potential dos, so we chose to go this route.","automated_response":false,"created_at":"2014-05-29T10:34:31.257Z","updated_at":"2014-05-29T10:34:31.257Z","actor":{"username":"jjoos","cleared":false,"url":"/jjoos","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/059/21840b8ea35224c071947ddcac0b9eb0801e0235_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":68462,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"A fix for this bug and other potential image processing DOS vulnerabilities is now live in production. Thanks for reporting this @dutchgraa! Sorry again for the delay in getting a fix out for this.","automated_response":false,"created_at":"2014-06-06T23:45:39.476Z","updated_at":"2014-06-06T23:45:39.476Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"beurtschipper","url":"/beurtschipper"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":68463,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2014-06-06T23:46:08.659Z","updated_at":"2014-06-06T23:46:08.659Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"security","collaborator":{"username":"beurtschipper","url":"/beurtschipper"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":68601,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Great thanks!","automated_response":false,"created_at":"2014-06-07T06:44:05.492Z","updated_at":"2014-06-07T06:44:05.492Z","actor":{"username":"beurtschipper","cleared":false,"url":"/beurtschipper","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/625/dd7df1c933e04d0149bf0b5760a04212cf881c70_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":392177,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-04-28T04:44:55.573Z","updated_at":"2015-04-28T04:44:55.573Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":402791,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2015-05-05T21:28:32.726Z","updated_at":"2015-05-05T21:28:32.726Z","additional_data":{"old_title":"A PNG in the ass","new_title":"PNG compression DoS"},"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":430154,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-05-28T04:45:07.412Z","updated_at":"2015-05-28T04:45:07.412Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}