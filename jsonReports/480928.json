{"id":480928,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80ODA5Mjg=","url":"https://hackerone.com/reports/480928","title":"Username restriction bypass with SSL client authentication","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-01-16T12:58:11.495Z","submitted_at":"2019-01-16T12:58:11.495Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"halfdog","url":"/halfdog","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/468/805/142d9cf56d5706ce90faefc13b7fa095b28ad9c8_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2019-3814"],"singular_disclosure_disabled":true,"disclosed_at":"2019-02-13T16:52:00.569Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2019-02-05T12:31:20.584Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\n\nDovecot supports enforcing the login user name to be the one encoded in the SSL client certificate, thus restricting the username. Using SSL certificates that do not even contain the relevant field bypasses this restriction, maybe leading to full login bypass under some (luckily rare) conditions.\n\n**Description:**\n\nAccording to [0] SSL client certificate authentication may be used to force a username, thus a user in posession of a valid client certificate may only authenticate as the user named in the certificate:\n\n\"\"\"You may also force the username to be taken from the certificate by setting auth_ssl_username_from_cert = yes.\n....\nYou may also want to disable the password checking completely. Doing this currently circumvents Dovecot's security model so it's not recommended to use it, but it is possible by making the passdb allow logins using any password (typically requiring \"nopassword\" extra field to be returned).\"\"\"\n\nWhile the text suggests, that the user cannot select another user identity, only the one encoded in the certificate is used. Thus\n\na) only accounts with corresponding valid certificates can be accessed and\n\nb) with \"nopassword\" a client-certificate only authentication procedure can be established.\n\nBy using a client certificate signed by one of the CAs registered in Dovecot (e.g. a stolen webserver certificate or internal system certificate issued by the organisation's own internal CA, or - in my case: an older version of the client SSL certificate issued prior to turning the setting on and only new certificates now containing the additional field) and that other certificate does not contain the required field to encode the username (e.g. \"x500UniqueIdentifier\"), then the client may submit any username via pop protocol. Together with certificate-only-auth (nopassword) any account can be accessed without password.\n\n## Releases Affected:\n\nThe issue described here was reproduced with Debian Buster, \"dovecot-pop3d 1:2.3.4-2\". If source code was understood correctly, it should also apply to imap-SSL, but that was not tested yet. See [1]. It seems, that the logic checks first if there is any user name to enforce and only if so, assigns it. Certificates without encoded username will always fail the \"strcmp(key, \"cert_username\")\" check.\n\n'''\nbool auth_request_import_auth(struct auth_request *request,\n\t\t\t      const char *key, const char *value)\n{\n\ti_assert(value != NULL);\n\n\tif (auth_request_import_info(request, key, value))\n\t\treturn TRUE;\n\n\t/* auth client may set these */\n\tif (strcmp(key, \"secured\") == 0) {\n\t\tif (strcmp(value, \"tls\") == 0)\n\t\t\trequest-\u003esecured = AUTH_REQUEST_SECURED_TLS;\n\t\telse\n\t\t\trequest-\u003esecured = AUTH_REQUEST_SECURED;\n\t}\n\telse if (strcmp(key, \"final-resp-ok\") == 0)\n\t\trequest-\u003efinal_resp_ok = TRUE;\n\telse if (strcmp(key, \"no-penalty\") == 0)\n\t\trequest-\u003eno_penalty = TRUE;\n\telse if (strcmp(key, \"valid-client-cert\") == 0)\n\t\trequest-\u003evalid_client_cert = TRUE; \n\telse if (strcmp(key, \"cert_username\") == 0) {\n\t\tif (request-\u003eset-\u003essl_username_from_cert) {\n\t\t\t/* get username from SSL certificate. it overrides\n\t\t\t   the username given by the auth mechanism. */\n\t\t\trequest-\u003euser = p_strdup(request-\u003epool, value);\n\t\t\trequest-\u003ecert_username = TRUE;\n\t\t}\n\t} else {\n\t\treturn FALSE;\n\t}\n\treturn TRUE;\n}'''\n\n## Steps To Reproduce:\n\nGenerate certificates with and without the \"x500UniqueIdentifier\" field.\n\nFollowing authentication/SSL settings were applied to Dovecot for testing.\n\n```protocols = pop3\ndisable_plaintext_auth = yes\nauth_ssl_require_client_cert = yes\nauth_ssl_username_from_cert = yes\nssl = required\nssl_cert = \u003c[keydir]/main.cert\nssl_key = \u003c[keydir]/main.key\nssl_ca = \u003c[keydir]/ca.certs\nssl_require_crl = yes\nssl_verify_client_cert = yes\nssl_cert_username_field = x500UniqueIdentifier\npassdb {\n  driver = pam\n}\nuserdb {\n  driver = passwd\n}\n\n# Replace PAM from above with this setting to test the \"nopassword\" use case.\npassdb {\n  driver = static\n  args = nopassword=y\n}```                                      \n\n## Supporting Material/References:\n\n* [0] https://wiki.dovecot.org/SSL/DovecotConfiguration\n* [1[ https://raw.githubusercontent.com/dovecot/core/master/src/auth/auth-request.c\n\n## Impact\n\nWhen attacker gains access to any eligible SSL certificate (and private key) he may bruteforce any login or login as any user (with nopassword). He may then read/delete/modify any messages found on server.\n\nAs the attacker has still to be able to access at least one valid client certificate (and private key), following attack cases might be most relevant:\n\n* The owner of the service \"upgrades\" to enforcing username by use of the SSL client name and reissues client certificates for his userbase. Assuming that enabling the Dovecot setting will tigthen security, he might not revoke the old certificates, e.g. to avoid having large CRLs for certifificates expiring in near future (maybe he even tried but the CRL was not copied to the server) or because users still use the old certificate for other protocols, e.g. SMTP sending, VPN. Thus any of those older but still valid certificates can be used as skeleton key to bypass the username check and maybe authentication (nopassword).\n\n* An attacker stole any non-dovecot-login SSL certificate and key signed by the CA registered in Dovecot, e.g. a webserver certificate, certificates deployed in devices with higher risk of theft, e.g. WLAN routers, smartphone with certificate based WLAN authentication.\n\n* The dovecot maintainer for some reason accidentially (or even on purpose - but that would be security by obscurity) configured an external CA, e.g. Thawte for client certificate checks. Any person who is allowed to purchase such a certificate may now access the service.","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-03-07T12:31:20.657Z","allow_singular_disclosure_after":-82002785.89261222,"singular_disclosure_allowed":true,"vote_count":26,"voters":["8ayac","ali","theappsec","an0nym0us","apapedulimu","kunal94","khizer47","luckydivino","cyberunit","cr4xerbik4sh","and 16 more..."],"severity":{"rating":"high","score":8.2,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"none"}},"structured_scope":{"databaseId":42899,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/dovecot/core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3987464,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi! Thank you for reporting this issue. We are looking into this.","automated_response":false,"created_at":"2019-01-16T15:48:54.889Z","updated_at":"2019-01-16T15:48:54.889Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3987470,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","automated_response":false,"created_at":"2019-01-16T15:50:11.246Z","updated_at":"2019-01-16T15:50:11.246Z","cve_ids":["CVE-2019-3814"],"actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3987602,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2019-01-16T16:16:56.477Z","updated_at":"2019-01-16T16:16:56.477Z","additional_data":{"old_severity":"High (8.1)","new_severity":"High (8.2)","old_severity_id":280781,"new_severity_id":280844},"actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4009995,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2019-01-21T07:37:37.553Z","updated_at":"2019-01-21T07:37:37.553Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"halfdog","url":"/halfdog"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4096033,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you for reporting this issue!","automated_response":false,"created_at":"2019-02-05T12:30:46.996Z","updated_at":"2019-02-05T12:30:46.996Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"halfdog","url":"/halfdog"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4096043,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-02-05T12:31:20.617Z","updated_at":"2019-02-05T12:31:20.617Z","first_to_agree":true,"actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4143333,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sorry, I'm not sure, who is responsible for this issue at the moment. Even if I have not button e.g. \"confirm disclosure request\", it could be me (inferred from the time delay the issue is in this state).\n\nIf so, is this verbal statement sufficient for disclosure? \"Please proceed at any pace you wish\"\n\nBTW: Changing the line\n\n\"[username] requested to disclose this report.\"\n\nto something like\n\n\"[username] requested to disclose this report (see disclosure standard operating procedure (SOP) [link])\"\n\nmight make taking appropriate actions easier for parties involved.","automated_response":false,"created_at":"2019-02-13T16:46:26.009Z","updated_at":"2019-02-13T16:46:26.009Z","actor":{"username":"halfdog","cleared":false,"url":"/halfdog","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/468/805/142d9cf56d5706ce90faefc13b7fa095b28ad9c8_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4143356,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I don't actually know =) but I'll pass your feedback to hackerone.","automated_response":false,"created_at":"2019-02-13T16:51:48.983Z","updated_at":"2019-02-13T16:51:48.983Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4143359,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","automated_response":false,"created_at":"2019-02-13T16:52:00.511Z","updated_at":"2019-02-13T16:52:00.511Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}