{"id":484745,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80ODQ3NDU=","url":"https://hackerone.com/reports/484745","title":"GoldSrc: Buffer Overflow in DELTA_ParseDelta function leads to RCE","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2019-01-23T18:31:17.741Z","submitted_at":"2019-01-23T18:31:17.741Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"pixelindigo","url":"/pixelindigo","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":23363,"url":"https://hackerone.com/valve","handle":"valve","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Valve","twitter_handle":"","website":"https://www.valvesoftware.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2021-05-04T19:29:19.947Z","bug_reporter_agreed_on_going_public_at":"2020-10-14T21:34:04.892Z","team_member_agreed_on_going_public_at":"2021-05-04T19:29:19.764Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","bounty_amount":"3000.0","formatted_bounty":"$3,000","weakness":{"id":4,"name":"Stack Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":25,"voters":["nightshiba","njbooher","drsniper","mvc","spam404","romesful","ali","fe7ch","theappsec","cryptographer","and 15 more..."],"severity":{"rating":"critical","score":9.6,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":{"databaseId":1289,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"hl.exe","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":4026829,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-01-23T20:42:21.120Z","updated_at":"2019-01-23T20:42:21.120Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4029095,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-01-24T07:09:01.945Z","updated_at":"2019-01-24T07:09:01.945Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4031693,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2019-01-24T15:31:40.785Z","updated_at":"2019-01-24T15:31:40.785Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4231558,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-02-28T19:06:01.029Z","updated_at":"2019-02-28T19:06:01.029Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4290942,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-09T09:46:50.197Z","updated_at":"2019-03-09T09:46:50.197Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4334012,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-15T20:21:40.821Z","updated_at":"2019-03-15T20:21:40.821Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4334152,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-15T20:51:35.406Z","updated_at":"2019-03-15T20:51:35.406Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4334815,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-16T00:33:24.724Z","updated_at":"2019-03-16T00:33:24.724Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4366620,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-21T14:24:44.261Z","updated_at":"2019-03-21T14:24:44.261Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4367367,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-21T16:39:32.274Z","updated_at":"2019-03-21T16:39:32.274Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4393586,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-26T14:16:39.867Z","updated_at":"2019-03-26T14:16:39.867Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4538890,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-04-11T12:52:37.386Z","updated_at":"2019-04-11T12:52:37.386Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4627538,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-04-23T16:06:45.740Z","updated_at":"2019-04-23T16:06:45.740Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4629894,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2019-04-23T21:31:55.469Z","updated_at":"2019-04-23T21:31:55.469Z","actor":{"url":"/valve","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Valve"}},"bounty_amount":"3000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"valve","collaborator":{"username":"pixelindigo","url":"/pixelindigo"},"actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4629896,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2019-04-23T21:32:14.624Z","updated_at":"2019-04-23T21:32:14.624Z","actor":{"username":"percybysshe","cleared":false,"url":"/percybysshe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/vuZfWG7XewsudrWa6NCkyxkZ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"pixelindigo","url":"/pixelindigo"},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4639329,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-04-25T06:47:12.540Z","updated_at":"2019-04-25T06:47:12.540Z","actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9525864,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-10-14T21:34:04.926Z","updated_at":"2020-10-14T21:34:04.926Z","first_to_agree":true,"actor":{"username":"pixelindigo","cleared":false,"url":"/pixelindigo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11616950,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-05-04T19:29:19.790Z","updated_at":"2021-05-04T19:29:19.790Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":11616951,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-05-04T19:29:19.997Z","updated_at":"2021-05-04T19:29:19.997Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":47932,"category":"team","content":"## Description\nThe bug is triggered by 2 packets.\nFirst one is `svc_deltadescription` which describes memory layout of such structures as `event_t`, `weapon_data_t`, ...\nIt is sent as a list of fields' descriptions: type, offset and others.\nNext, `DELTA_ParseDelta` fills these structures when corresponding delta packets are received. The problem is that this function doesn't check if `field_offset + field_size` doesn't exceed bounds of allocated memory for these structures which can lead to buffer overflow.\n\nTo actually trigger this overflow we need to send specially crafted delta information. I found that `svc_event` packet is parsed in `ParseEvent` function that allocates `event_t` structure on the stack and then fills it in vulnerable `DELTA_ParseDelta` function.\n\nUsing this info we can craft two packets that will triger stack overflow.\nIn my exploit I used following memory layout for `event_t` structure:\n```\npayload:\n  - type=String\n  - offset=0xac  # offset of return address in ParseEvent function\nint1:\n  - type=Integer\n  - offset=0xac + \u003cint1 offset in payload\u003e\n...\nintn:\n  - type=Integer\n  - offset=0xac + \u003cintn offset in payload\u003e\n```\nThe first field is used for the payload. Other extra integer fields are used to put data in the payload that has 2 or more zeros (for example 0x0b for syscall) since `DELTA_ParseDelta` copies string until it meets the null character `\\0`.\n\nNX is enabled, so it is not possible to execute shellcode on the stack or any other writable memory region directly. However, the main executable `hl` is loaded at the fixed address, which means we can build some ROPs without leaking addresses.\nI decided to take it one step further and build a rop chain to pop calc, so I checked other libraries and found `int 0x80` gadget in `hw.so`. Though, it will be loaded on different addresses on each run, which means that a rop chain has to calculate the base address of `hw.so` at runtime.\n\nI came up with the following rop chain (you can check the full one in the attached extra materials):\n1. Call `strncpy` to build `/usr/bin/xcalc` and `DISPLAY=:0` strings in .bss section from bytes that scattered across readonly sections\n2. Call `Sys_LoadModule(\"hw.so\")` to get its base address\n3. Prepare execve syscall arguments and jmp to int 0x80\n\n## Steps to reproduce\nThis poc exploit pops  `xcalc`. In my demo I used clean ubuntu 18.10, but it should work in other environments that have `/usr/bin/xcalc`.\n1. Make sure that you have python3 installed to run server\n2. Start server with `python3 poc.py` F411266  \n3. Launch Counter-Strike 1.6  \n4. Connect to 127.0.0.1  \n\nAfter these steps xcalc should pop up.\n\n\n## PoC Demo\n{F411267}\n\n## Impact\n\nRemote Code Execution on client.","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":279011,"username":"mikela","name":"Mike L","bio":"","cleared":false,"website":null,"location":"","created_at":"2018-05-17T22:06:50.780Z","url":"https://hackerone.com/mikela","anc_triager":false,"hackerone_triager":false,"hackerone_employee":null,"user_type":"company","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","xtralarge":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"}}},{"category":"researcher","can_view?":true,"can_create?":false}]}