{"id":497312,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80OTczMTI=","url":"https://hackerone.com/reports/497312","title":"Command injection by setting a custom search engine","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2019-02-17T16:00:52.893Z","submitted_at":"2019-02-17T16:00:52.893Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"peter_","url":"/peter_","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/138/324/94c560b36ae1a413b0c16f0f066405b8b8177f9d_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":36721,"url":"https://hackerone.com/notepad-plus-plus","handle":"notepad-plus-plus","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/721/b8be93879279f14a49e5051a1a2794575fb1f3f8_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/721/b8be93879279f14a49e5051a1a2794575fb1f3f8_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"disabled","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Notepad++","twitter_handle":"notepad_plus","website":"https://notepad-plus-plus.org","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-05-07T22:46:18.602Z","bug_reporter_agreed_on_going_public_at":"2019-04-07T22:46:08.755Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:** Arbitrary commands can be injected when using the \"Search on Internet\" function with a malicious custom search engine. The custom search engine can be set through the GUI or the config files, with different attack scenarios.\n\n**Description:** The \"Search on Internet\" context menu functionality calls the `ShellExecute` function with the current search engine as argument. This can lead to arbitrary command execution.\n\nBy setting a command or a program (e.g. `cmd.exe /c \"your_command_here\"`) the command will be passed to `ShellExecute` and will be run. After the malicious search engine is set, the command will be executed *every time* the \"Search on Internet\" context menu functionality is used, instead of opening a web page in a browser.\n\nThe consequence is that any actor that can succesfully set the custom search engine can make the user execute any command.\n\nThere are two ways to set the custom search engine:\n\n* in the GUI, from \"Settings\" \u003e \"Preferences\" \u003e \"Search Engine\"\n* from the `config.xml` file, by editing the following fields in the `GuiConfig` tag with `name=\"searchEngine\"`:\n\t* set `searchEngineCustom` to the command to execute\n\t* set `searchEngineChoice=0` to use the custom search engine\n\n## The vulnerability\n\nIn `PowerEditor\\src\\NppCommands.cpp`, line 452:\n\n```\n    case IDM_EDIT_SEARCHONINTERNET:\n    {\n[...]\n      if (nppGui._searchEngineChoice == nppGui.se_custom)\n      {\n[...]\n        {\n          url = nppGui._searchEngineCustom.c_str();\n        }\n      }\n[...]\n      Command cmd(url.c_str());\n      cmd.run(_pPublicInterface-\u003egetHSelf());  \n```\n\nIn `PowerEditor\\src\\WinControls\\StaticDialog\\RunDlg\\RunDlg.cpp`, line 169:\n\n```\nHINSTANCE Command::run(HWND hWnd)\n{\n[...]\n    HINSTANCE res = ::ShellExecute(hWnd, TEXT(\"open\"), cmd2Exec, args2Exec, TEXT(\".\"), SW_SHOW);\n```\n\n`::ShellExecute` is called on arguments that can be controlled by malicious users, without any validation.\n\nWhen a HTTP url is used as search engine, `ShellExecute` will see that the argument starts with \"http://\" or \"https://\" and open the default web browser. This is not guaranteed if the argument does not start with one of these two prefixes.\n\nThe `IDM_EDIT_SEARCHONINTERNET` code assumes that `url` is a well-formed HTTP url, but no checks are made to verify this. This makes it possible to pass arbitrary strings to `ShellExecute` and execute arbitrary commands for any actor that can modify the custom search engine.\n\n\n## Steps To Reproduce:\nIn our proof of concept, we chose to open a calculator by providing `cmd.exe /c calc.exe` as custom search engine.\n\n  1. Copy the provided `config.xml` file to `%APPDATA%\\Notepad++`\n  2. Run Notepad++\n  3. Right-click anywhere in the text field\n  4. Select \"Search on Internet\"\n\nThe default Windows calculator will open.\n\n## Suggested fix\nA possible fix is to check if the url actually starts with \"http://\" or \"https://\" when executing the \"Search on Internet\" function, before the `cmd.run` call.\n\nThis should guarantee that the default web browser will be opened instead of running arbitrary commands (NB: no filename can contain `:` or `/` on Windows).\n\n## Supporting Material/References:\n\n### Debug info of tested executables\nThe executables were downloaded from the nightly build at [https://ci.appveyor.com/project/donho/notepad-plus-plus](https://ci.appveyor.com/project/donho/notepad-plus-plus)\n\n```\nNotepad++ v7.6.3   (32-bit)\nBuild time : Feb 16 2019 - 23:07:35\nPath : C:\\Users\\Pietro\\Downloads\\npp.7.6.3.bin.minimalist\\notepad++.exe\nAdmin mode : OFF\nLocal Conf mode : ON\nOS : Windows 10 (64-bit)\nPlugins : none\n```\n\n```\nNotepad++ v7.6.3   (64-bit)\nBuild time : Feb 17 2019 - 02:47:42\nPath : C:\\Users\\Pietro\\Downloads\\npp.7.6.3.bin.minimalist64\\notepad++.exe\nAdmin mode : OFF\nLocal Conf mode : ON\nOS : Windows 10 (64-bit)\nPlugins : none\n```\n\n## Impact\n\nSince this is vulnerability can lead to arbitrary command execution, users risk complete loss of integrity, confidentiality and availability. An attacker may read, delete and modify any files that are accessible with the program's permission, and execute arbitrary code.\n\nUsers may be persuaded to use a custom config file, for instance if provided as a example config file on the Internet, or if the user believes it would solve a problem with the config they have.\n\nMoreover, a malicious program running with the user's permissions may directly write to %APPDATA% and trigger the vulnerability.","bounty_amount":"1137.83","formatted_bounty":"$1,137.83","weakness":{"id":58,"name":"Command Injection - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":425560,"file_name":"config.xml","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/425/560/056994b07120f10b36a6ca17ceb968bfea2b9b01/config.xml?response-content-disposition=attachment%3B%20filename%3D%22config.xml%22%3B%20filename%2A%3DUTF-8%27%27config.xml\u0026response-content-type=application%2Foctet-stream\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T150619Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=49131b57784b4ea8969669a3fea585746914e465776652b7201c3b276a313c29","file_size":5131,"type":"application/xml"}],"allow_singular_disclosure_at":"2019-05-07T22:46:08.825Z","allow_singular_disclosure_after":-76695610.28242989,"singular_disclosure_allowed":true,"vote_count":49,"voters":["foobar7","mik317","ali","asad0x01_","brucedh","an0nym0us","whitesector","f_m","smelt","felipeandrianpeixoto","and 39 more..."],"severity":{"rating":"medium","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":4170227,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @peter_, thanks for your submission. Your report is being reviewed and you'll hear back as soon as there's more to share.  ","automated_response":false,"created_at":"2019-02-19T00:02:27.451Z","updated_at":"2019-02-19T00:02:27.451Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4172717,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2019-02-19T12:45:33.106Z","updated_at":"2019-02-19T12:45:33.106Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":299493},"actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4172718,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hello @peter_,\n\nThank you for your submission! I was able to validate your report, and have submitted it to the appropriate remediation team for review. They will let us know the final ruling on this report, and when/if a fix will be implemented. Please note that the status and severity are subject to change.\n\nRegards,\n@nasr0x01 ","automated_response":false,"created_at":"2019-02-19T12:45:40.586Z","updated_at":"2019-02-19T12:45:40.586Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4178941,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2019-02-20T10:13:46.401Z","updated_at":"2019-02-20T10:13:46.401Z","additional_data":{"old_severity":"High","new_severity":"Medium","old_severity_id":299493,"new_severity_id":300064},"actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4178946,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello @peter_,\n\nThank you for your report. This has been validated by the Notpad++ team and will now be sent to the European Commission for final approval to pay out a bounty. We appreciate your patience and will update you as soon as we hear back but there may be some delay.\n\nRegards,\n@nasr0x01","automated_response":false,"created_at":"2019-02-20T10:14:27.408Z","updated_at":"2019-02-20T10:14:27.408Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4231817,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hello @peter_ ,\n\nThank you for this report. The team have confirmed your vulnerability as a Medium severity impact.\n\nThe H1 platform doesn’t allow €URO payments, hence the funky $1,137.83 amount.\n\nThe USD$ conversion for today is 1 United States Dollar equals 0.88 Euro.\n\nThanks for your help and participating in this program.\n\nKind Regards\nHackerOne","automated_response":false,"created_at":"2019-02-28T19:51:41.675Z","updated_at":"2019-02-28T19:51:41.675Z","actor":{"url":"/notepad-plus-plus","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/721/b8be93879279f14a49e5051a1a2794575fb1f3f8_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Notepad++"}},"bounty_amount":"1137.83","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"notepad-plus-plus","collaborator":{"username":"peter_","url":"/peter_"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4232486,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you!\nI was wondering if I was eligible for the 20% bonus, since I provided a fix to the vulnerability (which was applied [here](https://github.com/notepad-plus-plus/notepad-plus-plus/commit/b90be4a05b36e8e9117a8fd1e5b134894640fec0)).\nAnyway, thanks for your time :)","automated_response":false,"created_at":"2019-02-28T22:33:43.684Z","updated_at":"2019-02-28T22:33:43.684Z","actor":{"username":"peter_","cleared":false,"url":"/peter_","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/138/324/94c560b36ae1a413b0c16f0f066405b8b8177f9d_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4270209,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello @peter_,\n\nI am now in contact with the Notepad team to clarify whether the patch provided by you was used or not and will get back to you as soon as possible.\n\nRegards,\n@nasr0x01","automated_response":false,"created_at":"2019-03-06T19:07:53.971Z","updated_at":"2019-03-06T19:07:53.971Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4306741,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @peter_, \n\nThanks for submitting this report. I just got a reply from the Notepad team and the fix you mentioned wasn't used making you not eligible for the 20% bonus.\n\nWe have determined that this report is now resolved. If you’re still able to reproduce this issue, please let us know and we will investigate further. \n\nThanks! ","automated_response":false,"created_at":"2019-03-12T10:40:07.887Z","updated_at":"2019-03-12T10:40:07.887Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"peter_","url":"/peter_"},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4306756,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the clarification, I was glad to be of help anyway.","automated_response":false,"created_at":"2019-03-12T10:44:26.985Z","updated_at":"2019-03-12T10:44:26.985Z","actor":{"username":"peter_","cleared":false,"url":"/peter_","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/138/324/94c560b36ae1a413b0c16f0f066405b8b8177f9d_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4503674,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-04-07T22:46:08.782Z","updated_at":"2019-04-07T22:46:08.782Z","first_to_agree":true,"actor":{"username":"peter_","cleared":false,"url":"/peter_","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/138/324/94c560b36ae1a413b0c16f0f066405b8b8177f9d_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4771056,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-05-07T22:46:19.090Z","updated_at":"2019-05-07T22:46:19.090Z","actor":{"url":"/notepad-plus-plus","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/721/b8be93879279f14a49e5051a1a2794575fb1f3f8_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Notepad++"}},"genius_execution_id":null,"team_handle":"notepad-plus-plus","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}