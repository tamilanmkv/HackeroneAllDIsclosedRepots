{"id":511317,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MTEzMTc=","url":"https://hackerone.com/reports/511317","title":"Potential use-after-free due to struct array_entry_t lacking an explicit copy constructor","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2019-03-17T16:55:25.401Z","submitted_at":"2019-03-17T16:55:25.401Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"guido","url":"/guido","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7731,"url":"https://hackerone.com/monero","handle":"monero","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Monero","twitter_handle":"monero","website":"https://getmonero.org","about":" Monero: the secure, private, untraceable cryptocurrency"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-05-10T20:02:23.754Z","bug_reporter_agreed_on_going_public_at":"2019-04-10T20:02:20.346Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"```struct array_entry_t``` in ```contrib/epee/include/storages/portable_storage_base.h``` does not implement a copy constructor.\n\nWherever there is code that attempts to copy-construct ```array_entry_t```, the compiler inserts a copy constructor for ```array_entry_t``` that merely copies over the values.\n\nThe struct possesses an iterator (```mutable typename entry_container\u003ct_entry_type\u003e::type::const_iterator m_it```) which is copied over by the implicit copy constructor (inserted ad-hoc by the compiler).\n\nThis leads to a situation where ```m_it``` points to a different ```m_array_entry```. If that ```m_array_entry``` is deleted, then dereferencing ```m_it``` constitutes a use-after-free bug.\n\n```cpp\n#include \u003cstorages/portable_storage_base.h\u003e\n\nint main(void)\n{\n    /* Construct the first array_entry_t */\n    auto ae = new epee::serialization::array_entry_t\u003cuint64_t\u003e;\n\n    /* Insert two values */\n    ae-\u003einsert_first_val(111);\n    ae-\u003einsert_next_value(999);\n\n    /* Moves the iterator from the first element to the second element. */\n    ae-\u003eget_first_val();\n    /* The iterator is now at the value 999 */\n\n    /* Construct a new array_entry_t using the one already created.\n     * Invokes the copy constructor.\n     */\n    auto ae2 = new epee::serialization::array_entry_t\u003cuint64_t\u003e(*ae);\n\n    /* Delete the first array_entry_t */\n    delete ae;\n\n    /* ae2.m_it now still points to the array of the first array_entry_t,\n     * but that array was deleted in the statement above, so dereferencing it\n     * will be a use after free.\n     *\n     * Let's try:\n     */\n\n    auto res = ae2-\u003eget_next_val();\n    if ( res != nullptr ) {\n        /* Dereferencing freed pointer (use after free) */\n        printf(\"%zu\\n\", *res);\n    }\n\n    delete ae2;\n\n    return 0;\n}\n```\n\nCompile (from the monero source root path):\n\n```\nclang++ -g -I contrib/epee/include/ poc.cpp -fsanitize=address\n```\n\nNote that the implicit copy constructor is in fact called when serialization is performed using ```epee::serialization::portable_storage::load_from_binary```.\nHowever, I haven't observed an actual use-after-free, hence 'low' severity for this report.\nIn my opinion it is nonetheless something that ought to be addressed because future code dealing with ```array_entry_t``` and its methods could inadvertently lead to use-after-free.\n\nPatch:\n```\nFrom da7c7fe3766777eadd058a4682de5527bc5f5904 Mon Sep 17 00:00:00 2001\nFrom: Guido Vranken \u003cguidovranken@gmail.com\u003e\nDate: Sun, 17 Mar 2019 17:39:37 +0100\nSubject: [PATCH] Implement array_entry_t copy constructor\n\nManually initialize the array_entry_t iterator to ensure it points\nto the correct m_array, thereby preventing a potential use-after-free\nsituation.\n\nSigned-off-by: Guido Vranken \u003cguidovranken@gmail.com\u003e\n---\n contrib/epee/include/storages/portable_storage_base.h | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/contrib/epee/include/storages/portable_storage_base.h b/contrib/epee/include/storages/portable_storage_base.h\nindex da84fd8e..ca7c81dd 100644\n--- a/contrib/epee/include/storages/portable_storage_base.h\n+++ b/contrib/epee/include/storages/portable_storage_base.h\n@@ -82,6 +82,7 @@ namespace epee\n     struct array_entry_t\n     {\n       array_entry_t():m_it(m_array.end()){}        \n+      array_entry_t(const array_entry_t\u0026 other):m_array(other.m_array), m_it(m_array.end()){}\n \n       const t_entry_type* get_first_val() const \n       {\n-- \n2.17.1\n\n\n```\n\n## Impact\n\nUse-after-free; information disclosure, RCE","weakness":{"id":50,"name":"Use After Free"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-05-10T20:02:20.398Z","allow_singular_disclosure_after":-76446356.58966765,"singular_disclosure_allowed":true,"vote_count":9,"voters":["ali","cryptographer","odvlv","t3kk1","xakerwan","masterward","aarohakkinen","caffeinee","javier_vel"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":4342509,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the patch. You can PR it to github if you like, or I'll do it if you'd rather not.","automated_response":false,"created_at":"2019-03-17T23:34:55.654Z","updated_at":"2019-03-17T23:34:55.654Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4342510,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2019-03-17T23:35:32.312Z","updated_at":"2019-03-17T23:35:32.312Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4342521,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"See https://github.com/monero-project/monero/pull/5309","automated_response":false,"created_at":"2019-03-17T23:51:40.546Z","updated_at":"2019-03-17T23:51:40.546Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4352290,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks","automated_response":false,"created_at":"2019-03-19T11:25:25.398Z","updated_at":"2019-03-19T11:25:25.398Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4369818,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@guido please post an XMR address if you'd like bounty.","automated_response":false,"created_at":"2019-03-21T22:48:47.826Z","updated_at":"2019-03-21T22:48:47.826Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4369822,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"48XB817vPzmEhwEGvw5zcLSnT1aRMBbN1jQUnUXMLpoyJE7jgXpdPsUNYgXg3ddcKbA2u3wpGqmHhT3DbTZCMjmV6vSY3bt","automated_response":false,"created_at":"2019-03-21T22:50:54.578Z","updated_at":"2019-03-21T22:50:54.578Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4532409,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sent 2 XMR: dce9f50e04a511c0a686ff7c39a04f75959a93bd9b96fc35ef4548190de17706","automated_response":false,"created_at":"2019-04-10T19:05:20.782Z","updated_at":"2019-04-10T19:05:20.782Z","actor":{"username":"luigi1111w","cleared":false,"url":"/luigi1111w","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4532412,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!","automated_response":false,"created_at":"2019-04-10T19:06:36.104Z","updated_at":"2019-04-10T19:06:36.104Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4532676,"is_internal":false,"editable":false,"type":"Activities::SwagAwarded","message":"","automated_response":false,"created_at":"2019-04-10T20:01:00.250Z","updated_at":"2019-04-10T20:01:00.250Z","actor":{"url":"/monero","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Monero"}},"reporter":{"username":"guido","url":"/guido"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4532680,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2019-04-10T20:01:28.605Z","updated_at":"2019-04-10T20:01:28.605Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"guido","url":"/guido"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4532686,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-04-10T20:02:20.371Z","updated_at":"2019-04-10T20:02:20.371Z","first_to_agree":true,"actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4812150,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-05-10T20:02:23.777Z","updated_at":"2019-05-10T20:02:23.777Z","actor":{"url":"/monero","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Monero"}},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}