{"id":53088,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MzA4OA==","url":"https://hackerone.com/reports/53088","title":"SSRF vulnerability (access to metadata server on EC2 and OpenStack)","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-03-23T15:08:49.061Z","submitted_at":"2015-03-23T15:08:49.061Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"agarri_fr","url":"/agarri_fr","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-03-26T18:37:57.571Z","bug_reporter_agreed_on_going_public_at":"2015-03-26T18:37:57.356Z","team_member_agreed_on_going_public_at":"2015-03-26T18:33:49.042Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"In bug [#50537](https://hackerone.com/reports/50537), **haquaman** reported a SSRF vulnerability in the meme creation section of Phabricator. Ticket [T6755](https://secure.phabricator.com/T6755) was created and the HackerOne issue was closed as \"Won't fix\".\r\n\r\n[T6755](https://secure.phabricator.com/T6755) states that *\"attackers can use the machine's ability to access the network, which may allow them to find services (and, in some rare cases, interact with services that have very, very weak authentication and act over HTTP GET)\"*.\r\n\r\nHoewever, some common deployement scenarios (using Amazon EC2 or OpenStack) include a \"metadata\" web server listening on a multicast IP (169.254.169.254):\r\n- EC2: http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html\r\n- OpenStack:http://docs.openstack.org/admin-guide-cloud/content/section_metadata-service.html\r\n\r\nGiven the multicast IP address, this server can only reached from the instance itself.\r\n\r\nPlenty of interesting information are stored at /latest/meta-data/ ([hostname](http://169.254.169.254/latest/meta-data/hostname), private and public IP addresses, ...). However, the worst scenario is auto-starting instances, where a startup script is stored in [/latest/user-data](http://169.254.169.254/latest/user-data). These startup scripts may include passwords, private keys, source code, ...\r\n\r\nTest URLs:\r\n```\r\nhttp://169.254.169.254/latest/meta-data/hostname\r\nhttp://169.254.169.254/latest/user-data\r\n```\r\n\r\nOutside of EC2 and OpenStack, some services are commonly bound to localhost, including monitoring software, noSQL databases, administration interfaces, ...","bounty_amount":"300.0","formatted_bounty":"$300","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-04-25T18:33:49.221Z","allow_singular_disclosure_after":-203978139.62246507,"singular_disclosure_allowed":true,"vote_count":1,"voters":["supern0va"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":360754,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"For posterity, we discussed this out-of-band; my take here is that I find the widespread existence of these services in private/link-local IP space to be compelling in treating this as a material vulnerability. Previous reports did not include this information, which led to a lower risk assessment on my part.\n\nI have an initial patch out for review, which should blacklist all private/reserved IP space by default:\n\nhttps://secure.phabricator.com/D12136\n\nThis isn't a complete fix but should make the defaults significantly safer, the behavior in general more granular, the risks more clear, and prevent access to the EC2/OpenStack services.","automated_response":false,"created_at":"2015-03-23T16:04:50.656Z","updated_at":"2015-03-23T16:04:50.656Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":360884,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I went through the proposed patch, and I think that it can be bypassed quite easily:\n- the check against the blacklist is made before the HTTP request. If the IP address of this DNS record changes in the middle (*\"DNS re-binding\"*), then we could reach a forbidden URL. A patched version of [dnschef](https://thesprawl.org/projects/dnschef/) can be used for serving changing DNS records\n- it seems from [#50537](https://hackerone.com/reports/50537) that HTTP redirects are supported. The blacklist is applied only to the first destination. Redirecting (for example using HTTP 302) to a forbidden URL would allow to bypasss the filter","automated_response":false,"created_at":"2015-03-23T17:46:14.002Z","updated_at":"2015-03-23T17:46:14.002Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":363846,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"I believe we've now taken (or developed specific plans to take) all the reasonable steps available to us to mitigate SSRF attacks, per discussion here:\n\nhttps://secure.phabricator.com/T6755\n\nThis protection isn't entirely complete, but the remaining risks seem vanishingly small and we generally do not have a reasonable mechanism available to mitigate them (e.g., the behavior of `git clone http://secret-service.example.com/`), and/or the risk they present is small/theoretical and greatly outweighed by the large/practical benefit of providing the capability.","automated_response":false,"created_at":"2015-03-26T18:25:44.532Z","updated_at":"2015-03-26T18:25:44.532Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"agarri_fr","url":"/agarri_fr"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":363849,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"In assessing an award for this issue, I am primarily considering that this report mostly added new information (the existence of widely deployed link-local services on popular VM platforms) about a previously-known issue.\n\nThis information impacted my assessment of the importance of resolving the issue, but the report itself did not require significant original research and the vulnerability still requires a combination of conditions to exploit (a user account on the instance + deployment on a VM platform with a link-local service that exposes sensitive information + use of startup scripts exposed over that service which contain credentials + not disabling outbound request in configuration).","automated_response":false,"created_at":"2015-03-26T18:33:03.868Z","updated_at":"2015-03-26T18:33:03.868Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"agarri_fr","url":"/agarri_fr"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":363851,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Details about this issue are publicly available in the issue tracker and commit log, so it can be disclosed at any time.","automated_response":false,"created_at":"2015-03-26T18:33:49.078Z","updated_at":"2015-03-26T18:33:49.078Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":363858,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Nice job! And thanks for the money ;-)","automated_response":false,"created_at":"2015-03-26T18:37:57.397Z","updated_at":"2015-03-26T18:37:57.397Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":363859,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-03-26T18:37:57.617Z","updated_at":"2015-03-26T18:37:57.617Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}