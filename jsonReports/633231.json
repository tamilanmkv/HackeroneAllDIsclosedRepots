{"id":633231,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82MzMyMzE=","url":"https://hackerone.com/reports/633231","title":"pre-auth Stored XSS in comments via javascript: url when administrator edits user supplied comment","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-07-01T15:53:12.245Z","submitted_at":"2019-07-01T15:53:12.245Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"simonscannell","url":"/simonscannell","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/HvE5FGgP56eXFMNMr4rwmunu/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":55,"url":"https://hackerone.com/wordpress","handle":"wordpress","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"WordPress","twitter_handle":"wordpress","website":"https://wordpress.org/","about":"Beautiful sites of any kind."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-08-18T18:01:25.262Z","bug_reporter_agreed_on_going_public_at":"2020-07-19T18:01:23.660Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"When a comment is submitted, it is filtered via `wp_rel_nofollow_callback()`, which adds the `rel` attribute to `\u003ca\u003e` tags within the anchor:\n\n```\nfunction wp_rel_nofollow_callback( $matches ) {\n\t$text = $matches[1];\n\t$atts = shortcode_parse_atts( $matches[1] );\n\t$rel  = 'nofollow';\n\n\tif ( ! empty( $atts['href'] ) ) {\n\t\tif ( in_array( strtolower( wp_parse_url( $atts['href'], PHP_URL_SCHEME ) ), array( 'http', 'https' ), true ) ) {\n\t\t\tif ( strtolower( wp_parse_url( $atts['href'], PHP_URL_HOST ) ) === strtolower( wp_parse_url( home_url(), PHP_URL_HOST ) ) ) {\n\t\t\t\treturn \"\u003ca $text\u003e\";\n\t\t\t}\n\t\t}\n\t}\n\n\tif ( ! empty( $atts['rel'] ) ) {\n\t\t$parts = array_map( 'trim', explode( ' ', $atts['rel'] ) );\n\t\tif ( false === array_search( 'nofollow', $parts ) ) {\n\t\t\t$parts[] = 'nofollow';\n\t\t}\n\t\t$rel = implode( ' ', $parts );\n\t\tunset( $atts['rel'] );\n\n\t\t$html = '';\n\t\tforeach ( $atts as $name =\u003e $value ) {\n\t\t\t$html .= \"{$name}=\\\"\" .  $value . '\" ';\n\t\t}\n\t\t$text = trim( $html );\n\t}\n\treturn \"\u003ca $text rel=\\\"\" . esc_attr( $rel ) . '\"\u003e';\n}\n```\n\nif the `rel` attribute is already set, the `\u003ca\u003e` tag is built back together with the values returned by `shortcode_parse_atts()`.  This is problematic, since `shortcode_parse_atts()` calls `stripcslashes()` on the attribute values, which for example allows turning `\\x3a` into `:`. \n\nTherefor the `esc_url()` function can be bypassed by:\n1. using a URL such as `javascript\\x3aalert(1);` \n2. getting an admin to edit and update the comment containing the XSS payload\n3. done\n\nI recommend moving away from `shortcode_parse_atts()` because of side effects like these. I also got close to a XSS without user interaction through the same mechanisms but it fails luckily.\n\n### PoC:\n\n1. As an unauthenticated user, create a comment with the following content:\n```\nHi!\nI really enjoy your work. We've also written a blog post about it here: http://dummysite.com/awesome-blogpost. Feel free to check it out!\n\u003ca href=\"javascript\\x3aalert(1);\"\u003eVisit my web page\u003c/a\u003e\n```\n\n2. create a second comment with the content:\n```\nI just noticed a typo in the URL! Could you please change it from dummysite.com to dummysite2.com? Thank you so much\n```\n3. Log in as an admin, go to the comments section and edit the comment and click save\n4. View the comment on the post, click the \"Visit my web page\" URL and see the alert() box popping up.\n\n## Impact\n\nThrough the XSS, RCE can be gained. Obviously a lot of user interaction is required but yeah, it is a super easy to copy \u0026 paste payload that could be used against non technical users. The XSS could then also be triggered via clickjacking.","bounty_amount":"650.0","formatted_bounty":"$650","weakness":{"id":62,"name":"Cross-site Scripting (XSS) - Stored"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-08-18T18:01:23.746Z","allow_singular_disclosure_after":-36191543.64386962,"singular_disclosure_allowed":true,"vote_count":11,"voters":["zzero","foobar7","mashoud1122","ali","jesuser14","silverdel","paqman","nekoneko000","sibwtf","peperaking20","and 1 more..."],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":2750,"asset_type":"SOURCE_CODE","asset_identifier":"WordPress Core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":5285680,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey Simon,\n\nInteresting POC you have provided here. I'm sharing with the team, and we will be evaluating further. We will be in touch.\n\nCheers,\n\n@whyisjake","automated_response":false,"created_at":"2019-07-09T23:33:33.812Z","updated_at":"2019-07-09T23:33:33.812Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5285699,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2019-07-09T23:38:49.699Z","updated_at":"2019-07-09T23:38:49.699Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5560483,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey there @simonscannell,\n\nI think we have a fix for this issue and were wondering if you could confirm with this patch. \n\nThanks!\n\n@whyisjake","automated_response":false,"created_at":"2019-08-12T23:53:17.604Z","updated_at":"2019-08-12T23:53:17.604Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"attachments":[{"id":553935,"filename":"633231.diff","type":"text/x-patch","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/fb5h46tfYKGFAMJDJLueHVbi?response-content-disposition=attachment%3B%20filename%3D%22633231.diff%22%3B%20filename%2A%3DUTF-8%27%27633231.diff\u0026response-content-type=text%2Fx-patch\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYC7ZV3WT%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151347Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIDrMLp4%2BWn0RnMngqqBOAomCU8GWEnyzbfeWXMTkRqdkAiEAmbCt%2FtYvzimCcqsBY5T%2BAP6C1koJvsZIEr7pm24tsEAqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDHO5iuzPFsJ4aK7KmSrXA43fG9ZExUYtmldfJFAHkWRlov9q%2FHMMPiqI7JWoul8iB2lnCe0Z8UD9oM5cfjZfhntNLx94myZGJfeT24YbqZ%2BCsOqn%2BPXRlK7VWqoq1AV8zdBtboSY1qGlF1yW0h8xQvR1G807ShHTgDzCxdIUl0y2PUXdt%2BRNIlHckLFzjBfbJBmGFikh%2B68wwr3qhH%2BRekBJT8dRJqkMmVmJIoL4rn3y%2FCM010RJxL86Xuoat%2BrN046smSjkfceh4bPaJkOADf33dP%2FBliSDcBjoMG74ZFHPAmgnqoN439xdfqhUpIPqNFrcRU1WpQhc12VYut5tMZcbmJchXopaXhvm%2B4orW3DihHvyn7HD%2BiT1cpN9baXaycQzr%2B68J9MyG01Zce8VNQxPm5eRp7v9dtdfEQ9sF3yuOsWzUwY%2BTHCD7SIcVsQFrS5Z2L5Ux3CncTXxkqQVlNCyHTcJODpncVKfD7b6uHxsAmVawhDDZJgLpATJPpVIaGa0em09aEDUcT%2FuazJtx1N1gOr8ZYZSsD6LmJlT7xfEsyzeZ%2BC%2FQQSJKyYRebEtRjLR%2BsYz4MKD2jlXjj62sVdjHko29e6c4eso%2Fx8%2Bjrkj%2BYuyD88VzMWxszti4qHccB7%2Fr3%2BsDzDViZGLBjqlAc5vcHGjagoOTjMDz6VCxHAyKKMhBY%2F4ksl1iKt3Mkg6KIb8dD7WB3B5bRwalHdLpA6q%2F0HyHwVC3k8nRLkVacoHC%2BTnF8IsDYgQMa3VWvq9UB5BqCGPwIE9Smv%2FlQf6eGWyrcOO%2Brsi6UGSaKxoz3eFt2y8zMnz71sdDkZshTNAZoB15M%2BSMQApjyeteOn3dhbojlsBvMBhOE%2FWaBGY2zXmhSJaSA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=2c39a403381ac2448eb46ee5db57c91b9e84211758b3de333e1efde028205c47"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5566746,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jake,\n\nSorry for my late reply. The patch seems effective!","automated_response":false,"created_at":"2019-08-13T17:24:28.962Z","updated_at":"2019-08-13T17:24:28.962Z","actor":{"username":"simonscannell","cleared":false,"url":"/simonscannell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/HvE5FGgP56eXFMNMr4rwmunu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5678745,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @simonscannell,\n\nWe are looking to release the fix for this issue too, how would you like to be credited?\n\nCheers,\n\n@whyisjake\n","automated_response":false,"created_at":"2019-08-27T21:15:38.124Z","updated_at":"2019-08-27T21:15:38.124Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5685363,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jake,\n\nSorry for late response on my part, I had no signal the last couple days. If you could say \"Simon Scannell of both RIPS Technologies\" on bothbissues, that would be amazing, thanks!\n\nBest,\nSimon","automated_response":false,"created_at":"2019-08-28T17:52:17.557Z","updated_at":"2019-08-28T17:52:17.557Z","actor":{"username":"simonscannell","cleared":false,"url":"/simonscannell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/HvE5FGgP56eXFMNMr4rwmunu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5743807,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @simonscannell,\n\nThanks for your work in this security disclosure. As you have seen, we released 5.2.3 with a fix for this issue.\n\nhttps://wordpress.org/news/2019/09/wordpress-5-2-3-security-and-maintenance-release/\n\nWe would like to thank you for your contributions. This is being moved over to the bounty queue.\n\nCheers,\n\n@whyisjake","automated_response":false,"created_at":"2019-09-06T03:41:21.301Z","updated_at":"2019-09-06T03:41:21.301Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5743810,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2019-09-06T03:42:26.257Z","updated_at":"2019-09-06T03:42:26.257Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"simonscannell","url":"/simonscannell"},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5747054,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2019-09-06T13:41:55.514Z","updated_at":"2019-09-06T13:41:55.514Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"WordPress"}},"bounty_amount":"650.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"wordpress","collaborator":{"username":"simonscannell","url":"/simonscannell"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5757789,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you!","automated_response":false,"created_at":"2019-09-08T20:58:12.066Z","updated_at":"2019-09-08T20:58:12.066Z","actor":{"username":"simonscannell","cleared":false,"url":"/simonscannell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/HvE5FGgP56eXFMNMr4rwmunu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8646776,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Requesting disclosure for completeness. Thank you!","automated_response":false,"created_at":"2020-07-19T18:01:23.687Z","updated_at":"2020-07-19T18:01:23.687Z","first_to_agree":true,"actor":{"username":"simonscannell","cleared":false,"url":"/simonscannell","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/HvE5FGgP56eXFMNMr4rwmunu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8971457,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-08-18T18:01:25.424Z","updated_at":"2020-08-18T18:01:25.424Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"WordPress"}},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}