{"id":676710,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82NzY3MTA=","url":"https://hackerone.com/reports/676710","title":"Http response is not ended although underlying socket is already destroyed","state":"Closed","substate":"informative","readable_substate":"Informative","created_at":"2019-08-19T16:11:10.534Z","submitted_at":"2019-08-19T16:11:10.534Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"verdaster","url":"/verdaster","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22984,"url":"https://hackerone.com/nodejs","handle":"nodejs","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/022/984/e600648ace4a8553247bce967d461a030aa81d49_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/022/984/e600648ace4a8553247bce967d461a030aa81d49_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Node.js","twitter_handle":"nodejs","website":"https://nodejs.org","about":"The Node.js JavaScript Runtime"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-01-15T19:58:51.621Z","bug_reporter_agreed_on_going_public_at":"2020-01-15T19:58:51.575Z","team_member_agreed_on_going_public_at":"2020-01-14T23:30:33.936Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nWhen node server receives http request and hooks to end, finish and error events are attached on response object to handle cases when response is closed/ended but underlying socket is abruptly terminated then none of those events is fired. This leads to state when response seems to be still alive, although it's internal state of connection is destroyed. So basically after socket is destroyed this event is not propagated to http response object.\n\n**Description:**\nThis can lead to two states:\n\n1) If response is handled locally it remains open and if used to eg. stream data from file it keeps file handle opened until server is stopped.\n\n2) In case of request proxying another response stream remains open which can lead to DOS on target server where the request is proxyed to. In case of Apache httpd the server stops responding after certain number of such requests if no timeout is configured.\n\nIn both cases the system becomes unusable after certain time, based on incoming traffic and remains in this state until restarted.\n\n## Steps To Reproduce:\n\n  1. start node http server (server.js)\n  2. connect with example client (client.js)\n  3. http request will remain active although underlying socket is already destroyed until scheduled timeout kicks in and emits error which triggers attached error handler\n\n## Impact:\nAttack can possibly lead to open handles exhausting or in case of request proxying to eg. Apache httpd DOS attack.\n\n## Supporting Material/References:\n\nBelow are details about platform tested and code to reproduce with proxy example in attachments. I have used stream's utility function pipeline to handle emitted events on streams.\n\nVersion: v12.8.1\nPlatform: 4.15.0-58-generic #54~16.04.1-Ubuntu x86_64 GNU/Linux\nSubsystem: net/http\n\n## Impact\n\nDOS attack and resource exhausting.","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":559294,"file_name":"client.js","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/wNiFDxQYCyu3zHo16XHqFjQQ?response-content-disposition=attachment%3B%20filename%3D%22client.js%22%3B%20filename%2A%3DUTF-8%27%27client.js\u0026response-content-type=application%2Fx-javascript\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQZV3IBMDT%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151659Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIHx%2BIgfH0%2FRLQqbPD5vv6PNps92HY0yneL0kxkNwZHOyAiALrXRJqTvQQGm0xEkYGCB0kbPjUCCkzSeRztvcuetAYyqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIM5FTPTB1nK4gXIBLuKtcDHmLbKhsWpyXKgWy1fAYOf0DZEqCEqF9ns7RwihS1bFM9%2BSDXYY0CmIqutWQhK5asoL8jbJZ39%2FJ2eai2SoxTlg3PhjMpNNSUfPFgauwX6vt%2FoeK9VnB1Hmqg6bCNA62qIJPnlTONluGngv604Y6CnYL9Se%2B%2BjgOpqhqmIOX9KlzGAoRM0Ci%2BrWGdELH8Q66bSHmapdLHPWMoGBEj%2BeruK3oCs%2BDaUQ1aE%2FEQ8R5PgqLM3Pq6DrZV9PlFixmkikk8SpDcsFEiT0Zw0gsy2qPz3z3BHAEuG64GguAhIs5FvYP7HbdpPv7rQz4QSDXgN3SIbVD0A4kcV1iNQpZyiw2rmdxuUWIk46d%2FT0u%2B7j9yAdfpDuPVKPDHJD35k0pB6VLe7RtlSwwvcDUa7LL6FJxvOPpupIMPSy51BJl9%2Bf8022a6pcy263zeRDGJjALAc6brW%2BvQoDUu%2FQP%2BdxwOLZvXCyyGJp2%2BK86jg8qU%2FLWZ4DVeR3bIO1n7Fw%2B53iFlBIMatC3ZSLlV1J7dSDCk74u6OWvql%2Brvb6q%2Bj8NHQK6luFckQV%2B9okMhTYuNniW3sHS8rjyNrrGhP8vMtxMzink9EL%2FmU0Oxusg2wmaXCDfIKpDDmspvZQv8MJ%2F%2FkIsGOqYBaz2hfRV48KDU0Mx0UomuXdEWK6oszm51EnI%2FeSepVmINgIWWggB7gENawN0rgfpMSIqQjB%2BpErtoDw1jNWaknZlAG9GLkCZ49lNHNirjr7iPk7LouunUzSZjaag8Yc19L8BAWjyLZnHXpqUZQRBSoqOcAoct3F46M7AzK2ewXHmh7aKY3cfAQTu9yVTJd2CDpuLtlyUDUa37BJ8%2F84puzgJS34jmeg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=14906649766389f5871061464a2115de1b18bf01e5c65a0f195199c441c76562","file_size":285,"type":"application/x-javascript"},{"id":559295,"file_name":"server.js","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/FbFPMdK9WwRnSQM5tH6fWH46?response-content-disposition=attachment%3B%20filename%3D%22server.js%22%3B%20filename%2A%3DUTF-8%27%27server.js\u0026response-content-type=application%2Fx-javascript\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQZV3IBMDT%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151659Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIHx%2BIgfH0%2FRLQqbPD5vv6PNps92HY0yneL0kxkNwZHOyAiALrXRJqTvQQGm0xEkYGCB0kbPjUCCkzSeRztvcuetAYyqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIM5FTPTB1nK4gXIBLuKtcDHmLbKhsWpyXKgWy1fAYOf0DZEqCEqF9ns7RwihS1bFM9%2BSDXYY0CmIqutWQhK5asoL8jbJZ39%2FJ2eai2SoxTlg3PhjMpNNSUfPFgauwX6vt%2FoeK9VnB1Hmqg6bCNA62qIJPnlTONluGngv604Y6CnYL9Se%2B%2BjgOpqhqmIOX9KlzGAoRM0Ci%2BrWGdELH8Q66bSHmapdLHPWMoGBEj%2BeruK3oCs%2BDaUQ1aE%2FEQ8R5PgqLM3Pq6DrZV9PlFixmkikk8SpDcsFEiT0Zw0gsy2qPz3z3BHAEuG64GguAhIs5FvYP7HbdpPv7rQz4QSDXgN3SIbVD0A4kcV1iNQpZyiw2rmdxuUWIk46d%2FT0u%2B7j9yAdfpDuPVKPDHJD35k0pB6VLe7RtlSwwvcDUa7LL6FJxvOPpupIMPSy51BJl9%2Bf8022a6pcy263zeRDGJjALAc6brW%2BvQoDUu%2FQP%2BdxwOLZvXCyyGJp2%2BK86jg8qU%2FLWZ4DVeR3bIO1n7Fw%2B53iFlBIMatC3ZSLlV1J7dSDCk74u6OWvql%2Brvb6q%2Bj8NHQK6luFckQV%2B9okMhTYuNniW3sHS8rjyNrrGhP8vMtxMzink9EL%2FmU0Oxusg2wmaXCDfIKpDDmspvZQv8MJ%2F%2FkIsGOqYBaz2hfRV48KDU0Mx0UomuXdEWK6oszm51EnI%2FeSepVmINgIWWggB7gENawN0rgfpMSIqQjB%2BpErtoDw1jNWaknZlAG9GLkCZ49lNHNirjr7iPk7LouunUzSZjaag8Yc19L8BAWjyLZnHXpqUZQRBSoqOcAoct3F46M7AzK2ewXHmh7aKY3cfAQTu9yVTJd2CDpuLtlyUDUa37BJ8%2F84puzgJS34jmeg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=957ad6f6dff1580e350f8c84b3cfd5ee6d06d90b70ee76a611959f4cc326e7f8","file_size":1350,"type":"application/x-javascript"}],"allow_singular_disclosure_at":null,"vote_count":1,"voters":["root_hunterho"],"structured_scope":{"databaseId":666,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/nodejs/node","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":5628128,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @verdaster,\n\nThank you for your submission. Your report is currently being reviewed and the team will get back to you once there is additional information to share.\n\nKind regards,\n@antenna ","automated_response":false,"created_at":"2019-08-21T14:04:05.583Z","updated_at":"2019-08-21T14:04:05.583Z","actor":{"username":"antenna","cleared":false,"url":"/antenna","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/B1a8q5ga9BZjMczKoqAbnMj5/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5664409,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The following code does not suffer from the issue described. Essentially `'close'` has been emitted before `pipeline` is called. Once the event is emitted, it's gone. There are a few bugs in node that prevents this code to work properly, however I would not classify it as a DoS attack on core.\n\nThe following works properly:\n\n```\nconst Http = require('http');\nconst Stream = require('stream');\n\nconst server = Http.createServer((req, res) =\u003e {\n    console.log(`Received request ${req.method} ${req.url}`);\n    req.on('aborted', () =\u003e console.log('req aborted'))\n    res.on('close', () =\u003e {\n      console.log('res closed')\n    })\n    const request = Http.request('http://www.example.com', (response) =\u003e {\n      if (res.socket.destroyed) {\n        response.destroy()\n        console.log('SOCKET ALREADY CLOSED')\n        return\n      }\n\n        Stream.pipeline(response, res, (err) =\u003e {\n            if (err) {\n                console.error('Pipeline failed', err);\n            } else {\n                console.log('Pipeline successful');\n            }\n        });\n    });\n    request.end();\n});\n\nserver.listen(3000, 'localhost', () =\u003e console.log('Listening'));\nprocess.once('SIGINT', () =\u003e server.close());\n```","automated_response":false,"created_at":"2019-08-26T09:00:01.043Z","updated_at":"2019-08-26T09:00:01.043Z","actor":{"username":"mcollina","cleared":false,"url":"/mcollina","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/230/980/61a26e6fa4ec002fca494b3b7b43aa251eef3453_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5671379,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I see. I didn't realize that there is some delay before the request callback is called and close event could be lost. However, I would suggest to check whether res or other streams are destroyed in Stream.pipeline function call. In my opinion it is behavior that most users expect of such function - to properly cleanup pipelined resources, although one or more are already closed. Otherwise boilerplate code must be added to check such condition and is error prone and could leak resources. Thanks for your response.","automated_response":false,"created_at":"2019-08-27T07:22:26.512Z","updated_at":"2019-08-27T07:22:26.512Z","actor":{"username":"verdaster","cleared":false,"url":"/verdaster","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5671391,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I totally agree, and we are already discussing that. First step is https://github.com/nodejs/node/pull/29227 which will resolve the issue you flagged. Thanks for reporting!","automated_response":false,"created_at":"2019-08-27T07:27:22.485Z","updated_at":"2019-08-27T07:27:22.485Z","actor":{"username":"mcollina","cleared":false,"url":"/mcollina","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/230/980/61a26e6fa4ec002fca494b3b7b43aa251eef3453_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5671396,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Closing the report for now.","automated_response":false,"created_at":"2019-08-27T07:27:57.915Z","updated_at":"2019-08-27T07:27:57.915Z","actor":{"username":"mcollina","cleared":false,"url":"/mcollina","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/230/980/61a26e6fa4ec002fca494b3b7b43aa251eef3453_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6341773,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","automated_response":false,"created_at":"2019-11-19T00:36:16.025Z","updated_at":"2019-11-19T00:36:16.025Z","actor":{"url":"/nodejs","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/022/984/e600648ace4a8553247bce967d461a030aa81d49_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Node.js"}},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6772270,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-01-14T23:30:33.952Z","updated_at":"2020-01-14T23:30:33.952Z","first_to_agree":true,"actor":{"username":"octetcloud","cleared":false,"url":"/octetcloud","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/210/672/27b2c0c2193cfb366f7889374e7ce71077431f74_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6780783,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-01-15T19:58:51.593Z","updated_at":"2020-01-15T19:58:51.593Z","actor":{"username":"verdaster","cleared":false,"url":"/verdaster","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6780784,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-01-15T19:58:51.639Z","updated_at":"2020-01-15T19:58:51.639Z","actor":{"username":"verdaster","cleared":false,"url":"/verdaster","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nodejs","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}