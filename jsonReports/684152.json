{"id":684152,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82ODQxNTI=","url":"https://hackerone.com/reports/684152","title":"Steal all MKR from `flap` during liquidation by exploiting lack of validation in `flap.kick`","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-08-29T07:18:26.210Z","submitted_at":"2019-08-29T07:18:26.210Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"lucash-dev","url":"/lucash-dev","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":38065,"url":"https://hackerone.com/makerdao_bbp","handle":"makerdao_bbp","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"BlockDev Sp. Z o.o","twitter_handle":"makerdao","website":"https://makerdao.com/","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-09-26T15:34:59.756Z","bug_reporter_agreed_on_going_public_at":"2019-09-26T15:34:59.686Z","team_member_agreed_on_going_public_at":"2019-09-25T17:59:15.207Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Summary:\nThe `flap` contract provides the ability to auction DAI for MKR. That's a fundamental functionality of the MCD system, invoked usually from the `vow` contract.\nA flaw in the validation of calls to `flap.kick`, however, allows a malicious user to create \"fake' auctions that can be later used to steal MKR from `flap` during the liquidation (`end`) phase.\n\n## Detailed description\n\nThe method `flap.kick`, used to start an auction of DAI (for MKR) in the `flap` contract, lacks any validation of the `bid` parameter. Since the method is public, a malicious user can directly invoke it, passing an arbitrary `bid` parameter -- affecting other contracts that assume this value represents the highest bid in the auction.\n\nWhile it's possible that this issue will cause other problems, in this report I'll focus on what seems to be the highest severity attack enabled by it.\n\nThe attack consists of two parts:\n\n1 - During the normal operation of the MCD system (contracts not \"caged\"), the attacker will create one or more \"fake\" auctions by calling `flap.kick`. The `bid` parameter can be arbitrarily large, and won't be validated in any way. On the other hand, the `lot` parameter can be arbitrarily small, as long as it's not zero, which means the auction can be placed with almost zero cost.\n\n2 - After governance calls `end.cage`, the auctions are stopped -- but any MKR deposited in the `flap` contract for any outstanding auction will still be there until someone calls `yank` for each one.\nAt this point, the attacker can call `flap.yank` for his own \"fake\" auctions, and that will result in him getting MKR transferred from the `flap` contract to himself -- in whatever amount was specified as `bid` in step 1.\n\nSince the attacker might no know beforehand, it would be wise for them to create multiple \"fake\" auctions. In particular, an exponential series of auctions, with `bid` values 1, 2, 4, 8, 16... will allow the attacker to extract any exact amount of MKR from the `flap` contract.\n\n\n## Steps To Reproduce:\nI've attached to this report a modified version of `end.t.sol` which contains a test (the last one, `test_steal_mkr_from_flapper`) that reproduces this attack.\n\nPlease don't hesitate to contact me if you have any trouble understanding or reproducing this issue.\n\n## Impact\n\nThis issue allows an attacker to steal arbitrary amounts of MKR deposited for auction.\nThat impact is particularly troubling, as MKR tokens are used to govern the platform, and anyone maliciously obtaining large quantities of these tokens might use them to further affect other core functionalities, potentially leading to stealing collateral, DAI etc. Also, because the same MKR token might be used for governance of future versions of the contracts, the damage might be much more enduring and harder to mitigate.\n\nGiven the above, and the minimal cost for perpetrating the attack, this issue would normally be classified as Critical. The specific policies for this program, though, won't allow for that, since this attack doesn't steal collateral directly. So, I classified the severity as High.","bounty_amount":"10000.0","formatted_bounty":"$10,000","weakness":{"id":107,"name":"Improper Input Validation"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":569418,"file_name":"steal-mkr-flap.t.sol","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Q45Veqfp8RMbKPKU6vDbxetm?response-content-disposition=attachment%3B%20filename%3D%22steal-mkr-flap.t.sol%22%3B%20filename%2A%3DUTF-8%27%27steal-mkr-flap.t.sol\u0026response-content-type=application%2Foctet-stream\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTXACUYF6%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151728Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQDZ4o5FgQbPOV7cUhasXsMpsRhfie%2BaT3j2%2FpT4vRtXrQIhANTpo%2FcLyZWkchHfmQUF52JZTNkTQv76yqIpKiufRkzIKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxBFvChFQcfy0iFfX8q1wNyqcNfKQ7lbPM93GK7zsCVuFEl%2FVm4iCcIyQUbJFWfH2jiZwLWzXyXOGtPdAFg6jZ27A3JiIMI2cRQ0ZjefpX23ew4f2EgNrAjI%2BtoD%2F5QRlfpZWkH6iJZQB6Tl2elKHpLsozAmLMg2ZCF27az6tPlE5SwA3JPC5KKlDjsViNs2UljZCi3H9uSwsukoU%2FvdCWTH%2Fn50kTwo3bwe%2FH3PWsruJkAQ7DX1%2Fj9brsxUqDkLoqtLrdoJjkKc0QIPiVbiif2roLjf%2B%2BMNUUjLjPZ27VJBWMgYN3p%2FXN%2Fc2BT1VqWpZMMYQ84FXmc9pAGYMt40reW%2BOqOJwy98WVa3ZnRts3MNHsi7yiH6arhodeoIERCyyc0BhhJEItkxN5Wzyg1DrlhRUS1Y71%2FbjrEz4uBhQSkdwrt3ERf6rlWOARG2SfQdqloTHaxYeaKlkA1gYk2lr8P8v4Z2wcf76dl0kv5neqxZuEP1QXm7QMG6m4bxy4%2BSeNKsdU%2FVA5yixjEwa92C8A1VyBQrxcJgjfs7VfF2qV2iBmnh%2FB2iQg07zl1YJd0cPNun9USqJb8Uqe%2B27IwrOZbWtmOWnBh1TcvDRMDsM%2FPcb7c4FlLVjUX8TDrhUH4Hz0mpfpQPYswtoqRiwY6pAGpulV8rT1rLL2zo7CLXj%2FCsA9YXTe8QLCuwj5BAVEq1XkBbMgCpFE7wCWHjGb7zRvhVV%2BN69FRCvvxudtZT7OkdQfTd7cCnr7vVLgwdFxyTBTiSFdPhCB%2F%2BGa%2FZGSO8Tzmn%2F5kYwNrvNcaCO%2FfxLRKT5QyWFtCeJZaDCV4pXJgLvMY0o61KPcMitqxyN7tABkO5sZ5lEaE04FUiiZgi%2BMqeSxyhg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=71e7eee7d62163e68bf9c25523ad1675861b4ab650f25956189f9a47873bd86a","file_size":25099,"type":"application/octet-stream"}],"allow_singular_disclosure_at":null,"vote_count":54,"voters":["an40r1","env","n1m0","dittyroma","msultan","mashoud1122","zonduu","sameerphad72","spam404","ali","and 44 more..."],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":34664,"asset_type":"OTHER","asset_identifier":"MCD_FLAP","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":5690667,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, lucash-dev! We will investigate and return here.","automated_response":false,"created_at":"2019-08-29T12:16:23.430Z","updated_at":"2019-08-29T12:16:23.430Z","actor":{"username":"lasse_y44rf","cleared":false,"url":"/lasse_y44rf","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5701164,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @lucash-dev,\n\nThank you for your submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\n\nKind regards,\n@sodacan\n","automated_response":false,"created_at":"2019-08-30T21:02:17.252Z","updated_at":"2019-08-30T21:02:17.252Z","actor":{"username":"sodacan","cleared":false,"url":"/sodacan","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/397/342/f09b69d30e08f05bbd6f12bf02200844bdf46f11_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5739469,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"We are investigating this and will get back to you soon","automated_response":false,"created_at":"2019-09-05T14:23:52.267Z","updated_at":"2019-09-05T14:23:52.267Z","actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889672,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"@lucash-dev, again, thank you much for finding this bug. \n\nWe agree with you that this does not meet the requirements of a Critical bug as it does not involve collateral.  However, because it results in MKR token being stolen, we felt it was higher than the baseline \"High\" severity award. \n\nWe implemented a fix for the bug [here]([https://github.com/makerdao/dss/pull/68](https://github.com/makerdao/dss/pull/68)), would like to disclose your report. \n\nThank you and we look forward to hearing about any other bugs you discover!","automated_response":false,"created_at":"2019-09-25T17:57:22.505Z","updated_at":"2019-09-25T17:57:22.505Z","actor":{"url":"/makerdao_bbp","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"BlockDev Sp. Z o.o"}},"bounty_amount":"5000.0","bounty_currency":"usd","bonus_amount":"5000.0","genius_execution_id":null,"team_handle":"makerdao_bbp","collaborator":{"username":"lucash-dev","url":"/lucash-dev"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889681,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2019-09-25T17:59:02.530Z","updated_at":"2019-09-25T17:59:02.530Z","actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"lucash-dev","url":"/lucash-dev"},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889682,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-09-25T17:59:15.229Z","updated_at":"2019-09-25T17:59:15.229Z","first_to_agree":true,"actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5896782,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi, @iamchrissmith.\n\nThank you very much for the bounty! I'm agreeing to the disclosure.\n\nHope to keep contributing to your program in the future!","automated_response":false,"created_at":"2019-09-26T15:34:59.707Z","updated_at":"2019-09-26T15:34:59.707Z","actor":{"username":"lucash-dev","cleared":true,"url":"/lucash-dev","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5896783,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-09-26T15:34:59.778Z","updated_at":"2019-09-26T15:34:59.778Z","actor":{"username":"lucash-dev","cleared":true,"url":"/lucash-dev","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}