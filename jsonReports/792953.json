{"id":792953,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83OTI5NTM=","url":"https://hackerone.com/reports/792953","title":"SSRF - Guard - Unchecked HKP servers","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-02-11T06:51:47.674Z","submitted_at":"2020-02-11T06:51:47.674Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zhutyra","url":"/zhutyra","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-06-17T15:48:18.183Z","bug_reporter_agreed_on_going_public_at":"2020-06-17T15:48:18.135Z","team_member_agreed_on_going_public_at":"2020-06-17T12:30:03.846Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Description\n\nWhen encrypting an email, one of strategies to lookup recipient's encryption key is to contact a HKP keyserver specified in DNS records of recipient's domain.\n\nSpecifically it is `DNS SRV` records for `_hkps._tcp.\u003cdomain\u003e` and `_hkp._tcp.\u003cdomain\u003e`, which specify hostname and port of the keyserver.\n\nIn source code it is implemented in `HKPRecipKeyLookupStrategy`, `SRVHKPClientService`, `RemoteHKPClientService`, `HKPClient` classes.\n\nThe problem is that a keyserver specified in DNS can be any server, including internal adresses. Also HKP(S) is just HTTP(S) protocol, so the SRV entry might look legitimate, but the HKP server iself can later redirect clients to any other address.\n\n## Attack vectors\n\n* Server user can trigger this directly\n* External attacker can lure a server user to send them an encrypted email\n\n## Steps to reproduce\n\nAttached is a simple program {F712580} which implements DNS and HKP server.\n\n* run my DNS/HKP server on nameserver for *\u003cyourdomain\u003e*\n\n```bash\nnameserver# python3 hkp-server.py MY.IP.AD.DR\n```\n* run netcat on appsuite server\n\n```bash\nappsuite# nc -lp 1234\n```\n* compose new email in OX App Suite\n* enter any address with your domain as recipient's address - *user@\u003cyourdomain\u003e*\n* click on `Enable Encryption` lock icon\n* in terminal on nameserver you should see output like this\n\n```\nDNS _hkps._tcp.\u003cyourdomain\u003e.\nDNS _hkp._tcp.\u003cyourdomain\u003e.\n# answer to this ^^ will be hkp.\u003cyourdomain\u003e:80\nDNS hkp.\u003cyourdomain\u003e.\nGET hkp.\u003cyourdomain\u003e:80/pks/lookup?op=index\u0026options=mr\u0026search=user@\u003cyourdomain\u003e\n# answer to this ^^ will be redirect to localhost:1234\n```\n* in terminal on appsuite you should see output like this, confirming the SSRF\n\n```http\nGET /badthing HTTP/1.1\naccept: application/json\nConnection: close\nX-UI-INTERNAL-ACCOUNT-ID: d0a18490e9b982369e5a671a6c8a9263\nHost: localhost:1234\nUser-Agent: Apache-HttpClient/4.5.7 (Java/1.8.0_232)\nAccept-Encoding: gzip,deflate\n```\n\n## Impact\n\nAn attacker can trigger requests to internal resources.","bounty_amount":"400.0","formatted_bounty":"$400","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":712580,"file_name":"hkp-server.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/rWjUfxg3AFGabcEdZYfdhA63?response-content-disposition=attachment%3B%20filename%3D%22hkp-server.py%22%3B%20filename%2A%3DUTF-8%27%27hkp-server.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTQR22CE2%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T152839Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIHylhpFJOF4pRe7XlaDX6z3BLEup%2BswnNkaACr%2Fwjwr8AiASjuyeD0TYwrZA5sOldf5eC6UQrO8hSHC9jNR%2BVNumhyqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMfK%2BofD1wJOHYcOUJKtcDnC3f8Y3jglGs7z8YlxF9bdYkYlsSrPxEkx9hDqtH%2BQ3u1daZrwyM6F3WHlk0a%2BWNezGk%2FnRxFWuvgXlXXAEBaCUWEe1UXv97gs6KKr%2F4fZ92%2FH3VXeVMioYLi220Z8qDdmiwSK2Z%2FPfK0nlRhO3v9Ee3r3C7BMq5B4DRnfxp0cJyzU%2FHbMNzQNjyO%2BlGzreHCzcyKBe%2FoFAr2W6xbLokCINrIUxMnvI9Mxs7SraD%2FF2sZw8Ln4uZ6aJweQoOPwsnYKkrRjb370Lt%2FREkrEj9pcgae0C9R5BTZegZaqNN6CzMkZfNHB7RmNrhJFg6j7%2BfPYLcWFNxzvJV9dbVJdocqrM5Jmi3hE47KOBrMSGuFrCha2vRk9P64hqfhM1GdDtMLFZZn5VqOJgdyVWZ8bTrZpmlBP%2FJ6YiHIaMTH8G%2FRndaRrVRAR8iOSqWok%2FikWajxMvcVA29H%2F5RznwCFPkLrSbv34tOiWcwVp50Yy3HjkGq4LnY67LMRRRIwThQ9vc%2BM3G9xlb7TwO6%2F3vE5U6azDCH6hDFQ3Xi8ZJVYrTOOWINnf%2BC3BIhvL8Uql%2FhI1vUmbQiAR01xN%2FdEQ9ReTSo0pfJ3SDSXhBXiwUW0IRKspJO189rJyI3MImNkYsGOqYBwdOGh60JXyl1FPj8jwEbnfg6var6H0hyaUwn%2B%2FnamMWODqDwoSJI6f0Q6RJHnQJo2gfc6OFgj1W2B%2FGcJDL4gMvwPBD8bBDDMSaZ3x1nqw%2FhzMwsaQP%2BTnUJEKAVQSe3o5Yvwzg%2FSvpNP%2By981FbIZs9aWoGNPHY48ZIUNdNLCWPS2PxNm9xHrAxEcqn8ib1XLvQQS%2FALl2CG36%2BewUP2tPIf%2BIPmw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=3c78af1c74f57b9455549bddaed9b90e534609baf116e6be6ec4a2a53de13fef","file_size":2118,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":4,"voters":["secator","brahim_boufakri01","ali","gogeruk"],"severity":{"rating":"medium","score":5.0,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"low","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":551,"asset_type":"URL","asset_identifier":"sandbox.open-xchange.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":7015512,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"Thanks for the report, you're right that redirects to local resources should be avoided. \n\nCan you please describe the \"External attacker can lure a server user to send them an encrypted email\" case in more detail? To my understanding this would require the attacker to take over a legitimate domain, which allows a great number of other nasty things. Injecting incorrect public key information through HKP alone would probably make the mail useless but would not redirect it.","automated_response":false,"created_at":"2020-02-11T08:31:27.526Z","updated_at":"2020-02-11T08:31:27.526Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7018404,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Hello,\n\nI didn't mean taking over someone else's domain. Where I said \u003cyourdomain\u003e I meant that you will be just testing it on your domain. Otherwise I as an attacker would ask you as a victim to send me an email to my domain under my control. Then when Guard tries to fetch a key from my HKP server it would redirect the request back to your infrastucture.\n\nIt would be useful mainly if the attacker already knew that there is some HTTP-based (or HTTP-friendly) service in your infrastructure and the request would be somehow useful for them.\n\nAlso the code seems to be trying all SRV entries from the DNS response (which didn't work for me, but I didn't investigate it), so it could possibly cause chain of multiple internal requests, or at least maybe allow to measure times between requests for port-scanning or something.","automated_response":false,"created_at":"2020-02-11T10:41:13.428Z","updated_at":"2020-02-11T10:41:13.428Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7018790,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"OK, thanks. So that specific attack vector would include social engineering to send a mail to a domain which uses malicious hkp responders. I understood that you could somehow use this lookup to \"automatically\" redirect mail without owning the domain or make the user do things.\n\nThe attack vector of using a domain under your control and redirecting HKP requests while having access to a account with Guard is clear and makes sense. We're going to follow up on this vector primarily.","automated_response":false,"created_at":"2020-02-11T10:57:04.990Z","updated_at":"2020-02-11T10:57:04.990Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7018801,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-02-11T10:58:43.971Z","updated_at":"2020-02-11T10:58:43.971Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038132,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2020-02-13T07:22:58.280Z","updated_at":"2020-02-13T07:22:58.280Z","additional_data":{"old_severity":"Medium","new_severity":"Medium (5.0)","old_severity_id":629709,"new_severity_id":632320},"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038141,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2020-02-13T07:24:11.264Z","updated_at":"2020-02-13T07:24:11.264Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zhutyra","url":"/zhutyra"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038142,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-02-13T07:24:17.032Z","updated_at":"2020-02-13T07:24:17.032Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"400.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"zhutyra","url":"/zhutyra"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7040258,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you very much for the bounty.","automated_response":false,"created_at":"2020-02-13T09:56:23.187Z","updated_at":"2020-02-13T09:56:23.187Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8319670,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-06-17T12:30:03.868Z","updated_at":"2020-06-17T12:30:03.868Z","first_to_agree":true,"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8321773,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-06-17T15:48:18.157Z","updated_at":"2020-06-17T15:48:18.157Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8321774,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-06-17T15:48:18.210Z","updated_at":"2020-06-17T15:48:18.210Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}