{"id":792960,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83OTI5NjA=","url":"https://hackerone.com/reports/792960","title":"SSRF - Guard - Unchecked WKS servers","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-02-11T07:04:33.124Z","submitted_at":"2020-02-11T07:04:33.124Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zhutyra","url":"/zhutyra","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-06-17T15:48:31.039Z","bug_reporter_agreed_on_going_public_at":"2020-06-17T15:48:30.980Z","team_member_agreed_on_going_public_at":"2020-06-17T12:30:48.940Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"#### Note\n\nThis is different vulnerability than HKP lookup #792953, although it does basically same thing and has same problem, these are independent implementations of key lookup and the vulnerable code isn't shared.\n\n## Description\n\nWhen encrypting an email, one of strategies to lookup recipient's encryption key is to contact a WKS keyserver specified in DNS records of recipient's domain.\n\nSpecifically it is `DNS SRV` records for `_openpgpkey._tcp.\u003cdomain\u003e`, which specify hostname and port of the keyserver.\n\nIn source code it is implemented in `WKSRecipKeyLookupStrategy`, `SRVWKSClientService`, `WKSClientImpl`, `WKSClient` classes.\n\nThe keyserver must be on subdomain of the original domain, but as WKS is just HTTP(S) protocol, the WKS server itself can later redirect clients to any other address.\n\n## Attack vectors\n\n* Server user can trigger this directly\n* External attacker can lure a server user to send them an encrypted email\n\n## Steps to reproduce\n\nAttached is a simple program {F712598} which implements DNS and WKS server.\n\nIt may be actually simpler to do it properly but in my testing this is what I did to not need DNSSEC and to be able to use self-signed certificate.\n\nPlease note that this *weakening* is just to simplify testing, it isn't required for the vulnerability or an attacker.\n\n* log in to nameserver for *\u003cyourdomain\u003e*\n* generate new certificate\n\n```\nnameserver# openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem\n...\nCommon Name (e.g. server FQDN or YOUR name) []: wks.\u003cyourdomain\u003e\n```\n* run my DNS/WKS server\n\n```\nnameserver# python3 wks-server.py \u003cns.ip.addr.ess\u003e\n```\n\n* log in to appsuite server\n* retrieve our certificate\n\n```\nappsuite# cd /tmp\nappsuite# echo \"\" | openssl s_client -connect wks.\u003cyourdomain\u003e:443 -showcerts 2\u003e/dev/null | openssl x509 -out certfile.txt\n```\n* import it to Java's trust store, so we can use our self-signed certificate\n\n```\nappsuite# cd /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/security  # Debian 9\nappsuite# keytool -import -alias wkstest -file /tmp/certfile.txt -keystore cacerts -storepass changeit\n...\nTrust this certificate? [no]:  yes\n```\n* edit `/opt/open-xchange/etc/guard-core.properties`, so we don't need DNSSEC\n\n```\ncom.openexchange.guard.keySources.trustLevelWKSServer=4 # by default it is 3 and trustThreshold is 4\n```\n* restart open-xchange\n\n```\nappsuite# systemctl restart open-xchange\n```\n* compose new email in OX App Suite\n* enter any address with your domain as recipient's address - *user@\u003cyourdomain\u003e*\n* click on `Enable Encryption` lock icon\n* in terminal on nameserver you should see output like this\n\n```\nDNS _openpgpkey._tcp.\u003cyourdomain\u003e.\n# answer to this ^^ will be wks.\u003cyourdomain\u003e:443\nDNS wks.\u003cyourdomain\u003e.\nGET wks.\u003cyourdomain\u003e:443/.well-known/openpgpkey/hu/864dx8gcr5d5xxxjc4azgzgnw5ckag6b\n# answer to this ^^ will be a redirect to localhost:1234\n```\n* in terminal on appsuite you should see output like this, confirming the SSRF\n\n```http\nGET /badthing HTTP/1.1\nHost: localhost:1234\nConnection: Keep-Alive\nUser-Agent: Apache-HttpClient/4.5.7 (Java/1.8.0_232)\nAccept-Encoding: gzip,deflate\n```\n\n## Impact\n\nAn attacker can trigger requests to internal resources.","bounty_amount":"400.0","formatted_bounty":"$400","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":712598,"file_name":"wks-server.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Wa99gtnjAxdYLi7cQDNfdyGc?response-content-disposition=attachment%3B%20filename%3D%22wks-server.py%22%3B%20filename%2A%3DUTF-8%27%27wks-server.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSWVBQGJF%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T152840Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIDKFbNpVUzrOPbUQYjhN4DgAxVU5%2FXEKmVfjCMWb%2BNkIAiABDuahSBdMUCytEahxX048K6jzH7PGdOzEr8bjHNv10CqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMFF93LkCZvrkmcBNoKtcDT4JSiF4LJ9dMlVWVXz6ozMkun%2BZIV%2FnNB6qVpNI4VDOdAc06QNZffMvjZwfupMjaAHpuIYcvqlkda6prO9SWrglyS6NCrBHv2gaT40jgHA6ufjwtH7OxGYsx039h%2Bh8lmcb39NUtDqetz1GDVn0P%2BUNi77DW4gUN5GnzWQsten34H99dGqb8t6pYxCQN%2F8DKWHJ%2BalzRH5DiTjmpYvgNaPu2xwo%2F6Zr8S4tdff1lzr%2BcSt%2FZceeJJnqd2Z9QEAJO7SqjLAnxMOiEuHPHYVOEZ3kfA%2B%2Bbt34tKfFC8MGX%2BXh1zYwal1wOrSP2k%2FZSlC9lsLebNN7Iooim1lSpjw7Du5GV89O7g%2F7rGROCUF%2B%2BB24LrVSbZTIggbHns1VxsRvSvZGmJHi7XvmhECvDwu9WmRNJs7XWIMzDD0fOHc22lsbafqmlkdZqwRzJhStehJfZCskFpe6v4wdnRFJqrnSW1n3s9Cn28vHMBxxweBr72n7tIeDBX4PMTrrfy%2B5OhLDCrxYOtKZndzmZHfMzTm0b0uMHvqjv6rofYcR42du%2BPYJ87HhllMZGstEyOaYDwXJ6mUAWqgFU1cRtr5KgJU%2BjBFYZrWtE%2BoZkvuXgEXg40jlw%2BeRQEreWMOGKkYsGOqYBYdUdmtOC7YWorffY3XWIt13STuNB47ZWJ85D8q%2F8hMPTVw3x9BFRZcvFy7ieSMolt4GYUK%2F8moEzkTt%2FanjYuLBUJFMJFunxOEvaMPJA128lGEkS1qX60D7%2BiOofrwvOesADqaqm%2FmYvf6HgURng7sqkiLxzy3mjSpM33Soz6mVH2tmMNYspiP4BF%2BNbXdXLCjYBsB98ENZjOy3b4d4U9P8NkvkUag%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=f9a1af699ae54459bd79d7d7ba67a6223be70b7735a68eda6f25c9527bba04b1","file_size":2253,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":4,"voters":["secator","brahim_boufakri01","ali","sl33pyp0t4t0"],"severity":{"rating":"medium","score":5.0,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"low","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":551,"asset_type":"URL","asset_identifier":"sandbox.open-xchange.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":7018763,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-02-11T10:53:27.158Z","updated_at":"2020-02-11T10:53:27.158Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038134,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2020-02-13T07:23:11.176Z","updated_at":"2020-02-13T07:23:11.176Z","additional_data":{"old_severity":"Medium","new_severity":"Medium (5.0)","old_severity_id":629720,"new_severity_id":632321},"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038138,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We solved this vulnerability internally and will provide a backport to in-production releases during the next weeks.","automated_response":false,"created_at":"2020-02-13T07:23:56.003Z","updated_at":"2020-02-13T07:23:56.003Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zhutyra","url":"/zhutyra"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7038139,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-02-13T07:24:02.285Z","updated_at":"2020-02-13T07:24:02.285Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"400.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"zhutyra","url":"/zhutyra"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7040254,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you very much for the bounty.","automated_response":false,"created_at":"2020-02-13T09:55:46.535Z","updated_at":"2020-02-13T09:55:46.535Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8319675,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-06-17T12:30:48.970Z","updated_at":"2020-06-17T12:30:48.970Z","first_to_agree":true,"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8321775,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-06-17T15:48:31.008Z","updated_at":"2020-06-17T15:48:31.008Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8321776,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-06-17T15:48:31.074Z","updated_at":"2020-06-17T15:48:31.074Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}