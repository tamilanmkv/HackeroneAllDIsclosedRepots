{"id":93691,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85MzY5MQ==","url":"https://hackerone.com/reports/93691","title":"Arbitrary write on s3://shopify-delivery-app-storage/files","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-10-13T19:22:49.202Z","submitted_at":"2015-10-13T19:22:49.202Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"brakhane","url":"/brakhane","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/040/726/4b47d99eec4ee906a402afb934855158d1e6d929_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2015-10-15T18:55:26.436Z","bug_reporter_agreed_on_going_public_at":"2015-10-15T18:55:26.206Z","team_member_agreed_on_going_public_at":"2015-10-14T22:31:57.913Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Short\n====\nThe policy used to upload files via the Delivery app is too generic which results in an arbitrary write (and replace) of files in the files/ directory.\n\nDisclaimer: While I was unable to create a second store to fully test this (I can't create new development stores right now, support is researching this), I strongly believe that this vulnerability works as I expect it to work due to the nature of the policy.\n\nCurrent Policy\n====\n\n    {\n    \"expiration\": \"2015-10-14T15:27:47Z\",\n    \"conditions\": [\n        {\n            \"bucket\": \"shopify-delivery-app-storage\"\n        },\n        [\n            \"starts-with\", \"$key\", \"files/\"\n        ],\n        {\n            \"acl\": \"private\"\n        },\n        {\n            \"success_action_status\": \"200\"\n        },\n        [\"content-length-range\", 0, 5368709120]\n    ]\n    }\n\n\nWhat's wrong here\n====\n\nThe only (security relevant) limitations we have here are:\n - Signature + Policy are only valid for one day\n - The key has to start with files/\n - ACL has to be set private\n\nSo, one can basically write arbitrary files to the S3 bucket as long as those are within the files/ dir. This doesn't hinder anybody as all the 'good stuff to replace' is under that dir. As the ACL is private, files can just be downloaded when the delivery app signed a download request, so the attacker needs to get a hold on a valid link.  \n\nThe vector\n====\n - Find a shop with a downloadable good and purchase it OR get a manual direct link\n - Grab the bucket key when the file will be downloaded directly from S3 (via signed url)\n - Go to your own shop, create a product with a downloadable good\n - Note down the parameters used to POST the file when you upload it\n - Issue a new request to the key recorded from the data you don't own with the parameters you just grabbed from your own delivery app\n - Profit\n\nOne could do a ton of fun stuff to the files, to my mind come Viruses, Exploits, Illegal Content, etc.\n\nHow it should be\n====\n\nThe policy should be tailored directly to the upload at hand, especially the key. The app does return the specific path already where the file should be placed by the client, I don't see why the policy doesn't reflect that. The policy should be nailed directly to that key to eliminate this vulnerability.\n\nWhat I did that you should cleanup\n====\nI did upload 2 files to the bucket which don't belong to anyone, those files are:\n - files/hackerone/simon/brakhane/kitty.jpg\n - files/kitty.jpg\n\nYou might want to clean them away as they can't be downloaded anyway and just cost you money.\n\nCheers,\nSimon\n\nPS: I do hope strongly this isn't already known ;)","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-11-13T22:31:58.125Z","allow_singular_disclosure_after":-186513090.3833123,"singular_disclosure_allowed":true,"vote_count":3,"voters":["drsniper","techguynoob","spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":619460,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\r\n\r\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\r\n\r\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","automated_response":true,"created_at":"2015-10-13T19:22:50.249Z","updated_at":"2015-10-13T19:22:50.249Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":619510,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. I have reproduced the issue and our engineering team is investigating.","automated_response":false,"created_at":"2015-10-13T20:17:25.785Z","updated_at":"2015-10-13T20:17:25.785Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":619581,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We just deployed a fix for the issue. The policy now requires an exact match for the file path.\n\nWe have a bit more testing to do on our end, and we will get back to you about a bounty within the next few days.\n\nCould you let us know the email address you used to sign up for your partner account so we can check why you aren't able to create new shops?","automated_response":false,"created_at":"2015-10-13T21:21:57.594Z","updated_at":"2015-10-13T21:21:57.594Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":621207,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify. This issue has been resolved.","automated_response":false,"created_at":"2015-10-14T22:31:44.158Z","updated_at":"2015-10-14T22:31:44.158Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"2000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"brakhane","url":"/brakhane"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":621208,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2015-10-14T22:31:53.249Z","updated_at":"2015-10-14T22:31:53.249Z","actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"brakhane","url":"/brakhane"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":621209,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-10-14T22:31:57.951Z","updated_at":"2015-10-14T22:31:57.951Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":621573,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"You're welcome and thanks for the bounty!\n\nMy problem regarding the shop creation disappeared yesterday after I was in contact with the support. No idea what cause the problems there, but they are gone by now.","automated_response":false,"created_at":"2015-10-15T08:28:17.098Z","updated_at":"2015-10-15T08:28:17.098Z","actor":{"username":"brakhane","cleared":false,"url":"/brakhane","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/726/4b47d99eec4ee906a402afb934855158d1e6d929_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":622179,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-10-15T18:55:26.231Z","updated_at":"2015-10-15T18:55:26.231Z","actor":{"username":"brakhane","cleared":false,"url":"/brakhane","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/726/4b47d99eec4ee906a402afb934855158d1e6d929_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":622180,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-10-15T18:55:26.460Z","updated_at":"2015-10-15T18:55:26.460Z","actor":{"username":"brakhane","cleared":false,"url":"/brakhane","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/726/4b47d99eec4ee906a402afb934855158d1e6d929_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}