{"id":865195,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84NjUxOTU=","url":"https://hackerone.com/reports/865195","title":"reading the stack data of the imap process","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2020-05-03T11:25:22.913Z","submitted_at":"2020-05-03T11:25:22.913Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ihsinme","url":"/ihsinme","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2021-03-10T14:18:17.474Z","bug_reporter_agreed_on_going_public_at":"2021-03-10T14:18:17.383Z","team_member_agreed_on_going_public_at":"2021-03-10T08:42:42.968Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"in dovecot / core in the imap-client-hibernate.c file in the imap_hibernate_handshake function, lines 31..39 contain vulnerable code:\n```cpp\n\t  else if ((ret = read(fd, buf, sizeof(buf)-1)) \u003c 0) {\n\t\ti_error(\"read(%s) failed: %m\", path);\n\t\treturn -1;\n\t} else if (ret \u003e 0 \u0026\u0026 buf[ret-1] == '\\n') {\n\t\tbuf[ret-1] = '\\0';\n\t\tif (version_string_verify(buf, \"imap-hibernate\", 1))\n\t\t\treturn 0;\n\t}\n\ti_error(\"%s sent invalid VERSION handshake: %s\", path, buf);\n```\n\nthe vulnerability of which is ensured by the allocation of the buf variable on the stack, which does not guarantee its initialization by zeros and if the 39th line of code is reached (i_error (\"% s sent invalid VERSION handshake:% s\", path, buf)), they can be sent to the mail server log stack junk data.\nConsidering that the call to this function occurs when the client sends the IDLE state after the mail has been collected, the data on the operation of the process imap can be on the stack.\nReachability 39 lines of code is possible in situations when the read function returns data without the '\\n' character at the end or returns 0 as a sign of lack of data.\n\nTo check the impact, I used the changes in the connection.c file, adding the following code to line 457:\n```cpp\nif (strcmp(set-\u003eservice_name_out,\"imap-hibernate\")==0)\n         o_stream_nsend_str(conn-\u003eoutput, t_strdup_printf(\"--%u--\",set-\u003eminor_version));\nelse\n```\nchanging the length of the transmitted buffer, I received a different number of additional bytes from the stack at the end.\nI also believe that there are other ways of influencing the interprocess communication channel imap and imap-hibernate.\n\n## Impact\n\nThe essence of the impact is the ability to include data in the mail server log.\n\nAs part of my experiments, I was able to read a few bytes.\nOn a real mail server, the data volume will be much higher, because there will be more clients and work will be done with e-mail, which will pollute the stack.","bounty_amount":"50.0","formatted_bounty":"$50","weakness":{"id":9,"name":"Buffer Over-read"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":14,"voters":["secator","th4nu_0x0","bl4de","ali","demonia","salahhasoneh","since2003","cryptographer","5kyw41k3r","yougotrektmatexd","and 4 more..."],"severity":{"rating":"low","score":2.3,"author_type":"User","metrics":{"attack_vector":"local","attack_complexity":"low","privileges_required":"high","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":42899,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/dovecot/core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":7882826,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi! Thank you for the report, we'll look into it. =)","automated_response":false,"created_at":"2020-05-04T06:30:38.636Z","updated_at":"2020-05-04T06:30:38.636Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7882918,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-05-04T06:43:47.167Z","updated_at":"2020-05-04T06:43:47.167Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7883670,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi!\n\nWe looked into this issue and while it's valid buffer overflow, we do not consider it a security issue as such. This is because the privileges required on most systems make it hard to see the actual data leak.\n\nWe will of course fix it eventually, and we will close this issue now as Resolved to grant you points for it. Thank you for taking the time to report this issue. If you feel that we have overlooked some aspect that would make it a practical security issue, please let us know.","automated_response":false,"created_at":"2020-05-04T07:27:03.854Z","updated_at":"2020-05-04T07:27:03.854Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"ihsinme","url":"/ihsinme"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7883690,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-05-04T07:28:26.229Z","updated_at":"2020-05-04T07:28:26.229Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"50.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"ihsinme","url":"/ihsinme"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7883858,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"thank","automated_response":false,"created_at":"2020-05-04T07:41:50.415Z","updated_at":"2020-05-04T07:41:50.415Z","actor":{"username":"ihsinme","cleared":false,"url":"/ihsinme","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7884374,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks again for the prompt reply. Itâ€™s really hard to find something that is a real security risk in your code because your code is good enough.\n\nBut speaking of the correction of the indicated section, I would like to draw attention to the following sections of your code, which theoretically can also be problematic, but fortunately they are protected by the implementation of work with the allocated memory pool, namely, its correct cleaning. If this code was used on a regular heap, then it would also be vulnerable:\n\nhttps://github.com/dovecot/core/blob/f9257a02efd2b32d983dad135b3eb7ed967c1e81/src/util/script-login.c#L47\nhttps://github.com/dovecot/core/blob/f9257a02efd2b32d983dad135b3eb7ed967c1e81/src/config/config-parser.c#L482\nhttps://github.com/dovecot/core/blob/f9257a02efd2b32d983dad135b3eb7ed967c1e81/src/auth/db-checkpassword.c#L306\n\nI hope this information will be useful to you in preparing corrections.","automated_response":false,"created_at":"2020-05-04T08:34:23.333Z","updated_at":"2020-05-04T08:34:23.333Z","actor":{"username":"ihsinme","cleared":false,"url":"/ihsinme","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7884692,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the extra information. We will check those to make sure there is no problem.","automated_response":false,"created_at":"2020-05-04T08:51:23.736Z","updated_at":"2020-05-04T08:51:23.736Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7885339,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"These code paths seem to be working as expected/designed. I'm not really sure what problem you see in them? The string_t doesn't use NUL terminated strings internally, so even if there was no internal cleaning in the memory pool it should work correctly.","automated_response":false,"created_at":"2020-05-04T09:33:31.493Z","updated_at":"2020-05-04T09:33:31.493Z","actor":{"username":"tss","cleared":false,"url":"/tss","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7885518,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"All specified places are passed not for the terminated string to the str_append_data function, in which the string is still terminated in two places:\n1. https://github.com/dovecot/core/blob/3edf96f22a54ca06e635142fa3235903adcd2054/src/lib/buffer.c#L58\n2. https://github.com/dovecot/core/blob/3edf96f22a54ca06e635142fa3235903adcd2054/src/lib/buffer.c#L65\n\nAt the same time, this termination did not occur in the second case on a real heap, since the heap remains dirty from the end upon release.","automated_response":false,"created_at":"2020-05-04T09:48:01.464Z","updated_at":"2020-05-04T09:48:01.464Z","actor":{"username":"ihsinme","cleared":false,"url":"/ihsinme","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10942563,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This has been now merged.","automated_response":false,"created_at":"2021-03-10T08:42:43.003Z","updated_at":"2021-03-10T08:42:43.003Z","first_to_agree":true,"actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10946163,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-03-10T14:18:17.417Z","updated_at":"2021-03-10T14:18:17.417Z","actor":{"username":"ihsinme","cleared":false,"url":"/ihsinme","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10946164,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-03-10T14:18:17.514Z","updated_at":"2021-03-10T14:18:17.514Z","actor":{"username":"ihsinme","cleared":false,"url":"/ihsinme","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EfzvpGEZUFwUq5x6HAHsiUtY/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}