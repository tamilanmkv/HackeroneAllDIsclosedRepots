{"id":330105,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zMzAxMDU=","url":"https://hackerone.com/reports/330105","title":"Exploitable vulnerability in SDEX","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-03-26T22:10:22.372Z","submitted_at":"2018-03-26T22:10:22.372Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"orbitlens","url":"/orbitlens","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":20287,"url":"https://hackerone.com/stellar","handle":"stellar","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ULGxmU4deMmgF8BMsZ5EqRaZ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/ULGxmU4deMmgF8BMsZ5EqRaZ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Stellar.org","twitter_handle":"stellarorg","website":"https://www.stellar.org","about":""}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-10-14T07:51:57.947Z","bug_reporter_agreed_on_going_public_at":"2018-09-14T07:51:50.143Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\n\nLast Thursday I discovered the exploitable vulnerability in SDEX. I immediately reported the bug directly to Jed by email and he confirmed it.  \n\nIt's all about rounding during trades. You see, I found that orders are always executed if the price matches market, even if the amount is as small as 0.0000001. A minimum traded amount is also 0.0000001, so if we are buying the more valued asset (say, we are buying BTC for XLM), **an asset is traded 1:1 regardless of the price set in MANAGE_ORDER operation**.\n\nIt's not a problem if traded assets have roughly equal value (for example, MOBY/XLM rate is 0.34, CNY/XLM - 0.66). Nobody sanely will spend 100 stroops for fees just to trade 0.0000001 CNY with a slightly better rate.  \n\nNow let's consider trading on XLM/BTC pair. Market exchange price is ~ **37,000 XLM/BTC**.  \n\nI create an order selling 0.0000001 XLM with a price, say, 50,000 XLM/BTC and submit it to the network. The price is higher than avg market, so the order is executed immediately. That's it, **I bought 0.0000001 BTC for 0.0000001 XLM**. If I trade back BTC back to lumens at the market price I'll get **0.0037000** XLM, which is much greater than originally spent **0.0000101** XLM.  \n\n## Proof\n\n(examples on Mainnet)  \n\n- ManageOffer: https://horizon.stellar.org/operations/71512944940158977\n- Effects: https://horizon.stellar.org/operations/71512944940158977/effects\n  \n(reproduced on Testnet) \n\n- ManageOffer: https://horizon-testnet.stellar.org/operations/34556568129245185\n- Account effects: https://horizon-testnet.stellar.org/accounts/GDD7OTUPGR7FMJZLSLYLXTUCPG5IA5UTSPXXZWYRX3HJMGMWWSKCCH65/effects\n- Account balance: https://horizon-testnet.stellar.org/accounts/GDD7OTUPGR7FMJZLSLYLXTUCPG5IA5UTSPXXZWYRX3HJMGMWWSKCCH65\n\n## Attack vector\n\n1. Create 20 accounts and fund with, say, 120 XLM each.\n2. Code a primitive bot that submits a transaction with 100 ManageOffer operations for each account every 4 seconds (roughly 900\\*100 =90,000 operations per hour for each account).\n3. Rent a cheap cloud server and launch the bot.\n4. Once in 10 minutes or so bot should sell all traded BTC at market price and send all profits to a master-account.\n5. Repeat until there is at least one open offer. Then switch to another asset (BTC issued by another anchor, or, for example, ETH tokens).\n\n**Attacker hourly profit:**\n\n`(0.0037-0.0000101) * 20 * 90000=6641.82 XLM/hour.`\n\nIf the attacker is greedy, he may initially create up to 50 accounts instead of 20. However, it will immediately affect the overall network performance and everybody will be alarmed. A witty attacker may rather run a bot with 20-30 accounts on a Sunday night to gain a maximum profit.\u0026nbsp;\n\nTraders that are selling BTC (or any other pricey asset) are effectively loosing all money, because offers are traded at a fraction (**1/37,000 in case of BTC)** of the market value despite the fact that the initial price was set correctly.\n\nNot sure if this issue is eligible for reward, as Jed mentioned that you are working on something like this. If yes, here is my account address:\n\n`GB3VFWJW7ZSY2VX666SMVQNHAOMTQ6Y2723CU4XL26F455574JNLC54Z`\n\n## Impact\n\nAn attack may lead to a loss of a substantial amount of users' funds. It can't be stopped or prevented without the entire Stellar Network upgrade due to the nature of the distributed ledger. \n\nOnce an attacker is blocked, he may change an IP or the target Stellar Core validator node and continue an attack. In such case he can still more than 100,000 XLM (~20,000 USD) during the first day of attack.","weakness":{"id":65,"name":"Business Logic Errors"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-10-14T07:51:50.254Z","allow_singular_disclosure_after":-94460090.20892201,"singular_disclosure_allowed":true,"vote_count":25,"voters":["sp1d3rs","sameerphad72","wisp","miguel_santareno","mik317","armaanpathan","ali","metnew","r3y","an0nym0us","and 15 more..."],"severity":{"rating":"high","score":7.2,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"none","integrity":"low","availability":"low"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2534542,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for the report. We are investigating this.","automated_response":false,"created_at":"2018-03-27T07:24:11.308Z","updated_at":"2018-03-27T07:24:11.308Z","actor":{"username":"bart","cleared":false,"url":"/bart","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/154/65b70bcb5b2ee4ae9ac8c6f518590c3cb9c08550_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3286960,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yesterday @fritz reported the strange activity to the public #validators channel. I asked him to remove messages, looks like nobody had seen them.\n\nSo some guy is exploiting the vulnerability right now: \nhttps://horizon.stellar.org/trades?cursor=84982168538882049-87\u0026counter_asset_type=credit_alphanum4\u0026base_asset_type=native\u0026counter_asset_issuer=GATEMHCCKCY67ZUCKTROYN24ZYT5GK4EQZ65JJLDHKHRUZI3EUEKMTCH\u0026counter_asset_code=BTC\u0026base_asset_code=XLM\u0026order=desc\u0026limit=100\n\nI examine the situation around the problem periodically. There are more than one account using this exploit already. At least two of them were created today. \nhttps://stellar.expert/explorer/public/account/GCFZQ2NSPDRBP2DRIW6HJVOQ2NUE564PPBV72VJKELOVSEVV6PQ2ISCL\nhttps://stellar.expert/explorer/public/account/GDHKVKHCDUESQVMM7KSQCUGWPKH3IYKZRMALTQZO7YIEW5M6V2IBPQJA\nhttps://stellar.expert/explorer/public/account/GDYOVUZLB6U6BUAEGPAKQVOLRIBHK7TRJ2RXP3GASFGUHE4FZT2YGCQZ\n\nIt seems to me that I found the guy who is behind all this.\n\nAll those new accounts are funded by [GAS2ZJKYAIYS5JO3LDYBCQH3FHPWKDRW5MG7JTZA2FGFSUTIRTV2QHTX](https://stellar.expert/explorer/public/account/GAS2ZJKYAIYS5JO3LDYBCQH3FHPWKDRW5MG7JTZA2FGFSUTIRTV2QHTX?filter=settings), which was created by [GBCKM7MWKT7KLEIOPA62OCWJNY5Z6IMTXKLA4EJMAHWZXODE7IIBDOMQ](https://stellar.expert/explorer/public/account/GBCKM7MWKT7KLEIOPA62OCWJNY5Z6IMTXKLA4EJMAHWZXODE7IIBDOMQ?filter=settings) on 01 Sep 2018. GBCK...DOMQ was then merged into the GAS2...QHTX, so it's definitely a \"successor\" account, and the secret key of both accounts are controlled by the same person. \n\nGBCK...DOMQ was created by [GADZ2K6ICGNHLC7ATW6DFQQXRY2UU6MTFOBLRC7PJ7YB2WHGWLOJCIA5](https://stellar.expert/explorer/public/account/GADZ2K6ICGNHLC7ATW6DFQQXRY2UU6MTFOBLRC7PJ7YB2WHGWLOJCIA5?filter=settings). It looks like GADZ...CIA5 is a trader account backed by Stronghold (`home_domain` set to stronghold.co). \n\nIf you contact Stronghold, they will give you personal details of that trader. His account was either hacked (seems unlikely), or he is behind this history with the exploit.\n\nThe attacker buys BTC at 1/3 of real price. This guy so far does not understand that he can buy BTC at 1/30,000 of real price and submit 100 such operations in each transaction. But I think he will get it soon.","automated_response":false,"created_at":"2018-09-03T22:30:27.822Z","updated_at":"2018-09-03T22:30:27.822Z","actor":{"username":"orbitlens","cleared":false,"url":"/orbitlens","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3290165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for monitoring this. I repeated the same offers (using new random accounts) in testnet that is running v10 and amounts transacted are equal `0`: https://horizon-testnet.stellar.org/transactions/71ab2e706956021ad4ac23ae0af737efab671f3b63edccb715bae42228e5738c/effects\n\nWe will publish production releases of V10 core and horizon in the end of this week.","automated_response":false,"created_at":"2018-09-04T14:27:14.413Z","updated_at":"2018-09-04T14:27:14.413Z","actor":{"username":"bart","cleared":false,"url":"/bart","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/154/65b70bcb5b2ee4ae9ac8c6f518590c3cb9c08550_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3333483,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Public network has been upgraded to version 10. This has been fixed.","automated_response":false,"created_at":"2018-09-13T17:31:38.287Z","updated_at":"2018-09-13T17:31:38.287Z","actor":{"username":"bart","cleared":false,"url":"/bart","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/154/65b70bcb5b2ee4ae9ac8c6f518590c3cb9c08550_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"orbitlens","url":"/orbitlens"},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3336034,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Great!","automated_response":false,"created_at":"2018-09-14T07:51:50.183Z","updated_at":"2018-09-14T07:51:50.183Z","first_to_agree":true,"actor":{"username":"orbitlens","cleared":false,"url":"/orbitlens","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3477433,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-10-14T07:51:57.961Z","updated_at":"2018-10-14T07:51:57.961Z","actor":{"url":"/stellar","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ULGxmU4deMmgF8BMsZ5EqRaZ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Stellar.org"}},"genius_execution_id":null,"team_handle":"stellar","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}