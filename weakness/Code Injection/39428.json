{"id":39428,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTQyOA==","url":"https://hackerone.com/reports/39428","title":"Phabricator Phame Blog Skins Local File Inclusion","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-12-15T15:52:43.735Z","submitted_at":"2014-12-15T15:52:43.735Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"nullsub","url":"/nullsub","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-01-14T18:50:23.905Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-12-15T18:50:18.747Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Phabricator's Phame blog allows users to set a skin.\r\n\r\nAn attacker with the ability to upload files to the server can exploit this LFI vulnerability to gain remote code execution through Phabricator and thus, gain access to Phabricator's data. Common scenarios may include:\r\n\r\n- A box serving Phabricator and other web application that would allow uploading files to controlled paths.\r\n- A box where the attacker can log in through ssh as a restricted user (not having access to Phabricator's files, but having access to write in /tmp, for instance)\r\n- etc ...\r\n\r\nWhile testing, I used the following request to create a blog:\r\n\r\n```\r\nPOST /phame/blog/new/ HTTP/1.1\r\nHost: phabricator\r\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\nAccept-Language: en-GB,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nReferer: http://phabricator.48bits.com/phame/blog/new/\r\nCookie: phsid=o36kfovszv6sqpbjheacicu2ykx25lqoh5iepeit; phusr=guest\r\nConnection: keep-alive\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 254\r\n\r\n__csrf__=B%40acbxwmgk39152b45fd9eff2e\u0026__form__=1\u0026name=xxxx\u0026description=bla\u0026can_view=users\u0026can_edit=users\u0026can_join=users\u0026custom_domain=\u0026skin=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%74%6d%70%2f%74%65%73%74\r\n```\r\n\r\nThat makes phabricator try to load the skin template php files from:\r\n\r\n/var/www/phabricator/phabricator/externals/skins/../../../../../../../../../../tmp/test/\r\n\r\nIn order to exploit the vulnerability a valid skin structure must exist at the specified location, I have simply copied the oblivious skin and modified it to output a phpinfo() within the header.php script with the expected results.\r\n\r\nProposed fix:\r\n\r\nPhabricator should verify that the skin's path is not outside its own root.\r\n\r\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-01-14T18:50:18.868Z","allow_singular_disclosure_after":-212702703.24046373,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":178572,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Some more thoughts... there are things that I haven't tested yet (wanted to report you straight away) , but you may be able to shed some light with:                                                               \n                   \n- I believe users with the ability to write to a repository may also be able to exploit this.  \n- Not sure how files are stored locally if not using MySQL but that could be another avenue to gain RCE by users.\n\n","automated_response":false,"created_at":"2014-12-15T16:03:44.958Z","updated_at":"2014-12-15T16:03:44.958Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":178687,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, confirming...","automated_response":false,"created_at":"2014-12-15T18:08:58.776Z","updated_at":"2014-12-15T18:08:58.776Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178701,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I was able to reproduce this by following your instructions. Nice catch! Fix out for review:\n\nhttps://secure.phabricator.com/D10992","automated_response":false,"created_at":"2014-12-15T18:27:36.284Z","updated_at":"2014-12-15T18:27:36.284Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178711,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!, just checked your fix, it looks fine to me now.","automated_response":false,"created_at":"2014-12-15T18:36:17.644Z","updated_at":"2014-12-15T18:36:17.644Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":178712,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This is now fixed in HEAD:\n\nhttps://secure.phabricator.com/rP2037979142cb2e8b5edb8dc2361567c755bb7396","automated_response":false,"created_at":"2014-12-15T18:42:27.382Z","updated_at":"2014-12-15T18:42:27.382Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"nullsub","url":"/nullsub"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178723,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"This vulnerability is severe, but two factors that make it difficult to exploit partially mitigate it:\n\n  - Phame is a \"prototype\" application, and not installed by default. Prototype applications are heavily caveated in the documentation (https://secure.phabricator.com/book/phabricator/article/prototypes/).\n  - The attacker would also need to write to local disk, and need some control over file paths. I don't believe an attacker -- even one with substantial access -- could normally perform these writes. They could write to disk if `storage.local-file-path` is configured, but can not reconfigure it without CLI access and can not control written paths (I believe this would prevent them from writing a valid-looking skin which Phabricator would actually load). They could push to a repository, but repositories are normally stored in bare mode, so the actual files do not exist on disk (e.g., under git, they are compressed and stored as objects). As you mention, an attacker with existing access to the machine could easily do these writes, but that's unusual in most configurations of Phabricator.\n\n","automated_response":false,"created_at":"2014-12-15T18:49:35.752Z","updated_at":"2014-12-15T18:49:35.752Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"nullsub","url":"/nullsub"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178725,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The fix for this issue is publicly available, so it can be disclosed at any time.\n\nThanks for the report!","automated_response":false,"created_at":"2014-12-15T18:50:18.764Z","updated_at":"2014-12-15T18:50:18.764Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178732,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the bounty and for your clarifications","automated_response":false,"created_at":"2014-12-15T18:53:08.489Z","updated_at":"2014-12-15T18:53:08.489Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":310665,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-01-14T18:50:24.602Z","updated_at":"2015-01-14T18:50:24.602Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}