{"id":163338,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNjMzMzg=","url":"https://hackerone.com/reports/163338","title":"\\OCA\\DAV\\CardDAV\\ImageExportPlugin allows serving arbitrary data with user-defined or empty mimetype","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2016-08-25T13:26:40.644Z","submitted_at":"2016-08-25T13:26:40.644Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"lukasreschke","url":"/lukasreschke","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2016-9465"],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-03T21:59:28.846Z","bug_reporter_agreed_on_going_public_at":"2016-11-03T21:59:15.769Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The SabreDAV plugin `\\OCA\\DAV\\CardDAV\\ImageExportPlugin` is used for displaying pictures of a VCF. It registers on a GET request on a CardDAV element and acts when the query parameter `photo` is sent.\n\nThe logic can be seen below:\n```\n/**\n * Intercepts GET requests on addressbook urls ending with ?photo.\n *\n * @param RequestInterface $request\n * @param ResponseInterface $response\n * @return bool|void\n */\nfunction httpGet(RequestInterface $request, ResponseInterface $response) {\n\n\t$queryParams = $request-\u003egetQueryParameters();\n\t// TODO: in addition to photo we should also add logo some point in time\n\tif (!array_key_exists('photo', $queryParams)) {\n\t\treturn true;\n\t}\n\n\t$path = $request-\u003egetPath();\n\t$node = $this-\u003eserver-\u003etree-\u003egetNodeForPath($path);\n\n\tif (!($node instanceof Card)) {\n\t\treturn true;\n\t}\n\n\t$this-\u003eserver-\u003etransactionType = 'carddav-image-export';\n\n\t// Checking ACL, if available.\n\tif ($aclPlugin = $this-\u003eserver-\u003egetPlugin('acl')) {\n\t\t/** @var \\Sabre\\DAVACL\\Plugin $aclPlugin */\n\t\t$aclPlugin-\u003echeckPrivileges($path, '{DAV:}read');\n\t}\n\n\tif ($result = $this-\u003egetPhoto($node)) {\n\t\t$response-\u003esetHeader('Content-Type', $result['Content-Type']);\n\t\t$response-\u003esetStatus(200);\n\n\t\t$response-\u003esetBody($result['body']);\n\n\t\t// Returning false to break the event chain\n\t\treturn false;\n\t}\n\treturn true;\n}\n```\n\nAs can be seen the the content-type is read from `$this-\u003egetPhoto($node)` as well as the body, looking at it's implementation shows that the data is directly read from the vCard:\n\n```\nfunction getPhoto(Card $node) {\n\t// TODO: this is kind of expensive - load carddav data from database and parse it\n\t//       we might want to build up a cache one day\n\ttry {\n\t\t$vObject = $this-\u003ereadCard($node-\u003eget());\n\t\tif (!$vObject-\u003ePHOTO) {\n\t\t\treturn false;\n\t\t}\n\n\t\t$photo = $vObject-\u003ePHOTO;\n\t\t$type = $this-\u003egetType($photo);\n\n\t\t$val = $photo-\u003egetValue();\n\t\tif ($photo-\u003egetValueType() === 'URI') {\n\t\t\t$parsed = \\Sabre\\URI\\parse($val);\n\t\t\t//only allow data://\n\t\t\tif ($parsed['scheme'] !== 'data') {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (substr_count($parsed['path'], ';') === 1) {\n\t\t\t\tlist($type,) = explode(';', $parsed['path']);\n\t\t\t}\n\t\t\t$val = file_get_contents($val);\n\t\t}\n\t\treturn [\n\t\t\t'Content-Type' =\u003e $type,\n\t\t\t'body' =\u003e $val\n\t\t];\n\t} catch(\\Exception $ex) {\n\t\t$this-\u003elogger-\u003elogException($ex);\n\t}\n\treturn false;\n}\n```\n\nThis means if somebody uploads a VCF with the following content this will deliver the content `\u003chtml\u003e\u003cfont color=\"red\"\u003etest\u003c/font\u003e\u003c/html\u003e` with an empty Content-Type. The photo is a base64 encoding of before mentioned string.\n\n```\nBEGIN:VCARD\nVERSION:3.0\nFN:test\nUID:5cf6e5e2-ec37-4798-abb7-3c261eda92c9\nPHOTO;ENCODING=b:PGh0bWw+PGZvbnQgY29sb3I9InJlZCI+dGVzdDwvZm9udD48L2h0bWw+\nEND:VCARD\n```\n\nThen it's sufficient to just access http://10.211.55.7/stable9/remote.php/dav/addressbooks/users/admin/contacts/5cf6e5e2-ec37-4798-abb7-3c261eda92c9.vcf?photo, the easiest to reproduce this is by enabling `debug` mode and using Internet Explorer since we employ CSP which largely mitigates the issue.\n\nAs another remark, we should replace the `file_get_contents` with another implementation. This seems currently like a too risky implementation for me.\n\n{F114833}","weakness":{"id":60,"name":"Cross-site Scripting (XSS) - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":114833,"file_name":"2016-08-25_15-26-06.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/114/833/4aa3fbc2c1e64d92e8781dae48f5740964b607ea/2016-08-25_15-26-06.png?response-content-disposition=attachment%3B%20filename%3D%222016-08-25_15-26-06.png%22%3B%20filename%2A%3DUTF-8%27%272016-08-25_15-26-06.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRCOM766B%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T134824Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQC2plSLprTu8RjGD8JYtZWBPt0cszlQG9FE345fmJX2hAIhALFlvJYKDzrEhN7%2FvlACW3w%2FuqitMoDByli%2BB32UD4xHKoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5Igydotw%2BzjeVoEUzifsq1wO17iYJRnZ0fDCk2qA3GFkCAi2TACWamwiykehERisJcA6JAf5%2BKDXCSCA9Z5sJN1RS6yYikkzrd1g0%2FNHQvlKNEb%2F0bkFdpBo983pYtuPm%2FjZwdUmgycUkQTsKElvIdrra2ORU8syHUfTSsU0jkhKy1nTU1EUbOyVSpNZUO9kXRRe3ohujd32sjmj8LzGUv8aTvRQduIzkPVeEQOKzFH7EgJMvdNR3vaK2TDhSXjMkBaQKBFqnh6PEMyOLZDUpbrlIy%2BoEq2r%2B%2F10hoGkdsLCXXLTZ6FqEIiLpzSb0Iu7CYkr0MdHXUykD4DOTntKsy9rifi4r4BROm%2BFSV7DvWqgt3W4BdQyDDpqk1mezBTFX0MzxjgcpwKW8P9MAJbLCDmqfTTPFk4Q3hwN161Se85vO9XLNOyRVtPGBxj7OBbf9ALPJ5O3JeDoWAJMilj8zwYEUZ8HB%2BwxjDJ9XD8WIvUhkGyonPTYta41EE5Apa%2BuA9mDzlzHtztW9QWk0A9Sy6yWDe5RV1BvTfuQDIENmCujUYeHBAI1LctTr5dAfQfpbR25kBWiGSGkGj66CsyM%2Fv4WpFwB06OZt5%2FWKkqDvm8EJ4nRBeXyQEZgKwI6%2BBfR8uHZJrNaXh7ww%2FuiQiwY6pAG6PxCWeEgmj5NWNLAASGSJOsH%2B4v2Ym%2BQKqlIQLRYFFWUC%2FZOjX8OosfCA%2F2VoFSUqa9gE9u1ak8ebfBQMrD4qWG%2BNBuWtrVAT0zNhYQeLm7qYZBf6nK1%2F4Q%2FfiKY5Hwm5q1KG1XzDtwU7hRI5PfdeIVO1imHecmyw8jlgyE%2Bpn%2Bt6DW7WJdNcVKLCb%2BX4TDKDa3Lt%2FOx7FpCltN7n4hWkIyVpiw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=cae34454658506f4a6b927d7c8a470c1b7d73398fe3440d8e8e8885fd6f51448","file_size":84417,"type":"image/png"}],"allow_singular_disclosure_at":"2016-12-03T21:59:15.809Z","allow_singular_disclosure_after":-153157748.5003576,"singular_disclosure_allowed":true,"vote_count":9,"voters":["lukasreschke","secator","mpz","kiraak-boy","alfredsaonoy","ishahriyar","demo--hacker","spetr0x","dyabla"],"severity":{"rating":"medium","score":5.4,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"required","scope":"changed","confidentiality":"low","integrity":"low","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1153734,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","automated_response":true,"created_at":"2016-08-25T13:26:40.835Z","updated_at":"2016-08-25T13:26:40.835Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1153737,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"No reward since this is an internal finding.","automated_response":false,"created_at":"2016-08-25T13:27:03.345Z","updated_at":"2016-08-25T13:27:03.345Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1153738,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"cc @nickvergessen FYI, as discussed in IRC.","automated_response":false,"created_at":"2016-08-25T13:27:22.219Z","updated_at":"2016-08-25T13:27:22.219Z","actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1153741,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"To fix this we probably should always require one of the following mimetypes:\n\n- JPG\n- PNG\n- GIF\n- TIFF\n\n For parsing data URIs I found http://stackoverflow.com/a/6735480","automated_response":false,"created_at":"2016-08-25T13:29:14.960Z","updated_at":"2016-08-25T13:29:14.960Z","actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1184191,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Patches:\n\n- master: https://github.com/nextcloud/server/pull/1339\n- stable10: https://github.com/nextcloud/server/pull/1340","automated_response":false,"created_at":"2016-09-09T10:37:35.253Z","updated_at":"2016-09-09T10:37:35.253Z","actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1239987,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2016-10-10T12:36:50.164Z","updated_at":"2016-10-10T12:36:50.164Z","additional_data":{"old_severity":null,"new_severity":"Medium (5.4)","old_severity_id":null,"new_severity_id":1271},"actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1239988,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Closing as resolved, no bounty since internal finding.","automated_response":false,"created_at":"2016-10-10T12:37:06.712Z","updated_at":"2016-10-10T12:37:38.555Z","actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"lukasreschke","url":"/lukasreschke"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1283466,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-11-03T21:59:15.788Z","updated_at":"2016-11-03T21:59:15.788Z","first_to_agree":true,"actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1339199,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-12-03T21:59:28.862Z","updated_at":"2016-12-03T21:59:28.862Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}