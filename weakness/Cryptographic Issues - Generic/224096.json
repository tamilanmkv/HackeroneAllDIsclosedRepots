{"id":224096,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjQwOTY=","url":"https://hackerone.com/reports/224096","title":"ShopifyAPI is vulnerable to timing attacks.","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-04-26T16:31:49.207Z","submitted_at":"2017-04-26T16:31:49.207Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"edoverflow","url":"/edoverflow","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/116/374/9a3cf4d62b2f507a0d33808aacbad863ec4455ac_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-06-23T15:36:23.392Z","bug_reporter_agreed_on_going_public_at":"2017-06-23T15:30:37.677Z","team_member_agreed_on_going_public_at":"2017-06-23T15:36:23.360Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Dear Shopify bug bounty team,\n\nThe [Python ShopifyAPI](https://github.com/Shopify/shopify_python_api) library is vulnerable to timing attacks, because the `validate_hmac()` falls back to a non-constant time comparison when `hmac.compare_digest()` is not available. I am perfectly aware that this issue is out of scope, but your Shopify Guru (Jack P.) kindly advised me to report this issue here.\n\n# Summary\n---\n\nTiming attacks are a type of side channel attack where one can discover valuable information by recording the time it takes for a cryptographic algorithm to execute.\n\nThe issue lies in `shopify/session.py`'s `validate_hmac()` function:\n\n~~~\n# Try to use compare_digest() to reduce vulnerability to timing attacks.\n# If it's not available, just fall back to regular string comparison.\ntry:\n    return hmac.compare_digest(hmac_calculated, hmac_to_verify)\nexcept AttributeError:\n    return hmac_calculated == hmac_to_verify\n~~~\n\nThe `==` operator does a byte-by-byte comparison of two values and as soon as the two differentiate it terminates. This means the longer it takes until the operation returns, the more correct characters the attacker has guessed. It is important to note that this issue really only affects users using Python versions prior to 2.7.7.\n\nLink to source code: https://github.com/Shopify/shopify_python_api/blob/master/shopify/session.py#L115-L120\n\n# PoC\n---\n\nHere is a quick and messy PoC to demonstrate the issue:\n\n~~~python\nimport time, hmac\n\n\ndef timing(f):\n    def wrap(*args):\n        time1 = time.time()\n        ret = f(*args)\n        time2 = time.time()\n        print '%s took %0.3f ms' % (f.func_name, (time2-time1)*1000.0)\n        return ret\n    return wrap\n\n@timing\ndef timing_attack_diff():\n    s1 = \"100000000000000000000000000000000\"\n    s2 = \"000000000000000000000000000000001\"\n    for i in range(200):\n        if not s1 == s2:\n            print i\n\n@timing\ndef timing_attack_same():\n    s1 = \"100000000000000000000000000000000\"\n    s2 = \"100000000000000000000000000000000\"\n    for i in range(200):\n        if s1 == s2:\n            print i\n\n@timing\ndef constant_time_diff():\n    s1 = b\"100000000000000000000000000000000\"\n    s2 = b\"000000000000000010000000000000000\"\n    for i in range(200):\n        if not hmac.compare_digest(s1, s2):\n            print i\n        \n@timing\ndef constant_time_same():\n    s1 = b\"100000000000000000000000000000000\"\n    s2 = b\"100000000000000000000000000000000\"\n    for i in range(200):\n        if hmac.compare_digest(s1, s2):\n            print i\n\ntiming_attack_diff()\ntiming_attack_same()\nconstant_time_diff()\nconstant_time_same()\n~~~\n\nThe results are quite significant:\n\n| Round   | timing_attack_diff | timing_attack_same | constant_time_diff | constant_time_same |\n|---------|---------------------------|---------------------------|---------------------------|---------------------------|\n| Round 1 | 2463 ms                   | 2365 ms                   | 2310 ms                   | 2329 ms                   |\n| Round 2 | 2219 ms                   | 2175 ms                   | 2156 ms                   | 2188 ms                   |\n\n# How can this be fixed?\n---\n\n~~~python\n# Try to use compare_digest() to reduce vulnerability to timing attacks.\ntry:\n    return hmac.compare_digest(hmac_calculated, hmac_to_verify)\nexcept AttributeError:\n    def fallback_constant_time(hmac_calculated, hmac_to_verify):\n    if len(hmac_calculated) != len(hmac_to_verify):\n        return False\n    \n    result = 0\n    for x, y in zip(hmac_calculated, hmac_to_verify):\n        result |= x ^ y\n    return result == 0\n~~~\n\nThis fallback does not terminate as soon as two bytes are not the same. I am willing to submit a PR to solve this issue, but I need your permission first.\n\n# Just one more little thing\n---\n\nThe \"Verify the request\" section over in the [docs](https://help.shopify.com/api/tutorials/building-public-app) is also vulnerable to timing attacks:\n\n~~~ruby\nif not (hmac == digest)\n    return [403, \"Authentication failed. Digest provided was: #{digest}\"]\nend\n~~~\n\nBest regards,\nEd","weakness":{"id":32,"name":"Cryptographic Issues - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":179737,"file_name":"shopify_timing_attack_poc.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/179/737/884207803eea164ebea174299ec87252d168f995/shopify_timing_attack_poc.py?response-content-disposition=attachment%3B%20filename%3D%22shopify_timing_attack_poc.py%22%3B%20filename%2A%3DUTF-8%27%27shopify_timing_attack_poc.py\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRCOM766B%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T140824Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQC2plSLprTu8RjGD8JYtZWBPt0cszlQG9FE345fmJX2hAIhALFlvJYKDzrEhN7%2FvlACW3w%2FuqitMoDByli%2BB32UD4xHKoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5Igydotw%2BzjeVoEUzifsq1wO17iYJRnZ0fDCk2qA3GFkCAi2TACWamwiykehERisJcA6JAf5%2BKDXCSCA9Z5sJN1RS6yYikkzrd1g0%2FNHQvlKNEb%2F0bkFdpBo983pYtuPm%2FjZwdUmgycUkQTsKElvIdrra2ORU8syHUfTSsU0jkhKy1nTU1EUbOyVSpNZUO9kXRRe3ohujd32sjmj8LzGUv8aTvRQduIzkPVeEQOKzFH7EgJMvdNR3vaK2TDhSXjMkBaQKBFqnh6PEMyOLZDUpbrlIy%2BoEq2r%2B%2F10hoGkdsLCXXLTZ6FqEIiLpzSb0Iu7CYkr0MdHXUykD4DOTntKsy9rifi4r4BROm%2BFSV7DvWqgt3W4BdQyDDpqk1mezBTFX0MzxjgcpwKW8P9MAJbLCDmqfTTPFk4Q3hwN161Se85vO9XLNOyRVtPGBxj7OBbf9ALPJ5O3JeDoWAJMilj8zwYEUZ8HB%2BwxjDJ9XD8WIvUhkGyonPTYta41EE5Apa%2BuA9mDzlzHtztW9QWk0A9Sy6yWDe5RV1BvTfuQDIENmCujUYeHBAI1LctTr5dAfQfpbR25kBWiGSGkGj66CsyM%2Fv4WpFwB06OZt5%2FWKkqDvm8EJ4nRBeXyQEZgKwI6%2BBfR8uHZJrNaXh7ww%2FuiQiwY6pAG6PxCWeEgmj5NWNLAASGSJOsH%2B4v2Ym%2BQKqlIQLRYFFWUC%2FZOjX8OosfCA%2F2VoFSUqa9gE9u1ak8ebfBQMrD4qWG%2BNBuWtrVAT0zNhYQeLm7qYZBf6nK1%2F4Q%2FfiKY5Hwm5q1KG1XzDtwU7hRI5PfdeIVO1imHecmyw8jlgyE%2Bpn%2Bt6DW7WJdNcVKLCb%2BX4TDKDa3Lt%2FOx7FpCltN7n4hWkIyVpiw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=3682a4bc3974d2d1fea4047ed0052f2beceaf3cd9bb9ef2e3426f4689eb70c57","file_size":1194,"type":"text/plain"}],"allow_singular_disclosure_at":null,"vote_count":9,"voters":["drsniper","muhammad_uwais","eveeez","r3y","christophetd","b3nac","exadmin","hacklad","dolph1n"],"severity":{"rating":"low","score":3.7,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"none","integrity":"low","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1638017,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\n\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","automated_response":true,"created_at":"2017-04-26T16:31:49.488Z","updated_at":"2017-04-26T16:31:49.488Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1640203,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report.\n\nYou are welcome to open a PR with the fix, we will update our documentation.","automated_response":false,"created_at":"2017-04-27T15:07:02.341Z","updated_at":"2017-04-27T15:07:02.341Z","actor":{"username":"iv-rodriguez","cleared":false,"url":"/iv-rodriguez","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/122/715/28b56e3c5fa52c310c754558b341beb5ec0b2ab1_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1640361,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @iv-rodriguez,\n\nThank you for the prompt response and for giving me your permission to patch this issue. The PR can be found here: https://github.com/Shopify/shopify_python_api/pull/194.\n\nBy the way, the same issue is located in the \"Receiving and verifying webhooks\" section in the [docs](https://help.shopify.com/api/tutorials/building-public-app) too:\n\n~~~\ndef verify_webhook(hmac, data)\n  digest = OpenSSL::Digest.new('sha256')\n  calculated_hmac = Base64.encode64(OpenSSL::HMAC.digest(digest, @secret, data)).strip\n\n  hmac == calculated_hmac\nend\n~~~\n\nBest regards,\nEd","automated_response":false,"created_at":"2017-04-27T15:57:07.584Z","updated_at":"2017-04-27T16:01:00.633Z","actor":{"username":"edoverflow","cleared":true,"url":"/edoverflow","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/116/374/9a3cf4d62b2f507a0d33808aacbad863ec4455ac_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1776657,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Thanks again for your report. As discussed in https://github.com/Shopify/shopify_python_api/pull/194, the fallback behaviour only affects old Python versions (which are quickly disappearing) and the timing differences are too small to be exploitable in practice. Thus we don't feel a code change is warranted, and we're closing this issue as informative.","automated_response":false,"created_at":"2017-06-23T14:16:02.847Z","updated_at":"2017-06-23T14:16:02.847Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1776678,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@clayton The issue concerning the docs has not been addressed.","automated_response":false,"created_at":"2017-06-23T14:23:14.623Z","updated_at":"2017-06-23T14:23:14.623Z","actor":{"username":"edoverflow","cleared":true,"url":"/edoverflow","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/116/374/9a3cf4d62b2f507a0d33808aacbad863ec4455ac_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1776693,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"@edio You're correct. I'll re-open this until that's done.","automated_response":false,"created_at":"2017-06-23T14:29:56.989Z","updated_at":"2017-06-23T14:29:56.989Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1776694,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2017-06-23T14:30:04.978Z","updated_at":"2017-06-23T14:30:04.978Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1776695,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you, @clayton.","automated_response":false,"created_at":"2017-06-23T14:31:23.467Z","updated_at":"2017-06-23T14:31:23.467Z","actor":{"username":"edoverflow","cleared":true,"url":"/edoverflow","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/116/374/9a3cf4d62b2f507a0d33808aacbad863ec4455ac_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1776821,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"The documentation has now been updated.\n\nThank you for your interest in improving the security of the Shopify platform!","automated_response":false,"created_at":"2017-06-23T15:26:05.105Z","updated_at":"2017-06-23T15:26:05.105Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"edoverflow","url":"/edoverflow"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1776822,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","automated_response":false,"created_at":"2017-06-23T15:26:10.476Z","updated_at":"2017-06-23T15:26:10.476Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1776995,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"@clayton I really enjoyed working with you and hopefully I can help out again in the future. I really appreciate your feedback on my PoC and the fact that you went to all the trouble to write your own.","automated_response":false,"created_at":"2017-06-23T15:30:37.710Z","updated_at":"2017-06-23T15:30:37.710Z","first_to_agree":true,"actor":{"username":"edoverflow","cleared":true,"url":"/edoverflow","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/116/374/9a3cf4d62b2f507a0d33808aacbad863ec4455ac_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1777008,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-06-23T15:36:23.376Z","updated_at":"2017-06-23T15:36:23.376Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1777009,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-06-23T15:36:23.406Z","updated_at":"2017-06-23T15:36:23.406Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}