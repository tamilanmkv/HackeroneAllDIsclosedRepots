{"id":812754,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84MTI3NTQ=","url":"https://hackerone.com/reports/812754","title":"Denial of Service by requesting to reset a password","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-03-07T13:51:40.910Z","submitted_at":"2020-03-07T13:51:40.910Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"makerlab","url":"/makerlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8295"],"singular_disclosure_disabled":false,"disclosed_at":"2021-01-25T20:12:19.503Z","bug_reporter_agreed_on_going_public_at":"2021-01-25T20:12:19.444Z","team_member_agreed_on_going_public_at":"2021-01-25T14:09:18.055Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Description:\nI believe that this is posible due to the brute force protection that makes all request last for 30 seconds which in this case is using all the PHP workers avalible in the pool, so the only way to defend yourself is setting up a limit or having a lot of resources.\n\n### How to reproduce:\n* In the Nextcloud login screen click the \"Forgot password?\" button and then type something in the textbox (can be anything)\n* Then open the developers tools and go to the network tab\n* Hold the \"enter\" key after pressing the reset password button and in the network tab you will see a lot of request being made\n* With just 1000 request I managed to make the demo server \"https://demo2.nextcloud.com/\" not respond for 1 hour\n\n## Impact\n\nThe attacker could make an entire nextcloud installation or even the entire server where it is hosted not respond for a very long time\nAlso, this attack can be made by almost anyone","bounty_amount":"250.0","formatted_bounty":"$250","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":740352,"file_name":"Report2.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/ciXvQcMcjivPucp6rut5ujVE?response-content-disposition=attachment%3B%20filename%3D%22Report2.png%22%3B%20filename%2A%3DUTF-8%27%27Report2.png\u0026response-content-type=image%2Fbmp\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSEHZZ6G7%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T153118Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCICgcJulSRaAJ%2FlV4SEWAQTyL4zo08LbSxF3YkMq%2FNlQPAiEAwYnoA1Ejs7bfAWoTffEddff%2B50LJlobfOVtd1RM%2FYnEqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDNRRuPIe4WOmezSvuirXA0I2fovKepc%2Br2vRekK4MdhNGmdM4Pc0OuzIHNmi1YNhdeljOfmMGUcQHlPqei9TxAGt4a%2Bwb9xKRrQFaS2o2gwxQkFXonxhS2p2%2FCJsWYUo5r66Rt8sQTiLMsAQcSzSjjF4bWzRQlm%2FsXkyqmfct1BfShpBMKnI%2BGx4M48yQfNnfgyRoZjVuWMHzcNqo6i%2B3imvvfu1gDhHkBQgvqL6AhnkVsXPRp6bS08enQ%2B4LeWijQjUmlhVfE3gDt1zfAq%2Fe%2FxOw17jAAuZH4zvbU5%2FFtGrJy%2BmroOTUxv%2FmxiaS8mF368AXRZQT%2FQ%2BK1TgapuP6OgN2v4j35edAg5veKR5WdWsY0QgOpQDSxzsTc2OCErw7fYWcmQYeYhOLVSghUfUtkDG76jJaJQMd36SmC4L2sb2NQ06wkAJfvd6Xh2dj7rFd%2BeVtQEdiI0FpNpkr5AYIz9emwENChfGQLyYkIfW5YUmUZn7%2BrBuWRxITz%2B3soyUxqmlqH%2B32ar8fmBp4Ie0VZd5xxkyHz5L%2BO4aTQveejpP0KxMm2%2Flqz8faN%2FLDBmpyKrFPcJn0sktEBiYdZCKd%2FJMvehZSGrjjy%2F75WSa1FwB%2FTzTTFRrGtLtYGGYby7RdTaug%2BPMKTC2jZGLBjqlAW%2FqLgyIU3l7q2BIHZ9aOYbvAcm7k5gKph8EjMf6tXptYEaiHmQx1q5jFWsRXPiWMZbi4fKKkFbfrJI1NS%2FDW3ba%2FI9tKqyLv9ZB%2FyHxyGg3CQqjMAh5HPdI6A9scOywAto0wTVOHwkl9Ay%2BNQ%2BadpR1vVj4UXnFx6R7Mt2xHMMc188gMtdSb8CXyaP6RpR3xaP3OWl7wd9lKp0P5L%2BRwYyHexzCFA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=02c137f58afa1822b89e5e9d1835b37c69e2c140fdbf2e2c02051d76656215b1","file_size":252774,"type":"image/bmp"},{"id":740353,"file_name":"Report.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/h96xyn5mZicSmabJrPLZLPw1?response-content-disposition=attachment%3B%20filename%3D%22Report.png%22%3B%20filename%2A%3DUTF-8%27%27Report.png\u0026response-content-type=image%2Fbmp\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSEHZZ6G7%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T153118Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCICgcJulSRaAJ%2FlV4SEWAQTyL4zo08LbSxF3YkMq%2FNlQPAiEAwYnoA1Ejs7bfAWoTffEddff%2B50LJlobfOVtd1RM%2FYnEqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDNRRuPIe4WOmezSvuirXA0I2fovKepc%2Br2vRekK4MdhNGmdM4Pc0OuzIHNmi1YNhdeljOfmMGUcQHlPqei9TxAGt4a%2Bwb9xKRrQFaS2o2gwxQkFXonxhS2p2%2FCJsWYUo5r66Rt8sQTiLMsAQcSzSjjF4bWzRQlm%2FsXkyqmfct1BfShpBMKnI%2BGx4M48yQfNnfgyRoZjVuWMHzcNqo6i%2B3imvvfu1gDhHkBQgvqL6AhnkVsXPRp6bS08enQ%2B4LeWijQjUmlhVfE3gDt1zfAq%2Fe%2FxOw17jAAuZH4zvbU5%2FFtGrJy%2BmroOTUxv%2FmxiaS8mF368AXRZQT%2FQ%2BK1TgapuP6OgN2v4j35edAg5veKR5WdWsY0QgOpQDSxzsTc2OCErw7fYWcmQYeYhOLVSghUfUtkDG76jJaJQMd36SmC4L2sb2NQ06wkAJfvd6Xh2dj7rFd%2BeVtQEdiI0FpNpkr5AYIz9emwENChfGQLyYkIfW5YUmUZn7%2BrBuWRxITz%2B3soyUxqmlqH%2B32ar8fmBp4Ie0VZd5xxkyHz5L%2BO4aTQveejpP0KxMm2%2Flqz8faN%2FLDBmpyKrFPcJn0sktEBiYdZCKd%2FJMvehZSGrjjy%2F75WSa1FwB%2FTzTTFRrGtLtYGGYby7RdTaug%2BPMKTC2jZGLBjqlAW%2FqLgyIU3l7q2BIHZ9aOYbvAcm7k5gKph8EjMf6tXptYEaiHmQx1q5jFWsRXPiWMZbi4fKKkFbfrJI1NS%2FDW3ba%2FI9tKqyLv9ZB%2FyHxyGg3CQqjMAh5HPdI6A9scOywAto0wTVOHwkl9Ay%2BNQ%2BadpR1vVj4UXnFx6R7Mt2xHMMc188gMtdSb8CXyaP6RpR3xaP3OWl7wd9lKp0P5L%2BRwYyHexzCFA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=95bae44b43a8e5dd9d4296bdc4f0224297c7bcce0ef42f97884f19dfd39f3de5","file_size":636998,"type":"image/bmp"}],"allow_singular_disclosure_at":"2021-02-24T14:09:18.151Z","allow_singular_disclosure_after":-19790520.18539967,"singular_disclosure_allowed":true,"vote_count":18,"voters":["xploiterr","najeh_halawani","ali","zimmer75","mikassa53","aravindselvan","01yed","alxdi_az","he110fr13nd","mrwiles","and 8 more..."],"severity":{"rating":"high","score":7.5,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"none","integrity":"none","availability":"high"}},"structured_scope":{"databaseId":13,"asset_type":"SOURCE_CODE","asset_identifier":"nextcloud/server","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":7251758,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","automated_response":true,"created_at":"2020-03-07T13:51:41.181Z","updated_at":"2020-03-07T13:51:41.181Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7260040,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hmm, couple of reqeusts are killed with 412 fo me right away.\nBut yeah seems to be possible to make the server busy.","automated_response":false,"created_at":"2020-03-09T10:11:31.296Z","updated_at":"2020-03-09T10:11:31.296Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7270674,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"In my Nextcloud installation I get 429 and 504 at a very slow rate\nThe login page also seems to be vulnerable\nA solution to this problem could be making the login system drop connections with a 429 and a message containing something like \"Too many requests, try again in 10 minutes\" (like most web apps) instead of throttling the next login attempt to 30 seconds which easily fills the PHP pool","automated_response":false,"created_at":"2020-03-09T19:07:58.942Z","updated_at":"2020-03-09T19:07:58.942Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7369091,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @makerlab \n\nwe are currently investigating several different solutions and will mostlikely patch this soon, sending a 429 without handling the request when a trashhold was reached in the last 30 mins by an ip.\nIn case you want to test it, see the patch below.\n\ncheers nickvergessen\n\n\n```diff\ndiff --git a/core/templates/429.php b/core/templates/429.php\nnew file mode 100644\nindex 0000000000..caf8a3675e\n--- /dev/null\n+++ b/core/templates/429.php\n@@ -0,0 +1,4 @@\n+\u003cdiv class=\"body-login-container update\"\u003e\n+\t\u003ch2\u003e\u003c?php p($l-\u003et('Too many requests')); ?\u003e\u003c/h2\u003e\n+\t\u003cp class=\"infogroup\"\u003e\u003c?php p($l-\u003et('There were too many requests from your network. Retry later or contact your administrator if this is an error.')); ?\u003e\u003c/p\u003e\n+\u003c/div\u003e\ndiff --git a/lib/private/AppFramework/Middleware/Security/BruteForceMiddleware.php b/lib/private/AppFramework/Middleware/Security/BruteForceMiddleware.php\nindex 46c33083e4..6cb44da3ed 100644\n--- a/lib/private/AppFramework/Middleware/Security/BruteForceMiddleware.php\n+++ b/lib/private/AppFramework/Middleware/Security/BruteForceMiddleware.php\n@@ -1,4 +1,5 @@\n \u003c?php\n+declare(strict_types=1);\n /**\n  * @copyright Copyright (c) 2017 Lukas Reschke \u003clukas@statuscode.ch\u003e\n  *\n@@ -25,9 +26,15 @@\n \n use OC\\AppFramework\\Utility\\ControllerMethodReflector;\n use OC\\Security\\Bruteforce\\Throttler;\n+use OCP\\AppFramework\\Controller;\n+use OCP\\AppFramework\\Http;\n use OCP\\AppFramework\\Http\\Response;\n+use OCP\\AppFramework\\Http\\TooManyRequestsResponse;\n use OCP\\AppFramework\\Middleware;\n+use OCP\\AppFramework\\OCS\\OCSException;\n+use OCP\\AppFramework\\OCSController;\n use OCP\\IRequest;\n+use OCP\\Security\\Bruteforce\\MaxDelayReached;\n \n /**\n  * Class BruteForceMiddleware performs the bruteforce protection for controllers\n@@ -65,7 +72,7 @@ public function beforeController($controller, $methodName) {\n \n \t\tif($this-\u003ereflector-\u003ehasAnnotation('BruteForceProtection')) {\n \t\t\t$action = $this-\u003ereflector-\u003egetAnnotationParameter('BruteForceProtection', 'action');\n-\t\t\t$this-\u003ethrottler-\u003esleepDelay($this-\u003erequest-\u003egetRemoteAddress(), $action);\n+\t\t\t$this-\u003ethrottler-\u003esleepDelayOrThrowOnMax($this-\u003erequest-\u003egetRemoteAddress(), $action);\n \t\t}\n \t}\n \n@@ -82,4 +89,23 @@ public function afterController($controller, $methodName, Response $response) {\n \n \t\treturn parent::afterController($controller, $methodName, $response);\n \t}\n+\n+\t/**\n+\t * @param Controller $controller\n+\t * @param string $methodName\n+\t * @param \\Exception $exception\n+\t * @throws \\Exception\n+\t * @return Response\n+\t */\n+\tpublic function afterException($controller, $methodName, \\Exception $exception): Response {\n+\t\tif ($exception instanceof MaxDelayReached) {\n+\t\t\tif ($controller instanceof OCSController) {\n+\t\t\t\tthrow new OCSException($exception-\u003egetMessage(), Http::STATUS_TOO_MANY_REQUESTS);\n+\t\t\t}\n+\n+\t\t\treturn new TooManyRequestsResponse();\n+\t\t}\n+\n+\t\tthrow $exception;\n+\t}\n }\ndiff --git a/lib/private/Security/Bruteforce/Throttler.php b/lib/private/Security/Bruteforce/Throttler.php\nindex b5a4dfbfaf..c11637692e 100644\n--- a/lib/private/Security/Bruteforce/Throttler.php\n+++ b/lib/private/Security/Bruteforce/Throttler.php\n@@ -1,4 +1,5 @@\n \u003c?php\n+declare(strict_types=1);\n /**\n  * @copyright Copyright (c) 2016 Lukas Reschke \u003clukas@statuscode.ch\u003e\n  *\n@@ -33,6 +34,7 @@\n use OCP\\IConfig;\n use OCP\\IDBConnection;\n use OCP\\ILogger;\n+use OCP\\Security\\Bruteforce\\MaxDelayReached;\n \n /**\n  * Class Throttler implements the bruteforce protection for security actions in\n@@ -49,6 +51,8 @@\n  */\n class Throttler {\n \tconst LOGIN_ACTION = 'login';\n+\tconst MAX_DELAY = 25;\n+\tconst MAX_ATTEMPTS = 10;\n \n \t/** @var IDBConnection */\n \tprivate $db;\n@@ -81,7 +85,7 @@ public function __construct(IDBConnection $db,\n \t * @param int $expire\n \t * @return \\DateInterval\n \t */\n-\tprivate function getCutoff($expire) {\n+\tprivate function getCutoff(int $expire): \\DateInterval {\n \t\t$d1 = new \\DateTime();\n \t\t$d2 = clone $d1;\n \t\t$d2-\u003esub(new \\DateInterval('PT' . $expire . 'S'));\n@@ -96,9 +100,9 @@ private function getCutoff($expire) {\n \t * @param array $metadata Optional metadata logged to the database\n \t * @suppress SqlInjectionChecker\n \t */\n-\tpublic function registerAttempt($action,\n-\t\t\t\t\t\t\t\t\t$ip,\n-\t\t\t\t\t\t\t\t\tarray $metadata = []) {\n+\tpublic function registerAttempt(string $action,\n+\t\t\t\t\t\t\t\t\tstring $ip,\n+\t\t\t\t\t\t\t\t\tarray $metadata = []): void {\n \t\t// No need to log if the bruteforce protection is disabled\n \t\tif($this-\u003econfig-\u003egetSystemValue('auth.bruteforce.protection.enabled', true) === false) {\n \t\t\treturn;\n@@ -138,7 +142,7 @@ public function registerAttempt($action,\n \t * @param string $ip\n \t * @return bool\n \t */\n-\tprivate function isIPWhitelisted($ip) {\n+\tprivate function isIPWhitelisted(string $ip): bool {\n \t\tif($this-\u003econfig-\u003egetSystemValue('auth.bruteforce.protection.enabled', true) === false) {\n \t\t\treturn true;\n \t\t}\n@@ -196,7 +200,6 @@ private function isIPWhitelisted($ip) {\n \t\t}\n \n \t\treturn false;\n-\n \t}\n \n \t/**\n@@ -204,20 +207,21 @@ private function isIPWhitelisted($ip) {\n \t *\n \t * @param string $ip\n \t * @param string $action optionally filter by action\n+\t * @param float $maxAgeHours\n \t * @return int\n \t */\n-\tpublic function getDelay($ip, $action = '') {\n+\tpublic function getAttempts(string $ip, string $action = '', float $maxAgeHours = 12): int {\n \t\t$ipAddress = new IpAddress($ip);\n \t\tif ($this-\u003eisIPWhitelisted((string)$ipAddress)) {\n \t\t\treturn 0;\n \t\t}\n \n \t\t$cutoffTime = (new \\DateTime())\n-\t\t\t-\u003esub($this-\u003egetCutoff(43200))\n+\t\t\t-\u003esub($this-\u003egetCutoff((int) ($maxAgeHours * 3600)))\n \t\t\t-\u003egetTimestamp();\n \n \t\t$qb = $this-\u003edb-\u003egetQueryBuilder();\n-\t\t$qb-\u003eselect('*')\n+\t\t$qb-\u003eselect($qb-\u003efunc()-\u003ecount('*', 'attempts'))\n \t\t\t-\u003efrom('bruteforce_attempts')\n \t\t\t-\u003ewhere($qb-\u003eexpr()-\u003egt('occurred', $qb-\u003ecreateNamedParameter($cutoffTime)))\n \t\t\t-\u003eandWhere($qb-\u003eexpr()-\u003eeq('subnet', $qb-\u003ecreateNamedParameter($ipAddress-\u003egetSubnet())));\n@@ -226,24 +230,37 @@ public function getDelay($ip, $action = '') {\n \t\t\t$qb-\u003eandWhere($qb-\u003eexpr()-\u003eeq('action', $qb-\u003ecreateNamedParameter($action)));\n \t\t}\n \n-\t\t$attempts = count($qb-\u003eexecute()-\u003efetchAll());\n+\t\t$result = $qb-\u003eexecute();\n+\t\t$row = $result-\u003efetch();\n+\t\t$result-\u003ecloseCursor();\n+\n+\t\treturn (int) $row['attempts'];\n+\t}\n \n+\t/**\n+\t * Get the throttling delay (in milliseconds)\n+\t *\n+\t * @param string $ip\n+\t * @param string $action optionally filter by action\n+\t * @return int\n+\t */\n+\tpublic function getDelay(string $ip, string $action = ''): int {\n+\t\t$attempts = $this-\u003egetAttempts($ip, $action);\n \t\tif ($attempts === 0) {\n \t\t\treturn 0;\n \t\t}\n \n-\t\t$maxDelay = 25;\n \t\t$firstDelay = 0.1;\n-\t\tif ($attempts \u003e (8 * PHP_INT_SIZE - 1))  {\n+\t\tif ($attempts \u003e self::MAX_ATTEMPTS) {\n \t\t\t// Don't ever overflow. Just assume the maxDelay time:s\n-\t\t\t$firstDelay = $maxDelay;\n-\t\t} else {\n-\t\t\t$firstDelay *= pow(2, $attempts);\n-\t\t\tif ($firstDelay \u003e $maxDelay) {\n-\t\t\t\t$firstDelay = $maxDelay;\n-\t\t\t}\n+\t\t\treturn self::MAX_DELAY;\n \t\t}\n-\t\treturn (int) \\ceil($firstDelay * 1000);\n+\n+\t\t$delay = $firstDelay * 2**$attempts;\n+\t\tif ($delay \u003e self::MAX_DELAY) {\n+\t\t\treturn self::MAX_DELAY;\n+\t\t}\n+\t\treturn (int) \\ceil($delay * 1000);\n \t}\n \n \t/**\n@@ -253,7 +270,7 @@ public function getDelay($ip, $action = '') {\n \t * @param string $action\n \t * @param string $metadata\n \t */\n-\tpublic function resetDelay($ip, $action, $metadata) {\n+\tpublic function resetDelay(string $ip, string $action, string $metadata): void {\n \t\t$ipAddress = new IpAddress($ip);\n \t\tif ($this-\u003eisIPWhitelisted((string)$ipAddress)) {\n \t\t\treturn;\n@@ -280,9 +297,28 @@ public function resetDelay($ip, $action, $metadata) {\n \t * @param string $action optionally filter by action\n \t * @return int the time spent sleeping\n \t */\n-\tpublic function sleepDelay($ip, $action = '') {\n+\tpublic function sleepDelay(string $ip, string $action = ''): int {\n \t\t$delay = $this-\u003egetDelay($ip, $action);\n \t\tusleep($delay * 1000);\n \t\treturn $delay;\n \t}\n+\n+\t/**\n+\t * Will sleep for the defined amount of time unless maximum was reached in the last 30 minutes\n+\t * In this case a \"429 Too Many Request\" exception is thrown\n+\t *\n+\t * @param string $ip\n+\t * @param string $action optionally filter by action\n+\t * @return int the time spent sleeping\n+\t * @throws MaxDelayReached when reached the maximum\n+\t */\n+\tpublic function sleepDelayOrThrowOnMax(string $ip, string $action = ''): int {\n+\t\t$delay = $this-\u003egetDelay($ip, $action);\n+\t\tif (($delay === self::MAX_DELAY * 1000) \u0026\u0026 $this-\u003egetAttempts($ip, $action, 0.5) \u003e self::MAX_ATTEMPTS) {\n+\t\t\t// If the ip made too many attempts within the last 30 mins we don't execute anymore\n+\t\t\tthrow new MaxDelayReached('Reached maximum delay');\n+\t\t}\n+\t\tusleep($delay * 1000);\n+\t\treturn $delay;\n+\t}\n }\ndiff --git a/lib/public/AppFramework/Http/TooManyRequestsResponse.php b/lib/public/AppFramework/Http/TooManyRequestsResponse.php\nnew file mode 100644\nindex 0000000000..160614ab33\n--- /dev/null\n+++ b/lib/public/AppFramework/Http/TooManyRequestsResponse.php\n@@ -0,0 +1,51 @@\n+\u003c?php\n+declare(strict_types=1);\n+/**\n+ * @copyright Copyright (c) 2020 Joas Schilling \u003ccoding@schilljs.com\u003e\n+ *\n+ * @license GNU AGPL version 3 or any later version\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as\n+ * published by the Free Software Foundation, either version 3 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n+ *\n+ */\n+\n+namespace OCP\\AppFramework\\Http;\n+\n+use OCP\\Template;\n+\n+/**\n+ * A generic 429 response showing an 404 error page as well to the end-user\n+ * @since 19.0.0\n+ */\n+class TooManyRequestsResponse extends Response {\n+\n+\t/**\n+\t * @since 19.0.0\n+\t */\n+\tpublic function __construct() {\n+\t\tparent::__construct();\n+\n+\t\t$this-\u003esetContentSecurityPolicy(new ContentSecurityPolicy());\n+\t\t$this-\u003esetStatus(429);\n+\t}\n+\n+\t/**\n+\t * @return string\n+\t * @since 19.0.0\n+\t */\n+\tpublic function render() {\n+\t\t$template = new Template('core', '429', 'blank');\n+\t\treturn $template-\u003efetchPage();\n+\t}\n+}\ndiff --git a/lib/public/Security/Bruteforce/MaxDelayReached.php b/lib/public/Security/Bruteforce/MaxDelayReached.php\nnew file mode 100644\nindex 0000000000..817ef0e60c\n--- /dev/null\n+++ b/lib/public/Security/Bruteforce/MaxDelayReached.php\n@@ -0,0 +1,30 @@\n+\u003c?php\n+declare(strict_types=1);\n+/**\n+ * @copyright Copyright (c) 2020 Joas Schilling \u003ccoding@schilljs.com\u003e\n+ *\n+ * @license GNU AGPL version 3 or any later version\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as\n+ * published by the Free Software Foundation, either version 3 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see \u003chttp://www.gnu.org/licenses/\u003e.\n+ *\n+ */\n+\n+namespace OCP\\Security\\Bruteforce;\n+\n+/**\n+ * Class MaxDelayReached\n+ * @since 19.0\n+ */\n+class MaxDelayReached extends \\RuntimeException {\n+}\n```","automated_response":false,"created_at":"2020-03-19T13:01:57.776Z","updated_at":"2020-03-19T13:01:57.776Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7369193,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the response and the patch!\nI will test it with the patch added and I'll see how it does with variants of this attack\nBy the way I love this aproach, combining both, the original idea and the new 429 response with too many requests","automated_response":false,"created_at":"2020-03-19T13:21:32.930Z","updated_at":"2020-03-19T13:21:32.930Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7373338,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It works but in my nextcloud installation (which is still in 18.0.2) I get the following error: `Sabre\\DAV\\Exception\\ServiceUnavailable: TypeError: Argument 3 passed to OC\\Security\\Bruteforce\\Throttler::resetDelay() must be of the type string, array given, called in /var/www/html/cloud/lib/base.php on line 816`\nWhich as a workaround I deleted the \"string\" in the  \"```public function resetDelay(string $ip, string $action, this-\u003estring $metadata): void {```\" as for some reason I was getting an array instead\nThe patch needs some polishing but I think it fixed the vulnerability so for me it is ok","automated_response":false,"created_at":"2020-03-19T23:26:49.787Z","updated_at":"2020-03-19T23:26:49.787Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7374604,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"you are right:\n\n```diff\ndiff --git a/lib/private/Security/Bruteforce/Throttler.php b/lib/private/Security/Bruteforce/Throttler.php\nindex c11637692e..563b7099c9 100644\n--- a/lib/private/Security/Bruteforce/Throttler.php\n+++ b/lib/private/Security/Bruteforce/Throttler.php\n@@ -268,9 +268,9 @@ public function getDelay(string $ip, string $action = ''): int {\n \t *\n \t * @param string $ip\n \t * @param string $action\n-\t * @param string $metadata\n+\t * @param array $metadata\n \t */\n-\tpublic function resetDelay(string $ip, string $action, string $metadata): void {\n+\tpublic function resetDelay(string $ip, string $action, array $metadata): void {\n \t\t$ipAddress = new IpAddress($ip);\n \t\tif ($this-\u003eisIPWhitelisted((string)$ipAddress)) {\n \t\t\treturn;\n\n```","automated_response":false,"created_at":"2020-03-20T06:56:34.116Z","updated_at":"2020-03-20T06:56:34.116Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8627537,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Any update on this?\nNextcloud 19 is still vulnerable to this attack","automated_response":false,"created_at":"2020-07-17T09:46:00.711Z","updated_at":"2020-07-17T09:46:00.711Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8790972,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yeah we are still discussing the PR, but it is planned to finish until the Nextcloud 20 release.\nWe might still backport it then to older versions.","automated_response":false,"created_at":"2020-07-29T10:34:57.431Z","updated_at":"2020-07-29T10:34:57.431Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10378361,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Sorry this issue somehow stayed open although we fixed it already in august.\n\nThanks a lot for your report again. This has been resolved in our latest maintenance releases and we're working on the advisories at the moment.\n\nPlease let us know how you'd like to be credited in our official advisory. We require the following information:\n\n- Name / Pseudonym\n- Email address (optional)\n- Website (optional)\n- Company (optional)\n","automated_response":false,"created_at":"2021-01-15T15:16:51.829Z","updated_at":"2021-01-15T15:16:51.829Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"makerlab","url":"/makerlab"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10423785,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Congratulations! We have determined this to be eligible for a reward of $250.\n\nThanks a lot for making the internet a safer place and keep hacking.","automated_response":false,"created_at":"2021-01-20T13:55:20.339Z","updated_at":"2021-01-20T13:55:20.339Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Nextcloud"}},"bounty_amount":"250.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"nextcloud","collaborator":{"username":"makerlab","url":"/makerlab"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10437754,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the update and the bounty.\n\nName: Jesús Ramos\nEmail: contact.makerlab@gmail.com\nWebsite: https://makerlab.sytes.net/","automated_response":false,"created_at":"2021-01-21T17:51:47.231Z","updated_at":"2021-01-21T17:51:47.231Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10472522,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":null,"automated_response":false,"created_at":"2021-01-25T13:54:11.517Z","updated_at":"2021-01-25T13:54:11.517Z","additional_data":{"old_severity":"High","new_severity":"High (7.5)","old_severity_id":652392,"new_severity_id":966639},"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10472599,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The website link seems dead, typo?","automated_response":false,"created_at":"2021-01-25T13:58:12.523Z","updated_at":"2021-01-25T13:58:12.523Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10472647,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Target URLs:\n\nAdvisory: https://nextcloud.com/security/advisory/?id=NC-SA-2021-003\nCVE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8295","automated_response":false,"created_at":"2021-01-25T14:04:05.755Z","updated_at":"2021-01-25T14:04:05.755Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10472703,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-01-25T14:09:18.082Z","updated_at":"2021-01-25T14:09:18.082Z","first_to_agree":true,"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10476678,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The website is now working, it was a whitelist issue\nThanks\n\nSpeaking of the advisory links, the one at nextcloud.com seems to have a wrong title","automated_response":false,"created_at":"2021-01-25T20:11:56.081Z","updated_at":"2021-01-25T20:11:56.081Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10476681,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-01-25T20:12:19.469Z","updated_at":"2021-01-25T20:12:19.469Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10476682,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-01-25T20:12:19.580Z","updated_at":"2021-01-25T20:12:19.580Z","actor":{"username":"makerlab","cleared":false,"url":"/makerlab","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/8NNKWNpiQru576myJcEP3CbH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10481375,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Should be fixed soon, only needs deploying.\nThanks for checking!","automated_response":false,"created_at":"2021-01-26T09:33:20.428Z","updated_at":"2021-01-26T09:33:20.428Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}