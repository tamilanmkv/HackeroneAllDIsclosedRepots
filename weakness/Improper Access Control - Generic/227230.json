{"id":227230,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjcyMzA=","url":"https://hackerone.com/reports/227230","title":"API Webhooks Fire And Are Unlisted After Permissions Removed","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-05-09T13:36:39.233Z","submitted_at":"2017-05-09T13:36:39.233Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"yaworsk","url":"/yaworsk","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/046/435/8321e52445321287eea5b5b3f4c9f6ea69e92bb5_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-06-27T19:45:37.376Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2017-06-27T19:45:26.349Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi All,\nquick note, I debated reporting this given recent developments and conversations. However, it seemed odd to wait until June to discuss the potential here, especially after I mulled over the design decision for two weeks having tested this April 25. That said, if you agree with the vulnerability, let's forego the bounty.\n\n##Description\nIn testing out the API web hooks, I noticed that the scoping permissions only allow API credentials to create web hooks for those actions which are enabled with at least read permissions. If you try to create a web hook for an action the API doesn't have, an error is returned. However, if you create a web hook and then remove the permission for that action, the web hook still fires when the event is invoked. For example:\n\n1. Create an API token\n2. Give it read access to orders\n3. Create a web hook for order creations\n4. Remove permission to read orders from the API\n5. Create an order\n6. Web hook fires\n\nAt this point, I recognize this may be an intentional design decision, that removing permissions did not immediately delete / revoke web hooks to avoid accidents where admins accidentally change permissions and unintentionally disable their existing web hooks. However, if that is in fact the case, I believe this is still an issue in that after removing the associated permission, if you make an API call to get all web hooks, web hooks without explicit permission are not returned. In other words, if you have created only 1 web hook and remove the permissions associated with it, calling for all web hooks returns an empty array.\n\nI also waited approximately an hour after creating my web hook and removing read access to ensure there was no queued action to remove the web hook itself. I can confirm, it doesn't appear that there is.\n\n##Vulnerability\nI'm reporting this as a vulnerability for two reasons: \n\n- First, once a permission is removed from an API token, that API can no longer make any read related calls. But, if a web hook was created first, that web hook will still fire and send the information to the defined endpoint. Assuming this is intended behaviour leads to the second reason.\n\n-  If a web hook exists and permissions are removed for the action it is performing, the web hook is no longer listed when making the API call to get all web hooks. Additionally, there is no UI page I could find to list API created web hooks (/admin/settings/notifications does not list API created web hooks). This means the only way an admin can confirm there are no back door web hooks (for lack of a better term) is to have an API token with read access to everything an periodically check which web hooks exist.\n\nFrom a malicious stand point, I thought this would give an attacker a subtle back door into ex-filtrating data from a site on a go forward basis. However, they would first need to compromise a site.\n\n##Steps to reproduce\n1. Log into your account\n2. Visit the private apps administration page ``/admin/apps/private/``\n3. Create an app\n4. Give it access to read orders\n5. Via cURL, make the call to create a web hook (changing the URL to your own requestb.in URL)\n\n~~~\n#!/bin/bash\n\ncreds=`cat ../creds`\n\ncurl -X POST \"$creds/admin/webhooks.json\" \\\n  -H \"Content-Type: application/json\" \\\n  -d @- \u003c\u003c EOD \n    {\n      \"webhook\": {\n        \"topic\": \"orders\\/create\",\n        \"address\": \"http://requestb.in/17m30us1\",\n        \"format\": \"json\"\n      }\n    }\nEOD\n\nprintf \"\\n\"\n~~~\n\n6. Go back to your app administration page and remove access to read orders\n7. Via cURL, make the call to get all web hooks, it should return []\n\n~~~\n#!/bin/bash\n\ncreds=`cat ../creds`\n\ncurl \"$creds/admin/webhooks.json?since=1\" \\\n  -H \"Content-Type: application/json\" \\\n\nprintf \"\\n\"\n~~~\n\n8. Visit your site orders page, ``/admin/orders`` and create an order\n9. Visit your ``requestb.in`` page, refresh and confirm the web hook fired\n\nPlease let me know if you have any questions.\nPete\n\n##P.S.\nI'd love to know if you don't mind me asking - when I originally tested this April 25, I swore I could create web hooks for any action with or without permissions. However, when I finally decided this should be reported as a vulnerability and went to confirm that behaviour on April 28 I couldn't any more. Am I just losing my mind or was there a code change that actually addressed that behaviour between April 25 and 28?","weakness":{"id":26,"name":"Improper Access Control - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":8,"voters":["drsniper","akaash_pantherdefence","eveeez","pavanw3b","zerotoone","sumit7","dolph1n","lovebugpaul"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1663150,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\n\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","automated_response":true,"created_at":"2017-05-09T13:38:09.456Z","updated_at":"2017-05-09T13:38:09.456Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1665431,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @yaworsk, thanks for the early report!\n\nI can confirm this is an issue that was brought up internally before, but a proper fixed was not investigated at the time. I raised the issue again and we will look into fixing this.","automated_response":false,"created_at":"2017-05-10T10:58:51.911Z","updated_at":"2017-05-10T10:58:51.911Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1665525,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks @francoischagnon - good to know I wasn't way off base.\n\nActually was thinking about this in the post-workout shower and while I wasn't able to turn it into a RCE, I realized I was wrong in my second bullet, ``This means the only way an admin can confirm there are no back door web hooks (for lack of a better term) is to have an API token with read access to everything an periodically check which web hooks exist.`` You guys likely know/realized, web hooks are API token specific so the only way to see what's been created is to enable read access on every scope for the particular token in question, then call get web hooks. Additionally, the /admin/webhook/count.json also returns 0 if there's only one webhook under a scope that isn't permitted and /admin/webhook/id will return not found.\n\nAnyways, just wanted to clarify. Thanks for the quick reply, see you in June :)\n\npete","automated_response":false,"created_at":"2017-05-10T12:07:16.158Z","updated_at":"2017-05-10T12:07:16.158Z","actor":{"username":"yaworsk","cleared":true,"url":"/yaworsk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/046/435/8321e52445321287eea5b5b3f4c9f6ea69e92bb5_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1721406,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Apologies I forgot to Triage this issue; we have someone working on this and the fix should be deployed soon","automated_response":false,"created_at":"2017-06-01T15:00:17.829Z","updated_at":"2017-06-01T15:00:17.829Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1721471,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Oh nice, good to hear! Thanks @francoischagnon ","automated_response":false,"created_at":"2017-06-01T15:17:38.181Z","updated_at":"2017-06-01T15:17:38.181Z","actor":{"username":"yaworsk","cleared":true,"url":"/yaworsk","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/046/435/8321e52445321287eea5b5b3f4c9f6ea69e92bb5_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1784328,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Closing as Resolved, a fix for this issue has been deployed. We'll no longer send webhooks after the app loses permissions associated with it.","automated_response":false,"created_at":"2017-06-27T13:27:25.353Z","updated_at":"2017-06-27T13:27:25.353Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"yaworsk","url":"/yaworsk"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1785193,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","automated_response":false,"created_at":"2017-06-27T17:52:12.936Z","updated_at":"2017-06-27T17:52:12.936Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1785763,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-06-27T19:45:26.376Z","updated_at":"2017-06-27T19:45:26.376Z","first_to_agree":true,"actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1785765,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","automated_response":false,"created_at":"2017-06-27T19:45:37.357Z","updated_at":"2017-06-27T19:45:37.357Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}