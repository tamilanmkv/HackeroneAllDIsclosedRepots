{"id":522876,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MjI4NzY=","url":"https://hackerone.com/reports/522876","title":"In Dockerized Environments, Failing to Read config.php Grants Any Anonymous User Full Admin Access","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-04-03T04:34:03.056Z","submitted_at":"2019-04-03T04:34:03.056Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"theguynamedguy86","url":"/theguynamedguy86","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-07-27T10:42:10.149Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2019-06-27T10:42:09.609Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Consider this deployment:\n- Nextcloud is already installed in a Dockerized environment.\n- There are two Nextcloud containers running in the environment.\n- Both containers share the same MySQL database.\n- Both containers share the same data (`/var/www/html/data`) and config (`/var/www/html/config`) via NFS-mounted or SMB-mounted Docker volumes.\n- All of the values Nextcloud needs to complete first-run setup (database name and credentials, admin credentials, etc) are provided to both containers via environment variables (`NEXTCLOUD_ADMIN_USER`, `NEXTCLOUD_ADMIN_PASSWORD`, `MYSQL_HOST`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`).\n\nNow, consider that one or both of the containers encounter an issue reading `/var/www/html/config/config.php`. This could be caused by an of the following:\n- Transient failure connecting to the NFS/SMB server at the time either container is launching or restarting (especially in response to a failed Liveness check).\n- Timeout or other transient failure in communication with the NFS/SMB server while the container is already running.\n- One container attempting to read `config.php` while the other container is writing to the file, causing an incomplete read (possibly making the file look empty).\n\nIn this situation, Nextcloud will assume that it is NOT installed (since the config seems empty). As a result, Nextcloud will launch the installer the next time ANY user requests a page from _the container that temporarily cannot read the `config.php` file_.  This causes that instance of Nextcloud to overwrite the `config.php` with a new file that has the same database credentials as the old file (populating the credentials from the environment variables), but the new config flags Nextcloud as not yet being installed (i.e. `installed` is set to `FALSE`). Some time later, assuming that NFS/SMB services have been restored to normal (e.g. the transient issue has disappeared), ALL containers will now happily serve up the Nextcloud installer to ANY user because the container that failed to read the configuration file wrote a new one with a newer timestamp that indicates Nextcloud is not installed.\n\nFrom here, ANY user who stumbles upon the installer page can provide ANY username and password and end up with a new admin account with full access to the existing Nextcloud installation.\n\nNextcloud should NOT allow the installer to be run if ANY database tables already exist in the target database. If this is not possible, Nextcloud should at least not allow the installer to be run if any `admin` users exist in the target database.\n\n## Impact\n\nAn attacker interested in taking over an existing installation of Nextcloud could write a script to frequently monitor that installation until such a time as that installation suffers a temporary issue reading `config.php` and starts serving up the installer. At that point, the attacker can hop over to the installation, finish the setup process, and create a username and password of their choice to gain full admin access to the entire Nextcloud installation.\n\nWith admin access, the attacker can lock out all of the existing users of the system, change system settings, and download or erase all of the files on the Nextcloud installation.","vulnerability_information_html":"\u003cp\u003eConsider this deployment:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eNextcloud is already installed in a Dockerized environment.\u003c/li\u003e\n\u003cli\u003eThere are two Nextcloud containers running in the environment.\u003c/li\u003e\n\u003cli\u003eBoth containers share the same MySQL database.\u003c/li\u003e\n\u003cli\u003eBoth containers share the same data (\u003ccode\u003e/var/www/html/data\u003c/code\u003e) and config (\u003ccode\u003e/var/www/html/config\u003c/code\u003e) via NFS-mounted or SMB-mounted Docker volumes.\u003c/li\u003e\n\u003cli\u003eAll of the values Nextcloud needs to complete first-run setup (database name and credentials, admin credentials, etc) are provided to both containers via environment variables (\u003ccode\u003eNEXTCLOUD_ADMIN_USER\u003c/code\u003e, \u003ccode\u003eNEXTCLOUD_ADMIN_PASSWORD\u003c/code\u003e, \u003ccode\u003eMYSQL_HOST\u003c/code\u003e, \u003ccode\u003eMYSQL_DATABASE\u003c/code\u003e, \u003ccode\u003eMYSQL_USER\u003c/code\u003e, \u003ccode\u003eMYSQL_PASSWORD\u003c/code\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eNow, consider that one or both of the containers encounter an issue reading \u003ccode\u003e/var/www/html/config/config.php\u003c/code\u003e. This could be caused by an of the following:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eTransient failure connecting to the NFS/SMB server at the time either container is launching or restarting (especially in response to a failed Liveness check).\u003c/li\u003e\n\u003cli\u003eTimeout or other transient failure in communication with the NFS/SMB server while the container is already running.\u003c/li\u003e\n\u003cli\u003eOne container attempting to read \u003ccode\u003econfig.php\u003c/code\u003e while the other container is writing to the file, causing an incomplete read (possibly making the file look empty).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eIn this situation, Nextcloud will assume that it is NOT installed (since the config seems empty). As a result, Nextcloud will launch the installer the next time ANY user requests a page from \u003cu\u003ethe container that temporarily cannot read the \u003ccode\u003econfig.php\u003c/code\u003e file\u003c/u\u003e.  This causes that instance of Nextcloud to overwrite the \u003ccode\u003econfig.php\u003c/code\u003e with a new file that has the same database credentials as the old file (populating the credentials from the environment variables), but the new config flags Nextcloud as not yet being installed (i.e. \u003ccode\u003einstalled\u003c/code\u003e is set to \u003ccode\u003eFALSE\u003c/code\u003e). Some time later, assuming that NFS/SMB services have been restored to normal (e.g. the transient issue has disappeared), ALL containers will now happily serve up the Nextcloud installer to ANY user because the container that failed to read the configuration file wrote a new one with a newer timestamp that indicates Nextcloud is not installed.\u003c/p\u003e\n\n\u003cp\u003eFrom here, ANY user who stumbles upon the installer page can provide ANY username and password and end up with a new admin account with full access to the existing Nextcloud installation.\u003c/p\u003e\n\n\u003cp\u003eNextcloud should NOT allow the installer to be run if ANY database tables already exist in the target database. If this is not possible, Nextcloud should at least not allow the installer to be run if any \u003ccode\u003eadmin\u003c/code\u003e users exist in the target database.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker interested in taking over an existing installation of Nextcloud could write a script to frequently monitor that installation until such a time as that installation suffers a temporary issue reading \u003ccode\u003econfig.php\u003c/code\u003e and starts serving up the installer. At that point, the attacker can hop over to the installation, finish the setup process, and create a username and password of their choice to gain full admin access to the entire Nextcloud installation.\u003c/p\u003e\n\n\u003cp\u003eWith admin access, the attacker can lock out all of the existing users of the system, change system settings, and download or erase all of the files on the Nextcloud installation.\u003c/p\u003e\n","weakness":{"id":26,"name":"Improper Access Control - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-07-27T10:42:09.677Z","allow_singular_disclosure_after":-44998353.73813826,"singular_disclosure_allowed":true,"vote_count":10,"voters":["dhakal_ananda","mygf","vishnugadupudi","cr4xerbik4sh","cryptographer","premashish","armansameer","mgallego","shubhampareek","kidhacker"],"severity":{"rating":"high","score":8.7,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"none","availability":"high"}},"structured_scope":{"databaseId":13,"asset_type":"SOURCE_CODE","asset_identifier":"nextcloud/server","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":4454410,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","markdown_message":"\u003cp\u003eThanks a lot for reporting this potential issue back to us!\u003c/p\u003e\n\n\u003cp\u003eOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we\u0026#39;d like to ask you to not disclose this issue to any other party.\u003c/p\u003e\n","automated_response":true,"created_at":"2019-04-03T04:34:03.322Z","updated_at":"2019-04-03T04:34:03.322Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4459136,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"BTW During a transient NFS/SMB issue, the error that appears in the Nextcloud log when the configuration file cannot be read is:\n\n```\nfopen(/var/www/html/config/config.php): failed to open stream: Transport endpoint is not connected at /var/www/html/lib/private/Config.php#241\n```","markdown_message":"\u003cp\u003eBTW During a transient NFS/SMB issue, the error that appears in the Nextcloud log when the configuration file cannot be read is:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003efopen(/var/www/html/config/config.php): failed to open stream: Transport endpoint is not connected at /var/www/html/lib/private/Config.php#241\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2019-04-03T15:51:20.617Z","updated_at":"2019-04-03T15:51:20.617Z","actor":{"username":"theguynamedguy86","cleared":false,"url":"/theguynamedguy86","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4472483,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @theguynamedguy86,\n\nThanks for  your report.\nHowever the situation you describe is not really supported. Config.php should be mounted read only in case of multiple cotainers. (blocking an install from writing the file in any case).\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi \u003ca href=\"/theguynamedguy86\"\u003e@theguynamedguy86\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThanks for  your report.\u003cbr\u003e\nHowever the situation you describe is not really supported. Config.php should be mounted read only in case of multiple cotainers. (blocking an install from writing the file in any case).\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-04T08:30:16.201Z","updated_at":"2019-04-04T08:30:16.201Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4472490,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Thanks a lot for your report. Much appreciated!\nWe're considering this a non-issue at the moment.\n\nWe'd like to encourage to keep hacking. We're looking forward to your next report!","markdown_message":"\u003cp\u003eThanks a lot for your report. Much appreciated!\u003cbr\u003e\nWe\u0026#39;re considering this a non-issue at the moment.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;d like to encourage to keep hacking. We\u0026#39;re looking forward to your next report!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-04T08:30:41.602Z","updated_at":"2019-04-04T08:30:41.602Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4474056,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think that it is very foolish not to consider this a security issue, for the following reasons:\n- One of the selling points of Nextcloud is supposedly security (from the homepage: \"Ensure compliance, security and flexibility\"). Why be on Hackerone if you are not actually interested in making the product more secure?\n- The repro steps I provided -- of there being several instances in the same Dockerized environment -- isn't a pre-requisite to trigger the vulnerability. I think that you are focusing too much on multiple containers and not enough on the fact that _any issue that causes `config.php` to be unreadable causes Nextcloud to provide the option to create a new admin user._\n- This vulnerability doesn't take much to trigger. We've seen it _twice_ on our installation in the last two weeks, but were only able to figure out what's happening the second time it happened; if it was that easy for us to fall into this trap, what about others?\n- The vulnerability triggers full admin access on the installation. Enough said.\n- Nothing in the documentation ever says that `config.php` should be read-only. This is *not even mentioned in the [security hardening section](https://docs.nextcloud.com/server/15/admin_manual/installation/harden_server.html)* -- trust me, I've re-read it *five* times.\n- Nothing in Nextcloud's security checks indicate that `config.php` should be read-only.\n- Other security-focused, PHP-based products like WordPress and Drupal do not allow re-installation on an existing database without use of a different prefix. Nextcloud's approach is not very secure here when compared to others on the same stack.\n\nGiven all of the above, if you still feel that this highly critical vulnerability is not something that you would like to fix in the product, I can proceed with public disclosure.","markdown_message":"\u003cp\u003eI think that it is very foolish not to consider this a security issue, for the following reasons:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eOne of the selling points of Nextcloud is supposedly security (from the homepage: \u0026quot;Ensure compliance, security and flexibility\u0026quot;). Why be on Hackerone if you are not actually interested in making the product more secure?\u003c/li\u003e\n\u003cli\u003eThe repro steps I provided -- of there being several instances in the same Dockerized environment -- isn\u0026#39;t a pre-requisite to trigger the vulnerability. I think that you are focusing too much on multiple containers and not enough on the fact that \u003cu\u003eany issue that causes \u003ccode\u003econfig.php\u003c/code\u003e to be unreadable causes Nextcloud to provide the option to create a new admin user.\u003c/u\u003e\n\u003c/li\u003e\n\u003cli\u003eThis vulnerability doesn\u0026#39;t take much to trigger. We\u0026#39;ve seen it \u003cu\u003etwice\u003c/u\u003e on our installation in the last two weeks, but were only able to figure out what\u0026#39;s happening the second time it happened; if it was that easy for us to fall into this trap, what about others?\u003c/li\u003e\n\u003cli\u003eThe vulnerability triggers full admin access on the installation. Enough said.\u003c/li\u003e\n\u003cli\u003eNothing in the documentation ever says that \u003ccode\u003econfig.php\u003c/code\u003e should be read-only. This is \u003cem\u003enot even mentioned in the \u003ca href=\"/redirect?url=https%3A%2F%2Fdocs.nextcloud.com%2Fserver%2F15%2Fadmin_manual%2Finstallation%2Fharden_server.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003esecurity hardening section\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/em\u003e -- trust me, I\u0026#39;ve re-read it \u003cem\u003efive\u003c/em\u003e times.\u003c/li\u003e\n\u003cli\u003eNothing in Nextcloud\u0026#39;s security checks indicate that \u003ccode\u003econfig.php\u003c/code\u003e should be read-only.\u003c/li\u003e\n\u003cli\u003eOther security-focused, PHP-based products like WordPress and Drupal do not allow re-installation on an existing database without use of a different prefix. Nextcloud\u0026#39;s approach is not very secure here when compared to others on the same stack.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eGiven all of the above, if you still feel that this highly critical vulnerability is not something that you would like to fix in the product, I can proceed with public disclosure.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-04T12:18:47.178Z","updated_at":"2019-04-04T12:18:47.178Z","actor":{"username":"theguynamedguy86","cleared":false,"url":"/theguynamedguy86","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4475552,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"Hi @theguynamedguy86 \n\nthank you for your lengthy reply.\n\nTo sum up your requests and points: we do take security very serious. That is also why we are having a hackerone project and even try to keep our response time to a minimum.\n\nSo regarding your request. The main issue is that you have two instances using the same file. So either you duplicate the config as well (risking the configs diverge) or you block writing to the config all together. There is not a lot we can do about this in general. In general running two web servers to access one data directory also sounds like a bad idea.\n\nNevertheless we will look into preventing re-installation after the config has been purged and will keep you updated. But that will not solve your problem of getting your config/data directory in a mixed/inconsistent state. So I would propose to switch the multiple container approach off.\n\ncheers nickvergessen","markdown_message":"\u003cp\u003eHi \u003ca href=\"/theguynamedguy86\"\u003e@theguynamedguy86\u003c/a\u003e \u003c/p\u003e\n\n\u003cp\u003ethank you for your lengthy reply.\u003c/p\u003e\n\n\u003cp\u003eTo sum up your requests and points: we do take security very serious. That is also why we are having a hackerone project and even try to keep our response time to a minimum.\u003c/p\u003e\n\n\u003cp\u003eSo regarding your request. The main issue is that you have two instances using the same file. So either you duplicate the config as well (risking the configs diverge) or you block writing to the config all together. There is not a lot we can do about this in general. In general running two web servers to access one data directory also sounds like a bad idea.\u003c/p\u003e\n\n\u003cp\u003eNevertheless we will look into preventing re-installation after the config has been purged and will keep you updated. But that will not solve your problem of getting your config/data directory in a mixed/inconsistent state. So I would propose to switch the multiple container approach off.\u003c/p\u003e\n\n\u003cp\u003echeers nickvergessen\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-04T14:27:15.920Z","updated_at":"2019-04-04T14:27:15.920Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4476566,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@nickvergessen I'm totally not opposed to mounting the volume read-only in order to support multiple container instances. My understanding from the documentation is that Nextcloud can be deployed for high availability, so your final statement that \"...I would propose to switch the multiple container approach off.\" is confusing to me. Are you saying that: 1) in general Nextcloud only supports running as a single instance, or that 2) given that the configuration data is writable by multiple instances in our initial deployment, we shouldn't be running multiple instances? I would like to assume you meant the latter; rather than implying Nextcloud cannot support HA in containers.\n\nRegardless, I must again reiterate that the vulnerability I am reporting here is **not** that Nextcloud is inherently insecure when running in a high-availability setup with a writable configuration folder (although, IMHO, docs should point out this limitation if this common deployment poses a security risk). The vulnerability is that: 1) deploying Nextcloud in a container, and 2) leveraging auto-setup via environment variables, leads Nextcloud to re-run its installer and grant admin access to any anonymous user if the Docker volume containing the `config.php` file. The reason for the file being unreadable can be any of the reasons I spelled out in the OP -- transient failure, issue mounting the volume, etc. \n\n_Ignore_ for a moment that one possible reason is that another instance is writing the file while the other is reading; I provided that because that's the easiest way we've been able to demonstrate the vulnerability. But, regardless of deployment, if `config.php` becomes inaccessible but has the correct permissions and you are running Nextcloud in a Docker container with auto setup environment variables, Nextcloud has this vulnerability.\n\nI suppose you could say next that Nextcloud should not be run in Docker or that it is a bad idea to use auto-setup. Again I would ask that if these deployments are inherently insecure, documentation needs to indicate this; otherwise, docs encourage these methods of deployment.","markdown_message":"\u003cp\u003e\u003ca href=\"/nickvergessen\"\u003e@nickvergessen\u003c/a\u003e I\u0026#39;m totally not opposed to mounting the volume read-only in order to support multiple container instances. My understanding from the documentation is that Nextcloud can be deployed for high availability, so your final statement that \u0026quot;...I would propose to switch the multiple container approach off.\u0026quot; is confusing to me. Are you saying that: 1) in general Nextcloud only supports running as a single instance, or that 2) given that the configuration data is writable by multiple instances in our initial deployment, we shouldn\u0026#39;t be running multiple instances? I would like to assume you meant the latter; rather than implying Nextcloud cannot support HA in containers.\u003c/p\u003e\n\n\u003cp\u003eRegardless, I must again reiterate that the vulnerability I am reporting here is \u003cstrong\u003enot\u003c/strong\u003e that Nextcloud is inherently insecure when running in a high-availability setup with a writable configuration folder (although, IMHO, docs should point out this limitation if this common deployment poses a security risk). The vulnerability is that: 1) deploying Nextcloud in a container, and 2) leveraging auto-setup via environment variables, leads Nextcloud to re-run its installer and grant admin access to any anonymous user if the Docker volume containing the \u003ccode\u003econfig.php\u003c/code\u003e file. The reason for the file being unreadable can be any of the reasons I spelled out in the OP -- transient failure, issue mounting the volume, etc. \u003c/p\u003e\n\n\u003cp\u003e\u003cu\u003eIgnore\u003c/u\u003e for a moment that one possible reason is that another instance is writing the file while the other is reading; I provided that because that\u0026#39;s the easiest way we\u0026#39;ve been able to demonstrate the vulnerability. But, regardless of deployment, if \u003ccode\u003econfig.php\u003c/code\u003e becomes inaccessible but has the correct permissions and you are running Nextcloud in a Docker container with auto setup environment variables, Nextcloud has this vulnerability.\u003c/p\u003e\n\n\u003cp\u003eI suppose you could say next that Nextcloud should not be run in Docker or that it is a bad idea to use auto-setup. Again I would ask that if these deployments are inherently insecure, documentation needs to indicate this; otherwise, docs encourage these methods of deployment.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-04T14:49:04.785Z","updated_at":"2019-04-04T14:49:04.785Z","actor":{"username":"theguynamedguy86","cleared":false,"url":"/theguynamedguy86","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4517316,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @theguynamedguy86 ,\n\nAh that explains a bit more. Yeah with autosetup in docker this can happen. Now I see the issue a bit more clear. (Because when thinking about it when traveling I was wondering how your install got your DB credentials).\n\nWe are in the progress with a PR at https://github.com/nextcloud/server/pull/14965 that should prevent reinstalling\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi \u003ca href=\"/theguynamedguy86\"\u003e@theguynamedguy86\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eAh that explains a bit more. Yeah with autosetup in docker this can happen. Now I see the issue a bit more clear. (Because when thinking about it when traveling I was wondering how your install got your DB credentials).\u003c/p\u003e\n\n\u003cp\u003eWe are in the progress with a PR at \u003ca title=\"https://github.com/nextcloud/server/pull/14965\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F14965\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/14965\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e that should prevent reinstalling\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-09T09:18:23.404Z","updated_at":"2019-04-09T09:18:23.404Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4542233,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-04-11T18:46:55.142Z","updated_at":"2019-04-11T18:46:55.142Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4542866,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Awesome; thank you, guys!","markdown_message":"\u003cp\u003eAwesome; thank you, guys!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-11T20:29:34.786Z","updated_at":"2019-04-11T20:29:34.786Z","actor":{"username":"theguynamedguy86","cleared":false,"url":"/theguynamedguy86","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4563740,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"https://github.com/nextcloud/server/pull/14965 has been merged and is in master and stable16\nThe backport to stable15 is pending.","markdown_message":"\u003cp\u003e\u003ca title=\"https://github.com/nextcloud/server/pull/14965\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F14965\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/14965\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e has been merged and is in master and stable16\u003cbr\u003e\nThe backport to stable15 is pending.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-15T12:28:51.692Z","updated_at":"2019-04-15T12:28:51.692Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4566414,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, again!","markdown_message":"\u003cp\u003eThanks, again!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-15T17:42:22.665Z","updated_at":"2019-04-15T17:42:22.665Z","actor":{"username":"theguynamedguy86","cleared":false,"url":"/theguynamedguy86","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/568/057/bf53eeac18a74800c6030a00b9b2eda23318a433_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5205114,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks a lot for your report again.","markdown_message":"\u003cp\u003eThanks a lot for your report again.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-27T10:41:54.864Z","updated_at":"2019-06-27T10:41:54.864Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"theguynamedguy86","url":"/theguynamedguy86"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5205115,"is_internal":false,"editable":false,"type":"Activities::SwagAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-06-27T10:42:02.999Z","updated_at":"2019-06-27T10:42:02.999Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"reporter":{"username":"theguynamedguy86","url":"/theguynamedguy86"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5205116,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","markdown_message":"","automated_response":false,"created_at":"2019-06-27T10:42:03.122Z","updated_at":"2019-06-27T10:42:03.122Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5205117,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-06-27T10:42:09.638Z","updated_at":"2019-06-27T10:42:09.638Z","first_to_agree":true,"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5443961,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-07-27T10:42:10.172Z","updated_at":"2019-07-27T10:42:10.172Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}