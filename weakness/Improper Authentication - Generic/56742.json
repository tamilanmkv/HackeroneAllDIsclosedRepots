{"id":56742,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81Njc0Mg==","url":"https://hackerone.com/reports/56742","title":"SPF whitelist of mandrill leads to email forgery","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-04-16T18:15:09.759Z","submitted_at":"2015-04-16T18:15:09.759Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"mikebrooks","url":"/mikebrooks","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-06-08T00:26:08.156Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2015-05-09T00:25:52.052Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I just sent a forged email to support@hackerone.com that appears to originate from mike.brooks@hackerone.com.   I was able to do this because of the following  SPF record:\r\n\r\ndig txt hackerone.com\r\nhackerone.com.\t\t299\tIN\tTXT\t\"v=spf1 include:_spf.google.com include:sendgrid.net include:mail.zendesk.com include:spf.mandrillapp.com ~all\"\r\n\r\nUsing my own mandrill account I can send email which appears to originate from hackerone.  This is useful in phishing,  and this type of vulnerability is news worthy (http://bits.blogs.nytimes.com/2015/04/09/sendgrid-email-breach-was-used-to-attack-coinbase-a-bitcoin-exchange/).\r\n\r\nThe patch is pretty simple.  Complete your mandril registration process.  This will lock out other mandrill users from sending email that originates from *@hackerone.com.\r\n\r\nLet me know if you need me to send another forged email,  or if  have any other questions.\r\n\r\nThanks,\r\nMike Brooks from Bishop Fox.\r\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":27,"name":"Improper Authentication - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-06-08T00:25:52.673Z","allow_singular_disclosure_after":-200241926.90106577,"singular_disclosure_allowed":true,"vote_count":3,"voters":["ak1","an0nym0us","dyabla"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":382762,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey Mike,\n\nSorry for the initial delay on this. I've been trying to get a-hold of both Mandrill and SendGrid support/security for the last few hours to figure out some options here, but they have been less than responsive. SendGrid support pointed me to their Security FAQ, which had nothing to do with my questions. Mandrill has yet to respond at all.\n\nBasically, we use SendGrid for sending out most of our e-mail, but we also utilize a third-party service for some backoffice stuff, which sends e-mails (using @hackerone.com addresses) using Mandrill. As such, we added Mandrill to our SPF record and added their DKIM public key as well. However, you make a good point about that enabling any Mandrill customer to send e-mail as us (and possibly also any SendGrid customer using our current configuration).\n\nIn the mean time, I've reached out to the folks internally who use the third-party service to see if we can disable it for now (so I can remove Mandrill).\n\nWill follow-up once I have more information. Thanks for the report!\n\n~reed","automated_response":false,"created_at":"2015-04-16T23:53:40.636Z","updated_at":"2015-04-16T23:53:40.636Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":385622,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2015-04-20T16:37:16.438Z","updated_at":"2015-04-20T16:37:16.438Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":391539,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Still no update from SendGrid or Mandrill about this. I'll try to escalate to other contacts.\n\nIn the mean time, I did remove Mandrill from our SPF record, as well as revoke their DKIM public key entry.","automated_response":false,"created_at":"2015-04-27T17:13:55.953Z","updated_at":"2015-04-27T17:13:55.953Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":400138,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I've dug into this a bit more, and I'm not sure how Mandrill prevents this attack.  SendGrid is a better service over all,  and I have verified that your SendGird configuration is secure.  A good solution would be to use SendGrid over Mandrill for outgoing email.  Sendgrid has a RESTful API to send outgoing email, or it can be sent via SMTP.\n\nBest Regards,\nMike Brooks, Bishop Fox","automated_response":false,"created_at":"2015-05-02T17:48:49.214Z","updated_at":"2015-05-02T17:48:49.214Z","actor":{"username":"mikebrooks","cleared":false,"url":"/mikebrooks","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":400154,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I found it!  This is how you prevent email forgery though mandrill:\n\nhttps://mandrill.zendesk.com/hc/en-us/articles/205582247-What-is-domain-verification-\n\nSorry for the 2nd email.\n\nBest Regards,\nMike Brooks\n","automated_response":false,"created_at":"2015-05-02T18:24:10.743Z","updated_at":"2015-05-02T18:24:10.743Z","actor":{"username":"mikebrooks","cleared":false,"url":"/mikebrooks","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":400223,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The problem is we aren't Mandrill customers. We utilize a third-party service who uses Mandrill for sending e-mail to people for backoffice purposes. So, I can't exactly go and \"claim\" the domain on Mandrill as a result. :-/\n\nMandrill and SendGrid support have both been very unhelpful. One would think SendGrid would be better, considering they [just got hacked](https://sendgrid.com/blog/update-on-security-incident-and-additional-security-measures./).","automated_response":false,"created_at":"2015-05-02T22:20:53.372Z","updated_at":"2015-05-02T22:20:53.372Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":400245,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Also, we have made some recent changes to our SendGrid settings to better protect against possible abuse. We now use a custom DKIM key and have restricted our SPF record to only permit our dedicated IP at SendGrid. This should prevent any additional SendGrid customers from being able to spoof our e-mails (and bypass DMARC/SPF/DKIM checks).\n\nI'm going to go ahead and close this out now that we have those changes in place and have removed Mandrill from our SPF/DKIM records.\n\nThanks again for the report!","automated_response":false,"created_at":"2015-05-02T23:05:24.011Z","updated_at":"2015-05-02T23:09:27.761Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"mikebrooks","url":"/mikebrooks"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":405531,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2015-05-09T00:25:44.963Z","updated_at":"2015-05-09T00:25:44.963Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"bounty_amount":"1000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"security","collaborator":{"username":"mikebrooks","url":"/mikebrooks"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":405532,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2015-05-09T00:25:52.091Z","updated_at":"2015-05-09T00:25:52.091Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":443853,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2015-06-08T00:26:08.354Z","updated_at":"2015-06-08T00:26:08.354Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}