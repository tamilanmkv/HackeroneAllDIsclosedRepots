{"id":53004,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MzAwNA==","url":"https://hackerone.com/reports/53004","title":"Blacklist bypass on Callback URLs","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-03-22T16:26:22.320Z","submitted_at":"2015-03-22T16:26:22.320Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"agarri_fr","url":"/agarri_fr","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":104,"url":"https://hackerone.com/coinbase","handle":"coinbase","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/104/b151e01a4adbf5ad9067fc30fb2dfe5d5997fa5c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/104/b151e01a4adbf5ad9067fc30fb2dfe5d5997fa5c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Coinbase","twitter_handle":"","website":"https://coinbase.com/security","about":"Creating an open financial system for the world"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-09-14T20:38:56.447Z","bug_reporter_agreed_on_going_public_at":"2016-08-15T20:38:52.736Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"In bug [#47368](https://hackerone.com/reports/47368), I was able to reach private IP addresses via the \"Test Now\" button of the \"Callback URL\" feature. Exploiting this flaw allowed me to reach the metadata server of your outbound proxy (which is, afaik, maintained by Proximo). A [comment](https://hackerone.com/reports/47368#activity-329823) by **aianus**  states that callbacks are now restricted *\"from hitting any RFC 6890 IP addresses and networks\"*. This security measure can be bypassed used DNS rebinding.\r\n\r\n Let's consider what happens where an URL like http://test42.sqli.nicob.net/_hostmanager/healthcheck is submitted via the \"Merchants settings\":\r\n1) The hostname \"test42.sqli.nicob.net\" is resolved (twice) by your servers. Then the resulting IP address is checked against a blacklist. If the IP is blacklisted, the message \"Invalid callback URL\" is printed and processing stops\r\n2) If the IP isn't blacklisted, the request is sent to the outbound proxy managed by Proximo. The proxy will resolve \"test42.sqli.nicob.net\" too, without applying a strict blacklist. Then the target URL is accessed.\r\n\r\nIn order to exploit the flaw, we need a custom DNS server. A patched copy of [dnschef](https://thesprawl.org/projects/dnschef/) can be used to send different answers at different times and bypass the filter. The following command will instruct the DNS server to answer with IP #2 twice (an authorized one), then IP #1 (a blacklisted one), then back to the beginning (scheme \"221\").\r\n\r\n```\r\n # ./rebind.py --ip1=127.0.0.1 --ip2=92.243.29.213 --scheme=221\r\n[17:05:08] 54.144.123.243: cooking the response of type 'A' for test42.sqli.nicob.net to 92.243.29.213 [1]\r\n[17:05:08] 54.82.64.0: cooking the response of type 'A' for test42.sqli.nicob.net to 92.243.29.213 [2]\r\n[17:05:09] 54.162.118.12: cooking the response of type 'A' for test42.sqli.nicob.net to 127.0.0.1 [3]\r\n```\r\n\r\nThe filters will see \"92.243.29.213\" and the proxy will see \"127.0.0.1\". And the Web interface will display the index page of the Web service listening on port TCP/80 of the loopback interface of the proxy server. Several ports were identified on loopback (80, 1080, 8000, 9177, ...)  and I found some unprotected URL like http://127.0.0.1:80/_hostmanager/healthcheck (which simply displays \"OK\").\r\n\r\nRegarding exploitation:\r\n- the metadata server on 169.254.169.254 is unreachable (that's good for you!)\r\n- the pages found (:9177/status, :80/_hostmanager/healthcheck, :80/check, ...) are unproctected but not sensitive\r\n- I may have missed some URL or web servers listening on loopback (brute-force is hard because of rate limitations)\r\n\r\nAdvice: the outbound proxy should implement a blacklist restricting access to internal and private IP addresses\r\n\r\nNB: this kind of DNS blacklist may be 1) used elsewhere by Coinbase2) exploited more easily in a different scenario","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-09-14T20:38:52.898Z","allow_singular_disclosure_after":-160079431.07476893,"singular_disclosure_allowed":true,"vote_count":10,"voters":["sw33tlie","johndoe1492","dilawer01","bugdiscloseguys","brodie_codie","sumit7","omespino","spetr0x","nigba","dyabla"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":365618,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the report, we're taking a look into this.","automated_response":false,"created_at":"2015-03-30T01:50:15.735Z","updated_at":"2015-03-30T01:50:15.735Z","actor":{"username":"adrianmacneil","cleared":false,"url":"/adrianmacneil","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/005/662/4d7d296e06780d24301380fc778810c199c22263_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":393175,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Any news?","automated_response":false,"created_at":"2015-04-28T21:03:15.198Z","updated_at":"2015-04-28T21:03:15.198Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":393599,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sorry for the delay here, just letting you know we are working on DNS pinning so that the hostname will only be resolved once. I believe that should prevent this issue.\n\nWe will also look at locking this down further so that the outbound proxy service is completely isolated, however that will be a longer-term project.","automated_response":false,"created_at":"2015-04-29T01:46:25.741Z","updated_at":"2015-04-29T01:46:25.741Z","actor":{"username":"adrianmacneil","cleared":false,"url":"/adrianmacneil","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/005/662/4d7d296e06780d24301380fc778810c199c22263_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":488063,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ping?","automated_response":false,"created_at":"2015-06-22T19:54:29.161Z","updated_at":"2015-06-22T19:54:29.161Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":503165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @agarri_fr,\n\nWe are currently evaluating this bug, and will notify you when we have finished our analysis. \n\nThanks for your patience!\n-The Coinbase Team","automated_response":false,"created_at":"2015-07-08T17:34:15.395Z","updated_at":"2015-07-08T17:34:15.395Z","actor":{"username":"rfang","cleared":false,"url":"/rfang","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/716/b9797de3662a05a8bf3e58525115c4e391bb998d_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":524096,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @agarri_fr,\n\nWe've put out a fix for this issue. Can you confirm you're no longer able to reproduce?","automated_response":false,"created_at":"2015-07-24T15:17:28.468Z","updated_at":"2015-07-24T15:17:28.468Z","actor":{"username":"coinbase2","cleared":false,"url":"/coinbase2","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":524319,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The patch seems OK. Well done!","automated_response":false,"created_at":"2015-07-24T17:50:01.775Z","updated_at":"2015-07-24T17:50:01.775Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":529198,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @agarri_fr,\n\nJust wanted to keep you posted on this issue. The patch unfortunately broke merchant callbacks for some of our clients and had to be rolled back. We're investigating alternate approaches.","automated_response":false,"created_at":"2015-07-28T21:55:02.221Z","updated_at":"2015-07-28T21:55:02.221Z","actor":{"username":"coinbase2","cleared":false,"url":"/coinbase2","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":549642,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We've pushed a better fix for this issue. Can you confirm you're no longer able to reproduce?","automated_response":false,"created_at":"2015-08-14T23:02:37.438Z","updated_at":"2015-08-14T23:02:37.438Z","actor":{"username":"coinbase2","cleared":false,"url":"/coinbase2","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":552382,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2015-08-17T23:12:09.898Z","updated_at":"2015-08-17T23:12:09.898Z","actor":{"username":"coinbase2","cleared":false,"url":"/coinbase2","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":560017,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I tested the patch and it seems OK.","automated_response":false,"created_at":"2015-08-24T08:25:08.386Z","updated_at":"2015-08-24T08:25:08.386Z","actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":561458,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Great, thanks again!","automated_response":false,"created_at":"2015-08-24T23:30:51.060Z","updated_at":"2015-08-24T23:30:51.060Z","actor":{"username":"coinbase2","cleared":false,"url":"/coinbase2","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"agarri_fr","url":"/agarri_fr"},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":561459,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Awarding defense-in-depth bounty as there wasn't anything sensitive exposed.","automated_response":false,"created_at":"2015-08-24T23:31:30.990Z","updated_at":"2015-08-24T23:31:30.990Z","actor":{"url":"/coinbase","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/104/b151e01a4adbf5ad9067fc30fb2dfe5d5997fa5c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Coinbase"}},"bounty_amount":"100.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"coinbase","collaborator":{"username":"agarri_fr","url":"/agarri_fr"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1127908,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-08-15T20:38:52.830Z","updated_at":"2016-08-15T20:38:52.830Z","first_to_agree":true,"actor":{"username":"agarri_fr","cleared":true,"url":"/agarri_fr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/223/9346bb3a772b6433536cfbbe2a0a6c4c7a786fe9_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1194469,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-09-14T20:38:56.600Z","updated_at":"2016-09-14T20:38:56.600Z","actor":{"url":"/coinbase","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/104/b151e01a4adbf5ad9067fc30fb2dfe5d5997fa5c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Coinbase"}},"genius_execution_id":null,"team_handle":"coinbase","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}