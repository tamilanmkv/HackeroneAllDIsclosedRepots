{"id":241202,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDEyMDI=","url":"https://hackerone.com/reports/241202","title":"Unsafe arithmetic in PyString_DecodeEscape","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-06-18T17:17:37.672Z","submitted_at":"2017-06-18T17:17:37.672Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jaybosamiya","url":"/jaybosamiya","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/079/629/e81985f7db0f0588f1a7c6177f900f7d59208604_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":27,"url":"https://hackerone.com/ibb-python","handle":"ibb-python","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/027/c46b79d4c73a7b34d61a717ed19ae719a0b67b2e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/027/c46b79d4c73a7b34d61a717ed19ae719a0b67b2e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Python (IBB)","twitter_handle":"","website":"http://www.python.org/news/security","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-08-15T11:50:42.211Z","bug_reporter_agreed_on_going_public_at":"2017-07-16T11:50:23.077Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I have submitted a vulnerability that has now been fixed. The report includes a proof of concept that demonstrates reliable heap corruption through integer overflow. I also submitted a patch which was accepted and merged.\n\nhttps://bugs.python.org/issue30657\n\n---\n\nIn Python 2.7, there is a possible integer overflow in PyString_DecodeEscape function of the file stringobject.c, which can be abused to gain a heap overflow, possibly leading to arbitrary code execution.\n\nThe relevant parts of the code are highlighted below:\n\n```\n    PyObject *PyString_DecodeEscape(const char *s,\n                                    Py_ssize_t len,\n                                    const char *errors,\n                                    Py_ssize_t unicode,\n                                    const char *recode_encoding)\n    {\n        int c;\n        char *p, *buf;\n        const char *end;\n        PyObject *v;\n(1)     Py_ssize_t newlen = recode_encoding ? 4*len:len;\n(2)     v = PyString_FromStringAndSize((char *)NULL, newlen);\n        if (v == NULL)\n            return NULL;\n(3)     p = buf = PyString_AsString(v);\n        end = s + len;\n        while (s \u003c end) {\n            if (*s != '\\\\') {\n              non_esc:\n    #ifdef Py_USING_UNICODE\n    [...]\n    #else\n(4)             *p++ = *s++;\n    #endif\n                continue;\n    [...]\n            }\n        }\n        if (p-buf \u003c newlen)\n            _PyString_Resize(\u0026v, p - buf); /* v is cleared on error */\n        return v;\n      failed:\n        Py_DECREF(v);\n        return NULL;\n    }\n```\n\n(1) If recode_encoding is true (i.e., non-null), we have an integer overflow here which can set newlen to be some very small value\n(2) This allows a small string to be created into v\n(3) Now p (and buf) use that small string\n(4) The small string is copied into with a larger string, thereby giving a heap buffer overflow\n\nIn the highly unlikely but definitely possible situation that we pass it a very large string (in the order of ~1GB on a 32-bit Python install), one can reliably get heap corruption. It is possible to access this function (and condition in line(1)) through function parsestr from ast.c, when the file encoding of an input .py file is something apart from utf-8 and iso-8859-1. This can be trivially done using the following at the start of the file:\n```\n    # -*- coding: us-ascii -*-\n```\n\nThe attached file (poc-gen.py) produces a poc.py file which satisfies these constraints and shows the vulnerability.\n\nNote: To see the vulnerability in action, it is necessary to have an ASAN build of Python, compiled for 32 bit on a 64 bit machine. Additionally, the poc.py file generated can take an extremely long time to load (over a few hours), and finally crash. Instead, if one wishes to see the proof of vulnerability quicker, then it might be better to change the constant 4 in line (1) to 65536 (just for simplicity sake), and change the multiplication_constant in poc-gen.py file to be the same (i.e. 65536).\n\nProposed fix: Confirm that the multiplication will not overflow, before actually performing the multiplication and depending on the result.\n\n---\n\nhttps://github.com/python/cpython/pull/2174\n\n```\ndiff --git a/Objects/stringobject.c b/Objects/stringobject.c\nindex c78e193..59d22e7 100644\n--- a/Objects/stringobject.c\n+++ b/Objects/stringobject.c\n@@ -612,7 +612,13 @@ PyObject *PyString_DecodeEscape(const char *s,\n     char *p, *buf;\n     const char *end;\n     PyObject *v;\n-    Py_ssize_t newlen = recode_encoding ? 4*len:len;\n+    Py_ssize_t newlen;\n+    /* Check for integer overflow */\n+    if (recode_encoding \u0026\u0026 (len \u003e PY_SSIZE_T_MAX / 4)) {\n+        PyErr_SetString(PyExc_OverflowError, \"string is too large\");\n+        return NULL;\n+    }\n+    newlen = recode_encoding ? 4*len:len;\n     v = PyString_FromStringAndSize((char *)NULL, newlen);\n     if (v == NULL)\n         return NULL;\n```","vulnerability_information_html":"\u003cp\u003eI have submitted a vulnerability that has now been fixed. The report includes a proof of concept that demonstrates reliable heap corruption through integer overflow. I also submitted a patch which was accepted and merged.\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://bugs.python.org/issue30657\" href=\"/redirect?url=https%3A%2F%2Fbugs.python.org%2Fissue30657\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.python.org/issue30657\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003eIn Python 2.7, there is a possible integer overflow in PyString_DecodeEscape function of the file stringobject.c, which can be abused to gain a heap overflow, possibly leading to arbitrary code execution.\u003c/p\u003e\n\n\u003cp\u003eThe relevant parts of the code are highlighted below:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    PyObject *PyString_DecodeEscape(const char *s,\n                                    Py_ssize_t len,\n                                    const char *errors,\n                                    Py_ssize_t unicode,\n                                    const char *recode_encoding)\n    {\n        int c;\n        char *p, *buf;\n        const char *end;\n        PyObject *v;\n(1)     Py_ssize_t newlen = recode_encoding ? 4*len:len;\n(2)     v = PyString_FromStringAndSize((char *)NULL, newlen);\n        if (v == NULL)\n            return NULL;\n(3)     p = buf = PyString_AsString(v);\n        end = s + len;\n        while (s \u0026lt; end) {\n            if (*s != \u0026#39;\\\\\u0026#39;) {\n              non_esc:\n    #ifdef Py_USING_UNICODE\n    [...]\n    #else\n(4)             *p++ = *s++;\n    #endif\n                continue;\n    [...]\n            }\n        }\n        if (p-buf \u0026lt; newlen)\n            _PyString_Resize(\u0026amp;v, p - buf); /* v is cleared on error */\n        return v;\n      failed:\n        Py_DECREF(v);\n        return NULL;\n    }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e(1) If recode_encoding is true (i.e., non-null), we have an integer overflow here which can set newlen to be some very small value\u003cbr\u003e\n(2) This allows a small string to be created into v\u003cbr\u003e\n(3) Now p (and buf) use that small string\u003cbr\u003e\n(4) The small string is copied into with a larger string, thereby giving a heap buffer overflow\u003c/p\u003e\n\n\u003cp\u003eIn the highly unlikely but definitely possible situation that we pass it a very large string (in the order of ~1GB on a 32-bit Python install), one can reliably get heap corruption. It is possible to access this function (and condition in line(1)) through function parsestr from ast.c, when the file encoding of an input .py file is something apart from utf-8 and iso-8859-1. This can be trivially done using the following at the start of the file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    # -*- coding: us-ascii -*-\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe attached file (poc-gen.py) produces a poc.py file which satisfies these constraints and shows the vulnerability.\u003c/p\u003e\n\n\u003cp\u003eNote: To see the vulnerability in action, it is necessary to have an ASAN build of Python, compiled for 32 bit on a 64 bit machine. Additionally, the poc.py file generated can take an extremely long time to load (over a few hours), and finally crash. Instead, if one wishes to see the proof of vulnerability quicker, then it might be better to change the constant 4 in line (1) to 65536 (just for simplicity sake), and change the multiplication_constant in poc-gen.py file to be the same (i.e. 65536).\u003c/p\u003e\n\n\u003cp\u003eProposed fix: Confirm that the multiplication will not overflow, before actually performing the multiplication and depending on the result.\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e\u003ca title=\"https://github.com/python/cpython/pull/2174\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F2174\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/python/cpython/pull/2174\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/Objects/stringobject.c b/Objects/stringobject.c\nindex c78e193..59d22e7 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/Objects/stringobject.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/Objects/stringobject.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -612,7 +612,13 @@\u003c/span\u003e PyObject *PyString_DecodeEscape(const char *s,\n     char *p, *buf;\n     const char *end;\n     PyObject *v;\n\u003cspan class=\"gd\"\u003e-    Py_ssize_t newlen = recode_encoding ? 4*len:len;\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    Py_ssize_t newlen;\n+    /* Check for integer overflow */\n+    if (recode_encoding \u0026amp;\u0026amp; (len \u0026gt; PY_SSIZE_T_MAX / 4)) {\n+        PyErr_SetString(PyExc_OverflowError, \u0026quot;string is too large\u0026quot;);\n+        return NULL;\n+    }\n+    newlen = recode_encoding ? 4*len:len;\n\u003c/span\u003e     v = PyString_FromStringAndSize((char *)NULL, newlen);\n     if (v == NULL)\n         return NULL;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":15,"name":"Integer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":195263,"file_name":"poc-gen.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/195/263/09c3256fc74d885d612d693e9d112edf572d40bd/poc-gen.py?response-content-disposition=attachment%3B%20filename%3D%22poc-gen.py%22%3B%20filename%2A%3DUTF-8%27%27poc-gen.py\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQUOQU5REA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T050803Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDKbajvkbgJ0bk%2BBvRtGQ7p5KCzGha%2FVaDDwyFq8CM66wIgaw7%2FMRI5kyRpH%2BnIlLG4ZnmM%2FrLjLjJWrmkX0zZfd9sqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDP91WL002Wbo0XGfnyqRA%2FNt3W4r54Z2Rrjnbzg30AtIqSAaUbiKh6dYPI5iumJt%2FacDVM4CmdTQCSkrpk45DFotrgtd1tIXQUPsAioE3hz70xop4zS0jebfAPdwBp38Mc3YKPYsW1TgWIT19zK4t%2B4eGJVFjPey5O%2FEfBu4XYpGDd%2Fy2VO0kVCb43%2F76mvlk6aWlA01UhpCilK3J%2F7qqZsw4P3jggaBSCjGhssHvqDLjMzfR%2FDpDE7VaotOr3rJmP5ZK66Q9%2BkoG5kaLgKcslwRO9FGLNBY8AuIhUCEMRp9RM9yBIFYe%2FyyvHRriCVGHEgdIJ9wvxaVVvCfEcWZw1dEIriA6BftAk5kML6b8WN8zwMI3cyqbnvBS9PGbEcrzzU67DDkEk0llxEfFqJB1g4ruY5L2BsxjsulOVXWFSQHoykg7EnBFBbQGmuPAyxW942tXfkTyjH7aQIFAbpwURAHEFFcnVcJBzYS%2B6tGyu1ozPdrsFK5Ko2OryeYDFeK8b9JxwAMZqBekNlk1Bn%2BWq2RJZZBgBTV1X9LfuQ%2FLbSAMJq2qv8FOusBgtnFtNPu6rgydFw%2BpCNudbVGZ39p3P2aIl7K%2B6fRTLBImgaGX5r2pXgGjSRb3Co5NHURzMlQWYw9SJdMt5vMsDNtT9otjm5R%2Fz00sRO779VmfaZOO18lLujlVlImBZA%2BY20iW%2B%2FVBR4UOivJTvxApUCo%2BQYZQghLFkO4s17mPPAo6XeP%2BtXjXhn71RPHuwavkbgQ0EuL1pf5gaqdarsB4psJiZ3FphFomE6unCMAErk3vFIwEIi%2Be5%2FjAIsDg6zS3oetmQEMR7IeJadGwnOF7tifKH8X2cyJk2IoG8HLG%2FfDEf2cBUt6EjPoIQ%3D%3D\u0026X-Amz-Signature=1eb722d0b9cc5a4eac72fbdc97f5d4b637e7f7c83404a1fcb62b2f7b17b8a856","file_size":323,"type":"text/plain"}],"allow_singular_disclosure_at":"2017-08-15T11:50:23.125Z","allow_singular_disclosure_after":-106420660.52152067,"singular_disclosure_allowed":true,"vote_count":14,"voters":["flamezzz","fizhimchik","eveeez","geeknik","japz","secdoor","snappyjack","jaybosamiya","pyxon","panda519","and 4 more..."],"severity":{"rating":"low","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1824812,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-07-11T13:58:02.057Z","updated_at":"2017-07-11T13:58:02.057Z","additional_data":{"old_severity":null,"new_severity":"Low","old_severity_id":null,"new_severity_id":57932},"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-python","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1824814,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-07-11T13:58:10.666Z","updated_at":"2017-07-11T13:58:10.666Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"jaybosamiya","url":"/jaybosamiya"},"genius_execution_id":null,"team_handle":"ibb-python","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1824815,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-07-11T13:58:16.847Z","updated_at":"2017-07-11T13:58:16.847Z","actor":{"url":"/ibb-python","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/027/c46b79d4c73a7b34d61a717ed19ae719a0b67b2e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Python (IBB)"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"ibb-python","collaborator":{"username":"jaybosamiya","url":"/jaybosamiya"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1838825,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks a lot for the bounty :) Since the bug report and patch are available publicly, can we disclose publicly on hackerone too?","markdown_message":"\u003cp\u003eThanks a lot for the bounty :) Since the bug report and patch are available publicly, can we disclose publicly on hackerone too?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-07-16T11:50:23.098Z","updated_at":"2017-07-16T11:50:23.098Z","first_to_agree":true,"actor":{"username":"jaybosamiya","cleared":false,"url":"/jaybosamiya","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/079/629/e81985f7db0f0588f1a7c6177f900f7d59208604_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb-python","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1930070,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-15T11:50:42.233Z","updated_at":"2017-08-15T11:50:42.233Z","actor":{"url":"/ibb-python","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/027/c46b79d4c73a7b34d61a717ed19ae719a0b67b2e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Python (IBB)"}},"genius_execution_id":null,"team_handle":"ibb-python","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}