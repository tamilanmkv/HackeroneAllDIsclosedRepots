{"id":109175,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMDkxNzU=","url":"https://hackerone.com/reports/109175","title":"Use After Free in sortWithSortKeys()","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-08T00:55:28.164Z","submitted_at":"2016-01-08T00:55:28.164Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"libnex","url":"/libnex","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/468/f5a6e39ea76748aa48e36e0087eb8b09ff892d6c_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":54349,"url":"https://hackerone.com/ibb","handle":"ibb","profile_picture_urls":{"small":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQUWIS6VCD%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T132400Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQD5qsiIq7Ck1i9U3MTr1Jo1%2F3EDxH2PPmsZwQtKB8ZKHgIhAJ3GPiydxb4RL1gx8xsJzOsLrxI5jwwj0tTnFObt0P14KoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgzIOEXrWQ9u1AQUX0Uq1wOcZjaNugHMVKWeqymcjzBFh6Y1k6CMr8RU%2By%2FCZ4rv9GZiC2wT8OmGhsgt00HKgFWK1MpUtynFdgo25n2Z3Hw%2BIbYI8vc1JJdIjhuurHucoJNgsKCs02JzKj8GyJUC61pv0yaDJyGUVPN694UkMEyn%2FPWTQr%2BUTeBhbmczKhCGUj%2FpPN2iIbYsRZixR6LxxOf2cvjX2jSZkAk%2FSVsApfA8g%2BhlsBjDUA9%2B8YRWNjxfWtxQ%2Foo1xWaWyO6R0C2NxkUOjfjpECLEYEQ7vJ%2Bmu27ctvQxX8DIgxS97NsRC7LzasVsLHVmntXBAZ7PuEI4sWc5xs%2Fk66Q906%2BB%2BzvloL3Axk31g5hiymuem0csQnadqDxLt8p2LjIDw8YcQPN5NH0kGSb6mQrkldEFgJqP84RMAJRIxUJWDd%2B%2BPuzQFsioIExGAI0yAK1L2jOitJOooOZlWfFIzjDUn7dj9xSziPydE91tqmI514stzkBU2GFbRIrklzPo3g7n0zD%2FNL7OLEHlmYWBTM9ot%2B6bu4Bck8DrV4VVi9QHnC5ukEnqLU7NSIQGPaibC1SdOVjM2Iv6X9PdR0rR6F07TM%2FRs9G%2B%2BYIK1kHXDHgTN6Tqa9Kn%2B8BfoEt%2BZqnCJGYwv%2ByQiwY6pAFugzNge1CtFW4ATDcRX3hNOdndjPYZIsRGJutSgqHjCwxt8awsI7yZQ6vRxlp6LSSmoSK%2BkQ3evRcXC09cJ%2F1e4JrEeYASE3WVsCxAQVnPVIMtkim2T%2BFMB87kfQL6qAH6iiBO2KVli0mZ4%2BX%2ByxoxRVipnwQh%2B2l8LEnW1ug4kWwPqBp1%2F3G0D3IViaM%2F6KEe0O675l3jsd9YY%2BgtdY9L6zl0yg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=3a66817adc8235ab43ee6eff26275b00735991453c5912ef6b7d40c6abaa492d","medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQUWIS6VCD%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T132400Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQD5qsiIq7Ck1i9U3MTr1Jo1%2F3EDxH2PPmsZwQtKB8ZKHgIhAJ3GPiydxb4RL1gx8xsJzOsLrxI5jwwj0tTnFObt0P14KoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgzIOEXrWQ9u1AQUX0Uq1wOcZjaNugHMVKWeqymcjzBFh6Y1k6CMr8RU%2By%2FCZ4rv9GZiC2wT8OmGhsgt00HKgFWK1MpUtynFdgo25n2Z3Hw%2BIbYI8vc1JJdIjhuurHucoJNgsKCs02JzKj8GyJUC61pv0yaDJyGUVPN694UkMEyn%2FPWTQr%2BUTeBhbmczKhCGUj%2FpPN2iIbYsRZixR6LxxOf2cvjX2jSZkAk%2FSVsApfA8g%2BhlsBjDUA9%2B8YRWNjxfWtxQ%2Foo1xWaWyO6R0C2NxkUOjfjpECLEYEQ7vJ%2Bmu27ctvQxX8DIgxS97NsRC7LzasVsLHVmntXBAZ7PuEI4sWc5xs%2Fk66Q906%2BB%2BzvloL3Axk31g5hiymuem0csQnadqDxLt8p2LjIDw8YcQPN5NH0kGSb6mQrkldEFgJqP84RMAJRIxUJWDd%2B%2BPuzQFsioIExGAI0yAK1L2jOitJOooOZlWfFIzjDUn7dj9xSziPydE91tqmI514stzkBU2GFbRIrklzPo3g7n0zD%2FNL7OLEHlmYWBTM9ot%2B6bu4Bck8DrV4VVi9QHnC5ukEnqLU7NSIQGPaibC1SdOVjM2Iv6X9PdR0rR6F07TM%2FRs9G%2B%2BYIK1kHXDHgTN6Tqa9Kn%2B8BfoEt%2BZqnCJGYwv%2ByQiwY6pAFugzNge1CtFW4ATDcRX3hNOdndjPYZIsRGJutSgqHjCwxt8awsI7yZQ6vRxlp6LSSmoSK%2BkQ3evRcXC09cJ%2F1e4JrEeYASE3WVsCxAQVnPVIMtkim2T%2BFMB87kfQL6qAH6iiBO2KVli0mZ4%2BX%2ByxoxRVipnwQh%2B2l8LEnW1ug4kWwPqBp1%2F3G0D3IViaM%2F6KEe0O675l3jsd9YY%2BgtdY9L6zl0yg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=022345a28e79cb953e1d0b6aeb9a6b7c315a4abeef28d5f1d0de142c8a1e8403"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Internet Bug Bounty","twitter_handle":"","website":"https://www.hackerone.com/internet-bug-bounty","about":"The Internet Bug Bounty rewards security research into vulnerabilities impacting Open Source Software Projects."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-01-20T00:20:52.450Z","bug_reporter_agreed_on_going_public_at":"2016-01-20T00:20:52.116Z","team_member_agreed_on_going_public_at":"2016-01-10T07:10:34.716Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Copy Paste of bug report at https://bugs.php.net/bug.php?id=71020\nIssue verified and fixed.\n\nDescription:\n------------\nThis is a vulnerability is in the function Collator::sortWithSortKeys. The vulnerable code is in ext/intl/collator/collator_sort.c\n\n1) Given an array, each element (hashData) is being referenced by a pointer in sortKeyIndxBuf[sortKeyCount].zstr (line 493):\n\n414: hash = Z_ARRVAL_P( array );\n...\n425: ZEND_HASH_FOREACH_VAL(hash, hashData) {\n....\n493: sortKeyIndxBuf[sortKeyCount].zstr = hashData;\n\n2) The array is then destroy and it's hashData elements freed (ref count -1):\n508: zval_ptr_dtor( array );\n\n\n3) Note that at this point sortKeyIndxBuf[sortKeyCount].zstr still contain pointers to the hashData elements which has been freed. In essence, sortKeyIndxBuf[sortKeyCount].zstr  are dangling pointers.\n\n4) A new array is reinitialized,\n510: array_init(array);\n\n5) The dangling pointers are then added as elements into the new array:\n515: zend_hash_next_index_insert( Z_ARRVAL_P(array), sortKeyIndxBuf[j].zstr);\n\n\n\n6) I've included a POC that triggers this  vulnerability, The POC can be obtained via: https://www.dropbox.com/s/5y9azo01hvflzug/collate-UAF-Poc.php?dl=0\n\n\t\t-an array of 0xbb elements is being passed into the function\n\t\t-sortKeyIndxBuf[0].zstr to sortKeyIndxBuf[0xba].zstr points to the elements in the array\n\t\t- Array is destroyed via zval_ptr_dtor( array );\n\t\t- sortKeyIndxBuf[0....0xba].zstr are now dangling pointers\n\t\t- New array initialized (Hashtable with initial element size of 8)\n\t\t- As the dangling pointers are added to array, the size of the Hashtable grows.\n\t\t- As the Hashtable grows, it's allocated more memory via zend_hash_do_resize()\n\t\t- It will then be allocated memory that co-incides with an address pointed to by the dangling pointer sortKeyIndxBuf[j].zstr. Thus sortKeyIndxBuf[j].zstr now no longer points to a valid zval.\n\t\t- When the code below dereferences this address, because it is pointing to an invalid zval, it will access dereference whatever is the value within this \"corrupted zval\". In this case it's a null pointer dereference. \n\t\t  514:Z_TRY_ADDREF_P( sortKeyIndxBuf[j].zstr );\n\n\n\nStopped reason: SIGSEGV\n0x000000000069f9cd in zval_addref_p (pz=0x7fffed28f840) at /home/elaw/php-7.0.0RC8/Zend/zend_types.h:822\n822             return ++GC_REFCOUNT(Z_COUNTED_P(pz));\ngdb-peda$ bt\n#0  0x000000000069f9cd in zval_addref_p (pz=0x7fffed28f840) at /home/elaw/php-7.0.0RC8/Zend/zend_types.h:822\n#1  zif_collator_sort_with_sort_keys (execute_data=0x7fffed213120, return_value=0x7fffed213110) at /home/elaw/php-7.0.0RC8/ext/intl/collator/collator_sort.c:514\n#2  0x0000000000ae496c in ZEND_DO_FCALL_SPEC_HANDLER () at /home/elaw/php-7.0.0RC8/Zend/zend_vm_execute.h:842\n#3  0x0000000000ae0a37 in execute_ex (ex=0x7fffed213030) at /home/elaw/php-7.0.0RC8/Zend/zend_vm_execute.h:414\n#4  0x0000000000ae135e in zend_execute (op_array=0x7fffed27f000, return_value=0x0) at /home/elaw/php-7.0.0RC8/Zend/zend_vm_execute.h:458\n#5  0x0000000000a58578 in zend_execute_scripts (type=0x8, retval=0x0, file_count=0x3) at /home/elaw/php-7.0.0RC8/Zend/zend.c:1428\n#6  0x00000000009b143d in php_execute_script (primary_file=0x7fffffffdee0) at /home/elaw/php-7.0.0RC8/main/main.c:2471\n#7  0x0000000000bb41e3 in do_cli (argc=0x2, argv=0x14cc4d0) at /home/elaw/php-7.0.0RC8/sapi/cli/php_cli.c:974\n#8  0x0000000000bb53b5 in main (argc=0x2, argv=0x14cc4d0) at /home/elaw/php-7.0.0RC8/sapi/cli/php_cli.c:1345\n#9  0x00007ffff0c5ab45 in __libc_start_main (main=0xbb4d24 \u003cmain\u003e, argc=0x2, argv=0x7fffffffe328, init=\u003coptimized out\u003e, fini=\u003coptimized out\u003e, rtld_fini=\u003coptimized out\u003e,\n    stack_end=0x7fffffffe318) at libc-start.c:287\n#10 0x0000000000445719 in _start ()\n\n\nThis bug seems to have been introduced in this commit: Bug introducted in https://github.com/php/php-src/commit/4fbaddb4f8b041769bea7efdd12313641387bd14\nOnly php 7 is affected.\n\nAccording to their developer:\nstas@php.net\nPutting this in public before the release probably wasn't the best idea, as this could be exploitable if the sortable data is user-controlled.","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-02-09T07:10:36.012Z","allow_singular_disclosure_after":-178956804.91474658,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":{"databaseId":84120,"asset_type":"OTHER","asset_identifier":"PHP","max_severity":"none"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":751363,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2016-01-10T07:10:02.883Z","updated_at":"2016-01-10T07:10:02.883Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"libnex","url":"/libnex"},"genius_execution_id":null,"team_handle":"ibb","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":751364,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2016-01-10T07:10:09.237Z","updated_at":"2016-01-10T07:10:09.237Z","actor":{"url":"/ibb","ibb":false,"profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/v0qywgoh5hm4cbhuanu8mqdtowhr/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22ibb%20revision%205%20copy.png%22%3B%20filename%2A%3DUTF-8%27%27ibb%2520revision%25205%2520copy.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQUWIS6VCD%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T132400Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQD5qsiIq7Ck1i9U3MTr1Jo1%2F3EDxH2PPmsZwQtKB8ZKHgIhAJ3GPiydxb4RL1gx8xsJzOsLrxI5jwwj0tTnFObt0P14KoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgzIOEXrWQ9u1AQUX0Uq1wOcZjaNugHMVKWeqymcjzBFh6Y1k6CMr8RU%2By%2FCZ4rv9GZiC2wT8OmGhsgt00HKgFWK1MpUtynFdgo25n2Z3Hw%2BIbYI8vc1JJdIjhuurHucoJNgsKCs02JzKj8GyJUC61pv0yaDJyGUVPN694UkMEyn%2FPWTQr%2BUTeBhbmczKhCGUj%2FpPN2iIbYsRZixR6LxxOf2cvjX2jSZkAk%2FSVsApfA8g%2BhlsBjDUA9%2B8YRWNjxfWtxQ%2Foo1xWaWyO6R0C2NxkUOjfjpECLEYEQ7vJ%2Bmu27ctvQxX8DIgxS97NsRC7LzasVsLHVmntXBAZ7PuEI4sWc5xs%2Fk66Q906%2BB%2BzvloL3Axk31g5hiymuem0csQnadqDxLt8p2LjIDw8YcQPN5NH0kGSb6mQrkldEFgJqP84RMAJRIxUJWDd%2B%2BPuzQFsioIExGAI0yAK1L2jOitJOooOZlWfFIzjDUn7dj9xSziPydE91tqmI514stzkBU2GFbRIrklzPo3g7n0zD%2FNL7OLEHlmYWBTM9ot%2B6bu4Bck8DrV4VVi9QHnC5ukEnqLU7NSIQGPaibC1SdOVjM2Iv6X9PdR0rR6F07TM%2FRs9G%2B%2BYIK1kHXDHgTN6Tqa9Kn%2B8BfoEt%2BZqnCJGYwv%2ByQiwY6pAFugzNge1CtFW4ATDcRX3hNOdndjPYZIsRGJutSgqHjCwxt8awsI7yZQ6vRxlp6LSSmoSK%2BkQ3evRcXC09cJ%2F1e4JrEeYASE3WVsCxAQVnPVIMtkim2T%2BFMB87kfQL6qAH6iiBO2KVli0mZ4%2BX%2ByxoxRVipnwQh%2B2l8LEnW1ug4kWwPqBp1%2F3G0D3IViaM%2F6KEe0O675l3jsd9YY%2BgtdY9L6zl0yg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=022345a28e79cb953e1d0b6aeb9a6b7c315a4abeef28d5f1d0de142c8a1e8403"},"profile":{"name":"Internet Bug Bounty"}},"bounty_amount":"1000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"ibb","collaborator":{"username":"libnex","url":"/libnex"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":751365,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-01-10T07:10:34.744Z","updated_at":"2016-01-10T07:10:34.744Z","first_to_agree":true,"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":764523,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2016-01-20T00:20:52.232Z","updated_at":"2016-01-20T00:20:52.232Z","actor":{"username":"libnex","cleared":false,"url":"/libnex","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/468/f5a6e39ea76748aa48e36e0087eb8b09ff892d6c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":764524,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2016-01-20T00:20:52.478Z","updated_at":"2016-01-20T00:20:52.478Z","actor":{"username":"libnex","cleared":false,"url":"/libnex","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/468/f5a6e39ea76748aa48e36e0087eb8b09ff892d6c_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}