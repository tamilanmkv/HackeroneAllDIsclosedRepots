{"id":112632,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTI2MzI=","url":"https://hackerone.com/reports/112632","title":"[tor] libevent dns remote stack overread vulnerability","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-25T02:27:56.487Z","submitted_at":"2016-01-25T02:27:56.487Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"guido","url":"/guido","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1800,"url":"https://hackerone.com/torproject","handle":"torproject","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Tor","twitter_handle":"torproject","website":"https://www.torproject.org/","about":"Anonymity Online"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-10-19T10:16:26.792Z","bug_reporter_agreed_on_going_public_at":"2017-10-19T10:16:26.676Z","team_member_agreed_on_going_public_at":"2017-10-19T09:34:08.728Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hello,\n\nthe name_parse function in libevent's DNS code is vulnerable to a buffer overread.\n```c\n 935 static int\n 936 name_parse(u8 *packet, int length, int *idx, char *name_out, int name_out_len) {\n 937     int name_end = -1;\n 938     int j = *idx;\n 939     int ptr_count = 0;\n 940 #define GET32(x) do { if (j + 4 \u003e length) goto err; memcpy(\u0026_t32, packet + j, 4); j += 4; x = ntohl(_t32); } while      (0)\n 941 #define GET16(x) do { if (j + 2 \u003e length) goto err; memcpy(\u0026_t, packet + j, 2); j += 2; x = ntohs(_t); } while (0)\n 942 #define GET8(x) do { if (j \u003e= length) goto err; x = packet[j++]; } while (0)\n 943 \n 944     char *cp = name_out;\n 945     const char *const end = name_out + name_out_len;\n 946 \n 947     /* Normally, names are a series of length prefixed strings terminated */\n 948     /* with a length of 0 (the lengths are u8's \u003c 63). */\n 949     /* However, the length can start with a pair of 1 bits and that */\n 950     /* means that the next 14 bits are a pointer within the current */\n 951     /* packet. */\n 952 \n 953     for (;;) {\n 954         u8 label_len;\n 955         if (j \u003e= length) return -1;\n 956         GET8(label_len);\n 957         if (!label_len) break;\n 958         if (label_len \u0026 0xc0) {\n 959             u8 ptr_low;\n 960             GET8(ptr_low);\n 961             if (name_end \u003c 0) name_end = j;\n 962             j = (((int)label_len \u0026 0x3f) \u003c\u003c 8) + ptr_low;\n 963             /* Make sure that the target offset is in-bounds. */\n 964             if (j \u003c 0 || j \u003e= length) return -1;\n 965             /* If we've jumped more times than there are characters in the\n 966              * message, we must have a loop. */\n 967             if (++ptr_count \u003e length) return -1;\n 968             continue;\n 969         }\n 970         if (label_len \u003e 63) return -1;\n 971         if (cp != name_out) {\n 972             if (cp + 1 \u003e= end) return -1;\n 973             *cp++ = '.';\n 974         }\n 975         if (cp + label_len \u003e= end) return -1;\n 976         memcpy(cp, packet + j, label_len);\n 977         cp += label_len;\n 978         j += label_len;\n 979     }\n 980     if (cp \u003e= end) return -1;\n 981     *cp = '\\0';                                                                                                   \n 982     if (name_end \u003c 0)\n 983         *idx = j;\n 984     else\n 985         *idx = name_end;\n 986     return 0;\n 987  err:\n 988     return -1;\n 989 }\n```\n\nPrior to the memcpy on line 976 it is not asserted that the range (```packet + j```) - (```packet + j + label_len```) does not exceed the length of the ```packet``` buffer (as stored in variable ```length```). My proof of concept exploits the possibility to keep jumping around in the buffer (lines 959 - 968), until the buffer index (```j```) is at the very end --- then, an overread of 63 bytes will occur. No overwrite takes place.\n\nAs you know, an overread *may* result in a crash, depending on a variety of factors.\n\nI believe the code in Tor is vulnerable and I will update this report with PoC against Tor itself as soon as I've constructed one.\n\nNobody has been notified of this bug except you. I will not contact the libevent developers about this issue unless you explicitly request so. It's up to you to notify them yourself.\n\nTo test against the latest version of libevent (libevent-2.0.22-stable.tar.gz):\n\n```sh\nCFLAGS=\"-fomit-frame-pointer -fsanitize=address\" ./configure\nmake -j4\ncd samples\n./dns-example -servertest\n```\n\nin a different terminal run\n```sh\npython libevent-poc.py\n```\n\nOutput of ```dns-example``` should be:\n```\nEVUTIL_AI_CANONNAME in example = 2\n=================================================================\n==27496== ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffcf5a7355c at pc 0x7f6096a6b652 bp 0x7ffcf5a72bb0 sp 0x7ffcf5a72ba8\nREAD of size 1 at 0x7ffcf5a7355c thread T0\n\n...\n...\n```\n\nGuido","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":70753,"file_name":"libevent-poc.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/070/753/f0e7d2a8a55f947329f3935b2547a64de96e082c/libevent-poc.py?response-content-disposition=attachment%3B%20filename%3D%22libevent-poc.py%22%3B%20filename%2A%3DUTF-8%27%27libevent-poc.py\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTTPJWCNM%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T132621Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHUaCXVzLXdlc3QtMiJIMEYCIQDOwM9%2B2Ol25EbTHv2AOl1ZXwoFCdY81Kf4Cj%2BZw5bGagIhALNw4OtUKzuuJ5JDnXIMoizsmzLoA6B3TMlT4JOm5OV%2FKoMECO7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQAhoMMDEzNjE5Mjc0ODQ5IgxBja9Y5H4vqpYK%2BZIq1wMKEFztYF934tg2oiDnz06aS%2BIxaoyblb3k6%2F%2BxBMgQzBtDrU0ocKh0rsBsPTyultSX957Ztb0Xxm%2BlSHqRsjq6d7mkuWsgkJaqQC34P%2FPoowX%2BlH2ZrTK%2FmkJH0GzYvbYPapiuIgj7k6s%2BThAEuj5K1dIvpyoPZSWU4lDCKAHDR63JJK4rjQBzSsyouhVced%2BThWTOJVdRFvPpVLh85ANN2kni9b%2BvA%2BYr4QNdI7bXX3vCy%2Bmlxmt9OtrkNSzeMBq%2B4UjjQL%2BALBrQRVk2zZ5rDj%2ByazHJ4N56LN4FxJEAdf%2BKr7nn9dZ2DExdIbY7%2Blz79tlyq02tT%2B98LGY82aPEMuTJbBZN6Znugvuj3qTN5Ajkz33XEdb09pTvqYEHwNQvHa8molgvM8Hr0UftpVOr%2FcSDQ%2Be7ClWky3g9k3C7fx8DtVeV3YKXMiauv6oe6iv529tf7ZQLwVbk8MDZHKluj8DVRfRr7MlmTLozZouf9SJ7q02NxX1M1zjSiK9%2Bb3knUL5CRpQRCENhmDWhXpTY5NtCVb6swQ3By1ka7LxXtkUadmYfSCwXxpca0jIGluHz9THdy%2Fc3993usF1hP11r0y8u18g%2BZLF5OCf8pMK8LDv4nKUjODow6e2QiwY6pAHH%2FNyAbORzwpluWJFiLzeFhl5RjYZpJEx0nM7ZKbFuGASfNSFcAHpRW7ZXX%2BBSHdPdxqv%2BQd1FC1QHUbL0ZWNROontBy0xjQujOuLkMDUyDfIqsPUVcZohJWSYUkM5yYj9wg6BrbGLNW9NinBFdcPB5%2BIeF%2Bg7o5tKzk0UaPV%2FO3FiQPt3VlESRyrk8YbEQk7JEub211414ZV4sdV3jLFmf60bgw%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=2de8ab5f76984bc5c0c254023d9d30cec2c9bcefbf8d29557d6160f6889a8b84","file_size":9526,"type":"text/plain"}],"allow_singular_disclosure_at":"2017-11-18T09:34:08.767Z","allow_singular_disclosure_after":-122961132.71263243,"singular_disclosure_allowed":true,"vote_count":6,"voters":["geeknik","eveeez","mr_r3boot","japz","spetr0x","b4155f7c29acd42c27d007a"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":770623,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello and thanks for the bug and the great report!\n\nWe are currently trying to see how this fits into our reward program.\n\nAs you can see in the bug rewards text we were not planning to pay out \"low severity\" vulnerabilities to third party libraries like libevent.\nStill, this seems like a nice bug, so we would like to reward it somehow!\n\nWe also want to check if this can be a DoS vector for Tor relays or dirauths.\n\nWe will get back to you ASAP!\n","automated_response":false,"created_at":"2016-01-25T10:24:21.171Z","updated_at":"2016-01-25T10:24:21.171Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":771222,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!\n\nAre you interested in a heap corruption/crash vulnerability in libevent that probably affects tor if it opens a specially crafted /etc/hosts ?\n\nGuido","automated_response":false,"created_at":"2016-01-25T18:22:14.639Z","updated_at":"2016-01-25T18:22:14.639Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771551,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello friend!\n\nWith regards to the /etc/hosts bug, I think such a bug would be out of scope for the bug bounty program, but it would still be a nice bug to fix.\nWe would still be happy to credit you with the discovery of the bug of course :)\n\nComing back to you soon about the reward of this bug.","automated_response":false,"created_at":"2016-01-25T21:57:34.366Z","updated_at":"2016-01-25T21:57:34.366Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":772425,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hello friend!\n\nWe decided $500 as the price of this bug. Out-of-bounds bugs are not super dangerous, but the potential of crashing exit nodes (that parse DNS queries with name_parse()) is concerning.\n\nYou are our first bug hunter! Thanks!\nPlease let us know if you would like to not be credited ,or be credited with a special name.\nOtherwise, we will just credit you as \"guido\".\n\nWe will start fixing the bug ASAP. When we do, we will post the patch here, so that you check it out if you want.\n\nCheers!","automated_response":false,"created_at":"2016-01-26T14:19:06.276Z","updated_at":"2016-01-26T14:19:06.276Z","actor":{"url":"/torproject","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Tor"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"torproject","collaborator":{"username":"guido","url":"/guido"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":773165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you very much!\n\nYou may credit me as: Guido Vranken","automated_response":false,"created_at":"2016-01-26T22:00:50.847Z","updated_at":"2016-01-26T22:00:50.847Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":773954,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello. We filed this bug here: https://github.com/libevent/libevent/issues/317\n\nWill close this issue when the patch gets merged.","automated_response":false,"created_at":"2016-01-27T15:19:39.204Z","updated_at":"2016-01-27T15:19:39.204Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":775459,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2016-01-28T13:51:02.436Z","updated_at":"2016-01-28T13:51:02.436Z","actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":786472,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This has been handled by the libevent team here:\nhttps://github.com/libevent/libevent/commit/96f64a022014a208105ead6c8a7066018449d86d\n\nPlease let us know if the fix is not sufficient.\n\nThanks!\n","automated_response":false,"created_at":"2016-02-05T16:28:48.034Z","updated_at":"2016-02-05T16:28:48.034Z","actor":{"username":"asn","cleared":false,"url":"/asn","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"guido","url":"/guido"},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083662,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T09:34:08.747Z","updated_at":"2017-10-19T09:34:08.747Z","first_to_agree":true,"actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2083747,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-10-19T10:16:26.735Z","updated_at":"2017-10-19T10:16:26.735Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2083748,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-10-19T10:16:26.818Z","updated_at":"2017-10-19T10:16:26.818Z","actor":{"username":"guido","cleared":false,"url":"/guido","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/983/e55b0b2324777fb7efc2de4212fd8d337ca816bd_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}