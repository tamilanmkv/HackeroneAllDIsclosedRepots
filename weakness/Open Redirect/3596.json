{"id":3596,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNTk2","url":"https://hackerone.com/reports/3596","title":"OAuth access_token stealing in Phabricator","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-03-10T12:03:49.078Z","submitted_at":"2014-03-10T12:03:49.078Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"krangbuster","url":"/krangbuster","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/003/495/375adba2f29a55536eac05aedcef905aad42ff64_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2014-04-11T14:23:15.622Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-03-12T14:34:14.479Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi,\r\n\r\nI found that an attacker is able to steal access_tokens of facebook users via Phabricator App (184510521580034).\r\n\r\nwhen users login to phabricator, they can choose to login via Facebook (https://secure.phabricator.com/login/) attaching pic, In this case an attacker is able to exploit this behavior to steal facebook access_tokens via phabricator app.\r\n\r\nFull Reproduce, Exploit:\r\n\r\n1. Create a blog on phabricator https://secure.phabricator.com/phame/blog/new/\r\nand provide a custom domain, in this case: files.nirgoldshlager.com\r\n\r\n2. send a malicious link to the victim: https://www.facebook.com/dialog/oauth?client_id=184510521580034\u0026response_type=token\u0026redirect_uri=https://secure.phabricator.com/phame/live/47/ , Click Continue\r\n\r\nwhen the victim will click continue, his access token will be send to my malicious server, saved in a log file under: http://files.nirgoldshlager.com\r\n\r\nPoC Video:\r\n\r\nhttps://drive.google.com/file/d/0B2-5ltUODX1LWHV6R3gxSFAwNzQ/edit?usp=sharing\r\n","bounty_amount":"450.0","formatted_bounty":"$450","weakness":{"id":53,"name":"Open Redirect"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":4207,"file_name":"loginviafacebook.jpg","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/004/207/b20351f991d93b5a0182edb6ac0b6ba090621240/loginviafacebook.jpg?response-content-disposition=attachment%3B%20filename%3D%22loginviafacebook.jpg%22%3B%20filename%2A%3DUTF-8%27%27loginviafacebook.jpg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T145020Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=fa54144f62e592f4b68a50b07514070fb519894181c6ba17dfd7d9950f737048","file_size":199867,"type":"image/jpeg"}],"allow_singular_disclosure_at":"2014-04-11T13:23:13.149Z","allow_singular_disclosure_after":-236741227.31664282,"singular_disclosure_allowed":true,"vote_count":3,"voters":["fantam1","japz","satyamdixit"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":14798,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"To clarify, the log file in question is logging HTTP referrers? I don't see a way to get the redirect to work with normal GET parameters. Am I misunderstanding that part of the attack?\n\nI have some offsite meetings this morning so I may not get a chance to fix this until later today.","automated_response":false,"created_at":"2014-03-10T14:05:38.730Z","updated_at":"2014-03-10T14:05:38.730Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":14801,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Evan,\n\nAbout the log script,  it's not via http referrers, it works with combination of javascript code with server side logger,\n\nBTW, \n\nthe data file ( leaked access tokens) stored in:\n\n http://files.nirgoldshlager.com/log.txt,\n\nSo if you want to reproduce:\n\nclick on the malicious link, + Continue:\n\nhttps://www.facebook.com/dialog/oauth?client_id=184510521580034\u0026response_type=token\u0026redirect_uri=https://secure.phabricator.com/phame/live/47/\n\nthen you will see your access_token in my log file under http://files.nirgoldshlager.com/log.txt\n\n\nBest,\n\nNir\n","automated_response":false,"created_at":"2014-03-10T14:23:21.094Z","updated_at":"2014-03-10T14:23:21.094Z","actor":{"username":"krangbuster","cleared":false,"url":"/krangbuster","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/495/375adba2f29a55536eac05aedcef905aad42ff64_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":14805,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ah, okay, I think I understand. I was confused at first because this does not work in Safari, which is my primary browser.\n\nSpecifically, what's happening is:\n\n  - The form with no \"action\" attribute preserves the anchor.\n  - Most browsers preserve the anchor after a 302 (Safari does not, but Firefox does).\n  - The attacker can read the anchor information once the victim arrives at his site.\n\nIs that right?\n\nI'm going to make these changes:\n\n  - Stop using implicit `action` on forms. It looks like `action=\"#\"` works as a safe alternative, although it would be nice to generate forms explicitly with the correct URI. We never expect the anchor to survive a POST.\n  - Get rid of the 302 to arbitrary external URIs after POST in Phame. I assumed this was safe because we CSRF it, but there's no reason this needs to exist.","automated_response":false,"created_at":"2014-03-10T14:49:38.508Z","updated_at":"2014-03-10T14:49:38.508Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":14813,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I think this prevents the attack, although I'd like to do more to mitigate similar attacks before considering this resolved:\n\nhttps://secure.phabricator.com/D8481","automated_response":false,"created_at":"2014-03-10T15:18:27.649Z","updated_at":"2014-03-10T15:18:27.649Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":14816,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Great,\n\nThis attack works with Chrome, Firefox, You use safari?, I'm guess you are a mac fun :),\n\nabout your solution, it should work, but I think the best solution is to make  a whitelist on phabricator facebook redirect_uri,\n\nthis could be done via https://developers.facebook.com/x/apps/184510521580034/settings/advanced/\n\nyou should see  Valid OAuth redirect URIs in advanced settings, just make sure you provide the right redirect_uri endpoint, after that, an attacker will not be able to manipulate the redirect_uri to a non endpoint url.","automated_response":false,"created_at":"2014-03-10T15:23:27.959Z","updated_at":"2014-03-10T15:23:27.959Z","actor":{"username":"krangbuster","cleared":false,"url":"/krangbuster","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/495/375adba2f29a55536eac05aedcef905aad42ff64_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":14818,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yeah -- we can do that ourselves (and I will), but I think there's no way we can get all installs of Phabricator to do that, and I think there's no way to check it with an API to see if they've done it or not, and not all OAuth2 providers have that option, so I still want to build more general-purpose mitigations against this.","automated_response":false,"created_at":"2014-03-10T15:29:43.657Z","updated_at":"2014-03-10T15:29:43.657Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":14819,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sure, I understand,\n\n\nThanks Evan!","automated_response":false,"created_at":"2014-03-10T15:33:32.043Z","updated_at":"2014-03-10T15:33:32.043Z","actor":{"username":"krangbuster","cleared":false,"url":"/krangbuster","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/495/375adba2f29a55536eac05aedcef905aad42ff64_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":15948,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This should be fixed in HEAD:\n\nhttps://secure.phabricator.com/rP5854de8c1c475913765cb0d6c836a0f692a146cc\n\nI've filed this to follow up with further mitigations:\n\nhttps://secure.phabricator.com/T4593","automated_response":false,"created_at":"2014-03-12T14:23:13.237Z","updated_at":"2014-03-12T14:23:13.237Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"krangbuster","url":"/krangbuster"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":15949,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"In setting an award amount, I'm considering these factors:\n\n  - This is a clever attack which exploited issues I was not previously aware of (e.g. anchors surviving POST, anchor reattachment after 302).\n  - Stealing OAuth tokens is severe and allows an attacker to do a lot of damage.\n\nHowever, the attack is mitigated by these factors:\n\n  - Primarily, the attacker must have access to create a Phame blog and set a custom domain. This requires they have an account, and that \"Beta\" applications be enabled on an install. You can not execute this attack blind against an install you don't already have significant access to.\n  - The victim must click through an unusual dialog.\n  - The attack only affects some authentication providers.\n  - The victim must be logged in, and either already connected or must click through an approval dialog.\n  - The attack works in most browsers, but not all of them.","automated_response":false,"created_at":"2014-03-12T14:29:26.925Z","updated_at":"2014-03-12T14:29:26.925Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"bounty_amount":"450.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"krangbuster","url":"/krangbuster"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":15952,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This can be disclosed at any time.","automated_response":false,"created_at":"2014-03-12T14:34:14.493Z","updated_at":"2014-03-12T14:34:14.493Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":28809,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2014-04-11T14:23:16.037Z","updated_at":"2014-04-11T14:23:16.037Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}