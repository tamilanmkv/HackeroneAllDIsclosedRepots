{"id":284951,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yODQ5NTE=","url":"https://hackerone.com/reports/284951","title":"Out-of-bounds read when importing corrupt blockchain with monero-blockchain-import","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-10-31T20:50:31.348Z","submitted_at":"2017-10-31T20:50:31.348Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"sybr","url":"/sybr","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7731,"url":"https://hackerone.com/monero","handle":"monero","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Monero","twitter_handle":"monero","website":"https://getmonero.org","about":" Monero: the secure, private, untraceable cryptocurrency"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-04-25T05:49:59.363Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2018-04-25T05:31:00.769Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"It is possible to trigger an *out-of-bounds read* in *monero-blockchain-import* when importing a corrupt blockchain and not verifying blocks and transitions during import (--verify 0).\n\nUsing a corrupt import_file, the attacker has full control over *buffer_block* in import_from_file (blockchain_import.cpp). As shown in the following lines of code (blockchain_import.cpp:404-407), this also enables the attacker to craft a corrupt bootstrap::block_package bp at will:\n```\nstr1.assign(buffer_block, chunk_size);\nbootstrap::block_package bp;\nif (! ::serialization::parse_binary(str1, bp))\n    throw std::runtime_error(\"Error in deserialization of chunk\");\n```\n\nIf verification is turned off (opt_verify = false), the following line of code (blockchain_import.cpp:484) is executed, where all arguments in the function call are extracted from the corrupt *bp*, hence, controlled by the attacker:\n```\ncore.get_blockchain_storage().get_db().add_block(b, block_size, cumulative_difficulty, coins_generated, txs);\n```\nThe executed function *BlockchainLMDB::add_block* then executes the following line of code (db_lmdb.cpp:2850), which passes the same (corrupt) arguments to the function *BlockchainDB::add_block*, where the actual memory corruption finally happens:\n```\nBlockchainDB::add_block(blk, block_size, cumulative_difficulty, coins_generated, txs);\n```\nIn *BlockchainDB::add_block*, there is unfortunately no sanity check about the passed arguments and the following lines are executed (blockchain_db:210-217):\n```\nint tx_i = 0;\ncrypto::hash tx_hash = null_hash;\nfor (const transaction\u0026 tx : txs)\n{\n    tx_hash = blk.tx_hashes[tx_i];                   // here the out-of-bounds read happens\n    add_transaction(blk_hash, tx, \u0026tx_hash);\n    ++tx_i;\n}\n```\nAs *txs* as well as *blk* originate from the *bootstrap::block_package bp* generated in blockchain_import, they can be set to arbitrary values by the attacker. In particular, if *bp* is crafted such that *bp.txs.size() \u003e bp.block.tx_hashes.size()*, then an out-of-bounds memory corruption happens in the for loop when accessing *blk.tx_hashes*.\n\nI have not yet examined whether the bug can be exploited in any malicious way, but I think it needs to be fixed anyways. Further, as the bug happens in the database outside of blockchain_import.cpp, it may also affect other code in monero, not only *monero-blockchain-import*. I have also not checked that. The bug can be easily fixed by introducing additional sanity checks, such as, whether *bp.txs.size() != bp.block.tx_hashes.size()*.\n\nI'll be happy to answer any further questions regarding the bug. Thank you!","weakness":{"id":8,"name":"Out-of-bounds Read"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-05-25T05:31:00.853Z","allow_singular_disclosure_after":-106736847.29428102,"singular_disclosure_allowed":true,"vote_count":6,"voters":["muon4","geeknik","eveeez","r3y","apapedulimu","apehex"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2124102,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hrm. Looks like my comment got sent to the bit bucket, sorry if this is a dupe.\nBasically, what I'd said is that you only use --verify 0 if you've created the file yourself, ie you know it's not malicious. That's the whole point of verification, to verify. That said, the proposed check is simple and non invasive, and so good to add. ","automated_response":false,"created_at":"2017-11-02T10:14:52.321Z","updated_at":"2017-11-02T10:14:52.321Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2125249,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Is there an indication this out of bounds read could be exploitable beyond crashing the importer, assuming the user disables verification ? Since there is no actual tx, adding the tx will fail, and that should be it. Since this is local, there is no information leak. ","automated_response":false,"created_at":"2017-11-02T14:55:00.071Z","updated_at":"2017-11-02T14:55:00.071Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2129317,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Everything good, no dupe. Yes, I agree with you that importing a malicious blockchain with \"--verify 0\" is a rather unusual scenario.\n\nI've looked a little more closely into the bug and so far I see no indication that it could be exploited in a malicious way.\n\nSubmitting the bug, I've though about an info leak scenario in which the database of the attacked user is filled with transactions that contain out-of-bounds *tx_hash*'s', i.e., parts of the attacked user's memory that resides next to *blk.tx_hashes*. To exfiltrate this data, other users could retrieve these transactions (i.e., parts of the attacked user's memory) while bootstrapping themselves through the network.\n\nHowever, I'm new to Monero and don't know yet what the code really does. So from your post I assume that this is not possible, since tx's are somehow verified so that \"adding the tx will fail, and that should be it\"?","automated_response":false,"created_at":"2017-11-02T20:02:58.662Z","updated_at":"2017-11-02T20:04:10.574Z","actor":{"username":"sybr","cleared":false,"url":"/sybr","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133034,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"If you're reading a transaction from the DB, you get a DB record, which has a size. The size is the size of the data chunk you originally wrote in, rather than an arbitrary number. So if you read N bytes from the DB, it's N bytes from the file. You won't get uninitialized memory there. I doubt you can save uninitialized memory in (which you could then read back in a non-buggy read) since what's saved is a serialized tx which was verified to be valid. It could be plausible if you find a way to fill uninitialized data into the several std::vector fields in play, but I don't know of a way.\n\nTxes are verified before being added, so unless the verification code is buggy, these should not pass the verification stage. If you run the imported with --verify 0, verification does not happen, but then it's a circular argument, since we're talking about a --verify 0 case in the first place.\n\nThat said, you are correct that *if* it is possible to store a tx into the DB which contains fragments of the user's memory, then it becomes possible to exfiltrate the data by requesting this transaction through normal P2P requests. However, doing so requires knowing the hash (you request by hash). If it contains uninitialized data, its hash will be unpredictable. If you know the parts that are uninitialized, you could plausible brute force all values of the uninitialized data, but that quickly becomes unwieldy. There is a P2P request to enumerate known hashes, but this only acts on blocks on the main chain, and in order for a block to be added to the main chain, its hash has to be below a difficulty level (essentially its hash must be less than a given 256 bit value, so a random hash has very, very little chance to match. Besides, the tx must also pass validity checks in addition to this hash below target check. So not gonna happen in practice.\n\nUnless another bug somewhere of course.\n","automated_response":false,"created_at":"2017-11-03T20:08:39.730Z","updated_at":"2017-11-03T20:08:39.730Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2133116,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Florian,\n\nThank you very much for your detailed report and for bringing this issue to our attention.\n\nAs noted in our [VRP](https://github.com/monero-project/meta/blob/master/VULNERABILITY_RESPONSE_PROCESS.md):\n\n```\n4. Response Manager makes inquiries to satisfy any needed information to confirm if submission is indeed a vulnerability\n    - a. If submission proves to be vulnerable, proceed to next step\n    - b. If not vulnerable:\n      - i. Response Manager responds with reasons why submission is not a vulnerability\n      - ii. Response Manager moves discussion to a new or existing ticket on GitHub if necessary\n```\n\nBased on the information discovered/provided, if this report can be deduced as an exploitable vulnerability (as opposed to a simple bug) - with 100% certainty/reproducibility - then we will proceed to section 4a. If not, then we would like to move to 4b and close this issue as Resolved (where you'll then get reputation points and a spot on our Thank You page) and then move the issue to github (where you will get credit for the proposed patch).\n\nIf this report is shown to not be an exploit, then no bounty will be released. Please continue hacking though because we do have bounty available.","automated_response":false,"created_at":"2017-11-03T20:36:07.831Z","updated_at":"2017-11-03T20:36:07.831Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2133475,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I don't think the bug is exploitable and I won't spend further time investigating this, since imho the maximum \"outcome\" is not worth the time. That said, I would like to move to 4b, close this issue, and take the reputation points as well as spot on the thank you page. Regarding continue hacking: do you have information on the amount you will pay for exploitable bugs of low/medium/high severity?\n\nThank you both for your quick, kind, and informative answers, especially moneromooo for your detailed answer on the workings of Monero!","automated_response":false,"created_at":"2017-11-03T22:29:50.907Z","updated_at":"2017-11-03T22:29:50.907Z","actor":{"username":"sybr","cleared":false,"url":"/sybr","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2137640,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003eRegarding continue hacking: do you have information on the amount you will pay for exploitable bugs of low/medium/high severity?\n\n@ovrflow this is something that we need to resolve on our end a.s.a.p. Thanks for the reminder.\n\n\u003eThank you both for your quick, kind, and informative answers, especially moneromooo for your detailed answer on the workings of Monero!\n\nThank you again @ovrflow. Will you open the issue on github then PR your fix? This will make accreditation easier.","automated_response":false,"created_at":"2017-11-06T18:01:16.996Z","updated_at":"2017-11-06T18:01:16.996Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2137646,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2017-11-06T18:02:31.026Z","updated_at":"2017-11-06T18:02:31.026Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"sybr","url":"/sybr"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2145509,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, I see no patch on github. If you prefer, I can PR it directly, if you give the authorship information you want (nick, email, both optional).\n","automated_response":false,"created_at":"2017-11-09T11:12:45.250Z","updated_at":"2017-11-09T11:12:45.250Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2145525,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Rereading something I wrote above, I conflated two things in my explanation. I was thinking of block, not txes:\n\nThe transaction hash does not need to be below target. The block PoW hash does (which is different from the block hash). Transactions are included in blocks (by way of a merkle tree, the root of which is included in the hashed data). There is no enumeration P2P call for txes, just blocks, but you can get a list of txes from the blocks). So it doesn't alter the conclusion, just the details of what I said.\n","automated_response":false,"created_at":"2017-11-09T11:17:37.863Z","updated_at":"2017-11-09T11:17:37.863Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2151833,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi! I'm sorry. So far, I had no time to do the github patch. If you want to get the bug fixed in the next days, please PR it directly. My nick on github is \"flozilla\". If you can wait for one or two weeks, then I can PR it.","automated_response":false,"created_at":"2017-11-11T22:19:18.468Z","updated_at":"2017-11-11T22:19:18.468Z","actor":{"username":"sybr","cleared":false,"url":"/sybr","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2153657,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I don't see any repo at that username, so I don't know which email address is preferred for authorship. Is it \"flozilla@users.noreply.github.com\" ?","automated_response":false,"created_at":"2017-11-13T11:20:54.888Z","updated_at":"2017-11-13T11:20:54.888Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2157986,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yes, I would like to use the anonymous github provided no-reply address. Thank you!","automated_response":false,"created_at":"2017-11-14T20:55:03.066Z","updated_at":"2017-11-14T20:55:03.066Z","actor":{"username":"sybr","cleared":false,"url":"/sybr","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2158974,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"OK, here's the patch I came up with, I'll PR this unless you have further comments. Thanks.\n\ncommit f9fad186080547a19fb3cc0f663763769b0830e5\nAuthor: flozilla \u003cflozilla@users.noreply.github.com\u003e\nDate:   Wed Nov 15 10:02:23 2017 +0000\n\n    blockchain_db: sanity check on tx/hash vector sizes\n    \n    It could trip on a corrupt/crafted file if the user has disabled\n    input verification.\n\ndiff --git a/src/blockchain_db/blockchain_db.cpp b/src/blockchain_db/blockchain_db.cpp\nindex c3f6e3d..2fb43a4 100644\n--- a/src/blockchain_db/blockchain_db.cpp\n+++ b/src/blockchain_db/blockchain_db.cpp\n@@ -194,6 +194,10 @@ uint64_t BlockchainDB::add_block( const block\u0026 blk\n                                 , const std::vector\u003ctransaction\u003e\u0026 txs\n                                 )\n {\n+  // sanity\n+  if (blk.tx_hashes.size() != txs.size())\n+    throw new std::runtime_error(\"Inconsistent tx/hashes sizes\");\n+\n   block_txn_start(false);\n \n   TIME_MEASURE_START(time1);\n","automated_response":false,"created_at":"2017-11-15T10:05:43.468Z","updated_at":"2017-11-15T10:05:43.468Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2662162,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-04-25T05:31:00.797Z","updated_at":"2018-04-25T05:31:00.797Z","first_to_agree":true,"actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2662188,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","automated_response":false,"created_at":"2018-04-25T05:49:59.316Z","updated_at":"2018-04-25T05:49:59.316Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}