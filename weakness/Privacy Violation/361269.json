{"id":361269,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNjEyNjk=","url":"https://hackerone.com/reports/361269","title":"Trusted daemon check fails when proxied through torsocks or proxychains","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2018-06-03T08:02:27.484Z","submitted_at":"2018-06-03T08:02:27.484Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"equim","url":"/equim","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7731,"url":"https://hackerone.com/monero","handle":"monero","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Monero","twitter_handle":"monero","website":"https://getmonero.org","about":" Monero: the secure, private, untraceable cryptocurrency"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-02T00:26:29.075Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2018-07-06T07:17:35.705Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nIf torsocks(1) or proxychains(1) is enforced when using Monero wallet with a remote node without explicit `--untrusted-daemon` arguments given, the application will assume the daemon is trusted.\n\n**Description:**\nBy default, the wallet checks if the daemon address can be trusted by calling `tools::is_local_address` when `--trust-daemon` is not set. However, if the process is proxied through torsocks(1) or proxychains(1), which resolves onion addresses into a loopback address that is handled by them internally, `is_local_address` will return `true` on such address, while the actual node should be considered untrusted.\n\nThis issue may sound trivial and I also noticed a new argument `--untrusted-daemon` has been added in commit [c4907d24cb32129ee52a53711547c5d54960c431](https://github.com/monero-project/monero/commit/c4907d24cb32129ee52a53711547c5d54960c431), but not all users using a remote node with torsocks or proxychains are aware of this. Essentially, we can't really tell if the address is really local, and current judgement of it doesn't make a sufficient condition that the daemon can be trusted.\n\n## Releases Affected:\n* Monero CLI wallet (@master)\n* Monero GUI wallet (@master)\n\n## Steps To Reproduce:\n1. Run the CLI wallet with `torsocks monero-wallet-cli --daemon-address zdhkwneu7lfaum2p.onion:18099`\n1. Authenticate the wallet and sync.\n1. Send command `rescan_bc`, which should be available only if the daemon is trusted.\n1. The command executed successfully.\n\n## Supporting Material/References:\nNone\n\n## Possible Solutions:\n1. Add an extra condition in src/common/util.cpp function is_local_address to judge if the daemon address ends with .onion or .i2p etc..\n1. Prompt the user explicitly if the daemon can be trusted.\n\n## Impact\n\nPossible private data disclosure to the untrusted remote node.","weakness":{"id":46,"name":"Privacy Violation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-08-05T07:17:35.782Z","allow_singular_disclosure_after":-100510384.4468784,"singular_disclosure_allowed":true,"vote_count":6,"voters":["eveeez","r3y","cryptographer","equim","arham-siddiqui","gwedd"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":2842857,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Plus, my mistake. In previous example `rescan_bc` should be `rescan_spent` since `rescan_bc` doesn't really require a trusted daemon.\n\nHere is yet another discovery. If we launch `monero-wallet-cli` without any argument, and we haven't set up any local daemon, then use command `set_daemon` to set the daemon, the trusted daemon check is also skipped, silently. As a proof we can run `rescan_spent`, and it will just proceed successfully, instead of saying `Error: this command requires a trusted daemon. Enable with --trusted-daemon` in the case we use `--daemon-address` in the first place. \n\nAnd this doesn't even need torsocks(1) or proxychains(1).\n","automated_response":false,"created_at":"2018-06-05T06:12:39.648Z","updated_at":"2018-06-05T06:14:55.716Z","actor":{"username":"equim","cleared":false,"url":"/equim","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2842868,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @equim, let's wait for an official response from @moneromooo.","automated_response":false,"created_at":"2018-06-05T06:24:42.699Z","updated_at":"2018-06-05T06:24:42.699Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2843048,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"You might well connect to your own node on a hidden service, or to a local node run by your system operator on a multiuser system. This is a heuristic, which is why you can override it.\nThe set_daemon one's a good one, will fix.\n","automated_response":false,"created_at":"2018-06-05T08:05:03.470Z","updated_at":"2018-06-05T08:05:03.470Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2843219,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I know whether a daemon is trusted or not this should be determined by the actual user and the automatic judgement only serves as a reference, and we have already made `--trusted-daemon` and `--untrusted-daemon` options for it.\n\nHowever, since most wallet functions already work properly upon an untrusted daemon, like `balance`, `refresh` and `transfer` etc, and there are just few exceptions like `rescan_spent` or `start_mining` that are meanwhile not so frequently used, in my opinion it's better to assume whatever daemon given is untrusted, unless the user explicitly set it as trusted.","automated_response":false,"created_at":"2018-06-05T08:32:42.394Z","updated_at":"2018-06-05T08:34:47.198Z","actor":{"username":"equim","cleared":false,"url":"/equim","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2844130,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"If you pull the conservative lever right to the max, then sure. We can certainly add a note in the README too along with the Tor instructions. I'll ask around for opinions on the default.\n\nThe set_daemon problem is now patched here: https://github.com/monero-project/monero/pull/3932. I'll add a i2p/onion check next.\n","automated_response":false,"created_at":"2018-06-05T10:27:02.150Z","updated_at":"2018-06-05T10:27:02.150Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2914285,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Good, I see it's merged now.","automated_response":false,"created_at":"2018-06-21T04:35:29.658Z","updated_at":"2018-06-21T04:35:29.658Z","actor":{"username":"equim","cleared":false,"url":"/equim","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2921436,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Will a release be tagged?","automated_response":false,"created_at":"2018-06-22T10:57:29.848Z","updated_at":"2018-06-22T10:57:29.848Z","actor":{"username":"equim","cleared":false,"url":"/equim","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2927955,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"There's at least one every 6 months, so next one is about september. Whether there is one before that depends on whether there's anything bad to fix. I think the timeout system might qualify, but that's up to fluffypony, who does the release work.","automated_response":false,"created_at":"2018-06-24T16:02:05.246Z","updated_at":"2018-06-24T16:02:05.246Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2963207,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@equim If you'd like bounty, please paste an XMR address.","automated_response":false,"created_at":"2018-06-30T05:01:44.574Z","updated_at":"2018-06-30T05:01:44.574Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2963210,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"`4777777jHFbZB4gyqrB1JHDtrGFusyj4b3M2nScYDPKEM133ng2QDrK9ycqizXS2XofADw5do5rU19LQmpTGCfeQTerm1Ti`","automated_response":false,"created_at":"2018-06-30T05:04:42.956Z","updated_at":"2018-06-30T05:04:42.956Z","actor":{"username":"equim","cleared":false,"url":"/equim","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/286/653/5962c47bc45ce4c12f14ae064d9f0553609ae1a0_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2997569,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sent 5 XMR: \u003c36837198cfda72f0a6b67a6383ca8c4d9f44ecb8c755d7a6eaff7436c070c3c3\u003e","automated_response":false,"created_at":"2018-07-06T05:28:47.226Z","updated_at":"2018-07-06T05:28:47.226Z","actor":{"username":"luigi1111w","cleared":false,"url":"/luigi1111w","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2998026,"is_internal":false,"editable":false,"type":"Activities::SwagAwarded","message":"","automated_response":false,"created_at":"2018-07-06T07:16:13.179Z","updated_at":"2018-07-06T07:16:13.179Z","actor":{"url":"/monero","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Monero"}},"reporter":{"username":"equim","url":"/equim"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2998029,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2018-07-06T07:16:49.852Z","updated_at":"2018-07-06T07:16:49.852Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"equim","url":"/equim"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2998031,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-07-06T07:17:35.729Z","updated_at":"2018-07-06T07:17:35.729Z","first_to_agree":true,"actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3130835,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","automated_response":false,"created_at":"2018-08-02T00:26:29.005Z","updated_at":"2018-08-02T00:26:29.005Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}