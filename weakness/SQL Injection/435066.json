{"id":435066,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MzUwNjY=","url":"https://hackerone.com/reports/435066","title":"SQL injection in GraphQL endpoint through embedded_submission_form_uuid parameter","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2018-11-06T16:52:08.233Z","submitted_at":"2018-11-06T16:52:08.233Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-11-30T01:26:39.932Z","bug_reporter_agreed_on_going_public_at":"2018-11-30T01:06:03.932Z","team_member_agreed_on_going_public_at":"2018-11-30T01:26:39.843Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The `embedded_submission_form_uuid` parameter in the `/graphql` endpoint is vulnerable to a SQL injection. Execute the following command to reproduce the behavior:\n\n**Locally**:\n```\ncurl -X POST http://localhost:8080/graphql\\?embedded_submission_form_uuid\\=1%27%3BSELECT%201%3BSELECT%20pg_sleep\\(30\\)%3B--%27\n```\n\n**HackerOne.com**\n```\ncurl -X POST https://hackerone.com/graphql\\?embedded_submission_form_uuid\\=1%27%3BSELECT%201%3BSELECT%20pg_sleep\\(30\\)%3B--%27\n```\n\n**Additional proof**\n```\n$ time curl -X POST https://hackerone.com/graphql\\?embedded_submission_form_uuid\\=1%27%3BSELECT%201%3BSELECT%20pg_sleep\\(5\\)%3B--%27\n{}curl -X POST   0.03s user 0.01s system 0% cpu 5.726 total\n$ time curl -X POST https://hackerone.com/graphql\\?embedded_submission_form_uuid\\=1%27%3BSELECT%201%3BSELECT%20pg_sleep\\(1\\)%3B--%27\n{}curl -X POST   0.03s user 0.01s system 2% cpu 1.631 total\n$ time curl -X POST https://hackerone.com/graphql\\?embedded_submission_form_uuid\\=1%27%3BSELECT%201%3BSELECT%20pg_sleep\\(10\\)%3B--%27\n{}curl -X POST   0.02s user 0.01s system 0% cpu 10.557 total\n```\n\n## Impact\n\nThe SQL injections seems to be executing in the context of the `secure` schema, so impact is currently unknown. However, since an attacker may be able to switch schemas, we should consider this to have a high impact on confidentiality.","weakness":{"id":67,"name":"SQL Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-12-30T01:06:04.055Z","allow_singular_disclosure_after":-87832434.92781816,"singular_disclosure_allowed":true,"vote_count":146,"voters":["mirchr","k1rox4n","pyrrhon","derision","ziot","the_arch_angel","kapytein","mashoud1122","jobert","muon4","and 136 more..."],"severity":{"rating":"critical","score":10.0,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":3,"asset_type":"URL","asset_identifier":"https://hackerone.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3594658,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2018-11-06T16:54:46.681Z","updated_at":"2018-11-06T16:54:46.681Z","additional_data":{"old_title":"SQL injection in GraphQL endpoint through UUID tracer parameter","new_title":"SQL injection in GraphQL endpoint through embedded_submission_form_uuid parameter"},"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3594660,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2018-11-06T16:55:16.383Z","updated_at":"2018-11-06T16:55:16.383Z","actor":{"username":"pei","cleared":false,"url":"/pei","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/939/2d83322336a492279dc84d8f92f280c2d54fcb5b_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3602706,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yesterday, at 12:42 PM PDT, a patch was released to address the SQL injection. The underlying root cause has not been addressed yet. From our preliminary investigation, it looks like a sanitization step was skipped when converting the GraphQL query into a SQL statement. We will continue to investigation and determine whether this has been abused. The SQL injection can currently not be exploited anymore and we didn't find any other occurrences of the problem.","automated_response":false,"created_at":"2018-11-07T19:20:48.403Z","updated_at":"2018-11-07T19:20:48.403Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3605170,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The commit `a6f976743368c29f8b4c0590079808e5583d4fb6` (rH) introduced the `embedded_submission_form_uuid ` parameter in the `/graphql` endpoint. This commit was merged on develop on September 3rd, 2018 and released to production on September 4th, 2018. In order for someone to have exploited this, the request would match `/graphql.*?embedded_submission_form_uuid.*?'`. The load balancer access logs are currently being queried to filter all requests that match this regular expression. We will manually review any matching request to determine whether this has been abused.","automated_response":false,"created_at":"2018-11-07T21:39:12.921Z","updated_at":"2018-11-07T21:39:12.921Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3614481,"is_internal":false,"editable":false,"type":"Activities::NotEligibleForBounty","message":"","automated_response":false,"created_at":"2018-11-09T06:04:19.475Z","updated_at":"2018-11-09T06:04:19.475Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"HackerOne"}},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3736166,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"On November 15th, we concluded the investigation to determine whether this has been abused. The investigation started on November 7th, but was pushed back due to the [SAML JIT incident](/reports/438306). **TL;DR: the SQL injection was not absued**. A more detailed answer can be found below.\n\nBased on the root cause of the vulnerability we identified a number of straightforward identifiers:\n\n - a `POST` request was made to `/graphql`\n - the `embedded_submission_form_uuid` parameter was passed in the URL or `POST` body (either as JSON or form encoded)\n - the user input must've contained a single quote in order to exploit the vulnerability\n\nThese identifiers helped us write a query to extract useful information from our Log Analysis Platform to see whether this was abused. We ran the query on the access logs from September 3rd, 2018 until October 8th, 2018. The query is slightly optimized and it took 00:06:34 to execute (it queries from both the hot and cold storage) and returned 104 matching requests.\n\n**Query**\n```\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n```\n\nThis query filters all requests to the `/graphql` endpoint with an embedded submission form UUID. The regular expression extracts the user input, decodes it, and constructs the executed SQL query. This helped us to immediately see what happened and determine whether someone purposely exploited this. We were also returning some more fields to help us figure out what the user would've seen, such as the HTTP response status code.\n\nSome interesting indicators that helped us here to determine whether this was abused: \n\n - the HTTP response status code (`code`) - in most cases it was a non-200 response, indicating that something went wrong. In most cases, this was related to a payload being used that would not work for PostgreSQL\n - the PoC that we developed ourselves executed the `pg_sleep` function - we used the `upstream_response_time`, `executedSqlQuery`, and `code` to determine whether the SQL was actually executed. Of the four `pg_sleep` functions we executed (`pg_sleep(1)`, `pg_sleep(5)`, `pg_sleep(10)`, and `pg_sleep(30)`), three were successful. The last one, with a timeout of 30, returned a 500 Internal Server Error because the backend aborted the request after 28 seconds.\n - in the logs, we found multiple scanners who tried to find a vulnerability. However, the majority of the scanners expect that the injection point is within a `WHERE` clause. In this case, the injection point was within a different context: `SET SESSION \u003cparameter\u003e TO '\u003cinjection\u003e'`. Because of this, automated scanners saw 500 Internal Server Errors and (most likely) didn't report a potential SQLi.\n\nThe **only** successful requests that were executed were our own `pg_sleep` payloads and came from trusted IP addresses.\n\nEarlier in this writeup, I wrote that one of the indicators was as following:\n\n - the `embedded_submission_form_uuid` parameter was passed in the URL or `POST` body (either as JSON or form encoded)\n\nThe underlying controller used the `params` object, which doesn't care where the user specified the parameter in the `POST` body or a URL (`GET`) parameter. This means that the nginx logs are not enough, as those don't log HTTP body data. The Rails logs do contain this information, but are harder to query, given that it's not in a JSON blob (**action item**: H1's security team prioritized a task to have a separate log pipeline that consists of JSON blogs). We've used the following query to filter the `embedded_submission_form_uuid` parameter from parameters Rails received:\n\n**Query**\n```\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n```\n\nThe result set was actually smaller (73 rows) than the initial results that were returned by the nginx access log query. We've looked into this and determined that not all requests from the load balancer were sent to unicorn and not all of the requests made it to Rails. This was not unexpected because nginx and/or Rack rejected some of the requests. We did not found any indicators that someone moved the parameters to the body. Here are the aggregated log counts per status code, which would also be a good indicator to see if this was abused:\n\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n\nNone of the requests showed any form of exploitation. This is why the team concluded that this wasn't abused.\n\nThe main takeaway from the root cause analysis and investigation is the reinforcement that building out an application log pipeline that includes all this information to be able to give an answer faster. The HackerOne security team has since prioritized building out these cohesive logs in a queryable format and has started collecting logs with enough context.\n\nThis incident will be played out again early next year as a table-top exercise to see how well we can respond to the same incident, but then with the new logs.","automated_response":false,"created_at":"2018-11-30T00:28:19.564Z","updated_at":"2018-11-30T00:31:03.206Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3736170,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2018-11-30T00:29:14.052Z","updated_at":"2018-11-30T00:29:14.052Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3736324,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This is ready to be disclosed.","automated_response":false,"created_at":"2018-11-30T01:06:03.971Z","updated_at":"2018-11-30T01:06:03.971Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3736482,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-11-30T01:26:39.878Z","updated_at":"2018-11-30T01:26:39.878Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3736483,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-11-30T01:26:39.952Z","updated_at":"2018-11-30T01:26:39.952Z","actor":{"username":"bencode","cleared":false,"url":"/bencode","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/117/ddaa1da4e004e1234c6857c42f9bfa8df85b5ccf_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":12272,"category":"team","content":"# Summary\nThe `embedded_submission_form_uuid` parameter in the `/graphql` endpoint was vulnerable to a SQL injection. This allowed an attacker to extract information from the public and secure schema. We have determine that the vulnerability was not exploited. A thorough explanation can be found in the report below.\n\n# Timeline\n\n| **Time (PST)**            | **Action**                                                                          |\n|---------------------------|-------------------------------------------------------------------------------------|\n| November 6th, 2018 8:04a  | @tomdev notices a `PG::SyntaxError` exception in hackerone.com's backend ðŸ™Œ           |\n| November 6th, 2018 8:04a  | @jjoos alerted InfoSec, people were assigned tasks                                  |\n| November 6th, 2018 8:20a  | Root cause was identified and a hot fix was put up for review                       |\n| November 6th, 2018 8:52a  | This report was filed to document the vulnerability                          |\n| November 6th, 2018 12:42p | A hot fix for the security vulnerability was released                               |\n| November 15th, 2018 2:20p | Investigation was concluded and determined that the vulnerability was not exploited |\n\n# Impacted Data\nWe have determine that the vulnerability was not exploited. A thorough explanation can be found in the report below.\n\n# Root cause\nHackerOne.com has a GraphQL endpoint that the frontend uses to query its backend. When the embedded submission form feature was introduced, a design decisions was made to leverage a GraphQL parameter rather than an input field. Input fields are properly sanitized. However, GraphQL parameters, were not. These GraphQL parameters were not designed to take raw user input. Here's the vulnerable piece of code:\n\n```ruby\nunless database_parameters_up_to_date\n  safe_query = ''\n\n  new_parameters.each do |key, value|\n    safe_query += \"SET SESSION #{key} TO #{value};\" # \u003c-- ðŸ˜®\n  end\n\n  begin\n    connection.query(safe_query)\n  rescue ActiveRecord::StatementInvalid =\u003e e\n    # NOTE: when the transaction is aborted, we cannot set or reset any parameters.\n    # Changes of previous SET statements are undone as well, so we can safely do\n    # nothing here\n    raise e unless e.cause.is_a? PG::InFailedSqlTransaction\n  end\nend\n```\n\nThe reason why we have to pass down these parameters to the PostgreSQL query level, is because HackerOne.com's database has two separate schemas. The `public` schema, which is where all the data resides and what we call the `secure` schema. The latter is a set of derived views from the `public` schema that returns data based on the currently signed in user (or signed out, for that matter). By default, GraphQL queries the `secure` schema. These derived views are automatically generated based on authorization logic we define in our GraphQL layer. This reduces the changes of information disclosure vulnerabilities, such as IDOR and SQL injections. Even when an attacker were to be able to query the `secure` schema, it'd reduce the number of exposed records significantly.","can_view?":true,"can_create?":false,"attachments":[],"user":{"id":2,"username":"jobert","name":"Jobert Abma","bio":"Co-founder of HackerOne. à² _à² ","cleared":true,"website":"https://hackerone.com","location":"San Francisco, CA","created_at":"2013-03-08T01:17:12.256Z","url":"https://hackerone.com/jobert","anc_triager":false,"hackerone_triager":false,"hackerone_employee":true,"hacker_resume_enabled":true,"user_type":"legacy","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c","xtralarge":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/c11036e2d3f8b05af4b5da5984ccdec6f786b763c8abceb4e68042e10dcdae85"}}},{"category":"researcher","can_view?":true,"can_create?":false}]}