{"id":925527,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85MjU1Mjc=","url":"https://hackerone.com/reports/925527","title":"Blind HTTP GET SSRF via website icon fetch (bypass of pull#812)","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2020-07-16T16:40:56.817Z","submitted_at":"2020-07-16T16:40:56.817Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"shielder","url":"/shielder","profile_picture_urls":{"small":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=ff7a8f325f8ed1b9769cf385aabd241b479e01af888127873be221290b5a1a3c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":21024,"url":"https://hackerone.com/bitwarden","handle":"bitwarden","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/uHvBgHfLjcd9SPWDmjdYVf21/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/uHvBgHfLjcd9SPWDmjdYVf21/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Bitwarden","twitter_handle":"bitwarden","website":"https://bitwarden.com","about":"Open source password management solutions for individuals, teams, and business organizations."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-09-11T13:24:08.854Z","bug_reporter_agreed_on_going_public_at":"2020-09-11T07:48:09.608Z","team_member_agreed_on_going_public_at":"2020-09-11T13:24:08.760Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"After a credential has been added to vault.bitwarden.com (or any self-hosted installation), if the settings allow website icons to be fetched (https://bitwarden.com/help/article/website-icons/), the Bitwarden server will try to fetch the icon image.\n\nThe relevant source code is https://github.com/bitwarden/server/blob/master/src/Icons/Controllers/IconsController.cs#L42-L65 and https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L59\nAs we can see in the second link, just the domain is used as entrypoint to retrieve the icon image. After trying both HTTPS and HTTP connections, if an HTTP redirect happens the backend will try to follow it, for a maximum of 2 times.\n\nThe merged pull request https://github.com/bitwarden/server/pull/812 (which seems based on the vulnerable code snippet available on https://stackoverflow.com/a/8113687) tries to prevent SSRF attacks by checking if the domain resolves to a private IP, but that protection can be bypassed because not all IPs are checked: for example \"0.0.0.0\" (which will request \"127.0.0.1\") or the private subnet \"169.254.0.0/16\" used in many cloud environments as metadata API (e.g. https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html) will pass that test and send the HTTP request to the private host.\n\n### Proof-of-concept\n0. Buy a domain and set it up on a server with a public IP address\n1. Setup a webserver on the domain, e.g. nginx\n2. Setup a malicious nameserver for the domain, I've used https://github.com/Crypt0s/FakeDns with the following configuration (change the domain name and IP with yours):\n\n```\nA www.yourdomain.com YOUR.PUBLIC.IP\nA .*.local.yourdomain.com 0.0.0.0\n```\n\n4. Create a redirect index page on the newly created webserver, e.g. (change the domain name with yours):\n\n```php\n\u003c?php\nheader(\"location: http://test.local.yourdomain.com/PATH_IS_KEPT\");\nexit();\n```\n\n3. Create a self-hosted Bitwarden instance following the instructions at https://bitwarden.com/help/article/install-on-premise/ and create an account\n4. Log-in via cli on the `icons` docker instance and setup a dummy TCP listener on port 80, this will confirm we can request arbitrary HTTP endpoints on 127.0.0.1 \n(**NOTE: i'm opening this socket just for PoC purposes -- of course the attacker wouldn't have such access however they could attack other locally-exposed services, such as the metadata API on 169.254.169.254**), e.g.:\n\n```\n# perl -MIO::Socket::INET -ne 'BEGIN{$l=IO::Socket::INET-\u003enew( LocalPort=\u003e80,Proto=\u003e\"tcp\",Listen=\u003e5,ReuseAddr=\u003e1); my $l=$l-\u003eaccept(); while(\u003c$l\u003e){ print $_; }; close($l);}'\n```\n\n5. Log-in Bitwarden and add a credential with URL \"www.yourdomain.com\" (change the domain name with yours)\n6. Notice the request at https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L301-L314 arrives on the local TCP listener, e.g.:\n\n```\nroot@2efebadd421d:/app# perl -MIO::Socket::INET -ne 'BEGIN{$l=IO::Socket::INET-\u003enew( LocalPort=\u003e80,Proto=\u003e\"tcp\",Listen=\u003e5,ReuseAddr=\u003e1); my $l=$l-\u003eaccept(); while(\u003c$l\u003e){ print $_; }; close($l);}'\nGET /PATH_IS_KEPT HTTP/1.1\nHost: redacted\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299\nAccept-Language: en-US, en; q=0.8\nCache-Control: no-cache\nPragma: no-cache\nAccept: text/html, application/xhtml+xml, application/xml; q=0.9, image/webp, image/apng, */*; q=0.8\nRequest-Id: |3d01319c-4dccd9dac66f3032.3.\nAccept-Encoding: gzip, deflate\n\n^C\nroot@2efebadd421d:/app#\n```\n\n### Bonus potential bypass (unverified) \nIt could also be possible to bypass such check via a DNS resolution Time-of-check/Time-of-use (TOCTOU, https://cwe.mitre.org/data/definitions/367.html) attack, similarly to what was done in https://hackerone.com/reports/541169.\n\nBy controlling a domain name and its nameserver an attacker can reply to the first DNS A resolution (the private IP check in https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L295) with a non-private IP address (with a very low TTL, such as 0, this way it is resolved again next time) to pass the check and then reply to the second DNS A resolution (the HTTP client DNS resolution triggered in https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L318) with any IP they want. Doing so allows them to bypass again the new protection and use any IP they want for the HTTP request. \n\nHere's a step-by-step explanation of the attack:\n\n0. The malicious user inputs a credential with URL \"http://shielder.it\" (whose nameserver they control)\n1. Bitwarden's backend requests a name resolution for the domain to check if it is a private IP (1st resolution, in https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L295)\n2. the attacker nameserver replies with any non-private IP, e.g. 8.8.8.8, with a low TTL, e.g. 0\n3. the Bitwarden backend checks it is not a private IP and tries to setup an HTTP request to it\n4. since the 1st resolution's TTL has now expired, the Bitwarden's server HTTP client resolves it again (2nd resolution, triggered by https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L318)\n5. the malicious nameserver now replies with a private IP address, e.g. 10.10.10.3\n6. the Bitwarden backend sends a HTTP request using the last IP address, e.g. 10.10.10.3\n\nMoreover, the attacker has the ability to send HTTP GET requests to arbitrary endpoint through the redirect technique I have talked about above.\n\nAs said previously, I haven't verified this second attack can actually work, however I wanted to point out it **should** theoretically be possible.\n\n### Remediation\n\nHere are my suggestions for the attack scenarios i have presented:\n* Consider in the check all the potential private IPs which now pass it, for example I suggest to have a look at what GitLab does (it is Ruby code but readable) at https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/url_blocker.rb\n* Verify the DNS resolution is not perfomed again after the IP is checked, if possible \"lock\" the HTTP request to the verified IP address so it is not sent using an unverified IP address\n\n### Credits\nPlease credit \"polict of Shielder\" in your changelog/hall-of-fame for the discovery of this vulnerability.\n\n## Impact\n\nA malicious Bitwarden user can use the Bitwarden server to scan the local network and send arbitrary HTTP GET requests to a locally-exposed host, such as localhost or an endpoint in 169.254.0.0/16. The privilege to send such requests could potentially allow them to get hold of reserved information or escalate their privileges.","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-10-11T07:48:09.666Z","allow_singular_disclosure_after":-31564487.935903855,"singular_disclosure_allowed":true,"vote_count":19,"voters":["drsniper","htrgouvea","demonia","codeur","m7mdharoun","smaury","b69fb2ebda43240ece9dbeb","vaibhavprajapati","breathingduke","ntr0v3rt_00","and 9 more..."],"severity":{"rating":"low","author_type":"Team"},"structured_scope":{"databaseId":773,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/bitwarden","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":8622485,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, thank you for the report. What version of the Bitwarden server are you testing with? The `Dns.GetHostEntry` checks that you are referencing in `master` have not yet been released. I do not beleive that the `HttpRequestMessage` you reference should not be following redirects as you suggest.","automated_response":false,"created_at":"2020-07-16T19:39:33.275Z","updated_at":"2020-07-16T19:39:33.275Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8622488,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","automated_response":false,"created_at":"2020-07-16T19:39:44.992Z","updated_at":"2020-07-16T19:39:44.992Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8625703,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Hi @kspearrin and thanks for the quick reply.\n\nI have tested it using both the hard-coded version in the \"self-deploy\" script (`$coreVersion = \"1.35.1\" and $webVersion = \"2.15.1\"` at https://raw.githubusercontent.com/bitwarden/server/master/scripts/bitwarden.ps1) and also by manually editing the generated DockerCompose file to use the `dev` build of the Icons service (specifically I am using the build https://hub.docker.com/layers/bitwarden/icons/dev/images/sha256-1f88d913e835f457ca5302801afa601baa09947f10349c1baf691920ce558a0b?context=explore). I'm pretty sure such build contains https://github.com/bitwarden/server/pull/812 because if I use `127.0.0.1.xip.io` (which resolves to 127.0.0.1) as website domain the icon's HTTP request is not sent, I guess because this check fails https://github.com/bitwarden/server/blob/master/src/Icons/Services/IconFetchingService.cs#L418. However let me know if I should create the environment in another way and I'll re-test it ASAP.\n\nRegarding the second point I'm not sure I have correctly understood what you mean: can you reformulate?","automated_response":false,"created_at":"2020-07-17T07:30:07.309Z","updated_at":"2020-07-17T07:30:07.309Z","actor":{"username":"shielder","cleared":false,"url":"/shielder","profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=abb7a18f0adc1e7e3fc2e5315e8d80aff755b61b4505c433c9ccf387b44b55d9"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8628872,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for verifying. If I understand correctly, in your attack you have a domain that resolves a public IP address and then redirects (location header) to `test.local.yourdomain.com` which resolves a localhost IP. We also do the internal IP checks on location header follows so I am a bit confused about how this gets by those checks.","automated_response":false,"created_at":"2020-07-17T12:00:10.037Z","updated_at":"2020-07-17T12:00:10.037Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8629496,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That's correct, but the problem is that those checks don't cover all possible private IPs. As I've mentioned earlier for example \"0.0.0.0\" (which in this context means \"all IPv4s addresses on the local machine\", https://en.wikipedia.org/wiki/0.0.0.0#As_a_host_address) will pass the checks performed in `IsInternal` and it will be used in the HTTP request, sending that request to 127.0.0.1, even though that should not be possible. In particular, the `IPAddress.IsLoopback` API doesn't consider it: \"In the case of IPv4, that the IsLoopback method returns true for any IP address of the form 127.X.Y.Z (where X, Y, and Z are in the range 0-255), not just Loopback (127.0.0.1).\" from https://docs.microsoft.com/en-gb/dotnet/api/system.net.ipaddress.isloopback?view=netcore-3.1. \n\nAnother \"private\" IP address which passes the checks is 169.254.169.254 (any IP in 169.254.0.0/16 actually), but it shouldn't because in many cloud environments that subnet is used for the metadata API (e.g. Amazon AWS https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html), so in case the self-hosted Bitwarden is deployed there an attacker can interact with the API and potentially elevate its privileges.\n\nThe HTTP redirect handling logic is not the problem here. I have used it just to gain the privilege of defining the `path` of the URL requested, because the first HTTP requests are done using only the `host` portion of the URL, and they wouldn't be of much value to an attacker by themselves if they want to interact meaningfully with another locally-available API.","automated_response":false,"created_at":"2020-07-17T13:04:18.741Z","updated_at":"2020-07-17T13:04:18.741Z","actor":{"username":"shielder","cleared":false,"url":"/shielder","profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=abb7a18f0adc1e7e3fc2e5315e8d80aff755b61b4505c433c9ccf387b44b55d9"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8629931,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"So I think we just need to add more IP ranges to the IsInternal check? Both `0.0.0.0` and `169.254.0.0/16`?","automated_response":false,"created_at":"2020-07-17T14:00:48.188Z","updated_at":"2020-07-17T14:00:48.188Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8630428,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Exactly, this way private IPv4 addresses should all be covered. About IPv6 addresses I suggest adding to the check all the IPv6 prefixes written in https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html#application-layer_1:\n```python \ndef is_private_ip(ip_address):\n    is_private = False\n    \"\"\"\n    Determine if a IP address provided is a private one.\n    Return TRUE if it's the case, FALSE otherwise.\n    \"\"\"\n    # Build the list of IP prefix for V4 and V6 addresses\n    ip_prefix = []\n    [...]\n    # Add IP V6 prefix for private addresses\n    # See https://en.wikipedia.org/wiki/Unique_local_address\n    # See https://en.wikipedia.org/wiki/Private_network\n    # See https://simpledns.com/private-ipv6\n    ip_prefix.append(\"fc\")\n    ip_prefix.append(\"fd\")\n    ip_prefix.append(\"fe\")\n    ip_prefix.append(\"ff\")\n    ip_prefix.append(\"::1\")\n    # Verify the provided IP address\n    # Remove whitespace characters from the beginning/end of the string\n    # and convert it to lower case\n    # Lower case is for preventing any IPV6 case bypass using mixed case\n    # depending on the source used to get the IP address\n    ip_to_verify = ip_address.strip().lower()\n    # Perform the check against the list of prefix\n    for prefix in ip_prefix:\n        if ip_to_verify.startswith(prefix):\n            is_private = True\n            break\n    return is_private\n```\n","automated_response":false,"created_at":"2020-07-17T14:52:00.647Z","updated_at":"2020-07-17T14:52:00.647Z","actor":{"username":"shielder","cleared":false,"url":"/shielder","profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=abb7a18f0adc1e7e3fc2e5315e8d80aff755b61b4505c433c9ccf387b44b55d9"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8630876,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","automated_response":false,"created_at":"2020-07-17T15:52:09.711Z","updated_at":"2020-07-17T15:52:09.711Z","additional_data":{"old_severity":null,"new_severity":"Low","old_severity_id":null,"new_severity_id":782682},"actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8630877,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks for the reference. Please see https://github.com/bitwarden/server/pull/827 to verify the fix.","automated_response":false,"created_at":"2020-07-17T15:52:12.363Z","updated_at":"2020-07-17T15:52:12.363Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8631910,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Were you able to validate DNS 0-TTL attack theory? My assumption is that with the initial check via DNS we're likely getting dotnet Core's System.Net internal DNS resolver cache which from my understanding doesn't respect much, including TTL, the time-to-execution, even if extended beyond 10 to 100ms between the initial DNS query to the time of execution (which will ultimately use dotnet's internal DNS resolver cache) will likely not hit a cache-miss and will use the original IP address (this would need to be tested) but I feel this would be a pretty small attack vector. To my understanding most folks actually have a harder time getting dotnet to dump it's internal DNS resolver cache vs. the other way around (too many repetitive DNS queries).","automated_response":false,"created_at":"2020-07-17T16:08:21.129Z","updated_at":"2020-07-17T16:08:41.880Z","actor":{"username":"chadscharf","cleared":false,"url":"/chadscharf","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/y7jahHdm66MGJNS9dmHCvJns/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8640376,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@kspearrin, I think this `return false;` should be a `return true;` because it is one of the localhost IPv6 address rapresentations (https://en.wikipedia.org/wiki/IPv6_address#Local_addresses): https://github.com/bitwarden/server/blob/52554d0443e147613308fb6813c0e3436dca36a4/src/Icons/Services/IconFetchingService.cs#L426 Moreover I'd add in the same `if` block also the check for `::`, which is equivalent to `::1` but would pass those checks at the moment (even with the correct return). Besides these changes it looks good to me!\n\n@chadscharf, yes I have tried it yesterday without success, I guess your explanation is correct and hence it is not really exploitable at the moment. Nonetheless, maybe it could be a good idea to add a comment in the code about it to prevent future changes from making it exploitable -- what do you think?","automated_response":false,"created_at":"2020-07-18T10:54:09.953Z","updated_at":"2020-07-18T10:54:09.953Z","actor":{"username":"shielder","cleared":false,"url":"/shielder","profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=abb7a18f0adc1e7e3fc2e5315e8d80aff755b61b4505c433c9ccf387b44b55d9"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8640695,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks. The fix will be available in the next release.","automated_response":false,"created_at":"2020-07-18T12:08:18.787Z","updated_at":"2020-07-18T12:08:18.787Z","actor":{"username":"kspearrin","cleared":false,"url":"/kspearrin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/NfF9KdzShJTHMmhSb4ajYq1p/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"shielder","url":"/shielder"},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9188000,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Can we disclose?","automated_response":false,"created_at":"2020-09-11T07:48:09.633Z","updated_at":"2020-09-11T07:48:09.633Z","first_to_agree":true,"actor":{"username":"shielder","cleared":false,"url":"/shielder","profile_picture_urls":{"medium":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/variants/o5786gd5qsya92gpbv5pzrtvp1pu/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c?response-content-disposition=inline%3B%20filename%3D%22cflfwHF7_400x400.jpeg%22%3B%20filename%2A%3DUTF-8%27%27cflfwHF7_400x400.jpeg\u0026response-content-type=image%2Fjpeg\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ57JDOB6N%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154257Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHcaCXVzLXdlc3QtMiJGMEQCIEj%2FvPHmMbBPYj%2BEqI%2BytJ5vP%2BW1Gij3b1KCROLW2m2fAiAUI2BnkECXV9d7hwkeZDEOYP6soFW%2FVQ7MIgaTaOghmSqDBAjw%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F8BEAIaDDAxMzYxOTI3NDg0OSIMaJpXtlkzQ%2F0YHokTKtcDqr54hfj92oRcu2Uf5AYn5X1dcYZ2fUSGzbf8TlAKPi%2BieszVvrvHI%2FlmbHmgiT1EynvsarNndOfkF2FRqu00jKx0CkmuRzepTozsI%2FVM4zmVsulVco0%2FTcUTH7ncLq5w17UCDOGpnW6JGeAot2EMSfGI%2BXeXow9Po2gINOm1gQnayfBCxU0Glim8HMTLVSft15PsLBhoVz6MQjjs5LpN9XS8yUG%2FvTzXTgclJY%2F9kWPo7VUzvyGgDBwaQ1NS4mY%2FwZ0AT%2BbZ6JXbFSX9ET%2BsjMi2Xi4Iz%2BSZK9IqUkrM05KykgVZmm0Jj83i2n43f%2BohD1oputpWW5Uu1cAXNs%2F4CRB2hvvyPQb%2B2khSXC6sOQi3exb9EuT5FkfOJXRD2w2ObGvWHxM%2BDQNczFHMaUBsCSSNn2cKqA093ghnjQ0g83xgTV9SBPb0QjpItD1Tnt9%2Bri%2FBh8RNCTedm%2Bor7TU6AnBCa6N50D96ANJhWhGw8kKZQdvzW0b0yw%2FH0clJ9XBtHGp1ul88rpA7tUuIoM7z31gr%2FReHR4G0fbpI0Bw%2BzUst%2BenEZyU7QQChxDc0u9loqAHNkWSJ3vDfDAhU2gFvocid02DAX%2FlKRXns4oUAYN7obhQgZX31MK2XkYsGOqYBmhNgLXdsx%2F8OPaK%2FmcpHbqK%2FVdgD3s09C%2FMBcjoeNruPiR%2B0%2FIpdgtcxNhaPoR0zb6re%2ByXh4v3hr2D2Z0%2BZCE4KiobLnf4PqE9a5czy2i5ctMeGIPCspubSRwCRBRORrnkT6%2FEocUc5PNqombEgctkvB80CoCyMfXpFqtIL0ne7x%2B%2B6lVkpXfm14Eb3XaRg7qWG7XL4Ud5U62KMTzbzA3t%2FxnvzsA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=abb7a18f0adc1e7e3fc2e5315e8d80aff755b61b4505c433c9ccf387b44b55d9"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9192122,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2020-09-11T13:24:08.783Z","updated_at":"2020-09-11T13:24:08.783Z","actor":{"username":"chadscharf","cleared":false,"url":"/chadscharf","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/y7jahHdm66MGJNS9dmHCvJns/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9192123,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2020-09-11T13:24:08.886Z","updated_at":"2020-09-11T13:24:08.886Z","actor":{"username":"chadscharf","cleared":false,"url":"/chadscharf","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/y7jahHdm66MGJNS9dmHCvJns/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"bitwarden","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}