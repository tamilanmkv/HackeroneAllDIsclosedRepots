{"id":997926,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85OTc5MjY=","url":"https://hackerone.com/reports/997926","title":"SSRF - Unchecked Snippet IDs for distributed files","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-10-04T21:48:39.709Z","submitted_at":"2020-10-04T21:48:39.732Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zhutyra","url":"/zhutyra","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2021-05-01T15:16:05.998Z","bug_reporter_agreed_on_going_public_at":"2021-05-01T15:16:05.927Z","team_member_agreed_on_going_public_at":"2021-04-30T07:44:02.617Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## ManagedFile\n\n`ManagedFiles` are basically just temporary files with some ID used for various purposes.\n\nWhen a managed file is created, it is registered in the local file map, which is just an internal map from `String(UUID)` to `ManagedFile`, and optionally also in the distributed file map, which is a distributed Hazelcast map from `String(UUID)` to `String(URL)`.\n\nWhen a managed file is accessed by ID and is not present in the local map, the distributed map is checked and the file is downloaded from the registered URL.\n\n## Snippets\n\nThe `/ajax/snippet?action=new` endpoint allows to create content snippets, usually mail signatures. Request body could look like this:\n\n```json\n{\n   \"type\":\"signature\",\n   \"module\":\"io.ox/mail\",\n   \"displayname\":\"\u003cname\u003e\",\n   \"content\":\"\u003ccontent\u003e\",\n   \"misc\":{\n      \"content-type\":\"\u003ccontent_type\u003e\",\n      \"imageId\":\"\u003cimage_id\u003e\"\n   }\n}\n```\n\nThe `imageId` field will be important later.\n\nThere are two snippet services:\n\n* `MimeSnippetService`, which requires `filestore` capability\n* `RdbSnippetService`, which doesn't have any requirements\n\nGuest users do not have the `filestore` capability, so the `RdbSnippetService` will be used for such sessions, which is the important one here.\n\nIn the code for retrieving a snippet from the database, we can see that `imageId` is used as the ID of the managed file holding the snippet attachment.\n\n```java\n// com.openexchange.snippet.rdb.RdbSnippetManagement.getSnippet0\nObject misc = snippet.getMisc();\nfinal String imageId = SnippetUtils.getImageId(misc);\nManagedFileManagement mfm = Services.getService(ManagedFileManagement.class);\nif (Strings.isNotEmpty(imageId) \u0026\u0026 !mfm.contains(imageId)) {\n    ManagedFile mf = mfm.createManagedFile(imageId, attachment.getInputStream());\n```\n\nHowever, Rdb only processes attachments if the `com.openexchange.snippet.rdb.supportsAttachments` config option is set to true. By default it is set to **false**.\n\n## The  Vulnerability\n\nThere are no checks on the specified ID. It can be any string, not just a UUID. This ID will be part of the URL registered in the disributed map and can cause incorrect URLs to be loaded.\n\nIn a cluster setup, we can create a malicious snippet on one node and then immediately load it from another node, which will only see it in the distributed map, and load it from the altered URL we registred. Probably, I didn't test this.\n\nIn a single-node setup, we have to wait for garbage collection of expired managed files. The cleanup takes place every 2 minutes and the file's time-to-live is 5 minutes after the last *touch*. So it's not a problem to wait. Files are only removed from the local map and will remain in the distributed map, so the next time they are accessed, they will be loaded directly from the distributed map containing our altered URL again. This is what my demo exploit does.\n\n## Summary\n\n* The `com.openexchange.snippet.rdb.supportsAttachments` is **disabled** by default.\n* But when enabled, it is possible to create managed files with arbitrary IDs, which leads to SSRF.\n* And it is exploitable by anonymous guest users.\n\n## Steps to reproduce\n\n* Enable RDB Snippet Attachments in the config and restart the server\n\n```\n# /opt/open-xchange/etc/snippets.properties\ncom.openexchange.snippet.rdb.supportsAttachments=true\n```\n\n* Run my demo exploit F1014374, which sets the URL to internal `/stats/diagnostic?param=version` page and should produce output like this:\n\n```html\n...\nsuccess. different content received\n\u003c!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\"\u003e\n\u003chtml\u003e\n\u003chead\u003e\u003ctitle\u003eDiagnostic\u003c/title\u003e\u003c/head\u003e\n\u003cbody\u003e\n\u003ch1\u003eVersion\u003c/h1\u003e\u003chr/\u003e\n7.10.4-Rev9\n\u003c/body\u003e\n\u003c/html\u003e\n```\n\n## Impact\n\nAn attacker can make requests to internal resources.","bounty_amount":"1500.0","formatted_bounty":"$1,500","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":1014374,"file_name":"ox-rdbsnipid.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/V7nyfbBmCrao5jnXmXSyR2EL?response-content-disposition=attachment%3B%20filename%3D%22ox-rdbsnipid.py%22%3B%20filename%2A%3DUTF-8%27%27ox-rdbsnipid.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSEHZZ6G7%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T154938Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCICgcJulSRaAJ%2FlV4SEWAQTyL4zo08LbSxF3YkMq%2FNlQPAiEAwYnoA1Ejs7bfAWoTffEddff%2B50LJlobfOVtd1RM%2FYnEqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDNRRuPIe4WOmezSvuirXA0I2fovKepc%2Br2vRekK4MdhNGmdM4Pc0OuzIHNmi1YNhdeljOfmMGUcQHlPqei9TxAGt4a%2Bwb9xKRrQFaS2o2gwxQkFXonxhS2p2%2FCJsWYUo5r66Rt8sQTiLMsAQcSzSjjF4bWzRQlm%2FsXkyqmfct1BfShpBMKnI%2BGx4M48yQfNnfgyRoZjVuWMHzcNqo6i%2B3imvvfu1gDhHkBQgvqL6AhnkVsXPRp6bS08enQ%2B4LeWijQjUmlhVfE3gDt1zfAq%2Fe%2FxOw17jAAuZH4zvbU5%2FFtGrJy%2BmroOTUxv%2FmxiaS8mF368AXRZQT%2FQ%2BK1TgapuP6OgN2v4j35edAg5veKR5WdWsY0QgOpQDSxzsTc2OCErw7fYWcmQYeYhOLVSghUfUtkDG76jJaJQMd36SmC4L2sb2NQ06wkAJfvd6Xh2dj7rFd%2BeVtQEdiI0FpNpkr5AYIz9emwENChfGQLyYkIfW5YUmUZn7%2BrBuWRxITz%2B3soyUxqmlqH%2B32ar8fmBp4Ie0VZd5xxkyHz5L%2BO4aTQveejpP0KxMm2%2Flqz8faN%2FLDBmpyKrFPcJn0sktEBiYdZCKd%2FJMvehZSGrjjy%2F75WSa1FwB%2FTzTTFRrGtLtYGGYby7RdTaug%2BPMKTC2jZGLBjqlAW%2FqLgyIU3l7q2BIHZ9aOYbvAcm7k5gKph8EjMf6tXptYEaiHmQx1q5jFWsRXPiWMZbi4fKKkFbfrJI1NS%2FDW3ba%2FI9tKqyLv9ZB%2FyHxyGg3CQqjMAh5HPdI6A9scOywAto0wTVOHwkl9Ay%2BNQ%2BadpR1vVj4UXnFx6R7Mt2xHMMc188gMtdSb8CXyaP6RpR3xaP3OWl7wd9lKp0P5L%2BRwYyHexzCFA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=9e6303b1f478bafbed756f89cee5f1b0b8f51449e9a25e1c3de337059067cd13","file_size":8571,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":49,"voters":["pmnh","whybee","jin0ne","ali","mattberg","dilawer01","0nlymohammed","rzx007x","sodium_","dz_samir","and 39 more..."],"severity":{"rating":"high","author_type":"Team"},"structured_scope":{"databaseId":43411,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/open-xchange/appsuite-middleware","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":9426851,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for your submission! I'm currently a bit caught up in an audit and will respond to your reports soon.","automated_response":false,"created_at":"2020-10-05T22:10:27.636Z","updated_at":"2020-10-05T22:10:27.636Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9490422,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Very nice finding!","automated_response":false,"created_at":"2020-10-12T08:33:40.898Z","updated_at":"2020-10-12T08:33:40.898Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9612147,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","automated_response":false,"created_at":"2020-10-23T12:27:05.043Z","updated_at":"2020-10-23T12:27:05.043Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zhutyra","url":"/zhutyra"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9612151,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":null,"automated_response":false,"created_at":"2020-10-23T12:27:16.289Z","updated_at":"2020-10-23T12:27:16.289Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":886472},"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9612159,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We're currently waiting for the transfer of funds to our account, once that is completed bounty will be assigned.","automated_response":false,"created_at":"2020-10-23T12:28:51.192Z","updated_at":"2020-10-23T12:28:51.192Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9699267,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","automated_response":false,"created_at":"2020-11-02T07:47:59.586Z","updated_at":"2020-11-02T07:47:59.586Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"1500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"zhutyra","url":"/zhutyra"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9700640,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you very much for the bounty.","automated_response":false,"created_at":"2020-11-02T10:11:25.725Z","updated_at":"2020-11-02T10:11:25.725Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11574961,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-04-30T07:44:02.648Z","updated_at":"2021-04-30T07:44:02.648Z","first_to_agree":true,"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":11588360,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2021-05-01T15:16:05.961Z","updated_at":"2021-05-01T15:16:05.961Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":11588361,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2021-05-01T15:16:06.038Z","updated_at":"2021-05-01T15:16:06.038Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}