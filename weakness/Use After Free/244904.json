{"id":244904,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDQ5MDQ=","url":"https://hackerone.com/reports/244904","title":"Use after free in mruby-mpdecimal","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-06-30T23:18:43.925Z","submitted_at":"2017-06-30T23:18:43.925Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"haquaman","url":"/haquaman","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-07-06T20:23:22.342Z","bug_reporter_agreed_on_going_public_at":"2017-07-06T20:23:22.298Z","team_member_agreed_on_going_public_at":"2017-07-06T19:58:36.436Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Running the following ruby script in mruby compiled with ASAN enabled causes a use after free error:\n\n```\nx=inspect.to_d-0\n```\n\nOutput of mruby with ASAN:\n\n```\n$ ./ext/enterprise_script_service/mruby/bin/mruby crash.rb\ntrace:\n\t[0] crash.rb:1\n\t[1] /root/ess/ext/enterprise_script_service/mruby-mpdecimal/mrblib/mpdecimal.rb:21:in to_d\n/root/ess/ext/enterprise_script_service/mruby-mpdecimal/mrblib/mpdecimal.rb:21:can't convert \"main\" into Decimal (ArgumentError)\n=================================================================\n==8219==ERROR: AddressSanitizer: heap-use-after-free on address 0x60800000b9f0 at pc 0x00000073de47 bp 0x7ffc2a5efa90 sp 0x7ffc2a5efa88\nREAD of size 8 at 0x60800000b9f0 thread T0\n    #0 0x73de46 in mpd_free /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/memory.c:139:5\n    #1 0x6e0c15 in mpd_del /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/mpdecimal.c:459:9\n    #2 0x6ddb62 in decimal_free /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c:28:3\n    #3 0x536973 in obj_free /root/ess/ext/enterprise_script_service/mruby/src/gc.c:823:9\n    #4 0x537055 in free_heap /root/ess/ext/enterprise_script_service/mruby/src/gc.c:388:9\n    #5 0x537055 in mrb_gc_destroy /root/ess/ext/enterprise_script_service/mruby/src/gc.c:397\n    #6 0x531d3d in mrb_close /root/ess/ext/enterprise_script_service/mruby/src/state.c:252:3\n    #7 0x4e6c39 in cleanup /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:165:3\n    #8 0x4e6c39 in main /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:257\n    #9 0x7f2e96bdaf44 in __libc_start_main /build/eglibc-SvCtMH/eglibc-2.19/csu/libc-start.c:287\n    #10 0x43f336 in _start (/root/ess/ext/enterprise_script_service/mruby/bin/mruby+0x43f336)\n\n0x60800000b9f0 is located 80 bytes inside of 96-byte region [0x60800000b9a0,0x60800000ba00)\nfreed by thread T0 here:\n    #0 0x4c6012 in free (/root/ess/ext/enterprise_script_service/mruby/bin/mruby+0x4c6012)\n    #1 0x52fdd0 in mrb_default_allocf /root/ess/ext/enterprise_script_service/mruby/src/state.c:56:5\n\npreviously allocated by thread T0 here:\n    #0 0x4c6635 in realloc (/root/ess/ext/enterprise_script_service/mruby/bin/mruby+0x4c6635)\n    #1 0x52fdad in mrb_default_allocf /root/ess/ext/enterprise_script_service/mruby/src/state.c:60:12\n\nSUMMARY: AddressSanitizer: heap-use-after-free /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/memory.c:139 mpd_free\nShadow bytes around the buggy address:\n  0x0c107fff96e0: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c107fff96f0: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9700: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9710: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd\n  0x0c107fff9720: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd\n=\u003e0x0c107fff9730: fa fa fa fa fd fd fd fd fd fd fd fd fd fd[fd]fd\n  0x0c107fff9740: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9750: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9760: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9770: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fa\n  0x0c107fff9780: fa fa fa fa fd fd fd fd fd fd fd fd fd fd fd fd\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07 \n  Heap left redzone:       fa\n  Heap right redzone:      fb\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack partial redzone:   f4\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==8219==ABORTING\n```\n\nThe version of mruby is:\n\n```\n 39779b339e12c81d2fd9dcc5d0a9c40bed965430 ext/enterprise_script_service/mruby (1.0.0-4080-g39779b3)\n ```\n\nThis is from the following commit in ess:\n\n```\n29ccd3691d8feabd37fe8872bd8d5c4e198531cf\n```\n\nI'll work on a patch this weekend hopefully.","bounty_amount":"800.0","formatted_bounty":"$800","weakness":{"id":50,"name":"Use After Free"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-08-05T19:58:36.480Z","allow_singular_disclosure_after":-131999429.69077086,"singular_disclosure_allowed":true,"vote_count":1,"voters":["japz"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":1795519,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to one week to respond. Thank you for your patience!","automated_response":true,"created_at":"2017-06-30T23:18:44.091Z","updated_at":"2017-06-30T23:18:44.091Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1795528,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"gdb output showing that same decimal is free'd twice:\n\n```\n(gdb) break decimal_free\nBreakpoint 1 at 0x6ddad0: file /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c, line 22.\n(gdb) r\nStarting program: /root/ess/ext/enterprise_script_service/mruby/bin/mruby crash.rb\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\ntrace:\n        [0] crash.rb:1\n        [1] /root/ess/ext/enterprise_script_service/mruby-mpdecimal/mrblib/mpdecimal.rb:21:in to_d\n/root/ess/ext/enterprise_script_service/mruby-mpdecimal/mrblib/mpdecimal.rb:21:can't convert \"main\" intoDecimal (ArgumentError)\n\nBreakpoint 1, decimal_free (state=0x61400000fe40, data=0x6020000083b0)\n    at /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c:22\n22      static void decimal_free(mrb_state *state, void *data) {\n(gdb) bt\n#0  decimal_free (state=0x61400000fe40, data=0x6020000083b0)\n    at /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c:22\n#1  0x0000000000536974 in obj_free (mrb=0x61400000fe40, obj=0x62f000004510, end=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:823\n#2  0x0000000000537056 in free_heap (gc=0x61400000ff00, mrb=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:388\n#3  mrb_gc_destroy (mrb=0x61400000fe40, gc=0x61400000ff00)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:397\n#4  0x0000000000531d3e in mrb_close (mrb=0x61400000fe40)\n    at /root/ess/ext/enterprise_script_service/mruby/src/state.c:252\n#5  0x00000000004e6c3a in cleanup (mrb=\u003coptimized out\u003e, args=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:165\n#6  main (argc=\u003coptimized out\u003e, argv=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:257\n(gdb) c\nContinuing.\n\nBreakpoint 1, decimal_free (state=0x61400000fe40, data=0x602000001850)\n    at /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c:22\n22      static void decimal_free(mrb_state *state, void *data) {\n(gdb) bt\n#0  decimal_free (state=0x61400000fe40, data=0x602000001850)\n    at /root/ess/ext/enterprise_script_service/mruby-mpdecimal/src/ext.c:22\n#1  0x0000000000536974 in obj_free (mrb=0x61400000fe40, obj=0x62f000007870, end=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:823\n#2  0x0000000000537056 in free_heap (gc=0x61400000ff00, mrb=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:388\n#3  mrb_gc_destroy (mrb=0x61400000fe40, gc=0x61400000ff00)\n    at /root/ess/ext/enterprise_script_service/mruby/src/gc.c:397\n#4  0x0000000000531d3e in mrb_close (mrb=0x61400000fe40)\n    at /root/ess/ext/enterprise_script_service/mruby/src/state.c:252\n#5  0x00000000004e6c3a in cleanup (mrb=\u003coptimized out\u003e, args=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:165\n#6  main (argc=\u003coptimized out\u003e, argv=\u003coptimized out\u003e)\n    at /root/ess/ext/enterprise_script_service/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:257\n(gdb)\n```","automated_response":false,"created_at":"2017-06-30T23:28:11.604Z","updated_at":"2017-06-30T23:28:11.604Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1802599,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. Our engineering team is investigating the issue.","automated_response":false,"created_at":"2017-07-04T20:13:17.149Z","updated_at":"2017-07-04T20:13:17.149Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1807192,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","automated_response":false,"created_at":"2017-07-05T14:00:46.948Z","updated_at":"2017-07-05T14:00:46.948Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1808873,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","automated_response":false,"created_at":"2017-07-05T20:37:25.148Z","updated_at":"2017-07-05T20:37:25.148Z","additional_data":{"old_title":"Use after free in mrub-mpdecimal","new_title":"Use after free in mruby-mpdecimal"},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1812413,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. We resolved this issue in https://github.com/Shopify/ess/pull/18 by statically allocating the gem's `mpd_context_t`. Previously it was stored in a Ruby object, which could be garbage collected while `Decimal` objects still needed it.\n\nOur next round of bounty decisions will take place within the next few days, so we'll be in touch with you again soon.","automated_response":false,"created_at":"2017-07-06T19:51:15.270Z","updated_at":"2017-07-06T19:51:15.270Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"haquaman","url":"/haquaman"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1812423,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify!","automated_response":false,"created_at":"2017-07-06T19:54:36.454Z","updated_at":"2017-07-06T19:54:36.454Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"800.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"haquaman","url":"/haquaman"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1812438,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2017-07-06T19:58:36.456Z","updated_at":"2017-07-06T19:58:36.456Z","first_to_agree":true,"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1812514,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Haha that was a quick bounty, thanks, will apply that and get back to you with more if I find it.","automated_response":false,"created_at":"2017-07-06T20:23:22.318Z","updated_at":"2017-07-06T20:23:22.318Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1812515,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2017-07-06T20:23:22.360Z","updated_at":"2017-07-06T20:23:22.360Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}