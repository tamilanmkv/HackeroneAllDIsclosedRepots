{"id":387279,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zODcyNzk=","url":"https://hackerone.com/reports/387279","title":"App messaging can be hijacked by third-party websites","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2018-07-26T18:56:22.668Z","submitted_at":"2018-07-26T18:56:22.668Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"palant","url":"/palant","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/125/397/69a28ca9d5030b1db03411852407732328b571c3_original.png/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/43e4513b9104ea0d68c9c096cea374ba8440dde3e027af5465c8771e8839a67c","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"pentest_feature_enabled?":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"has_collaborators":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2018-11-07T14:40:10.870Z","bug_reporter_agreed_on_going_public_at":"2018-11-07T13:30:26.073Z","team_member_agreed_on_going_public_at":"2018-11-07T14:40:10.681Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The JavaScript code at https://cdn.shopify.com/s/assets/admin/index-c6e72fa910cd0182ab1d1e67ff823fb2e6ca61745c00797769410ce01aafc4d8.js installs a `message` event listener to receive messages from installed apps when these apps are displayed in a frame. The following check rejects invalid event origins:\n\n    i.origin!==this.applicationOrigin\u0026\u0026!e(this.applicationOriginUri,Shopify.UrlMangler.getURL(i.origin))\n\nHere function `e` is defined above as follows:\n\n    e = function (e,t){\n      return e.protocol === t.protocol \u0026\u0026\n             e.port===t.port \u0026\u0026\n             t.hostname.slice(-e.hostname.length) === e.hostname \u0026\u0026\n             \"\" !== e.hostname;\n    }\n\nThis logic is meant to accept messages from subdomains of the app's domain. It is flawed however: if the app is running from `example.com`, messages from `badexample.com` will be accepted as well.\n\n*Recommendation*: Changing the condition into `t.hostname.slice(-e.hostname.length-1) === \".\" + e.hostname` will do the right thing.\n\nTo demonstrate this issue, my proof of concept exploits the app Trust Badge - it runs from \"https://hektorcommerce.com\", so anybody could register a domain name like `dehektorcommerce.com` and send messages to the admin interface which will then be accepted. This is not a flaw in the app however, any app not running from a subdomain can be exploited in the same way.\n\n# Steps to reproduce\n\n1. Make sure to install [Trust Badge app](https://apps.shopify.com/trust-badge) in your shop.\n2. Download the attached `ssl_server.py` script and `exploit_app_comm.html` page to the same directory on your computer.\n3. Edit `/etc/hosts` file (that's `%Windir%\\Sysnative\\drivers\\etc\\hosts` on Windows) and add the following entry: `127.0.0.1 dehektorcommerce.com`. The real attackers would register `dehektorcommerce.com` domain instead.\n4. Start `ssl_server.py` script (requires Python 3) to run a local SSL-protected web server. On Linux and macOS this script needs to be run with administrator privileges.\n5. Open `https://dehektorcommerce.com/exploit_app_comm.html` in your browser and accept the invalid certificate (real attacker would actually own dehektorcommerce.com, so they would be able to get a valid certificate for it).\n6. Enter the host name of your shop into the input field and click \"Do it!\" button.\n7. A new browser tab opens and the admin interface of your shop loads, only to be immediately replaced by a login form. You can enter something into the login form and click \"Log in\" - the page will respond with the message \"Gotcha\".\n\nThe fake login page is being displayed by sending a `Shopify.API.Modal.open` message in the name of the Trust Badge app, this allows overlaying the admin interface with an arbitrary web page. I didn't spend any time faking this login page look similar to the real one, but that would be trivial. Unlike with phishing pages, checking the address bar doesn't help - the URL really belongs to the Shopify admin interface.\n\n## Impact\n\nThis issue allows attacking admins of a specific, e.g. by abusing support channels to send them a malicious link. Social engineering could be used to convince admins to enter their credentials into fake login page - the URL of the page won't tip them off that this page has been manipulated.\n\nDisplaying overlays on top of the Shopify admin interface is something that any app can do by itself of course. So it might be a good idea to disallow removing all hints showing that the content displaying there doesn't belong to Shopify (the `hideHeader` parameter is particularly problematic here).\n\nHowever, abusing special privileges granted to some apps might be even more problematic. For example, messages like `Shopify.API.Cart.discount.add` are restricted to apps that received the necessary privilege. I'm not sure how much harm these messages could do, but this vulnerability allows third-party websites to send them.","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":57,"name":"Violation of Secure Design Principles"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":324946,"file_name":"exploit_app_comm.html","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/324/946/d7abccb0326ab25fe59a5987af398e5f95a3d717/exploit_app_comm.html?response-content-disposition=attachment%3B%20filename%3D%22exploit_app_comm.html%22%3B%20filename%2A%3DUTF-8%27%27exploit_app_comm.html\u0026response-content-type=application%2Foctet-stream\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYC7ZV3WT%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T145403Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIDrMLp4%2BWn0RnMngqqBOAomCU8GWEnyzbfeWXMTkRqdkAiEAmbCt%2FtYvzimCcqsBY5T%2BAP6C1koJvsZIEr7pm24tsEAqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDHO5iuzPFsJ4aK7KmSrXA43fG9ZExUYtmldfJFAHkWRlov9q%2FHMMPiqI7JWoul8iB2lnCe0Z8UD9oM5cfjZfhntNLx94myZGJfeT24YbqZ%2BCsOqn%2BPXRlK7VWqoq1AV8zdBtboSY1qGlF1yW0h8xQvR1G807ShHTgDzCxdIUl0y2PUXdt%2BRNIlHckLFzjBfbJBmGFikh%2B68wwr3qhH%2BRekBJT8dRJqkMmVmJIoL4rn3y%2FCM010RJxL86Xuoat%2BrN046smSjkfceh4bPaJkOADf33dP%2FBliSDcBjoMG74ZFHPAmgnqoN439xdfqhUpIPqNFrcRU1WpQhc12VYut5tMZcbmJchXopaXhvm%2B4orW3DihHvyn7HD%2BiT1cpN9baXaycQzr%2B68J9MyG01Zce8VNQxPm5eRp7v9dtdfEQ9sF3yuOsWzUwY%2BTHCD7SIcVsQFrS5Z2L5Ux3CncTXxkqQVlNCyHTcJODpncVKfD7b6uHxsAmVawhDDZJgLpATJPpVIaGa0em09aEDUcT%2FuazJtx1N1gOr8ZYZSsD6LmJlT7xfEsyzeZ%2BC%2FQQSJKyYRebEtRjLR%2BsYz4MKD2jlXjj62sVdjHko29e6c4eso%2Fx8%2Bjrkj%2BYuyD88VzMWxszti4qHccB7%2Fr3%2BsDzDViZGLBjqlAc5vcHGjagoOTjMDz6VCxHAyKKMhBY%2F4ksl1iKt3Mkg6KIb8dD7WB3B5bRwalHdLpA6q%2F0HyHwVC3k8nRLkVacoHC%2BTnF8IsDYgQMa3VWvq9UB5BqCGPwIE9Smv%2FlQf6eGWyrcOO%2Brsi6UGSaKxoz3eFt2y8zMnz71sdDkZshTNAZoB15M%2BSMQApjyeteOn3dhbojlsBvMBhOE%2FWaBGY2zXmhSJaSA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=9a6ce06471befbb9f1e3fda8b1fc8c2f0553d91cf075aa230f39b18bc6850b62","file_size":2520,"type":"text/html"},{"id":324947,"file_name":"ssl_server.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/324/947/0e1b760badc6b3cfb6aa6d7fa748380b13666ccf/ssl_server.py?response-content-disposition=attachment%3B%20filename%3D%22ssl_server.py%22%3B%20filename%2A%3DUTF-8%27%27ssl_server.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQYC7ZV3WT%2F20211011%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20211011T145403Z\u0026X-Amz-Expires=3600\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHYaCXVzLXdlc3QtMiJHMEUCIDrMLp4%2BWn0RnMngqqBOAomCU8GWEnyzbfeWXMTkRqdkAiEAmbCt%2FtYvzimCcqsBY5T%2BAP6C1koJvsZIEr7pm24tsEAqgwQI7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARACGgwwMTM2MTkyNzQ4NDkiDHO5iuzPFsJ4aK7KmSrXA43fG9ZExUYtmldfJFAHkWRlov9q%2FHMMPiqI7JWoul8iB2lnCe0Z8UD9oM5cfjZfhntNLx94myZGJfeT24YbqZ%2BCsOqn%2BPXRlK7VWqoq1AV8zdBtboSY1qGlF1yW0h8xQvR1G807ShHTgDzCxdIUl0y2PUXdt%2BRNIlHckLFzjBfbJBmGFikh%2B68wwr3qhH%2BRekBJT8dRJqkMmVmJIoL4rn3y%2FCM010RJxL86Xuoat%2BrN046smSjkfceh4bPaJkOADf33dP%2FBliSDcBjoMG74ZFHPAmgnqoN439xdfqhUpIPqNFrcRU1WpQhc12VYut5tMZcbmJchXopaXhvm%2B4orW3DihHvyn7HD%2BiT1cpN9baXaycQzr%2B68J9MyG01Zce8VNQxPm5eRp7v9dtdfEQ9sF3yuOsWzUwY%2BTHCD7SIcVsQFrS5Z2L5Ux3CncTXxkqQVlNCyHTcJODpncVKfD7b6uHxsAmVawhDDZJgLpATJPpVIaGa0em09aEDUcT%2FuazJtx1N1gOr8ZYZSsD6LmJlT7xfEsyzeZ%2BC%2FQQSJKyYRebEtRjLR%2BsYz4MKD2jlXjj62sVdjHko29e6c4eso%2Fx8%2Bjrkj%2BYuyD88VzMWxszti4qHccB7%2Fr3%2BsDzDViZGLBjqlAc5vcHGjagoOTjMDz6VCxHAyKKMhBY%2F4ksl1iKt3Mkg6KIb8dD7WB3B5bRwalHdLpA6q%2F0HyHwVC3k8nRLkVacoHC%2BTnF8IsDYgQMa3VWvq9UB5BqCGPwIE9Smv%2FlQf6eGWyrcOO%2Brsi6UGSaKxoz3eFt2y8zMnz71sdDkZshTNAZoB15M%2BSMQApjyeteOn3dhbojlsBvMBhOE%2FWaBGY2zXmhSJaSA%3D%3D\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Signature=8ee253bac1c60e2827d4913a6827b4e10f4fbd269a882c37c96c03919163e131","file_size":3657,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":39,"voters":["sp1d3rs","drsniper","foobar7","mashoud1122","sameerphad72","spam404","ali","quikke","cgboal","harry_mg","and 29 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":413,"asset_type":"URL","asset_identifier":"your-store.myshopify.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"activities":[{"id":3102385,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @palant,\nthanks for another detailed report. We've reproduced it and have notified the engineering team. I'm triaging this in the mean time.\n\nKeep up the great work.\nPete","automated_response":false,"created_at":"2018-07-26T20:33:57.961Z","updated_at":"2018-07-26T20:33:57.961Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3105735,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thank you for the report @palant, I'm awarding 500$ on triage and we will determine the final amount after we resolve the issue.","automated_response":false,"created_at":"2018-07-27T14:47:45.581Z","updated_at":"2018-07-27T14:47:45.581Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"palant","url":"/palant"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3107026,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @palant,\nwe just shipped a fix for this. Please let us know if you're still able to reproduce. I'm going to resolve this in the meantime.","automated_response":false,"created_at":"2018-07-27T21:32:52.363Z","updated_at":"2018-07-27T21:32:52.363Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"palant","url":"/palant"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3151917,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thank you for the report @palant, we've decided to award an additional 500$ for a total of 1000$.","automated_response":false,"created_at":"2018-08-06T17:25:37.867Z","updated_at":"2018-08-06T17:25:37.867Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"palant","url":"/palant"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3599867,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-11-07T13:30:26.135Z","updated_at":"2018-11-07T13:30:26.135Z","first_to_agree":true,"actor":{"username":"palant","cleared":false,"url":"/palant","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/125/397/69a28ca9d5030b1db03411852407732328b571c3_original.png/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3601364,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","automated_response":false,"created_at":"2018-11-07T14:40:10.743Z","updated_at":"2018-11-07T14:40:10.743Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3601365,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","automated_response":false,"created_at":"2018-11-07T14:40:10.904Z","updated_at":"2018-11-07T14:40:10.904Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/fd4ecbe1e3e98c343c7717114485ace2f830f9253103d3cfa7502059868c516c"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}